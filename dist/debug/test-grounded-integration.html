<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grounded Sheets - Campaign Cart Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .integration-status {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-indicator.success {
            background: #4CAF50;
        }
        
        .status-indicator.error {
            background: #f44336;
        }
        
        .status-indicator.warning {
            background: #FF9800;
        }
        
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .debug-panel h3 {
            margin-top: 0;
            color: #333;
        }
        
        .cart-contents {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .event-log {
            background: #1a1a1a;
            color: #4CAF50;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .event-log .event-entry {
            margin: 5px 0;
            opacity: 0.9;
        }
        
        .event-log .event-entry.new {
            animation: pulse 0.5s ease-in-out;
            opacity: 1;
        }
        
        @keyframes pulse {
            0% { background: rgba(76, 175, 80, 0.2); }
            100% { background: transparent; }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #1976D2;
        }
        
        button.danger {
            background: #f44336;
        }
        
        button.danger:hover {
            background: #d32f2f;
        }
        
        .info-box {
            background: #E3F2FD;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .info-box h4 {
            margin-top: 0;
            color: #1976D2;
        }
        
        .info-box code {
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõèÔ∏è Grounded Sheets - Campaign Cart Integration Test</h1>
        
        <div class="integration-status">
            <h3>Integration Status</h3>
            <div class="status-item">
                <div class="status-indicator" id="campaign-cart-status"></div>
                <span>Campaign Cart SDK: <span id="campaign-cart-text">Checking...</span></span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="grounded-status"></div>
                <span>Grounded Controller: <span id="grounded-text">Checking...</span></span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="integration-status"></div>
                <span>Integration: <span id="integration-text">Checking...</span></span>
            </div>
        </div>

        <div class="info-box">
            <h4>üìã How the Integration Works</h4>
            <p>When you select variants in the Grounded Sheets UI:</p>
            <ul>
                <li>Each complete variant selection triggers <code>updateCampaignCart()</code></li>
                <li>The variant ID is used as the package ID for the cart</li>
                <li>Metadata includes slot number, size, color, and pack quantity</li>
                <li>Tier changes clear the cart automatically</li>
                <li>Cart events are logged in the Event Log below</li>
            </ul>
        </div>

        <div class="debug-panel">
            <h3>üõí Current Cart Contents</h3>
            <div class="cart-contents" id="cart-contents">
                <pre>Cart is empty</pre>
            </div>
            <div class="controls">
                <button onclick="refreshCart()">Refresh Cart</button>
                <button onclick="clearCart()" class="danger">Clear Cart</button>
                <button onclick="simulateVariantSelection()">Simulate Selection</button>
            </div>
        </div>

        <div class="debug-panel">
            <h3>üìä Event Log</h3>
            <div class="event-log" id="event-log">
                <div class="event-entry">Waiting for events...</div>
            </div>
            <div class="controls">
                <button onclick="clearEventLog()">Clear Log</button>
                <button onclick="exportEventLog()">Export Log</button>
            </div>
        </div>

        <div class="debug-panel">
            <h3>üß™ Test Controls</h3>
            <div class="controls">
                <button onclick="testTierChange(1)">Select 1-Pack</button>
                <button onclick="testTierChange(2)">Select 2-Pack</button>
                <button onclick="testTierChange(3)">Select 3-Pack</button>
                <button onclick="testCompleteSelection()">Test Complete Selection</button>
            </div>
        </div>
    </div>

    <script>
        // Event logging
        const eventLog = [];
        
        function logEvent(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message, data };
            eventLog.push(entry);
            
            const logElement = document.getElementById('event-log');
            const newEntry = document.createElement('div');
            newEntry.className = 'event-entry new';
            newEntry.textContent = `[${timestamp}] ${message}${data ? ' - ' + JSON.stringify(data) : ''}`;
            logElement.insertBefore(newEntry, logElement.firstChild);
            
            // Remove animation class after animation completes
            setTimeout(() => newEntry.classList.remove('new'), 500);
            
            // Limit log entries to 50
            while (logElement.children.length > 50) {
                logElement.removeChild(logElement.lastChild);
            }
        }
        
        // Check integration status
        function checkIntegrationStatus() {
            // Check Campaign Cart
            if (typeof window.NextCommerce !== 'undefined') {
                document.getElementById('campaign-cart-status').className = 'status-indicator success';
                document.getElementById('campaign-cart-text').textContent = 'Loaded ‚úì';
                logEvent('Campaign Cart SDK detected');
            } else {
                document.getElementById('campaign-cart-status').className = 'status-indicator error';
                document.getElementById('campaign-cart-text').textContent = 'Not Found ‚úó';
                logEvent('Campaign Cart SDK not found', { error: 'NextCommerce is undefined' });
            }
            
            // Check Grounded Controller
            if (typeof window.TierController !== 'undefined') {
                document.getElementById('grounded-status').className = 'status-indicator success';
                document.getElementById('grounded-text').textContent = 'Loaded ‚úì';
                logEvent('Grounded Controller detected');
            } else {
                document.getElementById('grounded-status').className = 'status-indicator warning';
                document.getElementById('grounded-text').textContent = 'Not Loaded Yet';
            }
            
            // Check Integration
            if (typeof window.NextCommerce !== 'undefined' && typeof window.TierController !== 'undefined') {
                document.getElementById('integration-status').className = 'status-indicator success';
                document.getElementById('integration-text').textContent = 'Ready ‚úì';
                logEvent('Integration ready');
                setupEventListeners();
            } else {
                document.getElementById('integration-status').className = 'status-indicator warning';
                document.getElementById('integration-text').textContent = 'Waiting...';
            }
        }
        
        // Setup event listeners for cart events
        function setupEventListeners() {
            if (window.NextCommerce && window.NextCommerce.events) {
                window.NextCommerce.events.on('cart:updated', (cartState) => {
                    logEvent('Cart updated', { items: cartState.items?.length || 0 });
                    refreshCart();
                });
                
                window.NextCommerce.events.on('cart:item-added', (item) => {
                    logEvent('Item added to cart', { packageId: item.packageId });
                    refreshCart();
                });
                
                window.NextCommerce.events.on('cart:cleared', () => {
                    logEvent('Cart cleared');
                    refreshCart();
                });
                
                window.NextCommerce.events.on('grounded:selection-complete', (data) => {
                    logEvent('All selections complete', { tier: data.tier, selections: data.selections.length });
                });
            }
            
            // Listen for grounded events
            document.addEventListener('variantComplete', (e) => {
                logEvent('Variant selected', { 
                    slot: e.detail.slot, 
                    variantId: e.detail.variant.id,
                    size: e.detail.variant.size,
                    color: e.detail.variant.color
                });
            });
            
            document.addEventListener('tierChange', (e) => {
                logEvent('Tier changed', { tier: e.detail.tier });
            });
        }
        
        // Cart operations
        function refreshCart() {
            if (window.NextCommerce && window.NextCommerce.cart) {
                const cartState = window.NextCommerce.cart.getState();
                const cartElement = document.getElementById('cart-contents');
                
                if (cartState.items && cartState.items.length > 0) {
                    cartElement.innerHTML = `<pre>${JSON.stringify(cartState, null, 2)}</pre>`;
                } else {
                    cartElement.innerHTML = '<pre>Cart is empty</pre>';
                }
            }
        }
        
        function clearCart() {
            if (window.NextCommerce && window.NextCommerce.cart) {
                window.NextCommerce.cart.clear();
                logEvent('Cart cleared manually');
            }
        }
        
        function clearEventLog() {
            document.getElementById('event-log').innerHTML = '<div class="event-entry">Log cleared</div>';
            eventLog.length = 0;
        }
        
        function exportEventLog() {
            const blob = new Blob([JSON.stringify(eventLog, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `grounded-integration-log-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            logEvent('Event log exported');
        }
        
        // Test functions
        function simulateVariantSelection() {
            const testVariant = {
                id: 5,
                size: "Queen",
                color: "Obsidian Grey",
                quantity: 1
            };
            
            if (window.tierController) {
                window.tierController.dispatchVariantCompleteEvent(1, testVariant);
                logEvent('Simulated variant selection', testVariant);
            } else {
                logEvent('Cannot simulate - controller not ready');
            }
        }
        
        function testTierChange(tier) {
            if (window.tierController) {
                window.tierController.selectTier(tier);
                logEvent(`Changed to ${tier}-pack tier`);
            }
        }
        
        function testCompleteSelection() {
            if (window.tierController) {
                // Simulate complete selection for tier 1
                const variant = {
                    id: 5,
                    size: "Queen",
                    color: "Obsidian Grey",
                    quantity: 1
                };
                window.tierController.dispatchVariantCompleteEvent(1, variant);
                logEvent('Test complete selection executed');
            }
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            logEvent('Page loaded, checking integration...');
            
            // Check immediately
            checkIntegrationStatus();
            
            // Check again after a delay (in case scripts are still loading)
            setTimeout(checkIntegrationStatus, 1000);
            setTimeout(checkIntegrationStatus, 3000);
            
            // Listen for NextCommerce initialization
            document.addEventListener('next:initialized', () => {
                logEvent('NextCommerce initialized');
                checkIntegrationStatus();
            });
        });
        
        // Expose refresh function globally
        window.refreshCart = refreshCart;
        window.clearCart = clearCart;
        window.clearEventLog = clearEventLog;
        window.exportEventLog = exportEventLog;
        window.simulateVariantSelection = simulateVariantSelection;
        window.testTierChange = testTierChange;
        window.testCompleteSelection = testCompleteSelection;
    </script>
</body>
</html>