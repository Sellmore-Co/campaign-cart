!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NextCommerce={})}(this,function(e){"use strict";const t=e=>{let t;const i=new Set,n=(e,n)=>{const a="function"==typeof e?e(t):e;if(!Object.is(a,t)){const e=t;t=(null!=n?n:"object"!=typeof a||null===a)?a:Object.assign({},t,a),i.forEach(i=>i(t,e))}},a=()=>t,s={setState:n,getState:a,getInitialState:()=>r,subscribe:e=>(i.add(e),()=>i.delete(e)),destroy:()=>{i.clear()}},r=t=e(n,a,s);return s};function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n,a,s={exports:{}},r={};function o(){if(n)return r;n=1;var e=Symbol.for("react.transitional.element"),t=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),a=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),o=Symbol.for("react.consumer"),l=Symbol.for("react.context"),c=Symbol.for("react.forward_ref"),d=Symbol.for("react.suspense"),u=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),h=Symbol.iterator;var g={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,f={};function y(e,t,i){this.props=e,this.context=t,this.refs=f,this.updater=i||g}function v(){}function b(e,t,i){this.props=e,this.context=t,this.refs=f,this.updater=i||g}y.prototype.isReactComponent={},y.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},y.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},v.prototype=y.prototype;var x=b.prototype=new v;x.constructor=b,m(x,y.prototype),x.isPureReactComponent=!0;var w=Array.isArray,S={H:null,A:null,T:null,S:null,V:null},_=Object.prototype.hasOwnProperty;function k(t,i,n,a,s,r){return n=r.ref,{$$typeof:e,type:t,key:i,ref:void 0!==n?n:null,props:r}}function C(t){return"object"==typeof t&&null!==t&&t.$$typeof===e}var E=/\/+/g;function I(e,t){return"object"==typeof e&&null!==e&&null!=e.key?(i=""+e.key,n={"=":"=0",":":"=2"},"$"+i.replace(/[=:]/g,function(e){return n[e]})):t.toString(36);var i,n}function P(){}function A(i,n,a,s,r){var o=typeof i;"undefined"!==o&&"boolean"!==o||(i=null);var l,c,d=!1;if(null===i)d=!0;else switch(o){case"bigint":case"string":case"number":d=!0;break;case"object":switch(i.$$typeof){case e:case t:d=!0;break;case p:return A((d=i._init)(i._payload),n,a,s,r)}}if(d)return r=r(i),d=""===s?"."+I(i,0):s,w(r)?(a="",null!=d&&(a=d.replace(E,"$&/")+"/"),A(r,n,a,"",function(e){return e})):null!=r&&(C(r)&&(l=r,c=a+(null==r.key||i&&i.key===r.key?"":(""+r.key).replace(E,"$&/")+"/")+d,r=k(l.type,c,void 0,0,0,l.props)),n.push(r)),1;d=0;var u,g=""===s?".":s+":";if(w(i))for(var m=0;m<i.length;m++)d+=A(s=i[m],n,a,o=g+I(s,m),r);else if("function"==typeof(m=null===(u=i)||"object"!=typeof u?null:"function"==typeof(u=h&&u[h]||u["@@iterator"])?u:null))for(i=m.call(i),m=0;!(s=i.next()).done;)d+=A(s=s.value,n,a,o=g+I(s,m++),r);else if("object"===o){if("function"==typeof i.then)return A(function(e){switch(e.status){case"fulfilled":return e.value;case"rejected":throw e.reason;default:switch("string"==typeof e.status?e.then(P,P):(e.status="pending",e.then(function(t){"pending"===e.status&&(e.status="fulfilled",e.value=t)},function(t){"pending"===e.status&&(e.status="rejected",e.reason=t)})),e.status){case"fulfilled":return e.value;case"rejected":throw e.reason}}throw e}(i),n,a,s,r);throw n=String(i),Error("Objects are not valid as a React child (found: "+("[object Object]"===n?"object with keys {"+Object.keys(i).join(", ")+"}":n)+"). If you meant to render a collection of children, use an array instead.")}return d}function L(e,t,i){if(null==e)return e;var n=[],a=0;return A(e,n,"","",function(e){return t.call(i,e,a++)}),n}function T(e){if(-1===e._status){var t=e._result;(t=t()).then(function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)},function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)}),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var D="function"==typeof reportError?reportError:function(e){if("object"==typeof window&&"function"==typeof window.ErrorEvent){var t=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:"object"==typeof e&&null!==e&&"string"==typeof e.message?String(e.message):String(e),error:e});if(!window.dispatchEvent(t))return}else if("object"==typeof process&&"function"==typeof process.emit)return void process.emit("uncaughtException",e)};function M(){}return r.Children={map:L,forEach:function(e,t,i){L(e,function(){t.apply(this,arguments)},i)},count:function(e){var t=0;return L(e,function(){t++}),t},toArray:function(e){return L(e,function(e){return e})||[]},only:function(e){if(!C(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},r.Component=y,r.Fragment=i,r.Profiler=s,r.PureComponent=b,r.StrictMode=a,r.Suspense=d,r.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=S,r.__COMPILER_RUNTIME={__proto__:null,c:function(e){return S.H.useMemoCache(e)}},r.cache=function(e){return function(){return e.apply(null,arguments)}},r.cloneElement=function(e,t,i){if(null==e)throw Error("The argument must be a React element, but you passed "+e+".");var n=m({},e.props),a=e.key;if(null!=t)for(s in void 0!==t.ref&&void 0,void 0!==t.key&&(a=""+t.key),t)!_.call(t,s)||"key"===s||"__self"===s||"__source"===s||"ref"===s&&void 0===t.ref||(n[s]=t[s]);var s=arguments.length-2;if(1===s)n.children=i;else if(1<s){for(var r=Array(s),o=0;o<s;o++)r[o]=arguments[o+2];n.children=r}return k(e.type,a,void 0,0,0,n)},r.createContext=function(e){return(e={$$typeof:l,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null}).Provider=e,e.Consumer={$$typeof:o,_context:e},e},r.createElement=function(e,t,i){var n,a={},s=null;if(null!=t)for(n in void 0!==t.key&&(s=""+t.key),t)_.call(t,n)&&"key"!==n&&"__self"!==n&&"__source"!==n&&(a[n]=t[n]);var r=arguments.length-2;if(1===r)a.children=i;else if(1<r){for(var o=Array(r),l=0;l<r;l++)o[l]=arguments[l+2];a.children=o}if(e&&e.defaultProps)for(n in r=e.defaultProps)void 0===a[n]&&(a[n]=r[n]);return k(e,s,void 0,0,0,a)},r.createRef=function(){return{current:null}},r.forwardRef=function(e){return{$$typeof:c,render:e}},r.isValidElement=C,r.lazy=function(e){return{$$typeof:p,_payload:{_status:-1,_result:e},_init:T}},r.memo=function(e,t){return{$$typeof:u,type:e,compare:void 0===t?null:t}},r.startTransition=function(e){var t=S.T,i={};S.T=i;try{var n=e(),a=S.S;null!==a&&a(i,n),"object"==typeof n&&null!==n&&"function"==typeof n.then&&n.then(M,D)}catch(s){D(s)}finally{S.T=t}},r.unstable_useCacheRefresh=function(){return S.H.useCacheRefresh()},r.use=function(e){return S.H.use(e)},r.useActionState=function(e,t,i){return S.H.useActionState(e,t,i)},r.useCallback=function(e,t){return S.H.useCallback(e,t)},r.useContext=function(e){return S.H.useContext(e)},r.useDebugValue=function(){},r.useDeferredValue=function(e,t){return S.H.useDeferredValue(e,t)},r.useEffect=function(e,t,i){var n=S.H;if("function"==typeof i)throw Error("useEffect CRUD overload is not enabled in this build of React.");return n.useEffect(e,t)},r.useId=function(){return S.H.useId()},r.useImperativeHandle=function(e,t,i){return S.H.useImperativeHandle(e,t,i)},r.useInsertionEffect=function(e,t){return S.H.useInsertionEffect(e,t)},r.useLayoutEffect=function(e,t){return S.H.useLayoutEffect(e,t)},r.useMemo=function(e,t){return S.H.useMemo(e,t)},r.useOptimistic=function(e,t){return S.H.useOptimistic(e,t)},r.useReducer=function(e,t,i){return S.H.useReducer(e,t,i)},r.useRef=function(e){return S.H.useRef(e)},r.useState=function(e){return S.H.useState(e)},r.useSyncExternalStore=function(e,t,i){return S.H.useSyncExternalStore(e,t,i)},r.useTransition=function(){return S.H.useTransition()},r.version="19.1.1",r}function l(){return a||(a=1,s.exports=o()),s.exports}const c=i(l());var d,u,p,h,g={exports:{}},m={},f={exports:{}},y={};function v(){return u||(u=1,f.exports=function(){if(d)return y;d=1;var e=l(),t="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},i=e.useState,n=e.useEffect,a=e.useLayoutEffect,s=e.useDebugValue;function r(e){var i=e.getSnapshot;e=e.value;try{var n=i();return!t(e,n)}catch(a){return!0}}var o="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var o=t(),l=i({inst:{value:o,getSnapshot:t}}),c=l[0].inst,d=l[1];return a(function(){c.value=o,c.getSnapshot=t,r(c)&&d({inst:c})},[e,o,t]),n(function(){return r(c)&&d({inst:c}),e(function(){r(c)&&d({inst:c})})},[e]),s(o),o};return y.useSyncExternalStore=void 0!==e.useSyncExternalStore?e.useSyncExternalStore:o,y}()),f.exports}const b=i((h||(h=1,g.exports=function(){if(p)return m;p=1;var e=l(),t=v(),i="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},n=t.useSyncExternalStore,a=e.useRef,s=e.useEffect,r=e.useMemo,o=e.useDebugValue;return m.useSyncExternalStoreWithSelector=function(e,t,l,c,d){var u=a(null);if(null===u.current){var p={hasValue:!1,value:null};u.current=p}else p=u.current;u=r(function(){function e(e){if(!s){if(s=!0,n=e,e=c(e),void 0!==d&&p.hasValue){var t=p.value;if(d(t,e))return a=t}return a=e}if(t=a,i(n,e))return t;var r=c(e);return void 0!==d&&d(t,r)?(n=e,t):(n=e,a=r)}var n,a,s=!1,r=void 0===l?null:l;return[function(){return e(t())},null===r?void 0:function(){return e(r())}]},[t,l,c,d]);var h=n(e,u[0],u[1]);return s(function(){p.hasValue=!0,p.value=h},[h]),o(h),h},m}()),g.exports)),x={},{useDebugValue:w}=c,{useSyncExternalStoreWithSelector:S}=b;let _=!1;const k=e=>e;const C=e=>{const i="function"==typeof e?(e=>e?t(e):t)(e):e,n=(e,t)=>function(e,t=k,i){"production"!==(x?"production":void 0)&&i&&!_&&(_=!0);const n=S(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,i);return w(n),n}(i,e,t);return Object.assign(n,i),n},E=e=>e?C(e):C,I={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1},P=new Map,A=e=>{const t=P.get(e);return t?Object.fromEntries(Object.entries(t.stores).map(([e,t])=>[e,t.getState()])):{}},L=(e,t={})=>(i,n,a)=>{const{enabled:s,anonymousActionType:r,store:o,...l}=t;let c;try{c=(null!=s?s:"production"!==(I?"production":void 0))&&window.__REDUX_DEVTOOLS_EXTENSION__}catch(m){}if(!c)return e(i,n,a);const{connection:d,...u}=((e,t,i)=>{if(void 0===e)return{type:"untracked",connection:t.connect(i)};const n=P.get(i.name);if(n)return{type:"tracked",store:e,...n};const a={connection:t.connect(i),stores:{}};return P.set(i.name,a),{type:"tracked",store:e,...a}})(o,c,l);let p=!0;a.setState=(e,t,s)=>{const c=i(e,t);if(!p)return c;const u=void 0===s?{type:r||"anonymous"}:"string"==typeof s?{type:s}:s;return void 0===o?(null==d||d.send(u,n()),c):(null==d||d.send({...u,type:`${o}/${u.type}`},{...A(l.name),[o]:a.getState()}),c)};const h=(...e)=>{const t=p;p=!1,i(...e),p=t},g=e(a.setState,n,a);if("untracked"===u.type?null==d||d.init(g):(u.stores[u.store]=a,null==d||d.init(Object.fromEntries(Object.entries(u.stores).map(([e,t])=>[e,e===u.store?g:t.getState()])))),a.dispatchFromDevtools&&"function"==typeof a.dispatch){let e=!1;const t=a.dispatch;a.dispatch=(...i)=>{"production"===(I?"production":void 0)||"__setState"!==i[0].type||e||(e=!0),t(...i)}}return d.subscribe(e=>{var t;switch(e.type){case"ACTION":if("string"!=typeof e.payload)return;return T(e.payload,e=>{if("__setState"===e.type){if(void 0===o)return void h(e.state);Object.keys(e.state).length;const t=e.state[o];if(null==t)return;return void(JSON.stringify(a.getState())!==JSON.stringify(t)&&h(t))}a.dispatchFromDevtools&&"function"==typeof a.dispatch&&a.dispatch(e)});case"DISPATCH":switch(e.payload.type){case"RESET":return h(g),void 0===o?null==d?void 0:d.init(a.getState()):null==d?void 0:d.init(A(l.name));case"COMMIT":return void 0===o?void(null==d||d.init(a.getState())):null==d?void 0:d.init(A(l.name));case"ROLLBACK":return T(e.state,e=>{if(void 0===o)return h(e),void(null==d||d.init(a.getState()));h(e[o]),null==d||d.init(A(l.name))});case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return T(e.state,e=>{void 0!==o?JSON.stringify(a.getState())!==JSON.stringify(e[o])&&h(e[o]):h(e)});case"IMPORT_STATE":{const{nextLiftedState:i}=e.payload,n=null==(t=i.computedStates.slice(-1)[0])?void 0:t.state;if(!n)return;return h(void 0===o?n:n[o]),void(null==d||d.send(null,i))}case"PAUSE_RECORDING":return p=!p}return}}),g},T=(e,t)=>{let i;try{i=JSON.parse(e)}catch(n){}void 0!==i&&t(i)},D=e=>(t,i,n)=>{const a=n.subscribe;n.subscribe=(e,t,i)=>{let s=e;if(t){const a=(null==i?void 0:i.equalityFn)||Object.is;let r=e(n.getState());s=i=>{const n=e(i);if(!a(r,n)){const e=r;t(r=n,e)}},(null==i?void 0:i.fireImmediately)&&t(r,r)}return a(s)};return e(t,i,n)};function M(e,t){let i;try{i=e()}catch(n){return}return{getItem:e=>{var t;const n=e=>null===e?null:JSON.parse(e,void 0),a=null!=(t=i.getItem(e))?t:null;return a instanceof Promise?a.then(n):n(a)},setItem:(e,t)=>i.setItem(e,JSON.stringify(t,void 0)),removeItem:e=>i.removeItem(e)}}const F=e=>t=>{try{const i=e(t);return i instanceof Promise?i:{then:e=>F(e)(i),catch(e){return this}}}catch(i){return{then(e){return this},catch:e=>F(e)(i)}}},$=(e,t)=>"getStorage"in t||"serialize"in t||"deserialize"in t?((e,t)=>(i,n,a)=>{let s={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...t},r=!1;const o=new Set,l=new Set;let c;try{c=s.getStorage()}catch(f){}if(!c)return e((...e)=>{i(...e)},n,a);const d=F(s.serialize),u=()=>{const e=s.partialize({...n()});let t;const i=d({state:e,version:s.version}).then(e=>c.setItem(s.name,e)).catch(e=>{t=e});if(t)throw t;return i},p=a.setState;a.setState=(e,t)=>{p(e,t),u()};const h=e((...e)=>{i(...e),u()},n,a);let g;const m=()=>{var e;if(!c)return;r=!1,o.forEach(e=>e(n()));const t=(null==(e=s.onRehydrateStorage)?void 0:e.call(s,n()))||void 0;return F(c.getItem.bind(c))(s.name).then(e=>{if(e)return s.deserialize(e)}).then(e=>{if(e){if("number"!=typeof e.version||e.version===s.version)return e.state;if(s.migrate)return s.migrate(e.state,e.version)}}).then(e=>{var t;return g=s.merge(e,null!=(t=n())?t:h),i(g,!0),u()}).then(()=>{null==t||t(g,void 0),r=!0,l.forEach(e=>e(g))}).catch(e=>{null==t||t(void 0,e)})};return a.persist={setOptions:e=>{s={...s,...e},e.getStorage&&(c=e.getStorage())},clearStorage:()=>{null==c||c.removeItem(s.name)},getOptions:()=>s,rehydrate:()=>m(),hasHydrated:()=>r,onHydrate:e=>(o.add(e),()=>{o.delete(e)}),onFinishHydration:e=>(l.add(e),()=>{l.delete(e)})},m(),g||h})(e,t):((e,t)=>(i,n,a)=>{let s={storage:M(()=>localStorage),partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...t},r=!1;const o=new Set,l=new Set;let c=s.storage;if(!c)return e((...e)=>{i(...e)},n,a);const d=()=>{const e=s.partialize({...n()});return c.setItem(s.name,{state:e,version:s.version})},u=a.setState;a.setState=(e,t)=>{u(e,t),d()};const p=e((...e)=>{i(...e),d()},n,a);let h;a.getInitialState=()=>p;const g=()=>{var e,t;if(!c)return;r=!1,o.forEach(e=>{var t;return e(null!=(t=n())?t:p)});const a=(null==(t=s.onRehydrateStorage)?void 0:t.call(s,null!=(e=n())?e:p))||void 0;return F(c.getItem.bind(c))(s.name).then(e=>{if(e){if("number"!=typeof e.version||e.version===s.version)return[!1,e.state];if(s.migrate)return[!0,s.migrate(e.state,e.version)]}return[!1,void 0]}).then(e=>{var t;const[a,r]=e;if(h=s.merge(r,null!=(t=n())?t:p),i(h,!0),a)return d()}).then(()=>{null==a||a(h,void 0),h=n(),r=!0,l.forEach(e=>e(h))}).catch(e=>{null==a||a(void 0,e)})};return a.persist={setOptions:e=>{s={...s,...e},e.storage&&(c=e.storage)},clearStorage:()=>{null==c||c.removeItem(s.name)},getOptions:()=>s,rehydrate:()=>g(),hasHydrated:()=>r,onHydrate:e=>(o.add(e),()=>{o.delete(e)}),onFinishHydration:e=>(l.add(e),()=>{l.delete(e)})},s.skipHydration||g(),h||p})(e,t);var q=(e=>(e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG",e))(q||{});const O=()=>{if("undefined"==typeof window)return!1;const e=new URLSearchParams(window.location.search);return"true"===e.get("debug")||"true"===e.get("debugger")},U=class e{constructor(e){this.context=e}static setLogLevel(t){e.globalLevel=t}static getLogLevel(){return e.globalLevel}error(t,...i){e.globalLevel}warn(t,...i){O()&&e.globalLevel}info(t,...i){O()&&e.globalLevel}debug(t,...i){O()&&e.globalLevel}};U.globalLevel=2;let N=U;class z extends N{constructor(e){super(e)}warn(e,...t){O()&&super.warn(e,...t)}info(e,...t){O()&&super.info(e,...t)}debug(e,...t){O()&&super.debug(e,...t)}}function R(e){return new z(e)}R("SDK");class H{constructor(e={}){this.logger=R("StorageManager"),this.storage=e.storage??sessionStorage,this.serialize=e.serialize??JSON.stringify,this.deserialize=e.deserialize??JSON.parse}set(e,t){try{const i=this.serialize(t);return this.storage.setItem(e,i),this.logger.debug(`Stored value for key: ${e}`),!0}catch(i){return this.logger.error(`Failed to store value for key ${e}:`,i),!1}}get(e,t){try{const i=this.storage.getItem(e);if(null===i)return this.logger.debug(`No value found for key: ${e}`),t;const n=this.deserialize(i);return this.logger.debug(`Retrieved value for key: ${e}`),n}catch(i){return this.logger.error(`Failed to retrieve value for key ${e}:`,i),t}}remove(e){try{return this.storage.removeItem(e),this.logger.debug(`Removed value for key: ${e}`),!0}catch(t){return this.logger.error(`Failed to remove value for key ${e}:`,t),!1}}clear(){try{return this.storage.clear(),this.logger.debug("Cleared all storage"),!0}catch(e){return this.logger.error("Failed to clear storage:",e),!1}}has(e){return null!==this.storage.getItem(e)}keys(){const e=[];for(let t=0;t<this.storage.length;t++){const i=this.storage.key(t);null!==i&&e.push(i)}return e}size(){let e=0;for(let t=0;t<this.storage.length;t++){const i=this.storage.key(t);if(null!==i){const t=this.storage.getItem(i);null!==t&&(e+=i.length+t.length)}}return e}}const j=new H({storage:sessionStorage});new H({storage:localStorage});const V="next-campaign-cache";class B{constructor(){this.listeners=new Map}static getInstance(){return B.instance||(B.instance=new B),B.instance}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}emit(e,t){const i=this.listeners.get(e);i&&i.forEach(e=>{try{e(t)}catch(i){}})}off(e,t){const i=this.listeners.get(e);i&&i.delete(t)}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}}const K=R("CartStore"),W={items:[],subtotal:0,shipping:0,tax:0,total:0,totalQuantity:0,isEmpty:!0,appliedCoupons:[],enrichedItems:[],totals:{subtotal:{value:0,formatted:"$0.00"},shipping:{value:0,formatted:"$0.00"},tax:{value:0,formatted:"$0.00"},discounts:{value:0,formatted:"$0.00"},total:{value:0,formatted:"$0.00"},count:0,isEmpty:!0,savings:{value:0,formatted:"$0.00"},savingsPercentage:{value:0,formatted:"0%"},compareTotal:{value:0,formatted:"$0.00"},hasSavings:!1,totalSavings:{value:0,formatted:"$0.00"},totalSavingsPercentage:{value:0,formatted:"0%"},hasTotalSavings:!1}},Q=E()($(D((e,t)=>({...W,addItem:async i=>{const{useCampaignStore:n}=await Promise.resolve().then(()=>X),a=n.getState().getPackage(i.packageId??0);if(!a)throw new Error(`Package ${i.packageId} not found in campaign data`);e(e=>{const t={id:Date.now(),packageId:i.packageId??0,quantity:i.quantity??1,price:parseFloat(a.price_total),title:i.title??a.name,is_upsell:i.isUpsell??!1,image:i.image??void 0,sku:i.sku??void 0,price_per_unit:a.price,qty:a.qty,price_total:a.price_total,price_retail:a.price_retail,price_retail_total:a.price_retail_total,price_recurring:a.price_recurring,is_recurring:a.is_recurring,interval:a.interval,interval_count:a.interval_count};i.isUpsell&&K.debug("Adding upsell item:",{packageId:t.packageId,isUpsell:i.isUpsell,finalItemIsUpsell:t.is_upsell,itemData:t});const n=e.items.findIndex(e=>e.packageId===t.packageId);let s;return n>=0?(s=[...e.items],s[n].quantity+=t.quantity):s=[...e.items,t],{...e,items:s}}),t().calculateTotals();const s=B.getInstance();s.emit("cart:item-added",{packageId:i.packageId??0,quantity:i.quantity??1}),s.emit("cart:updated",t())},removeItem:async i=>{const n=t().items.find(e=>e.packageId===i);if(e(e=>{const t=e.items.filter(e=>e.packageId!==i);return{...e,items:t}}),t().calculateTotals(),n){const e=B.getInstance();e.emit("cart:item-removed",{packageId:i}),e.emit("cart:updated",t())}},updateQuantity:async(i,n)=>{if(n<=0)return t().removeItem(i);const a=t().items.find(e=>e.packageId===i),s=a?.quantity??0;if(e(e=>{const t=e.items.map(e=>e.packageId===i?{...e,quantity:n}:e);return{...e,items:t}}),t().calculateTotals(),a){const e=B.getInstance();e.emit("cart:quantity-changed",{packageId:i,quantity:n,oldQuantity:s}),e.emit("cart:updated",t())}},swapPackage:async(i,n)=>{e(e=>({...e,swapInProgress:!0}));try{await t().removeItem(i),await t().addItem(n)}finally{e(e=>({...e,swapInProgress:!1}))}},clear:async()=>{e(e=>({...e,items:[]})),t().calculateTotals()},syncWithAPI:async()=>{K.debug("syncWithAPI not yet implemented")},calculateTotals:async()=>{try{const{useCampaignStore:i}=await Promise.resolve().then(()=>X),n=i.getState(),a=t(),s=a.items.reduce((e,t)=>e+t.price*t.quantity,0),r=a.items.reduce((e,t)=>e+t.quantity,0),o=0===a.items.length,l=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e),c=a.items.reduce((e,t)=>{const i=n.getPackage(t.packageId);let a=0;return i?.price_retail_total?a=parseFloat(i.price_retail_total):i?.price_total&&(a=parseFloat(i.price_total)),e+a*t.quantity},0),d=Math.max(0,c-s),u=c>0?d/c*100:0,p=d>0,h=t().calculateShipping(),g=t().calculateTax();let m=0;const f=(a.appliedCoupons||[]).map(e=>{const i=t().calculateDiscountAmount(e.definition);return m+=i,{...e,discount:i}});f.length>0&&e(e=>({...e,appliedCoupons:f}));const y=s+h+g-m,v=d+m,b=c>0?v/c*100:0,x=v>0,w={subtotal:{value:s,formatted:l(s)},shipping:{value:h,formatted:l(h)},tax:{value:g,formatted:l(g)},discounts:{value:m,formatted:l(m)},total:{value:y,formatted:l(y)},count:r,isEmpty:o,savings:{value:d,formatted:l(d)},savingsPercentage:{value:u,formatted:`${Math.round(u)}%`},compareTotal:{value:c,formatted:l(c)},hasSavings:p,totalSavings:{value:v,formatted:l(v)},totalSavingsPercentage:{value:b,formatted:`${Math.round(b)}%`},hasTotalSavings:x};e({subtotal:s,shipping:h,tax:g,total:y,totalQuantity:r,isEmpty:o,totals:w}),await t().calculateEnrichedItems()}catch(i){e({subtotal:0,shipping:0,tax:0,total:0,totalQuantity:0,isEmpty:!0,totals:{subtotal:{value:0,formatted:"$0.00"},shipping:{value:0,formatted:"$0.00"},tax:{value:0,formatted:"$0.00"},discounts:{value:0,formatted:"$0.00"},total:{value:0,formatted:"$0.00"},count:0,isEmpty:!0,savings:{value:0,formatted:"$0.00"},savingsPercentage:{value:0,formatted:"0%"},compareTotal:{value:0,formatted:"$0.00"},hasSavings:!1,totalSavings:{value:0,formatted:"$0.00"},totalSavingsPercentage:{value:0,formatted:"0%"},hasTotalSavings:!1}})}},hasItem:e=>t().items.some(t=>t.packageId===e),getItem:e=>t().items.find(t=>t.packageId===e),getItemQuantity:e=>{const i=t().items.find(t=>t.packageId===e);return i?.quantity??0},calculateShipping:()=>{const e=t();return e.isEmpty||0===e.items.length?0:e.shippingMethod?e.shippingMethod.price:0},calculateTax:()=>0,setShippingMethod:async i=>{try{const{useCampaignStore:n}=await Promise.resolve().then(()=>X),{useCheckoutStore:a}=await Promise.resolve().then(()=>ie),s=n.getState(),r=a.getState(),o=s.data;if(!o?.shipping_methods)throw new Error("No shipping methods available");const l=o.shipping_methods.find(e=>e.ref_id===i);if(!l)throw new Error(`Shipping method ${i} not found`);const c=parseFloat(l.price||"0");e(e=>({...e,shippingMethod:{id:l.ref_id,name:l.code,price:c,code:l.code}})),r.setShippingMethod({id:l.ref_id,name:l.code,price:c,code:l.code}),t().calculateTotals();B.getInstance().emit("shipping:method-changed",{methodId:i,method:l})}catch(n){throw n}},getTotalWeight:()=>t().items.reduce((e,t)=>e+t.quantity,0),getTotalItemCount:()=>t().items.reduce((e,t)=>e+t.quantity,0),calculateEnrichedItems:async()=>{try{const{useCampaignStore:i}=await Promise.resolve().then(()=>X),n=i.getState(),a=t(),s=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e),r=a.items.map(e=>{const t=n.getPackage(e.packageId),i=parseFloat(t?.price||"0"),a=parseFloat(t?.price_retail||t?.price||"0"),r=e.price*e.quantity;let o=0;t?.price_retail_total?o=parseFloat(t.price_retail_total):t?.price_total&&(o=parseFloat(t.price_total));const l=o*e.quantity,c=Math.max(0,a-i),d=Math.max(0,l-r),u=a>i?Math.round(c/a*100):0,p=!0===t?.is_recurring,h=p?parseFloat(t?.price_recurring||"0"):0,g=p?t?.interval_count&&t.interval_count>1?`Every ${t.interval_count} ${t.interval}s`:`Per ${t.interval}`:"One time";return{id:e.id,packageId:e.packageId,quantity:e.quantity,price:{excl_tax:{value:i,formatted:s(i)},incl_tax:{value:i,formatted:s(i)},original:{value:a,formatted:s(a)},savings:{value:c,formatted:s(c)},recurring:{value:h,formatted:s(h)},lineTotal:{value:r,formatted:s(r)},lineCompare:{value:l,formatted:s(l)},lineSavings:{value:d,formatted:s(d)},savingsPct:{value:u,formatted:`${u}%`}},product:{title:e.title||t?.name||"",sku:t?.external_id?.toString()||"",image:e.image||t?.image||""},is_upsell:e.is_upsell??!1,is_recurring:p,interval:t?.interval||void 0,interval_count:t?.interval_count,frequency:g,is_bundle:!1,bundleComponents:void 0,hasSavings:d>0,hasComparePrice:a>i,showCompare:a>i?"show":"hide",showSavings:d>0?"show":"hide",showRecurring:p?"show":"hide"}});e({enrichedItems:r})}catch(i){}},applyCoupon:async i=>{const{useConfigStore:n}=await Promise.resolve().then(()=>le),a=n.getState(),s=t(),r=i.toUpperCase().trim();if((s.appliedCoupons||[]).some(e=>e.code===r))return{success:!1,message:"Coupon already applied"};const o=a.discounts[r];if(!o)return{success:!1,message:"Invalid coupon code"};const l=t().validateCoupon(r);return l.valid?(e(e=>({...e,appliedCoupons:[...e.appliedCoupons,{code:r,discount:0,definition:o}]})),t().calculateTotals(),{success:!0,message:`Coupon ${r} applied successfully`}):{success:!1,message:l.message||"Coupon cannot be applied"}},removeCoupon:i=>{e(e=>({...e,appliedCoupons:(e.appliedCoupons||[]).filter(e=>e.code!==i)})),t().calculateTotals()},getCoupons:()=>t().appliedCoupons||[],validateCoupon:e=>{const i=t(),n=window.nextConfig;if(!n?.discounts)return{valid:!1,message:"No discounts configured"};const a=n.discounts[e];return a?a.minOrderValue&&i.subtotal<a.minOrderValue?{valid:!1,message:`Minimum order value of $${a.minOrderValue} required`}:!a.combinable&&(i.appliedCoupons||[]).length>0?{valid:!1,message:"Cannot combine with other coupons"}:{valid:!0}:{valid:!1,message:"Invalid coupon code"}},calculateDiscountAmount:e=>{const i=t();let n=0;if("order"===e.scope)"percentage"===e.type?(n=i.subtotal*(e.value/100),e.maxDiscount&&(n=Math.min(n,e.maxDiscount))):n=e.value;else if("package"===e.scope&&e.packageIds){const t=i.items.filter(t=>e.packageIds?.includes(t.packageId)).reduce((e,t)=>e+t.price*t.quantity,0);"percentage"===e.type?(n=t*(e.value/100),e.maxDiscount&&(n=Math.min(n,e.maxDiscount))):n=Math.min(e.value,t)}return Math.min(n,i.subtotal)},reset:()=>{e(W)}})),{name:"next-cart-state",storage:{getItem:e=>j.get(e),setItem:(e,t)=>{j.set(e,t)},removeItem:e=>{j.remove(e)}},partialize:e=>({items:e.items,appliedCoupons:e.appliedCoupons,subtotal:e.subtotal,shipping:e.shipping,shippingMethod:e.shippingMethod,tax:e.tax,total:e.total,totalQuantity:e.totalQuantity,isEmpty:e.isEmpty,totals:e.totals,enrichedItems:[]})})),J=3e5,G=R("CampaignStore"),Z={data:null,packages:[],isLoading:!1,error:null},Y=E((e,t)=>({...Z,loadCampaign:async t=>{e({isLoading:!0,error:null});try{const i=j.get(V),n=Date.now();if(i&&i.apiKey===t&&n-i.timestamp<J){G.info("ðŸŽ¯ Using cached campaign data (expires in "+Math.round((J-(n-i.timestamp))/1e3)+" seconds)");const{useConfigStore:t}=await Promise.resolve().then(()=>le);return i.campaign.payment_env_key&&t.getState().setSpreedlyEnvironmentKey(i.campaign.payment_env_key),void e({data:i.campaign,packages:i.campaign.packages,isLoading:!1,error:null})}G.info("ðŸŒ Fetching fresh campaign data from API...");const{ApiClient:a}=await Promise.resolve().then(()=>de),s=new a(t),r=await s.getCampaigns();if(!r)throw new Error("Campaign data not found");const{useConfigStore:o}=await Promise.resolve().then(()=>le);r.payment_env_key&&(o.getState().setSpreedlyEnvironmentKey(r.payment_env_key),G.info("ðŸ’³ Spreedly environment key updated from campaign API: "+r.payment_env_key));const l={campaign:r,timestamp:n,apiKey:t};j.set(V,l),G.info("ðŸ’¾ Campaign data cached for 5 minutes"),e({data:r,packages:r.packages,isLoading:!1,error:null})}catch(i){const t=i instanceof Error?i.message:"Failed to load campaign";throw e({data:null,packages:[],isLoading:!1,error:t}),i}},getPackage:e=>{const{packages:i}=t();return i.find(t=>t.ref_id===e)??null},getProduct:e=>t().getPackage(e),setError:t=>{e({error:t})},reset:()=>{e(Z)},clearCache:()=>{j.remove(V),G.info("ðŸ—‘ï¸ Campaign cache cleared")},getCacheInfo:()=>{const e=j.get(V);if(!e)return{cached:!1};const t=Date.now(),i=J-(t-e.timestamp);return{cached:!0,expiresIn:Math.max(0,Math.round(i/1e3)),apiKey:e.apiKey}}})),X=Object.freeze(Object.defineProperty({__proto__:null,useCampaignStore:Y},Symbol.toStringTag,{value:"Module"})),ee={step:1,isProcessing:!1,errors:{},formData:{},paymentMethod:"credit-card",sameAsShipping:!0,testMode:!1,vouchers:[]},te=E(e=>({...ee,setStep:t=>{e({step:t})},setProcessing:t=>{e({isProcessing:t})},setError:(t,i)=>{e(e=>({errors:{...e.errors,[t]:i}}))},clearError:t=>{e(e=>{const{[t]:i,...n}=e.errors;return{errors:n}})},clearAllErrors:()=>{e({errors:{}})},updateFormData:t=>{e(e=>({formData:{...e.formData,...t}}))},setPaymentToken:t=>{e({paymentToken:t})},setPaymentMethod:t=>{e({paymentMethod:t})},setShippingMethod:t=>{e({shippingMethod:t})},setBillingAddress:t=>{e({billingAddress:t})},setSameAsShipping:t=>{e({sameAsShipping:t})},setTestMode:t=>{e({testMode:t})},addVoucher:t=>{e(e=>({vouchers:[...e.vouchers,t]}))},removeVoucher:t=>{e(e=>({vouchers:e.vouchers.filter(e=>e!==t)}))},reset:()=>{e(ee)}})),ie=Object.freeze(Object.defineProperty({__proto__:null,useCheckoutStore:te},Symbol.toStringTag,{value:"Module"})),ne=R("OrderStore"),ae={order:null,refId:null,orderLoadedAt:null,isLoading:!1,isProcessingUpsell:!1,error:null,upsellError:null,pendingUpsells:[],completedUpsells:[],completedUpsellPages:[],viewedUpsells:[],viewedUpsellPages:[],upsellJourney:[]},se=E()(L($((e,t)=>({...ae,setOrder:t=>{ne.debug("Setting order data:",t),e({order:t,error:null,orderLoadedAt:Date.now()})},setRefId:t=>{ne.debug("Setting ref ID:",t),e({refId:t})},loadOrder:async(i,n)=>{const a=t();if(!a.order||a.refId!==i||t().isOrderExpired())if(a.isLoading)ne.warn("Order loading already in progress");else{ne.info("Loading order:",i),e({isLoading:!0,error:null,refId:i});try{const t=await n.getOrder(i);ne.info("Order loaded successfully:",t);const a=[];t.lines&&Array.isArray(t.lines)&&t.lines.forEach(e=>{if(e.is_upsell&&e.product_sku){const t=e.product_sku.match(/(\d+)/);t?a.push(t[1]):a.push(e.product_sku),ne.debug("Detected upsell line:",{sku:e.product_sku,title:e.product_title,extractedId:t?t[1]:e.product_sku})}}),e({order:t,isLoading:!1,isProcessingUpsell:!1,error:null,orderLoadedAt:Date.now(),completedUpsells:a,upsellJourney:[],viewedUpsells:[],viewedUpsellPages:[]}),ne.debug("Populated completed upsells from order:",a)}catch(s){const t=s instanceof Error?s.message:"Failed to load order";ne.error("Failed to load order:",s),e({isLoading:!1,error:t,order:null})}}else ne.info("Using cached order data:",i)},clearOrder:()=>{ne.debug("Clearing order data"),e({order:null,refId:null,error:null,orderLoadedAt:null})},isOrderExpired:()=>{const e=t();if(!e.orderLoadedAt)return!0;const i=Date.now()-e.orderLoadedAt>9e5;return i&&ne.info("Order data has expired (>15 minutes old)"),i},addUpsell:async(i,n)=>{const a=t();if(!a.refId){const t="No order reference ID available";return ne.error(t),e({upsellError:t}),null}if(a.isProcessingUpsell)return ne.warn("Upsell processing already in progress"),null;ne.info("Adding upsell to order:",a.refId,i),e({isProcessingUpsell:!0,upsellError:null});try{const t=await n.addUpsell(a.refId,i);ne.info("Upsell added successfully:",t);const s=window.location.pathname,r=i.lines.map(e=>e.package_id.toString()),o=r.map(e=>({packageId:e,pagePath:s,action:"accepted",timestamp:Date.now()}));return e({order:t,isProcessingUpsell:!1,upsellError:null,orderLoadedAt:Date.now(),completedUpsells:[...a.completedUpsells,...r],completedUpsellPages:a.completedUpsellPages.includes(s)?a.completedUpsellPages:[...a.completedUpsellPages,s],upsellJourney:[...a.upsellJourney,...o]}),t}catch(s){const t=s instanceof Error?s.message:"Failed to add upsell";return ne.error("Failed to add upsell:",s),e({isProcessingUpsell:!1,upsellError:t}),null}},addPendingUpsell:i=>{const n=t();ne.debug("Adding pending upsell:",i),e({pendingUpsells:[...n.pendingUpsells,i]})},removePendingUpsell:i=>{const n=[...t().pendingUpsells];n.splice(i,1),ne.debug("Removing pending upsell at index:",i),e({pendingUpsells:n})},clearPendingUpsells:()=>{ne.debug("Clearing pending upsells"),e({pendingUpsells:[]})},markUpsellCompleted:i=>{const n=t();n.completedUpsells.includes(i)||(ne.debug("Marking upsell as completed:",i),e({completedUpsells:[...n.completedUpsells,i]}))},markUpsellViewed:i=>{const n=t();if(!n.viewedUpsells.includes(i)){ne.debug("Marking upsell as viewed:",i);const t={packageId:i,action:"viewed",timestamp:Date.now()};e({viewedUpsells:[...n.viewedUpsells,i],upsellJourney:[...n.upsellJourney,t]})}},markUpsellPageViewed:i=>{const n=t();if(!n.viewedUpsellPages.includes(i)){ne.debug("Marking upsell page as viewed:",i);const t={pagePath:i,action:"viewed",timestamp:Date.now()};e({viewedUpsellPages:[...n.viewedUpsellPages,i],upsellJourney:[...n.upsellJourney,t],isProcessingUpsell:!1,upsellError:null})}},markUpsellSkipped:(i,n)=>{const a=t();ne.debug("Marking upsell as skipped:",{packageId:i,pagePath:n});const s={action:"skipped",timestamp:Date.now()};void 0!==i&&(s.packageId=i),void 0!==n&&(s.pagePath=n),e({upsellJourney:[...a.upsellJourney,s],isProcessingUpsell:!1,upsellError:null})},setError:t=>e({error:t}),setUpsellError:t=>e({upsellError:t}),clearErrors:()=>e({error:null,upsellError:null}),setLoading:t=>e({isLoading:t}),setProcessingUpsell:t=>e({isProcessingUpsell:t}),hasUpsellPageBeenCompleted:e=>t().completedUpsellPages.includes(e),hasUpsellBeenViewed:e=>t().viewedUpsells.includes(e),hasUpsellPageBeenViewed:e=>t().viewedUpsellPages.includes(e),getUpsellJourney:()=>t().upsellJourney,getOrderTotal:()=>{const e=t();return e.order?parseFloat(e.order.total_incl_tax||"0"):0},canAddUpsells:()=>{const e=t();return!(!e.order||!e.order.supports_post_purchase_upsells||e.isProcessingUpsell)},reset:()=>{ne.debug("Resetting order store"),e(ae)}}),{name:"next-order",storage:{getItem:e=>{const t=sessionStorage.getItem(e);return t?JSON.parse(t):null},setItem:(e,t)=>{sessionStorage.setItem(e,JSON.stringify(t))},removeItem:e=>{sessionStorage.removeItem(e)}}}),{name:"order-store"})),re={apiKey:"",campaignId:"",debug:!1,pageType:"product",paymentConfig:{},googleMapsConfig:{},addressConfig:{},autoInit:!0,rateLimit:4,cacheTtl:300,retryAttempts:3,timeout:1e4,testMode:!1,maxRetries:3,requestTimeout:3e4,enableAnalytics:!0,enableDebugMode:!1,environment:"production",discounts:{},tracking:"auto"},oe=E((e,t)=>({...re,loadFromMeta:()=>{if("undefined"==typeof document)return;const t={},i=document.querySelector('meta[name="next-api-key"]');i&&(t.apiKey=i.getAttribute("content")??"");const n=document.querySelector('meta[name="next-campaign-id"]');n&&(t.campaignId=n.getAttribute("content")??"");const a=document.querySelector('meta[name="next-debug"]');a&&(t.debug="true"===a.getAttribute("content"));const s=document.querySelector('meta[name="next-page-type"]');s&&(t.pageType=s.getAttribute("content"));const r=document.querySelector('meta[name="next-spreedly-key"]')||document.querySelector('meta[name="next-payment-env-key"]');if(r){const e=r.getAttribute("content");e&&(t.spreedlyEnvironmentKey=e)}Object.keys(t).length>0&&e(t)},loadFromWindow:()=>{if("undefined"==typeof window)return;const t=window.nextConfig;if(!t||"object"!=typeof t)return;const i={};"string"==typeof t.apiKey&&(i.apiKey=t.apiKey),"string"==typeof t.campaignId&&(i.campaignId=t.campaignId),"boolean"==typeof t.debug&&(i.debug=t.debug),"string"==typeof t.pageType&&(i.pageType=t.pageType),"string"==typeof t.spreedlyEnvironmentKey&&(i.spreedlyEnvironmentKey=t.spreedlyEnvironmentKey),t.payment&&"object"==typeof t.payment&&(i.paymentConfig=t.payment),t.paymentConfig&&"object"==typeof t.paymentConfig&&(i.paymentConfig=t.paymentConfig),t.googleMaps&&"object"==typeof t.googleMaps&&(i.googleMapsConfig=t.googleMaps),t.addressConfig&&"object"==typeof t.addressConfig&&(i.addressConfig=t.addressConfig),t.discounts&&"object"==typeof t.discounts&&(i.discounts=t.discounts),"string"==typeof t.tracking&&(i.tracking=t.tracking),t.analytics&&"object"==typeof t.analytics&&(i.analytics=t.analytics),t.utmTransfer&&"object"==typeof t.utmTransfer&&(i.utmTransfer=t.utmTransfer),Object.keys(i).length>0&&e(i)},updateConfig:t=>{e(e=>({...e,...t}))},setSpreedlyEnvironmentKey:t=>{e({spreedlyEnvironmentKey:t})},reset:()=>{e(re)}})),le=Object.freeze(Object.defineProperty({__proto__:null,configStore:oe,useConfigStore:oe},Symbol.toStringTag,{value:"Module"}));class ce{constructor(e){this.baseURL="https://campaigns.apps.29next.com",this.apiKey=e,this.logger=R("ApiClient")}async getCampaigns(){return this.request("/api/v1/campaigns/")}async createCart(e){return this.request("/api/v1/carts/",{method:"POST",body:JSON.stringify(e)})}async createOrder(e){return this.request("/api/v1/orders/",{method:"POST",body:JSON.stringify(e)})}async getOrder(e){return this.request(`/api/v1/orders/${e}/`)}async addUpsell(e,t){return this.request(`/api/v1/orders/${e}/upsells/`,{method:"POST",body:JSON.stringify(t)})}async createProspectCart(e){return this.request("/api/v1/prospect-carts/",{method:"POST",body:JSON.stringify(e)})}async updateProspectCart(e,t){return this.request(`/api/v1/prospect-carts/${e}/`,{method:"PATCH",body:JSON.stringify(t)})}async getProspectCart(e){return this.request(`/api/v1/prospect-carts/${e}/`)}async abandonProspectCart(e){return this.request(`/api/v1/prospect-carts/${e}/abandon/`,{method:"POST"})}async convertProspectCart(e){return this.request(`/api/v1/prospect-carts/${e}/convert/`,{method:"POST"})}async request(e,t){const i=t?.method||"GET",n=`${this.baseURL}${e}`,a={Authorization:this.apiKey,"Content-Type":"application/json",...t?.headers};this.logger.debug(`API Request: ${i} ${n}`);try{const e=await fetch(n,{...t,headers:a});if(429===e.status){const t=`Rate limited. Retry after ${e.headers.get("Retry-After")} seconds`;throw this.logger.warn(t),new Error(t)}if(!e.ok){const t=`API Error: ${e.status} ${e.statusText}`;let i={};try{const t=await e.text();t&&(i=JSON.parse(t))}catch(s){this.logger.warn("Failed to parse error response body")}this.logger.error(t,i);const n=new Error(t);throw n.status=e.status,n.statusText=e.statusText,n.responseData=i,n}const i=await e.json();return this.logger.debug(`API Response: ${e.status}`,i),i}catch(r){throw r instanceof Error?this.logger.error("API request failed:",r.message):this.logger.error("API request failed:",String(r)),r}}setApiKey(e){this.apiKey=e}getApiKey(){return this.apiKey}}const de=Object.freeze(Object.defineProperty({__proto__:null,ApiClient:ce},Symbol.toStringTag,{value:"Module"}));class ue{constructor(){this.callbacks=new Map,this.exitIntentEnhancer=null,this.fomoEnhancer=null,this.logger=new N("NextCommerce"),this.eventBus=B.getInstance()}static getInstance(){return ue.instance||(ue.instance=new ue),ue.instance}hasItemInCart(e){const t=Q.getState();return!!e.packageId&&t.items.some(t=>t.packageId===e.packageId)}async addItem(e){const t=Q.getState(),i=e.quantity??1;e.packageId&&await t.addItem({packageId:e.packageId,quantity:i,isUpsell:!1})}async removeItem(e){const t=Q.getState();e.packageId&&await t.removeItem(e.packageId)}async updateQuantity(e){const t=Q.getState();e.packageId&&await t.updateQuantity(e.packageId,e.quantity)}async clearCart(){const e=Q.getState();await e.clear()}getCartData(){const e=Q.getState(),t=Y.getState();return{cartLines:e.enrichedItems,cartTotals:e.totals,campaignData:t.data,appliedCoupons:e.getCoupons()}}getCartTotals(){return Q.getState().totals}getCartCount(){return Q.getState().totalQuantity}getCampaignData(){return Y.getState().data}getPackage(e){return Y.getState().getPackage(e)}on(e,t){this.eventBus.on(e,t)}off(e,t){this.eventBus.off(e,t)}registerCallback(e,t){this.callbacks.has(e)||this.callbacks.set(e,new Set),this.callbacks.get(e).add(t)}unregisterCallback(e,t){this.callbacks.get(e)?.delete(t)}triggerCallback(e,t){this.callbacks.get(e)?.forEach(i=>{try{i(t)}catch(n){this.logger.error(`Callback error for ${e}:`,n)}})}async trackViewItemList(e,t,i){queueMicrotask(async()=>{try{const{nextAnalytics:t}=await Promise.resolve().then(()=>ut);t.trackViewItemList(e,i)}catch(t){this.logger.debug("Analytics tracking failed (non-critical):",t)}})}async trackViewItem(e){queueMicrotask(async()=>{try{const{nextAnalytics:t}=await Promise.resolve().then(()=>ut);t.trackViewItem(e)}catch(t){this.logger.debug("Analytics tracking failed (non-critical):",t)}})}async trackAddToCart(e,t){queueMicrotask(async()=>{try{const{nextAnalytics:i}=await Promise.resolve().then(()=>ut),n={id:String(e),packageId:e,quantity:t||1};i.trackAddToCart(n)}catch(i){this.logger.debug("Analytics tracking failed (non-critical):",i)}})}async trackRemoveFromCart(e,t){queueMicrotask(async()=>{try{const{nextAnalytics:i,EcommerceEvents:n}=await Promise.resolve().then(()=>ut);i.track(n.createRemoveFromCartEvent({packageId:e,quantity:t||1}))}catch(i){this.logger.debug("Analytics tracking failed (non-critical):",i)}})}async trackBeginCheckout(){queueMicrotask(async()=>{try{const{nextAnalytics:e}=await Promise.resolve().then(()=>ut);e.trackBeginCheckout()}catch(e){this.logger.debug("Analytics tracking failed (non-critical):",e)}})}async trackPurchase(e){queueMicrotask(async()=>{try{const{nextAnalytics:t}=await Promise.resolve().then(()=>ut);t.trackPurchase(e)}catch(t){this.logger.debug("Analytics tracking failed (non-critical):",t)}})}async trackCustomEvent(e,t){queueMicrotask(async()=>{try{const{nextAnalytics:i}=await Promise.resolve().then(()=>ut);i.track({event:e,...t})}catch(i){this.logger.debug("Analytics tracking failed (non-critical):",i)}})}async trackSignUp(e){queueMicrotask(async()=>{try{const{nextAnalytics:t}=await Promise.resolve().then(()=>ut);t.trackSignUp(e)}catch(t){this.logger.debug("Analytics tracking failed (non-critical):",t)}})}async trackLogin(e){queueMicrotask(async()=>{try{const{nextAnalytics:t}=await Promise.resolve().then(()=>ut);t.trackLogin(e)}catch(t){this.logger.debug("Analytics tracking failed (non-critical):",t)}})}async setDebugMode(e){queueMicrotask(async()=>{try{const{nextAnalytics:t}=await Promise.resolve().then(()=>ut);t.setDebugMode(e)}catch(t){this.logger.debug("Analytics debug mode failed (non-critical):",t)}})}async invalidateAnalyticsContext(){queueMicrotask(async()=>{try{const{nextAnalytics:e}=await Promise.resolve().then(()=>ut);e.invalidateContext()}catch(e){this.logger.debug("Analytics context invalidation failed (non-critical):",e)}})}getShippingMethods(){const e=Y.getState();return e.data?.shipping_methods||[]}getSelectedShippingMethod(){return te.getState().shippingMethod||null}async setShippingMethod(e){const t=Q.getState();await t.setShippingMethod(e)}formatPrice(e,t){const i=Y.getState(),n=t??i.data?.currency??"USD";return new Intl.NumberFormat("en-US",{style:"currency",currency:n}).format(e)}validateCheckout(){const e=[];return 0===Q.getState().items.length&&e.push("Cart is empty"),{valid:0===e.length,errors:e}}async applyCoupon(e){const t=Q.getState();return await t.applyCoupon(e)}removeCoupon(e){Q.getState().removeCoupon(e)}getCoupons(){return Q.getState().getCoupons()}validateCoupon(e){return Q.getState().validateCoupon(e)}calculateDiscountAmount(e){return Q.getState().calculateDiscountAmount(e)}async exitIntent(e){try{if(!this.exitIntentEnhancer){const{ExitIntentEnhancer:e}=await Promise.resolve().then(()=>ht);this.exitIntentEnhancer=new e,await this.exitIntentEnhancer.initialize()}this.exitIntentEnhancer.setup(e),this.logger.debug("Exit intent configured with image:",e.image)}catch(t){throw this.logger.error("Failed to setup exit intent:",t),t}}disableExitIntent(){this.exitIntentEnhancer&&this.exitIntentEnhancer.disable()}async fomo(e){try{if(!this.fomoEnhancer){const{FomoPopupEnhancer:e}=await Promise.resolve().then(()=>gt);this.fomoEnhancer=new e,await this.fomoEnhancer.initialize()}this.fomoEnhancer.setup(e),this.fomoEnhancer.start(),this.logger.debug("FOMO popup started")}catch(t){throw this.logger.error("Failed to start FOMO popup:",t),t}}stopFomo(){this.fomoEnhancer&&this.fomoEnhancer.stop()}async addUpsell(e){const t=se.getState(),i=oe.getState();if(!t.order)throw new Error("No order found. Upsells can only be added after order completion.");if(!t.canAddUpsells())throw new Error("Order does not support post-purchase upsells or is currently processing.");const n=new ce(i.apiKey);let a=[];if(e.items&&e.items.length>0)a=e.items.map(e=>({package_id:e.packageId,quantity:e.quantity||1}));else{if(!e.packageId)throw new Error("Either packageId or items array must be provided");a=[{package_id:e.packageId,quantity:e.quantity||1}]}const s={lines:a};this.logger.info("Adding upsell(s) via SDK:",s);try{const e=t.order?.lines?.map(e=>e.id)||[],i=await t.addUpsell(s,n);if(!i)throw new Error("Failed to add upsell - no updated order returned");const r=i.lines?.filter(t=>t.is_upsell&&!e.includes(t.id))||[],o=r.reduce((e,t)=>e+(t.price_incl_tax?parseFloat(t.price_incl_tax):0),0);return a.forEach((e,t)=>{const n=r[t],a=n?.price_incl_tax?parseFloat(n.price_incl_tax):0;this.eventBus.emit("upsell:added",{packageId:e.package_id,quantity:e.quantity,order:i,value:a})}),{order:i,addedLines:r,totalValue:o}}catch(r){throw this.logger.error("Failed to add upsell(s) via SDK:",r),r}}canAddUpsells(){return se.getState().canAddUpsells()}getCompletedUpsells(){return se.getState().completedUpsells}isUpsellAlreadyAdded(e){const t=se.getState();if(t.completedUpsells.includes(e.toString()))return!0;return t.upsellJourney.some(t=>t.packageId===e.toString()&&"accepted"===t.action)}}const pe={affiliate:"",funnel:"",gclid:"",utm_source:"",utm_medium:"",utm_campaign:"",utm_content:"",utm_term:"",subaffiliate1:"",subaffiliate2:"",subaffiliate3:"",subaffiliate4:"",subaffiliate5:"",metadata:{landing_page:"",referrer:"",device:"",device_type:"desktop",domain:"",timestamp:Date.now()},first_visit_timestamp:Date.now(),current_visit_timestamp:Date.now()},he=E()($((e,t)=>({...pe,initialize:async()=>{try{const{AttributionCollector:t}=await Promise.resolve().then(()=>ft),i=new t,n=await i.collect();e(e=>({...e,...n,first_visit_timestamp:e.first_visit_timestamp||n.first_visit_timestamp}))}catch(t){}},updateAttribution:t=>{e(e=>({...e,...t,metadata:t.metadata?{...e.metadata,...t.metadata}:e.metadata,current_visit_timestamp:Date.now()}))},setFunnelName:i=>{if(!i)return;if(t().funnel)return;const n=localStorage.getItem("next_funnel_name")||sessionStorage.getItem("next_funnel_name");if(n)e({funnel:n});else{e({funnel:i});try{sessionStorage.setItem("next_funnel_name",i),localStorage.setItem("next_funnel_name",i)}catch(a){}}},setEverflowClickId:t=>{t&&(localStorage.setItem("evclid",t),sessionStorage.setItem("evclid",t),e(e=>({...e,metadata:{...e.metadata,everflow_transaction_id:t}})))},getAttributionForApi:()=>{const e=t(),i={};return void 0!==e.affiliate&&(i.affiliate=e.affiliate),void 0!==e.funnel&&(i.funnel=e.funnel),void 0!==e.gclid&&(i.gclid=e.gclid),void 0!==e.metadata&&(i.metadata=e.metadata),void 0!==e.utm_source&&(i.utm_source=e.utm_source),void 0!==e.utm_medium&&(i.utm_medium=e.utm_medium),void 0!==e.utm_campaign&&(i.utm_campaign=e.utm_campaign),void 0!==e.utm_content&&(i.utm_content=e.utm_content),void 0!==e.utm_term&&(i.utm_term=e.utm_term),void 0!==e.subaffiliate1&&(i.subaffiliate1=e.subaffiliate1),void 0!==e.subaffiliate2&&(i.subaffiliate2=e.subaffiliate2),void 0!==e.subaffiliate3&&(i.subaffiliate3=e.subaffiliate3),void 0!==e.subaffiliate4&&(i.subaffiliate4=e.subaffiliate4),void 0!==e.subaffiliate5&&(i.subaffiliate5=e.subaffiliate5),e.metadata.everflow_transaction_id&&(i.everflow_transaction_id=e.metadata.everflow_transaction_id),i},debug:()=>{const e=t();for(let t=1;t<=5;t++){}return e.metadata.conversion_timestamp,"Attribution debug info logged to console."},reset:()=>{e(pe)},clearPersistedFunnel:()=>{try{localStorage.removeItem("next_funnel_name"),sessionStorage.removeItem("next_funnel_name"),e({funnel:""})}catch(t){}}}),{name:"next-attribution",storage:{getItem:e=>{const t=sessionStorage.getItem(e);return t?JSON.parse(t):null},setItem:(e,t)=>{sessionStorage.setItem(e,JSON.stringify(t))},removeItem:e=>{sessionStorage.removeItem(e)}}})),ge=class{static parseDataAttribute(e,t){const i=e.getAttribute(t);return{raw:i,parsed:this.parseValue(i),type:this.inferType(i)}}static parseValue(e){if(null===e||""===e)return null;if(e.startsWith("{")||e.startsWith("["))try{return JSON.parse(e)}catch{}if("true"===e)return!0;if("false"===e)return!1;if(/^-?\d+(\.\d+)?$/.test(e)){const t=parseFloat(e);return Number.isNaN(t)?e:t}return e}static inferType(e){return null===e||""===e?"string":"true"===e||"false"===e?"boolean":/^-?\d+(\.\d+)?$/.test(e)?"number":e.startsWith("{")&&e.endsWith("}")?"object":e.startsWith("[")&&e.endsWith("]")?"array":"string"}static getEnhancerTypes(e){const t=[];if(e.hasAttribute("data-next-display")&&t.push("display"),e.hasAttribute("data-next-toggle")&&t.push("toggle"),e.hasAttribute("data-next-action")&&t.push("action"),e.hasAttribute("data-next-timer")&&t.push("timer"),(e.hasAttribute("data-next-show")||e.hasAttribute("data-next-hide"))&&t.push("conditional"),e instanceof HTMLFormElement&&e.hasAttribute("data-next-checkout")&&t.push("checkout"),e.hasAttribute("data-next-express-checkout")){const i=e.getAttribute("data-next-express-checkout");"container"===i?t.push("express-checkout-container"):"paypal"!==i&&"apple_pay"!==i&&"google_pay"!==i||t.push("express-checkout")}if(e.hasAttribute("data-next-cart-items")&&t.push("cart-items"),e.hasAttribute("data-next-order-items")&&t.push("order-items"),e.hasAttribute("data-next-quantity")){const i=e.getAttribute("data-next-quantity");i&&["increase","decrease","set"].includes(i)&&t.push("quantity")}if(e.hasAttribute("data-next-remove-item")&&t.push("remove-item"),(e.hasAttribute("data-next-selector")||e.hasAttribute("data-next-cart-selector")||e.hasAttribute("data-next-selector-id")&&!e.hasAttribute("data-next-action"))&&t.push("selector"),(e.hasAttribute("data-next-upsell")||e.hasAttribute("data-next-upsell-selector")||e.hasAttribute("data-next-upsell-select"))&&t.push("upsell"),e.hasAttribute("data-next-coupon")){const i=e.getAttribute("data-next-coupon");"input"!==i&&""!==i||t.push("coupon")}return e.hasAttribute("data-next-accordion")&&t.push("accordion"),e.hasAttribute("data-next-tooltip")&&t.push("tooltip"),e.hasAttribute("data-next-component")&&"scroll-hint"===e.getAttribute("data-next-component")&&t.push("scroll-hint"),[...new Set(t)]}static parseDisplayPath(e){const t=e.split(".");return 1===t.length?{object:"cart",property:t[0]??""}:{object:t[0]??"cart",property:t.slice(1).join(".")}}static parseCondition(e){try{if(e.includes("(")&&e.includes(")")){const t=e.match(/^(\w+)\.(\w+)\(([^)]*)\)$/);if(t)return{type:"function",object:t[1]??"",method:t[2]??"",args:t[3]?t[3].split(",").map(e=>this.parseValue(e.trim())):[]}}if(e.includes(" ")){const t=[">=","<=",">","<","===","==","!==","!="];for(const i of t)if(e.includes(i)){const[t,n]=e.split(i).map(e=>e.trim());return{type:"comparison",left:this.parseDisplayPath(t??""),operator:i,right:this.parseValue(n??"")}}}return{type:"property",...this.parseDisplayPath(e)}}catch(t){return this.logger.error("Failed to parse condition:",e,t),{type:"property",object:"cart",property:"isEmpty"}}}};ge.logger=R("AttributeParser");let me=ge;class fe{constructor(e={}){this.handlers=new Set,this.isObserving=!1,this.pendingChanges=new Set,this.logger=R("DOMObserver"),this.config={childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-next-display","data-next-toggle","data-next-timer","data-next-show","data-next-hide","data-next-checkout","data-next-validate","data-next-express-checkout"],...e},this.observer=new MutationObserver(this.handleMutations.bind(this))}addHandler(e){this.handlers.add(e),this.logger.debug(`Added handler, total: ${this.handlers.size}`)}removeHandler(e){this.handlers.delete(e),this.logger.debug(`Removed handler, total: ${this.handlers.size}`)}start(e=document.body){if(this.isObserving)this.logger.warn("Already observing, ignoring start request");else try{this.observer.observe(e,this.config),this.isObserving=!0,this.logger.debug("Started observing DOM changes",{target:e.tagName})}catch(t){this.logger.error("Failed to start DOM observation:",t)}}stop(){this.isObserving&&(this.observer.disconnect(),this.isObserving=!1,this.clearThrottle(),this.pendingChanges.clear(),this.logger.debug("Stopped observing DOM changes"))}pause(){this.isObserving&&(this.observer.disconnect(),this.isObserving=!1,this.logger.debug("Paused DOM observation"))}resume(e=document.body){this.isObserving||(this.start(e),this.logger.debug("Resumed DOM observation"))}isActive(){return this.isObserving}handleMutations(e){const t=e.filter(e=>this.isRelevantMutation(e));if(0!==t.length){this.logger.debug(`Processing ${t.length} relevant mutations`);for(const e of t)this.processMutation(e);this.throttleNotifications()}}isRelevantMutation(e){switch(e.type){case"childList":return this.hasRelevantNodes(e.addedNodes)||this.hasRelevantNodes(e.removedNodes);case"attributes":const t=e.attributeName;return null!==t&&!0===this.config.attributeFilter?.includes(t);default:return!1}}hasRelevantNodes(e){for(const t of e)if(t instanceof HTMLElement&&(this.hasRelevantAttributes(t)||this.hasRelevantDescendants(t)))return!0;return!1}hasRelevantAttributes(e){return!0===this.config.attributeFilter?.some(t=>e.hasAttribute(t))}hasRelevantDescendants(e){if(!this.config.attributeFilter)return!1;const t=this.config.attributeFilter.map(e=>`[${e}]`).join(",");return null!==e.querySelector(t)}processMutation(e){switch(e.type){case"childList":this.processChildListMutation(e);break;case"attributes":this.processAttributeMutation(e)}}processChildListMutation(e){for(const t of e.addedNodes)if(t instanceof HTMLElement&&(this.addElementForProcessing(t,"added"),this.config.attributeFilter)){const e=this.config.attributeFilter.map(e=>`[${e}]`).join(",");t.querySelectorAll(e).forEach(e=>{e instanceof HTMLElement&&this.addElementForProcessing(e,"added")})}for(const t of e.removedNodes)t instanceof HTMLElement&&this.addElementForProcessing(t,"removed")}processAttributeMutation(e){if(e.target instanceof HTMLElement&&e.attributeName){const t=e.target,i=e.attributeName,n=e.oldValue,a=t.getAttribute(i);this.notifyHandlers({type:"attributeChanged",element:t,attributeName:i,oldValue:n||void 0,newValue:a||void 0})}}addElementForProcessing(e,t){this.hasRelevantAttributes(e)&&(this.pendingChanges.add(e),"removed"===t&&this.notifyHandlers({type:"removed",element:e,attributeName:void 0,oldValue:void 0,newValue:void 0}))}throttleNotifications(){this.throttleTimeout||(this.throttleTimeout=window.setTimeout(()=>{this.processePendingChanges(),this.throttleTimeout=void 0},16))}processePendingChanges(){if(0!==this.pendingChanges.size){this.logger.debug(`Processing ${this.pendingChanges.size} pending changes`);for(const e of this.pendingChanges)this.notifyHandlers({type:"added",element:e,attributeName:void 0,oldValue:void 0,newValue:void 0});this.pendingChanges.clear()}}notifyHandlers(e){for(const i of this.handlers)try{i(e)}catch(t){this.logger.error("Handler error:",t)}}clearThrottle(){this.throttleTimeout&&(clearTimeout(this.throttleTimeout),this.throttleTimeout=void 0)}destroy(){this.stop(),this.handlers.clear(),this.logger.debug("DOM observer destroyed")}getConfig(){return{...this.config}}updateConfig(e){const t=this.isObserving;let i;t&&(i=document.body,this.stop()),this.config={...this.config,...e},t&&i&&this.start(i),this.logger.debug("Updated configuration",this.config)}}class ye{constructor(){this.enhancers=new WeakMap,this.enhancerCount=0,this.isScanning=!1,this.scanQueue=new Set,this.enhancerStats=new Map,this.isDebugMode=!1,this.processQueueDebounced=this.debounce(()=>{this.processQueue()},50),this.logger=R("AttributeScanner"),this.domObserver=new fe,this.domObserver.addHandler(this.handleDOMChange.bind(this)),this.isDebugMode="true"===new URLSearchParams(location.search).get("debug"),this.isDebugMode}async scanAndEnhance(e){if(this.isScanning)this.logger.warn("Already scanning, queuing request");else{this.isScanning=!0,this.logger.debug("Scanning for data attributes...",{root:e.tagName});try{const t=["[data-next-display]","[data-next-toggle]","[data-next-action]","[data-next-timer]","[data-next-show]","[data-next-hide]","form[data-next-checkout]","[data-next-express-checkout]","[data-next-timer-display]","[data-next-timer-expired]","[data-next-cart-items]","[data-next-order-items]",'[data-next-quantity="increase"]','[data-next-quantity="decrease"]','[data-next-quantity="set"]',"[data-next-remove-item]","[data-next-selector]","[data-next-selector-id]","[data-next-cart-selector]","[data-next-upsell]","[data-next-upsell-selector]","[data-next-upsell-select]",'[data-next-coupon="input"]','[data-next-coupon=""]',"[data-next-accordion]","[data-next-tooltip]",'[data-next-express-checkout="container"]','[data-next-component="scroll-hint"]'].join(", "),i=e.querySelectorAll(t);this.logger.debug(`Found ${i.length} elements with data attributes`);let n=0;const a=[],s=10;for(let e=0;e<i.length;e+=s){const t=Array.from(i).slice(e,e+s);for(const e of t)e instanceof HTMLElement&&a.push(this.enhanceElement(e).then(()=>{n++}));await Promise.all(a.splice(0,s)),e+s<i.length&&await new Promise(e=>setTimeout(e,0))}await Promise.all(a),this.logger.debug(`Enhanced ${n} elements successfully`),this.isDebugMode&&this.enhancerStats.size>0&&this.showPerformanceReport(),document.documentElement.classList.add("next-display-ready"),this.logger.debug("Added next-display-ready class to HTML element"),window.dispatchEvent(new CustomEvent("next:display-ready",{detail:{enhancedCount:n,root:e.tagName}})),this.startObserving(e)}catch(t){this.logger.error("Error during scan and enhance:",t)}finally{this.isScanning=!1}}}async enhanceElement(e){if(this.enhancers.has(e))return void this.logger.debug("Element already enhanced, skipping",e);const t=e.closest("[data-next-cart-items]");if(t&&t!==e)return void this.logger.debug("Skipping element inside cart items template",e);const i=e.getAttribute("data-package-id");if(i&&i.includes("{")&&i.includes("}"))this.logger.debug("Skipping element with template variable",e,i);else try{const t=me.getEnhancerTypes(e);if(0===t.length)return void this.logger.debug("No enhancer types found for element",e);const i=[];for(const a of t){const t=await this.createEnhancer(a,e);if(t){i.push(t);try{if(this.isDebugMode){const i=performance.now();await t.initialize();const n=performance.now()-i;this.updateEnhancerStats(a,n),this.logger.debug(`Initialized ${a} enhancer for element`,e)}else await t.initialize(),this.logger.debug(`Initialized ${a} enhancer for element`,e)}catch(n){this.logger.error(`Failed to initialize ${a} enhancer:`,n,e),t.destroy()}}}i.length>0&&(this.enhancers.set(e,i),this.enhancerCount+=i.length,this.logger.debug(`Enhanced element with ${i.length} enhancer(s)`,{element:e.tagName,types:t,attributes:Array.from(e.attributes).map(e=>e.name)}))}catch(a){this.logger.error("Failed to enhance element:",a,e)}}async createEnhancer(e,t){try{switch(e){case"display":const i=t.getAttribute("data-next-display")||"",n=me.parseDisplayPath(i);if(this.logger.debug(`Creating display enhancer for path: "${i}"`,{parsed:n,element:t.tagName,elementHtml:t.outerHTML.substring(0,200)+"..."}),"cart"===n.object){this.logger.debug("Using CartDisplayEnhancer");const{CartDisplayEnhancer:e}=await Promise.resolve().then(()=>At);return new e(t)}if("selection"===n.object){this.logger.debug("Using SelectionDisplayEnhancer");const{SelectionDisplayEnhancer:e}=await Promise.resolve().then(()=>Tt);return new e(t)}if("package"===n.object||"campaign"===n.object){this.logger.debug("Using ProductDisplayEnhancer");const{ProductDisplayEnhancer:e}=await Promise.resolve().then(()=>Ft);return new e(t)}if("order"===n.object){this.logger.debug("Using OrderDisplayEnhancer");const{OrderDisplayEnhancer:e}=await Promise.resolve().then(()=>$t);return new e(t)}if("shipping"===n.object){this.logger.debug("Using ShippingDisplayEnhancer");const{ShippingDisplayEnhancer:e}=await Promise.resolve().then(()=>qt);return new e(t)}{let e=t.parentElement,i=!1;for(;e&&!i;)(e.hasAttribute("data-next-package-id")||e.hasAttribute("data-next-package")||e.hasAttribute("data-package-id"))&&(i=!0),e=e.parentElement;if(i){this.logger.debug("Using ProductDisplayEnhancer (fallback with package context)");const{ProductDisplayEnhancer:e}=await Promise.resolve().then(()=>Ft);return new e(t)}{this.logger.debug("Using CartDisplayEnhancer (fallback without package context)");const{CartDisplayEnhancer:e}=await Promise.resolve().then(()=>At);return new e(t)}}case"toggle":const{CartToggleEnhancer:a}=await Promise.resolve().then(()=>Ot);return new a(t);case"action":const s=t.getAttribute("data-next-action");switch(s){case"add-to-cart":const{AddToCartEnhancer:e}=await Promise.resolve().then(()=>zt);return new e(t);case"accept-upsell":const{AcceptUpsellEnhancer:i}=await Promise.resolve().then(()=>jt);return new i(t);default:return this.logger.warn(`Unknown action type: ${s}`),null}case"selector":const{PackageSelectorEnhancer:r}=await Promise.resolve().then(()=>Qt);return new r(t);case"timer":const{TimerEnhancer:o}=await Promise.resolve().then(()=>Jt);return new o(t);case"conditional":const{ConditionalDisplayEnhancer:l}=await Promise.resolve().then(()=>Gt);return new l(t);case"checkout":const{CheckoutFormEnhancer:c}=await Promise.resolve().then(()=>xi);return new c(t);case"express-checkout":return this.logger.debug("Skipping individual express checkout button - managed by container"),null;case"express-checkout-container":const{ExpressCheckoutContainerEnhancer:d}=await Promise.resolve().then(()=>wi);return new d(t);case"cart-items":const{CartItemListEnhancer:u}=await Promise.resolve().then(()=>_i);return new u(t);case"order-items":const{OrderItemListEnhancer:p}=await Promise.resolve().then(()=>ki);return new p(t);case"quantity":const{QuantityControlEnhancer:h}=await Promise.resolve().then(()=>Ei);return new h(t);case"remove-item":const{RemoveItemEnhancer:g}=await Promise.resolve().then(()=>Ii);return new g(t);case"upsell":const{UpsellEnhancer:m}=await Promise.resolve().then(()=>Li);return new m(t);case"coupon":const{CouponEnhancer:f}=await Promise.resolve().then(()=>Ti);return new f(t);case"accordion":const{AccordionEnhancer:y}=await Promise.resolve().then(()=>$i);return new y(t);case"tooltip":const{TooltipEnhancer:v}=await Promise.resolve().then(()=>ra);return new v(t);case"scroll-hint":const{ScrollHintEnhancer:b}=await Promise.resolve().then(()=>oa);return new b(t);default:return this.logger.warn(`Unknown enhancer type: ${e}`),null}}catch(i){return this.logger.error(`Failed to create enhancer of type ${e}:`,i),null}}startObserving(e){this.domObserver.isActive()||(this.domObserver.start(e),this.logger.debug("Started DOM observation"))}handleDOMChange(e){switch(e.type){case"added":this.queueElementForEnhancement(e.element);break;case"removed":this.cleanupElement(e.element);break;case"attributeChanged":e.attributeName?.startsWith("data-next-")&&(this.logger.debug("Data attribute changed, re-enhancing element",{element:e.element.tagName,attribute:e.attributeName,oldValue:e.oldValue,newValue:e.newValue}),this.cleanupElement(e.element),this.queueElementForEnhancement(e.element))}}queueElementForEnhancement(e){this.scanQueue.add(e),this.processQueueDebounced()}async processQueue(){if(0===this.scanQueue.size)return;const e=Array.from(this.scanQueue);this.scanQueue.clear(),this.logger.debug(`Processing ${e.length} queued elements`);for(const i of e)try{await this.enhanceElement(i)}catch(t){this.logger.error("Failed to enhance queued element:",t,i)}}debounce(e,t){let i;return function(...n){clearTimeout(i),i=window.setTimeout(()=>e.apply(this,n),t)}}cleanupElement(e){const t=this.enhancers.get(e);t&&(t.forEach(e=>e.destroy()),this.enhancerCount-=t.length,this.enhancers.delete(e))}destroy(){this.domObserver.destroy(),this.scanQueue.clear(),this.enhancerCount=0,this.logger.debug("AttributeScanner destroyed")}pause(){this.domObserver.pause(),this.logger.debug("AttributeScanner paused")}resume(e=document.body){this.domObserver.resume(e),this.logger.debug("AttributeScanner resumed")}updateEnhancerStats(e,t){const i=this.enhancerStats.get(e)||{totalTime:0,count:0};i.totalTime+=t,i.count+=1,this.enhancerStats.set(e,i)}showPerformanceReport(){const e=Array.from(this.enhancerStats.entries()).map(([e,t])=>({Enhancer:e,"Total Time (ms)":t.totalTime.toFixed(2),"Average Time (ms)":(t.totalTime/t.count).toFixed(2),Count:t.count,Impact:t.totalTime>50?"ðŸ”´ High":t.totalTime>20?"ðŸŸ¡ Medium":"ðŸŸ¢ Low"})).sort((e,t)=>parseFloat(t["Total Time (ms)"])-parseFloat(e["Total Time (ms)"])).slice(0,3);e.length>0&&e.forEach((e,t)=>{});Array.from(this.enhancerStats.values()).reduce((e,t)=>e+t.totalTime,0),Array.from(this.enhancerStats.values()).reduce((e,t)=>e+t.count,0)}getStats(){const e={enhancedElements:this.enhancerCount,queuedElements:this.scanQueue.size,isObserving:this.domObserver.isActive(),isScanning:this.isScanning};if(this.isDebugMode&&this.enhancerStats.size>0){e.performanceStats={};for(const[t,i]of this.enhancerStats.entries())e.performanceStats[t]={totalTime:i.totalTime,averageTime:i.totalTime/i.count,count:i.count}}return e}}class ve{constructor(){this.isTestMode=!1,this.konamiSequence=["ArrowUp","ArrowUp","ArrowDown","ArrowDown","ArrowLeft","ArrowRight","ArrowLeft","ArrowRight","KeyB","KeyA"],this.keySequence=[],this.testCards=[{number:"4111111111111111",name:"Visa Test Card",cvv:"123",expiry:"12/25",type:"visa"},{number:"5555555555554444",name:"Mastercard Test Card",cvv:"123",expiry:"12/25",type:"mastercard"},{number:"378282246310005",name:"American Express Test Card",cvv:"1234",expiry:"12/25",type:"amex"},{number:"6011111111111117",name:"Discover Test Card",cvv:"123",expiry:"12/25",type:"discover"}],this.initializeKonamiCode(),this.checkUrlTestMode()}static getInstance(){return ve.instance||(ve.instance=new ve),ve.instance}initializeKonamiCode(){document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(e){if(this.keySequence.push(e.code),this.keySequence.length>this.konamiSequence.length&&this.keySequence.shift(),this.keySequence.length===this.konamiSequence.length){this.keySequence.every((e,t)=>e===this.konamiSequence[t])&&(this.activateKonamiCode(),this.keySequence=[])}}checkUrlTestMode(){const e=new URLSearchParams(window.location.search),t="true"===e.get("debugger"),i="true"===e.get("test");(t||i)&&(this.isTestMode=!0)}activateKonamiCode(){this.isTestMode=!0,this.showKonamiMessage();const e=new URL(window.location.href);e.searchParams.set("test","true"),window.history.replaceState({},"",e.toString()),this.konamiCallback&&setTimeout(()=>{this.konamiCallback?.()},2e3),document.dispatchEvent(new CustomEvent("next:test-mode-activated",{detail:{method:"konami"}}))}showKonamiMessage(){const e=document.createElement("div");e.className="konami-activation-message",e.innerHTML='\n      <div class="konami-content">\n        <h3>ðŸŽ® Konami Code Activated!</h3>\n        <p>Test mode enabled. You can now use test payment methods.</p>\n        <div class="konami-progress">\n          <div class="konami-progress-bar"></div>\n        </div>\n      </div>\n    ',e.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      padding: 2rem;\n      border-radius: 12px;\n      box-shadow: 0 20px 40px rgba(0,0,0,0.3);\n      z-index: 10000;\n      font-family: Arial, sans-serif;\n      text-align: center;\n      min-width: 300px;\n    ";const t=e.querySelector(".konami-progress-bar");t&&(t.style.cssText="\n        width: 100%;\n        height: 4px;\n        background: rgba(255,255,255,0.3);\n        border-radius: 2px;\n        overflow: hidden;\n        margin-top: 1rem;\n      ",t.innerHTML='<div style="width: 0; height: 100%; background: white; transition: width 2s ease-in-out;"></div>'),document.body.appendChild(e),setTimeout(()=>{const e=t?.querySelector("div");e&&(e.style.width="100%")},100),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},2500)}setTestMode(e){if(this.isTestMode=e,e){const e=new URL(window.location.href);e.searchParams.set("test","true"),window.history.replaceState({},"",e.toString())}}isActive(){return this.isTestMode}onKonamiCode(e){this.konamiCallback=e}getTestCards(){return[...this.testCards]}getTestCard(e){if(e){const t=this.testCards.find(t=>t.type===e);if(t)return t}const t=this.testCards[0];if(!t)throw new Error("No test cards available");return t}fillTestCardData(e="visa"){if(!this.isTestMode)return;const t=this.getTestCard(e),i=document.querySelector('input[data-spreedly="number"], input[name*="card_number"], input[name*="cardNumber"]');i&&(i.value=t.number,i.dispatchEvent(new Event("input",{bubbles:!0})));const n=document.querySelector('input[data-spreedly="cvv"], input[name*="cvv"], input[name*="security"]');n&&(n.value=t.cvv,n.dispatchEvent(new Event("input",{bubbles:!0})));const a=document.querySelector('input[name*="expiry"], input[name*="exp"]');if(a)a.value=t.expiry,a.dispatchEvent(new Event("input",{bubbles:!0}));else{const e=document.querySelector('select[name*="month"], input[name*="month"]'),i=document.querySelector('select[name*="year"], input[name*="year"]');if(e&&i){const[n,a]=t.expiry.split("/");n&&a&&(e.value=n,i.value=`20${a}`,e.dispatchEvent(new Event("change",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0})))}}const s=document.querySelector('input[name*="cardholder"], input[name*="card_name"]');s&&(s.value="Test Cardholder",s.dispatchEvent(new Event("input",{bubbles:!0})))}showTestCardMenu(){if(!this.isTestMode)return;const e=document.createElement("div");e.className="test-card-menu",e.innerHTML=`\n      <div class="test-card-content">\n        <h4>Test Card Numbers</h4>\n        <div class="test-card-options">\n          ${this.testCards.map(e=>`\n            <button class="test-card-option" data-card-type="${e.type}">\n              <div class="card-name">${e.name}</div>\n              <div class="card-number">${e.number}</div>\n            </button>\n          `).join("")}\n        </div>\n        <button class="test-card-close">Close</button>\n      </div>\n    `,e.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: white;\n      border: 1px solid #ddd;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      z-index: 10000;\n      font-family: Arial, sans-serif;\n      min-width: 250px;\n    ",e.addEventListener("click",t=>{const i=t.target;if(i.classList.contains("test-card-option")||i.closest(".test-card-option")){const t=i.closest(".test-card-option").getAttribute("data-card-type");t&&(this.fillTestCardData(t),e.remove())}else i.classList.contains("test-card-close")&&e.remove()}),document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.remove()},3e4)}}const be=ve.getInstance(),xe=class{static async initialize(){if(this.initialized)this.logger.warn("SDK already initialized");else try{this.logger.info("Initializing 29Next Campaign Cart SDK v2..."),await this.waitForDOM(),await this.loadConfiguration(),await this.initializeAttribution(),await this.loadCampaignData(),await this.initializeAnalytics(),this.initializeErrorHandler(),await this.checkAndLoadOrder(),await this.scanAndEnhanceDOM(),this.setupReadyCallbacks(),await this.initializeDebugMode(),this.initialized=!0,this.retryAttempts=0,this.logger.info("SDK initialization complete âœ…"),this.emitInitializedEvent()}catch(e){if(this.logger.error("SDK initialization failed:",e),this.retryAttempts<this.maxRetries)return this.retryAttempts++,this.logger.warn(`Retrying initialization (attempt ${this.retryAttempts}/${this.maxRetries})...`),await new Promise(e=>setTimeout(e,1e3*this.retryAttempts)),this.initialize();throw e}}static async loadConfiguration(){const e=oe.getState(),t=new URLSearchParams(window.location.search),i="true"===t.get("debugger"),n=t.get("forcePackageId");e.loadFromMeta(),e.loadFromWindow(),i&&e.updateConfig({debug:!0}),n&&(this.logger.info("forcePackageId parameter detected:",n),window._nextForcePackageId=n),this.logger.debug("Configuration loaded:",e)}static async loadCampaignData(){const e=oe.getState(),t=Y.getState();if(!e.apiKey)throw new Error("API key not found. Please set next-api-key meta tag or window.nextConfig.apiKey");await t.loadCampaign(e.apiKey),this.logger.debug("Campaign data loaded"),await this.processForcePackageId()}static async processForcePackageId(){const e=window._nextForcePackageId;if(e)try{this.logger.info("Processing forcePackageId parameter:",e);const t=Q.getState(),i=Y.getState();await t.clear(),this.logger.debug("Cart cleared for forcePackageId");const n=e.split(",").map(e=>{const[t,i]=e.trim().split(":"),n=parseInt(t||"",10),a=i?parseInt(i,10):1;if(isNaN(n)||n<=0)throw new Error(`Invalid package ID: ${t}`);if(isNaN(a)||a<=0)throw new Error(`Invalid quantity: ${i}`);return{packageId:n,quantity:a}});this.logger.debug("Parsed package specifications:",n);for(const e of n){i.getPackage(e.packageId)?(await t.addItem({packageId:e.packageId,quantity:e.quantity,isUpsell:!1}),this.logger.debug(`Added package ${e.packageId} with quantity ${e.quantity} to cart`)):this.logger.warn(`Package ${e.packageId} not found in campaign data, skipping`)}this.logger.info(`Successfully processed forcePackageId: added ${n.length} package(s) to cart`),delete window._nextForcePackageId}catch(t){this.logger.error("Error processing forcePackageId parameter:",t)}}static async initializeAttribution(){try{this.logger.info("Initializing attribution...");const e=he.getState(),t=oe.getState();if(await e.initialize(),this.setupAttributionListeners(),t.utmTransfer?.enabled){const{UtmTransfer:e}=await Promise.resolve().then(()=>ca);new e(t.utmTransfer).init(),this.logger.debug("UTM transfer initialized")}this.logger.debug("Attribution initialized")}catch(e){this.logger.error("Attribution initialization failed:",e)}}static setupAttributionListeners(){const e=B.getInstance(),t=he.getState();e.on("campaign:loaded",e=>{e?.name&&!t.funnel&&(t.setFunnelName(e.name),this.logger.debug("Set funnel name from campaign:",e.name))}),e.on("cart:updated",()=>{t.updateAttribution({metadata:{...t.metadata,conversion_timestamp:Date.now()}}),this.logger.debug("Updated attribution with conversion timestamp")}),window.addEventListener("popstate",()=>{t.updateAttribution({metadata:{...t.metadata,landing_page:window.location.href}})})}static async initializeAnalytics(){setTimeout(async()=>{try{this.logger.info("Initializing analytics v2 (lazy)...");const{nextAnalytics:e}=await Promise.resolve().then(()=>ut);await e.initialize(),this.logger.debug("Analytics v2 initialized successfully (lazy)")}catch(e){this.logger.warn("Analytics v2 initialization failed (non-critical):",e)}},0)}static initializeErrorHandler(){try{Promise.resolve().then(()=>ua).then(({errorHandler:e})=>{e.initialize(),this.logger.debug("Error handler initialized")})}catch(e){this.logger.warn("Error handler initialization failed:",e)}}static async checkAndLoadOrder(){const e=new URLSearchParams(window.location.search).get("ref_id");if(e){this.logger.info("Page loaded with ref_id parameter, auto-loading order:",e);try{const t=oe.getState(),i=se.getState(),n=new ce(t.apiKey);await i.loadOrder(e,n),this.logger.info("Order loaded successfully:",i.order),i.order&&this.logger.info("Order supports upsells:",i.order.supports_post_purchase_upsells)}catch(t){this.logger.error("Failed to auto-load order:",t)}}}static async scanAndEnhanceDOM(){this.attributeScanner&&this.attributeScanner.destroy(),this.attributeScanner=new ye,await this.attributeScanner.scanAndEnhance(document.body);const e=this.attributeScanner.getStats();this.logger.info("DOM scanning and enhancement complete",e)}static setupReadyCallbacks(){const e=ue.getInstance();if("undefined"!=typeof window){if(Array.isArray(window.nextReady)){window.nextReady.forEach(t=>{try{t(e)}catch(i){this.logger.error("Ready callback error:",i)}})}window.next=e,window.nextReady={push:t=>{try{t(e)}catch(i){this.logger.error("Ready callback error:",i)}}},this.logger.debug("nextReady callback system and window.next API initialized")}}static async initializeDebugMode(){if(oe.getState().debug){this.logger.info("Debug mode enabled - initializing debug utilities"),N.setLogLevel(q.DEBUG),this.logger.info("Logger level set to DEBUG");const{debugOverlay:e}=await Promise.resolve().then(()=>Ea);e.initialize(),this.setupGlobalDebugUtils(),this.logger.info("Debug utilities initialized âœ…")}}static setupGlobalDebugUtils(){"undefined"!=typeof window&&(window.nextDebug={overlay:()=>Promise.resolve().then(()=>Ea).then(e=>e.debugOverlay),testMode:be,stores:{cart:Q,campaign:Y,config:oe,checkout:te,order:se,attribution:he},sdk:ue.getInstance(),reinitialize:()=>this.reinitialize(),getStats:()=>this.getInitializationStats(),addToCart:(e,t=1)=>{const i=Q.getState(),n=Y.getState().getPackage(e);n&&i.addItem({packageId:e,quantity:t,price:parseFloat(n.price),title:n.name,isUpsell:!1})},removeFromCart:e=>{Q.getState().removeItem(e)},updateQuantity:(e,t)=>{Q.getState().updateQuantity(e,t)},loadCampaign:()=>{const e=oe.getState();return Y.getState().loadCampaign(e.apiKey)},clearCampaignCache:()=>{Y.getState().clearCache()},getCacheInfo:()=>Y.getState().getCacheInfo(),inspectPackage:e=>{Y.getState().getPackage(e)},testShippingMethod:async e=>{try{const t=Q.getState();await t.setShippingMethod(e);t.shippingMethod;document.dispatchEvent(new CustomEvent("debug:update-content"))}catch(t){}},sortPackages:e=>{document.dispatchEvent(new CustomEvent("debug:update-content"))},analytics:{getStatus:async()=>{const{nextAnalytics:e}=await Promise.resolve().then(()=>ut);return e.getStatus()},getProviders:async()=>{const{nextAnalytics:e}=await Promise.resolve().then(()=>ut);return e.getStatus().providers},track:async(e,t)=>{const{nextAnalytics:i}=await Promise.resolve().then(()=>ut);return i.track({event:e,...t})},setDebugMode:async e=>{const{nextAnalytics:t}=await Promise.resolve().then(()=>ut);return t.setDebugMode(e)},invalidateContext:async()=>{const{nextAnalytics:e}=await Promise.resolve().then(()=>ut);return e.invalidateContext()}},attribution:{debug:()=>he.getState().debug(),get:()=>he.getState().getAttributionForApi(),setFunnel:e=>he.getState().setFunnelName(e),setEvclid:e=>he.getState().setEverflowClickId(e),clearFunnel:()=>he.getState().clearPersistedFunnel(),getFunnel:()=>{const e=he.getState(),t=localStorage.getItem("next_funnel_name")||sessionStorage.getItem("next_funnel_name");return e.funnel||t||"(not set)"}},highlightElement:e=>{this.logger.debug(`ðŸŽ¯ Highlighting element: ${e}`)},addTestItems:()=>{const e=Q.getState();[2,7,9].forEach(t=>{e.addItem({packageId:t,quantity:1,price:19.99,title:`Test Package ${t}`,isUpsell:!1})})},accordion:{open:e=>{document.dispatchEvent(new CustomEvent("next:accordion-open",{detail:{id:e}}))},close:e=>{document.dispatchEvent(new CustomEvent("next:accordion-close",{detail:{id:e}}))},toggle:e=>{document.dispatchEvent(new CustomEvent("next:accordion-toggle",{detail:{id:e}}))}},order:{getJourney:()=>se.getState().getUpsellJourney(),isExpired:()=>se.getState().isOrderExpired(),clearCache:()=>{se.getState().clearOrder()},getStats:()=>{const e=se.getState();return{hasOrder:!!e.order,refId:e.refId,orderAge:e.orderLoadedAt?`${Math.floor((Date.now()-e.orderLoadedAt)/1e3/60)} minutes`:"N/A",viewedUpsells:e.viewedUpsells,viewedUpsellPages:e.viewedUpsellPages,completedUpsells:e.completedUpsells,journeyLength:e.upsellJourney.length}}}})}static isInitialized(){return this.initialized}static async reinitialize(){this.logger.info("Reinitializing SDK..."),this.attributeScanner&&(this.attributeScanner.destroy(),this.attributeScanner=null),this.initialized=!1,this.retryAttempts=0,await this.initialize()}static async waitForDOM(){if("loading"===document.readyState)return new Promise(e=>{const t=()=>{document.removeEventListener("DOMContentLoaded",t),document.removeEventListener("readystatechange",t),e()};document.addEventListener("DOMContentLoaded",t),document.addEventListener("readystatechange",t)})}static emitInitializedEvent(){if("undefined"!=typeof window){const e=new CustomEvent("next:initialized",{detail:{version:"0.2.0",timestamp:Date.now(),stats:this.attributeScanner?.getStats()}});window.dispatchEvent(e)}}static getAttributeScanner(){return this.attributeScanner}static getInitializationStats(){return{initialized:this.initialized,retryAttempts:this.retryAttempts,...this.attributeScanner&&{scannerStats:this.attributeScanner.getStats()}}}};xe.logger=R("SDKInitializer"),xe.initialized=!1,xe.attributeScanner=null,xe.retryAttempts=0,xe.maxRetries=3;let we=xe;"undefined"!=typeof window&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{we.initialize()}):we.initialize(),window.addEventListener("next:ready",()=>{"requestIdleCallback"in window?(requestIdleCallback(()=>{Promise.resolve().then(()=>At),Promise.resolve().then(()=>Ot),Promise.resolve().then(()=>Qt),Promise.resolve().then(()=>Ft),Promise.resolve().then(()=>Tt),Promise.resolve().then(()=>Jt)},{timeout:5e3}),requestIdleCallback(()=>{Promise.resolve().then(()=>xi),Promise.resolve().then(()=>wi),Promise.resolve().then(()=>$t),Promise.resolve().then(()=>Li),Promise.resolve().then(()=>ft),Promise.resolve().then(()=>_i),Promise.resolve().then(()=>Ei)},{timeout:5e3}),requestIdleCallback(()=>{Promise.resolve().then(()=>$i),Promise.resolve().then(()=>Ti),Promise.resolve().then(()=>ht)},{timeout:5e3})):setTimeout(()=>{Promise.resolve().then(()=>At),Promise.resolve().then(()=>Ft),Promise.resolve().then(()=>Ia)},1e3)}));const Se={debug:{enabled:!1,verbose:!1,logEvents:!0,logErrors:!0,persistInLocalStorage:!0},providers:[],enrichContext:!0,sessionTimeout:18e5,eventValidation:!0},_e={required:["event"],eventSpecific:{purchase:["ecommerce.transaction_id","ecommerce.value","ecommerce.items"],add_to_cart:["ecommerce.items"],remove_from_cart:["ecommerce.items"],view_item:["ecommerce.items"],view_item_list:["ecommerce.items"],begin_checkout:["ecommerce.value"],add_payment_info:["ecommerce.value"],add_shipping_info:["ecommerce.value"]},fieldTypes:{event:"string",event_id:"string",event_category:"string",event_label:"string",event_value:"number","ecommerce.value":"number","ecommerce.tax":"number","ecommerce.shipping":"number","ecommerce.discount":"number"}},ke="nextDataLayer_debugMode",Ce="nextDataLayer_sessionId",Ee="nextDataLayer_sessionStart",Ie="nextDataLayer_userProperties",Pe=R("PendingEventsHandler"),Ae="next_v2_pending_events";class Le{constructor(){}static getInstance(){return Le.instance||(Le.instance=new Le),Le.instance}queueEvent(e){try{const t=this.getPendingEvents(),i={event:e,timestamp:Date.now(),id:`${e.event}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};t.push(i),sessionStorage.setItem(Ae,JSON.stringify(t)),Pe.info(`Event queued for after redirect: ${e.event} (${t.length} total queued)`)}catch(t){Pe.error("Failed to queue event:",t)}}getPendingEvents(){try{const e=sessionStorage.getItem(Ae);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return Pe.error("Failed to get pending events:",e),[]}}processPendingEvents(){const e=this.getPendingEvents();if(0===e.length)return void Pe.debug("No pending analytics events to process");Pe.info(`Processing ${e.length} pending analytics events`);const t=[];for(const n of e)try{if(Date.now()-n.timestamp>3e5){Pe.warn("Skipping stale event:",n.event.event),t.push(n.id);continue}Me.push(n.event),t.push(n.id),Pe.debug("Processed pending event:",n.event.event)}catch(i){Pe.error("Failed to process pending event:",n.event.event,i)}if(t.length>0){const i=e.filter(e=>!t.includes(e.id));0===i.length?sessionStorage.removeItem(Ae):sessionStorage.setItem(Ae,JSON.stringify(i)),Pe.debug("Removed processed events:",t.length)}}clearPendingEvents(){try{sessionStorage.removeItem(Ae),Pe.debug("Cleared all pending events")}catch(e){Pe.error("Failed to clear pending events:",e)}}reset(){this.clearPendingEvents(),Pe.debug("PendingEventsHandler reset")}initialize(){Pe.debug("PendingEventsHandler initialized")}}const Te=Le.getInstance();class De{constructor(e){this.sequenceNumber=0,this.debugMode=!1,this.context={},this.config={...Se,...e},this.initializeDataLayer(),this.sessionId=this.getOrCreateSessionId(),this.loadDebugMode(),this.enrichContext()}getContext(){return this.context}static getInstance(e){return De.instance||(De.instance=new De(e)),De.instance}initializeDataLayer(){"undefined"!=typeof window&&(window.NextDataLayer||(window.NextDataLayer=[]),this.config.transformFn&&(window.NextDataLayerTransformFn=this.config.transformFn))}push(e){try{if(this.config.eventValidation&&!this.validateEvent(e))return;const t=this.enrichEvent(e);let i=t;if(window.NextDataLayerTransformFn){const n=window.NextDataLayerTransformFn(t);if(!n)return void this.debug("Event filtered out by transform function",e);i=n}const n=i._willRedirect;if(this.debug(`Event ${i.event} has _willRedirect flag:`,n),delete i._willRedirect,n)return Te.queueEvent(i),void this.debug(`Event queued for after redirect: ${i.event}`,i);window.NextDataLayer.push(i),this.debug("Event pushed to data layer",i),this.notifyProviders(i)}catch(t){this.error("Error pushing event to data layer",t,e)}}setDebugMode(e,t){if(this.debugMode=e,this.config.debug&&(this.config.debug={...this.config.debug,enabled:e,...t}),this.config.debug?.persistInLocalStorage)try{localStorage.setItem(ke,JSON.stringify({enabled:e,options:t}))}catch(i){}this.debug("Debug mode "+(e?"enabled":"disabled"))}isDebugMode(){return this.debugMode}invalidateContext(){this.context={},this.enrichContext(),this.debug("Context invalidated and re-enriched")}setUserProperties(e){try{localStorage.setItem(Ie,JSON.stringify(e)),this.debug("User properties updated",e)}catch(t){this.error("Failed to save user properties",t)}}getUserProperties(){try{const e=localStorage.getItem(Ie);return e?JSON.parse(e):null}catch(e){return this.error("Failed to load user properties",e),null}}clear(){window.NextDataLayer=[],this.sequenceNumber=0,this.context={},this.enrichContext(),this.debug("Data layer cleared")}validateEvent(e){for(const i of _e.required)if(!this.getNestedValue(e,i))return this.error(`Missing required field: ${i}`,null,e),!1;const t=_e.eventSpecific[e.event];if(t)for(const i of t)if(!this.getNestedValue(e,i))return this.error(`Missing required field for ${e.event}: ${i}`,null,e),!1;for(const[i,n]of Object.entries(_e.fieldTypes)){const t=this.getNestedValue(e,i);if(void 0!==t&&typeof t!==n)return this.error(`Invalid type for field ${i}: expected ${n}, got ${typeof t}`,null,e),!1}return!0}enrichEvent(e){const t={...e,_metadata:{pushed_at:Date.now(),session_id:this.sessionId,sequence_number:++this.sequenceNumber,debug_mode:this.debugMode,source:"NextDataLayer",version:"0.2.0"}};if(this.config.enrichContext){t.event_time=t.event_time||(new Date).toISOString(),t.event_id=t.event_id||this.generateEventId();const e=this.getUserProperties();e&&(t.user_properties={...e,...t.user_properties})}return t}enrichContext(){"undefined"!=typeof window&&(this.context={page_location:window.location.href,page_title:document.title,page_referrer:document.referrer,user_agent:navigator.userAgent,screen_resolution:`${screen.width}x${screen.height}`,viewport_size:`${window.innerWidth}x${window.innerHeight}`,session_id:this.sessionId,timestamp:Date.now()})}getOrCreateSessionId(){try{const e=localStorage.getItem(Ce),t=localStorage.getItem(Ee),i=Date.now(),n=this.config.sessionTimeout||18e5;if(e&&t&&i-parseInt(t)<n)return localStorage.setItem(Ee,i.toString()),e;const a=this.generateSessionId();return localStorage.setItem(Ce,a),localStorage.setItem(Ee,i.toString()),a}catch(e){return this.generateSessionId()}}loadDebugMode(){if(this.config.debug?.persistInLocalStorage)try{const e=localStorage.getItem(ke);if(e){const{enabled:t,options:i}=JSON.parse(e);this.debugMode=t,i&&this.config.debug&&(this.config.debug={...this.config.debug,...i})}}catch(e){}}notifyProviders(e){if(this.config.providers)for(const i of this.config.providers)try{"function"==typeof i.isEnabled?i.isEnabled()&&i.trackEvent&&i.trackEvent(e):!1!==i.enabled&&i.trackEvent&&i.trackEvent(e)}catch(t){this.error(`Error in provider ${i.name||"unknown"}`,t,e)}}generateEventId(){return`${this.sessionId}_${this.sequenceNumber}_${Date.now()}`}generateSessionId(){return`${Date.now()}_${Math.random().toString(36).substring(2,11)}`}getNestedValue(e,t){return t.split(".").reduce((e,t)=>e?.[t],e)}debug(e,t){if(!this.debugMode||!this.config.debug?.logEvents)return;this.config.debug}error(e,t,i){if(!this.config.debug?.logErrors)return}initialize(){this.initializeDataLayer(),this.debug("Data layer initialized")}addProvider(e){this.config.providers||(this.config.providers=[]),this.config.providers.push(e),this.debug(`Provider ${e.name||"unknown"} added`)}setTransformFunction(e){window.NextDataLayerTransformFn=e,this.debug("Transform function set")}getEventCount(){return window.NextDataLayer?.length||0}formatEcommerceEvent(e,t){return{event:e,event_time:(new Date).toISOString(),data:t.data||t,ecommerce:t.ecommerce||t}}formatUserDataEvent(e){return{event:"dl_user_data",event_time:(new Date).toISOString(),user_properties:e.user_properties||e,cart_total:e.cart_total,ecommerce:e.ecommerce}}}const Me=De.getInstance();class Fe{constructor(e){this.enabled=!0,this.name=e}setEnabled(e){this.enabled=e}isEnabled(){return this.enabled}trackEvent(e){this.sendEvent(e)}transformEvent(e){return{event:e.event,...e.data}}debug(e,t){"undefined"!=typeof window&&window.localStorage?.getItem("analytics_debug")}isBrowser(){return"undefined"!=typeof window}getNestedProperty(e,t){return t.split(".").reduce((e,t)=>e?.[t],e)}formatCurrency(e){return e.toFixed(2)}extractEcommerceData(e){const t=e.ecommerce||e.data||{};return{currency:t.currency||"USD",value:t.value||t.total||0,items:t.items||t.products||[],transaction_id:t.transaction_id||t.order_id,coupon:t.coupon||t.discount_code,shipping:t.shipping||0,tax:t.tax||0}}}class $e extends Fe{constructor(){super("GTM")}trackEvent(e){this.sendEvent(e)}sendEvent(e){if(!this.enabled||!this.isBrowser())return;window.dataLayer=window.dataLayer||[];const t=this.transformToGTMFormat(e);this.isEcommerceEvent(e.event)&&window.dataLayer.push({ecommerce:null}),window.dataLayer.push(t),this.debug("Event sent to GTM",t)}transformToGTMFormat(e){const t={event:e.event,event_timestamp:e.timestamp,event_id:e.id};return this.isEcommerceEvent(e.event)?{...t,ecommerce:this.buildEcommerceObject(e)}:{...t,...e.data}}buildEcommerceObject(e){const t=this.extractEcommerceData(e),i=this.getEcommerceEventType(e.event),n={currency:t.currency,value:parseFloat(this.formatCurrency(t.value))};return t.items.length>0&&(n.items=this.formatItems(t.items)),"purchase"===i&&(n.transaction_id=t.transaction_id,n.affiliation=e.data?.affiliation||"Online Store",n.tax=t.tax,n.shipping=t.shipping,t.coupon&&(n.coupon=t.coupon)),"add_to_cart"===i&&e.data?.cart_id&&(n.cart_id=e.data.cart_id),"view_item_list"===i&&e.data?.item_list_name&&(n.item_list_name=e.data.item_list_name,n.item_list_id=e.data.item_list_id),n}formatItems(e){return e.map((e,t)=>({item_id:e.item_id||e.id||e.product_id||e.sku,item_name:e.item_name||e.name||e.title,affiliation:e.affiliation||"Online Store",coupon:e.coupon||void 0,discount:e.discount||0,index:e.index||t,item_brand:e.item_brand||e.brand,item_category:e.item_category||e.category,item_category2:e.item_category2||e.category2,item_category3:e.item_category3||e.category3,item_category4:e.item_category4||e.category4,item_category5:e.item_category5||e.category5,item_list_id:e.item_list_id||e.list_id,item_list_name:e.item_list_name||e.list_name,item_variant:e.item_variant||e.variant,location_id:e.location_id,price:parseFloat(this.formatCurrency(e.price||0)),quantity:e.quantity||1}))}isEcommerceEvent(e){return["dl_add_to_cart","dl_remove_from_cart","dl_view_cart","dl_begin_checkout","dl_add_payment_info","dl_add_shipping_info","dl_purchase","dl_view_item","dl_view_item_list","dl_select_item","dl_select_promotion","dl_view_promotion","add_to_cart","remove_from_cart","view_cart","begin_checkout","add_payment_info","add_shipping_info","purchase","view_item","view_item_list","select_item","select_promotion","view_promotion"].includes(e)}getEcommerceEventType(e){return e.replace(/^dl_/,"")}}class qe extends Fe{constructor(e){super("Facebook"),this.blockedEvents=[],this.eventMapping={dl_page_view:"PageView",dl_view_item:"ViewContent",dl_add_to_cart:"AddToCart",dl_remove_from_cart:"RemoveFromCart",dl_begin_checkout:"InitiateCheckout",dl_add_payment_info:"AddPaymentInfo",dl_purchase:"Purchase",dl_search:"Search",dl_add_to_wishlist:"AddToWishlist",dl_sign_up:"CompleteRegistration",dl_login:"Login",dl_subscribe:"Subscribe",dl_start_trial:"StartTrial",dl_view_cart:"ViewCart",dl_viewed_upsell:"ViewedUpsell",dl_accepted_upsell:"AcceptedUpsell",dl_skipped_upsell:"SkippedUpsell",page_view:"PageView",view_item:"ViewContent",add_to_cart:"AddToCart",remove_from_cart:"RemoveFromCart",begin_checkout:"InitiateCheckout",add_payment_info:"AddPaymentInfo",purchase:"Purchase",search:"Search",add_to_wishlist:"AddToWishlist",sign_up:"CompleteRegistration",login:"Login",subscribe:"Subscribe",start_trial:"StartTrial",view_cart:"ViewCart"},e?.blockedEvents&&(this.blockedEvents=e.blockedEvents)}trackEvent(e){this.sendEvent(e)}isFbqLoaded(){return this.isBrowser()&&"function"==typeof window.fbq}sendEvent(e){this.enabled?this.blockedEvents.includes(e.event)?this.debug(`Event ${e.event} is blocked for Facebook`):this.isFbqLoaded()?this.sendEventInternal(e):this.waitForFbq().then(()=>{this.sendEventInternal(e)}).catch(()=>{this.debug("Facebook Pixel failed to load, skipping event:",e.event)}):this.debug("Facebook adapter disabled")}async waitForFbq(e=5e3){const t=Date.now();return new Promise((i,n)=>{const a=setInterval(()=>{this.isFbqLoaded()?(clearInterval(a),i()):Date.now()-t>e&&(clearInterval(a),n(new Error("Facebook Pixel load timeout")))},100)})}sendEventInternal(e){const t=this.mapEventName(e.event);if(!t)return void this.debug(`No Facebook mapping for event: ${e.event}`);const i=this.transformParameters(e,t);try{window.fbq&&(window.fbq("track",t,i),this.debug(`Event sent to Facebook: ${t}`,i))}catch(n){}}mapEventName(e){return this.eventMapping[e]||null}transformParameters(e,t){switch(e.data?.value&&parseFloat(this.formatCurrency(e.data.value)),e.data?.currency&&e.data.currency,t){case"ViewContent":return this.buildViewContentParams(e);case"AddToCart":case"RemoveFromCart":return this.buildAddToCartParams(e);case"InitiateCheckout":return this.buildCheckoutParams(e);case"Purchase":return this.buildPurchaseParams(e);case"Search":return this.buildSearchParams(e);case"CompleteRegistration":return this.buildRegistrationParams(e);case"ViewedUpsell":case"AcceptedUpsell":case"SkippedUpsell":return this.buildUpsellParams(e,t);default:return this.buildGenericParams(e)}}buildViewContentParams(e){const t=e.data||{},i=t.items||t.products||[],n={content_type:"product",currency:t.currency||"USD",value:t.value||0};return i.length>0&&(n.content_ids=i.map(e=>e.item_id||e.id||e.product_id||e.sku||e.external_id),n.contents=i.map(e=>({id:e.item_id||e.id||e.product_id||e.sku||e.external_id,quantity:e.quantity||1,item_price:e.price||e.item_price||0})),n.content_name=i[0].item_name||i[0].name||i[0].title,n.content_category=i[0].item_category||i[0].category||"uncategorized"),n}buildAddToCartParams(e){const t=e.data||{},i=t.items||t.products||[],n={content_type:"product",currency:t.currency||"USD",value:t.value||0};if(i.length>0){n.content_ids=i.map(e=>e.item_id||e.id||e.product_id||e.sku||e.external_id);const e=i.map(e=>e.item_name||e.name||e.title).filter(Boolean);e.length>0&&(n.content_name=e.join(", "));const t=i[0].item_category||i[0].category;t&&(n.content_category=t);const a=i.reduce((e,t)=>e+(t.quantity||1),0);n.num_items=a,n.contents=i.map(e=>({id:e.item_id||e.id||e.product_id||e.sku||e.external_id,quantity:e.quantity||1,item_price:e.price||e.item_price||0,name:e.item_name||e.name,category:e.item_category||e.category||"uncategorized"}))}return n}buildCheckoutParams(e){const t=e.data||{},i=t.items||t.products||[],n={content_type:"product",currency:t.currency||"USD",value:t.value||t.total||0,num_items:i.length};return i.length>0&&(n.content_ids=i.map(e=>e.item_id||e.id||e.product_id||e.sku||e.external_id),n.contents=i.map(e=>({id:e.item_id||e.id||e.product_id||e.sku||e.external_id,quantity:e.quantity||1,item_price:e.price||e.item_price||0}))),(t.coupon||t.discount_code)&&(n.coupon=t.coupon||t.discount_code),n}buildPurchaseParams(e){const t=e.data||{},i=t.items||t.products||[],n={content_type:"product",currency:t.currency||"USD",value:t.value||t.total||0,num_items:i.length,order_id:t.transaction_id||t.order_id};return i.length>0&&(n.content_ids=i.map(e=>e.item_id||e.id||e.product_id||e.sku||e.external_id),n.contents=i.map(e=>({id:e.item_id||e.id||e.product_id||e.sku||e.external_id,quantity:e.quantity||1,item_price:e.price||e.item_price||0}))),n}buildSearchParams(e){const t=e.data||{};return{search_string:t.search_term||t.query||"",content_category:t.category,content_ids:t.product_ids||[]}}buildRegistrationParams(e){const t=e.data||{};return{content_name:t.registration_method||"email",status:t.status||"completed",value:t.value||0,currency:t.currency||"USD"}}buildUpsellParams(e,t){const i={content_type:"product",order_id:e.order_id||e.data?.order_id,event_name:t};return e.upsell&&(i.content_ids=[e.upsell.package_id],i.content_name=e.upsell.package_name||`Package ${e.upsell.package_id}`,void 0!==e.upsell.value&&(i.value=parseFloat(this.formatCurrency(e.upsell.value))),void 0!==e.upsell.price&&(i.value=parseFloat(this.formatCurrency(e.upsell.price))),e.upsell.currency&&(i.currency=e.upsell.currency),void 0!==e.upsell.quantity&&(i.num_items=e.upsell.quantity)),i}buildGenericParams(e){const t=e.data||{},i={};return void 0!==t.value&&(i.value=t.value),t.currency&&(i.currency=t.currency),t.content_name&&(i.content_name=t.content_name),t.content_type&&(i.content_type=t.content_type),t.content_category&&(i.content_category=t.content_category),i}}const Oe=R("RudderStack");class Ue extends Fe{constructor(){super("RudderStack"),this.pageViewSent=!1}trackEvent(e){this.sendEvent(e)}isRudderStackLoaded(){return this.isBrowser()&&"object"==typeof window.rudderanalytics&&"function"==typeof window.rudderanalytics.track}sendEvent(e){this.enabled?(Oe.info(`Processing event "${e.event}"`,{eventName:e.event,eventData:e}),this.isRudderStackLoaded()?this.sendEventInternal(e):this.waitForRudderStack().then(()=>{this.sendEventInternal(e)}).catch(()=>{this.debug("RudderStack failed to load, skipping event:",e.event)})):this.debug("RudderStack adapter disabled")}async waitForRudderStack(e=5e3){const t=Date.now();return new Promise((i,n)=>{if(window.rudderanalytics?.ready)window.rudderanalytics.ready(()=>i()),setTimeout(()=>{this.isRudderStackLoaded()?i():n(new Error("RudderStack ready timeout"))},e);else{const a=setInterval(()=>{this.isRudderStackLoaded()?(clearInterval(a),i()):Date.now()-t>e&&(clearInterval(a),n(new Error("RudderStack load timeout")))},100)}})}sendEventInternal(e){try{switch(e.event){case"dl_page_view":case"page_view":this.handlePageView(e);break;case"dl_user_data":case"user_data":this.handleUserData(e);break;default:const t=this.mapEventName(e.event);if(t){const i=this.buildEventProperties(e,t);window.rudderanalytics.track(t,i),this.debug(`Event sent to RudderStack: ${t}`,i)}}}catch(t){}}handlePageView(e){if(this.pageViewSent)return void this.debug("Page view already sent, skipping duplicate");const t=e.data||{},i=t.page_type||"unknown",n=t.page_name||"unknown",a=this.getCampaignData(t),s={path:t.page_location||window.location.pathname,url:t.page_location||window.location.href,title:t.page_title||document.title,referrer:t.page_referrer||document.referrer,campaignName:a.campaignName,campaignApiKey:a.campaignApiKey,campaignCurrency:a.campaignCurrency,campaignLanguage:a.campaignLanguage};window.rudderanalytics.page(i,n,s);const r=`${i.charAt(0).toUpperCase()+i.slice(1)} Page View`;window.rudderanalytics.track(r,{pageName:n,...s}),this.pageViewSent=!0,this.debug("Page View tracked",{pageType:i,pageName:n,eventName:r})}handleUserData(e){const t=e.user_properties||e.data||{};if(t.customer_email||t.email||t.user_id){const e=t.user_id||t.customer_email||t.email,i={email:t.customer_email||t.email,firstName:t.customer_first_name||t.firstName||t.first_name,lastName:t.customer_last_name||t.lastName||t.last_name,phone:t.customer_phone||t.phone,city:t.customer_city||t.city,state:t.customer_state||t.state,country:t.customer_country||t.country,postalCode:t.customer_zip||t.postalCode||t.postal_code,acceptsMarketing:t.customer_accepts_marketing||t.acceptsMarketing||t.accepts_marketing};Object.keys(i).forEach(e=>void 0===i[e]&&delete i[e]),window.rudderanalytics.identify(e,i),this.debug("User Identified",{userId:e,traits:i})}}mapEventName(e){return{dl_view_item:"Product Viewed",dl_view_item_list:"Product List Viewed",dl_add_to_cart:"Product Added",dl_remove_from_cart:"Product Removed",dl_view_cart:"Cart Viewed",dl_cart_updated:"Cart Viewed",dl_begin_checkout:"Checkout Started",dl_purchase:"Order Completed",view_item:"Product Viewed",view_item_list:"Product List Viewed",add_to_cart:"Product Added",remove_from_cart:"Product Removed",view_cart:"Cart Viewed",begin_checkout:"Checkout Started",purchase:"Order Completed",dl_viewed_upsell:"Upsell Viewed",dl_accepted_upsell:"Upsell Accepted",dl_skipped_upsell:"Upsell Skipped",dl_sign_up:"Signed Up",dl_login:"Logged In",sign_up:"Signed Up",login:"Logged In"}[e]||null}buildEventProperties(e,t){const i=e.data||e.ecommerce||{},n=this.getPageMetadata(),a=this.getCampaignData(i),s={pageType:n.pageType,pageName:n.pageName,campaignName:a.campaignName,campaignApiKey:a.campaignApiKey};switch(t){case"Product Viewed":return this.buildProductViewedProps(i,s);case"Product List Viewed":return this.buildProductListViewedProps(i,s);case"Product Added":case"Product Removed":return this.buildProductAddedRemovedProps(i,s);case"Cart Viewed":return this.buildCartViewedProps(i,s);case"Checkout Started":return this.buildCheckoutStartedProps(i,s);case"Order Completed":return this.buildOrderCompletedProps(i,s);case"Upsell Viewed":case"Upsell Accepted":case"Upsell Skipped":return this.buildUpsellProps(e,t,s);default:return{...i,...s}}}buildProductViewedProps(e,t){const i=(e.items||[])[0]||{};return{product_id:i.item_id||"",sku:i.item_id||"",name:i.item_name||"",price:parseFloat(i.price)||0,currency:e.currency||"USD",quantity:parseInt(i.quantity)||1,position:i.position||0,url:window.location.href,...t}}buildProductListViewedProps(e,t){const i=this.formatProducts(e.items||[]);return{list_id:e.list_id||"main-product-list",category:t.pageType,products:i,currency:e.currency||"USD",...t}}buildProductAddedRemovedProps(e,t){const i=(e.items||[])[0]||{},n=this.getCampaignData(e);return{cart_id:`cart-${Date.now()}`,product_id:i.item_id||"",sku:i.item_id||"",name:i.item_name||"",price:parseFloat(i.price)||0,currency:e.currency||n.campaignCurrency||"USD",quantity:parseInt(i.quantity)||1,category:i.item_category||"",position:i.position||0,url:window.location.href,...t}}buildCartViewedProps(e,t){const i=this.formatProducts(e.items||[]),n=this.getCampaignData(e);return{cart_id:`cart-${Date.now()}`,products:i,currency:e.currency||n.campaignCurrency||"USD",value:parseFloat(e.value)||0,...t}}buildCheckoutStartedProps(e,t){const i=this.formatProducts(e.items||[]),n=this.getCampaignData(e);return{order_id:`pending-${Date.now()}`,value:parseFloat(e.value)||0,revenue:parseFloat(e.value)||0,currency:e.currency||n.campaignCurrency||"USD",products:i,...t}}buildOrderCompletedProps(e,t){const i=this.formatProducts(e.items||[]),n=this.getCampaignData(e),a={checkout_id:`checkout-${Date.now()}`,order_id:e.transaction_id||"",affiliation:"Hanacure",total:parseFloat(e.value)||0,revenue:parseFloat(e.value)||0,shipping:parseFloat(e.shipping)||0,tax:parseFloat(e.tax)||0,discount:parseFloat(e.discount)||0,coupon:e.coupon||"",currency:e.currency||n.campaignCurrency||"USD",products:i,...t};if(e.email_hash||e.firstname){const t=e.email_hash||`user-${e.transaction_id}`,i={firstName:e.firstname||"",lastName:e.lastname||"",city:e.city||"",state:e.state||"",postalCode:e.zipcode||"",country:e.country||""};Object.keys(i).forEach(e=>""===i[e]&&delete i[e]),Object.keys(i).length>0&&(window.rudderanalytics.identify(t,i),this.debug("User Identified on Purchase",{userId:t}))}return a}buildUpsellProps(e,t,i){const n=e.data||e,a=this.getCampaignData(n);if("Upsell Accepted"===t){const e={cart_id:`cart-upsell-${Date.now()}`,product_id:n.upsell_id||"",sku:n.upsell_id||"",name:n.upsell_name||"",price:parseFloat(n.upsell_price)||0,currency:n.currency||a.campaignCurrency||"USD",quantity:1,url:window.location.href,isUpsell:!0,upsellRef:n.upsell_id||"",originalOrderId:n.order_id||n.transaction_id||"",...i};window.rudderanalytics.track("Product Added",e)}return{order_id:n.order_id||n.transaction_id||"",product_id:n.upsell_id||"",product_name:n.upsell_name||"",price:parseFloat(n.upsell_price)||0,quantity:1,total:parseFloat(n.value||n.upsell_price)||0,currency:n.currency||a.campaignCurrency||"USD",ref_id:n.upsell_id||"",...i}}formatProducts(e){return e&&Array.isArray(e)?e.map(e=>({product_id:e.item_id||e.id||"",sku:e.item_id||e.id||"",name:e.item_name||e.name||"",price:parseFloat(e.price)||0,quantity:parseInt(e.quantity)||1,category:e.item_category||e.category||"",brand:e.item_brand||"Hanacure",variant:e.item_variant||"",position:e.position||0,url:window.location.href,image_url:e.image_url||""})):[]}getPageMetadata(){return{pageType:document.querySelector('meta[name="next-page-type"]')?.getAttribute("content")||"unknown",pageName:document.querySelector('meta[name="next-page-name"]')?.getAttribute("content")||"unknown"}}getCampaignData(e){if(e.campaignName)return{campaignName:e.campaignName,campaignApiKey:e.campaignApiKey||"",campaignCurrency:e.campaignCurrency||"USD",campaignLanguage:e.campaignLanguage||""};if(this.isBrowser()&&window.next){const e=window.next,t=e.getCampaignData?.();if(t)return{campaignName:t.name||"",campaignApiKey:window.nextDebug?.stores?.config?.getState()?.apiKey||"",campaignCurrency:t.currency||"USD",campaignLanguage:t.language||""}}return{campaignName:"",campaignApiKey:"",campaignCurrency:"USD",campaignLanguage:""}}}class Ne extends Fe{constructor(){super("NextCampaign"),this.logger=R("NextCampaignAdapter"),this.scriptLoaded=!1,this.scriptLoading=!1,this.loadPromise=null,this.apiKey=""}async initialize(e){if(this.logger.info("NextCampaign adapter initializing..."),e?.apiKey)this.apiKey=e.apiKey,this.logger.info("API key provided via config parameter");else{const e=oe.getState();this.apiKey=e.apiKey||"",this.logger.info("API key from config store: "+(this.apiKey?"found":"not found"))}this.apiKey?(this.logger.info(`NextCampaign API key found: ${this.apiKey.substring(0,8)}...${this.apiKey.substring(this.apiKey.length-4)}`),await this.loadScript()):this.logger.warn("No API key available for NextCampaign initialization")}trackEvent(e){this.sendEvent(e)}async sendEvent(e){if(!this.enabled)return void this.debug("NextCampaign adapter disabled");this.scriptLoaded||await this.loadScript();const t=this.mapEvent(e);if(t)try{window.nextCampaign&&(window.nextCampaign.event(t.name,t.data),this.debug(`Event sent to NextCampaign: ${t.name}`,t.data))}catch(i){this.logger.error("Error sending event to NextCampaign:",i)}}async loadScript(){if(!this.scriptLoaded){if(this.scriptLoading)return this.loadPromise;this.scriptLoading=!0,this.loadPromise=this.performLoad();try{await this.loadPromise,this.scriptLoaded=!0,this.logger.info("NextCampaign SDK loaded and initialized successfully âœ…")}catch(e){throw this.logger.error("Failed to load NextCampaign SDK:",e),e}finally{this.scriptLoading=!1}}}async performLoad(){const e="https://campaigns.apps.29next.com/js/v1/campaign/";document.querySelector(`script[src="${e}"]`)?await this.waitForNextCampaign():(await new Promise((t,i)=>{const n=document.createElement("script");n.async=!0,n.src=e,n.onload=()=>{this.logger.debug("NextCampaign script loaded"),t()},n.onerror=()=>{i(new Error(`Failed to load NextCampaign script: ${e}`))},document.head.appendChild(n)}),await this.waitForNextCampaign(),window.nextCampaign&&this.apiKey&&(window.nextCampaign.config({apiKey:this.apiKey}),this.logger.debug("NextCampaign configured with API key"),this.fireInitialPageView()))}fireInitialPageView(){"complete"===document.readyState?this.sendPageView():window.addEventListener("load",()=>{this.sendPageView()})}sendPageView(){try{window.nextCampaign&&(window.nextCampaign.event("page_view",{title:document.title,url:window.location.href}),this.logger.info("Initial page_view event sent to NextCampaign"))}catch(e){this.logger.error("Error sending initial page view to NextCampaign:",e)}}async waitForNextCampaign(e=5e3){const t=Date.now();return new Promise((i,n)=>{const a=setInterval(()=>{window.nextCampaign?(clearInterval(a),i()):Date.now()-t>e&&(clearInterval(a),n(new Error("NextCampaign load timeout")))},100)})}mapEvent(e){switch(e.event){case"dl_page_view":case"page_view":return{name:"page_view",data:{title:document.title,url:window.location.href}};default:return null}}}class ze extends Fe{constructor(e={}){super("Custom"),this.eventQueue=[],this.batchTimer=null,this.retryQueue=new Map,this.config={endpoint:e.endpoint||"",headers:{"Content-Type":"application/json",...e.headers},batchSize:e.batchSize||10,batchIntervalMs:e.batchIntervalMs||5e3,maxRetries:e.maxRetries||3,retryDelayMs:e.retryDelayMs||1e3,transformFunction:e.transformFunction||(e=>e)}}updateConfig(e){this.config={...this.config,...e},e.headers&&(this.config.headers={...this.config.headers,...e.headers})}sendEvent(e){this.enabled&&this.config.endpoint?(this.eventQueue.push(e),this.debug(`Event queued. Queue size: ${this.eventQueue.length}`),this.eventQueue.length>=this.config.batchSize?this.sendBatch():this.scheduleBatch()):this.debug("Custom adapter disabled or no endpoint configured")}scheduleBatch(){this.batchTimer||(this.batchTimer=setTimeout(()=>{this.sendBatch()},this.config.batchIntervalMs))}async sendBatch(){this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);const e=this.eventQueue.splice(0,this.config.batchSize);if(0!==e.length){this.debug(`Sending batch of ${e.length} events`);try{const t=e.map(e=>this.config.transformFunction(e)),i={events:t,batch_info:{size:t.length,timestamp:(new Date).toISOString(),source:"next-campaign-cart"}},n=await this.sendRequest(i);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);this.debug("Batch sent successfully")}catch(t){e.forEach(e=>{this.addToRetryQueue(e)})}this.eventQueue.length>0&&this.scheduleBatch()}}async sendRequest(e,t=1){try{return await fetch(this.config.endpoint,{method:"POST",headers:this.config.headers,body:JSON.stringify(e)})}catch(i){if(t<this.config.maxRetries)return await this.delay(this.config.retryDelayMs*t),this.sendRequest(e,t+1);throw i}}addToRetryQueue(e){const t=e.id?this.retryQueue.get(e.id):void 0;t?t.attempts<this.config.maxRetries?(t.attempts++,e.id&&this.scheduleRetry(e.id)):e.id&&this.retryQueue.delete(e.id):e.id&&(this.retryQueue.set(e.id,{event:e,attempts:1}),this.scheduleRetry(e.id))}scheduleRetry(e){const t=this.retryQueue.get(e);if(!t)return;const i=this.config.retryDelayMs*t.attempts;setTimeout(()=>{const t=this.retryQueue.get(e);t&&(this.retryQueue.delete(e),this.sendEvent(t.event))},i)}delay(e){return new Promise(t=>setTimeout(t,e))}async flush(){for(this.debug("Flushing all queued events"),this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null);this.eventQueue.length>0;)await this.sendBatch()}getQueueSize(){return this.eventQueue.length}getRetryQueueSize(){return this.retryQueue.size}clearQueue(){this.eventQueue=[],this.retryQueue.clear(),this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null)}}const Re=R("ListAttributionTracker"),He="analytics_current_list",je=18e5;class Ve{constructor(){this.currentList=null,this.loadFromStorage(),this.setupUrlTracking()}static getInstance(){return Ve.instance||(Ve.instance=new Ve),Ve.instance}initialize(){Re.debug("ListAttributionTracker initialized")}setCurrentList(e,t){const i={...void 0!==e&&{listId:e},...void 0!==t&&{listName:t},timestamp:Date.now(),url:window.location.href};this.currentList=i,this.saveToStorage(),Re.debug("Set current list:",{listId:e,listName:t})}getCurrentList(){return this.currentList?Date.now()-this.currentList.timestamp>je?(Re.debug("List context expired"),this.clearCurrentList(),null):{...void 0!==this.currentList.listId&&{listId:this.currentList.listId},...void 0!==this.currentList.listName&&{listName:this.currentList.listName}}:null}clearCurrentList(){this.currentList=null,this.removeFromStorage(),Re.debug("Cleared current list")}reset(){this.clearCurrentList(),Re.debug("ListAttributionTracker reset")}detectListFromUrl(e){const t=e||window.location.href,i=new URL(t,window.location.origin),n=i.pathname.toLowerCase(),a=[{regex:/\/collections?\/([^\/]+)/,type:"collection"},{regex:/\/category\/([^\/]+)/,type:"category"},{regex:/\/categories\/([^\/]+)/,type:"category"},{regex:/\/products\/?$/,type:"all_products"},{regex:/\/shop\/?$/,type:"shop"},{regex:/\/store\/?$/,type:"store"},{regex:/\/search/,type:"search"},{regex:/\/tag\/([^\/]+)/,type:"tag"},{regex:/\/tags\/([^\/]+)/,type:"tag"},{regex:/\/brand\/([^\/]+)/,type:"brand"},{regex:/\/brands\/([^\/]+)/,type:"brand"}];for(const r of a){const e=n.match(r.regex);if(e){const t=e[1]||r.type,i=this.formatListName(t,r.type);return Re.debug("Detected list from URL:",{listId:t,listName:i,type:r.type}),{listId:t,listName:i}}}const s=i.searchParams;if(s.has("category")){const e=s.get("category");return{listId:e,listName:this.formatListName(e,"category")}}if(s.has("collection")){const e=s.get("collection");return{listId:e,listName:this.formatListName(e,"collection")}}if(s.has("q")||s.has("query")||s.has("search")){return{listId:"search_results",listName:`Search Results: ${s.get("q")||s.get("query")||s.get("search")||""}`}}return null}setupUrlTracking(){if("undefined"==typeof window)return;this.trackCurrentUrl(),window.addEventListener("popstate",()=>{this.trackCurrentUrl()});const e=history.pushState,t=history.replaceState;history.pushState=function(...t){e.apply(history,t),setTimeout(()=>Ve.getInstance().trackCurrentUrl(),0)},history.replaceState=function(...e){t.apply(history,e),setTimeout(()=>Ve.getInstance().trackCurrentUrl(),0)}}trackCurrentUrl(){const e=this.detectListFromUrl();if(e)this.setCurrentList(e.listId,e.listName);else{const e=window.location.pathname.toLowerCase();this.isProductPage(e)||this.clearCurrentList()}}isProductPage(e){return[/\/product\/[^\/]+/,/\/products\/[^\/]+/,/\/item\/[^\/]+/,/\/p\/[^\/]+/].some(t=>t.test(e))}formatListName(e,t){const i=e.replace(/[-_]/g," ").replace(/\b\w/g,e=>e.toUpperCase());switch(t){case"collection":return`${i} Collection`;case"category":return`${i} Category`;case"all_products":return"All Products";case"shop":return"Shop";case"store":return"Store";case"search":return"Search Results";case"tag":return`Tag: ${i}`;case"brand":return`${i} Brand`;default:return i}}loadFromStorage(){if("undefined"!=typeof window&&window.sessionStorage)try{const e=sessionStorage.getItem(He);if(e){const t=JSON.parse(e);Date.now()-t.timestamp<je?(this.currentList=t,Re.debug("Loaded list context from storage:",t)):this.removeFromStorage()}}catch(e){Re.error("Error loading list context from storage:",e)}}saveToStorage(){if("undefined"!=typeof window&&window.sessionStorage&&this.currentList)try{sessionStorage.setItem(He,JSON.stringify(this.currentList))}catch(e){Re.error("Error saving list context to storage:",e)}}removeFromStorage(){if("undefined"!=typeof window&&window.sessionStorage)try{sessionStorage.removeItem(He)}catch(e){Re.error("Error removing list context from storage:",e)}}}const Be=Ve.getInstance(),Ke=R("ViewItemListTracker");class We{constructor(){this.observer=null,this.trackedProducts=new Set,this.lastScanTime=0,this.scanDebounceMs=500,this.isInitialized=!1}static getInstance(){return We.instance||(We.instance=new We),We.instance}initialize(){this.isInitialized||"undefined"==typeof window||(this.isInitialized=!0,Me.initialize(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.scan()):setTimeout(()=>this.scan(),100),this.setupObserver(),Ke.info("ViewItemListTracker initialized"))}scan(){const e=Date.now();if(e-this.lastScanTime<this.scanDebounceMs)return void Ke.debug("Scan debounced (too soon after last scan)");this.lastScanTime=e;const t=this.findProductElements();if(0!==t.length)if(Ke.debug(`Found ${t.length} products on page`),1===t.length){const e=t[0];e&&this.trackViewItem(e)}else this.trackViewItemList(t);else Ke.debug("No products found on page")}rescan(){Ke.debug("Manual rescan triggered"),this.trackedProducts.clear(),this.scan()}findProductElements(){const e=document.querySelectorAll("[data-next-package-id]"),t=[],i=new Set;return e.forEach((e,n)=>{const a=e.getAttribute("data-next-package-id");a&&!i.has(a)&&(i.add(a),t.push({packageId:a,element:e,index:n}))}),t}trackViewItem(e){if(this.trackedProducts.has(e.packageId))return void Ke.debug("Product already tracked:",e.packageId);const t=Y.getState();if(!t.data||!t.packages||0===t.packages.length)return Ke.debug("Campaign data not yet loaded, deferring tracking"),void setTimeout(()=>this.scan(),1e3);const i=parseInt(e.packageId,10),n=isNaN(i)?null:t.getPackage(i);if(!n)return void Ke.warn("Package not found in store:",e.packageId);const a=Be.getCurrentList(),s={item_id:n.external_id.toString(),item_name:n.name||`Package ${e.packageId}`,currency:t.data?.currency||"USD",price:parseFloat(n.price_total||"0"),quantity:1,item_category:"uncategorized",item_variant:void 0,...a&&{item_list_id:a.listId,item_list_name:a.listName}},r=Me.formatEcommerceEvent("dl_view_item",{currency:s.currency,value:s.price,items:[s]});Me.push(r),this.trackedProducts.add(e.packageId),Ke.debug("Tracked view_item:",e.packageId)}trackViewItemList(e){const t=Y.getState(),i=[];let n=0;if(!t.data||!t.packages||0===t.packages.length)return Ke.debug("Campaign data not yet loaded, deferring tracking"),void setTimeout(()=>this.scan(),1e3);const a=Be.getCurrentList()||Be.detectListFromUrl()||{listId:"product_list",listName:"Product List"};if(e.forEach((e,s)=>{if(this.trackedProducts.has(e.packageId))return;const r=parseInt(e.packageId,10),o=isNaN(r)?null:t.getPackage(r);if(!o)return void Ke.warn("Package not found in store:",e.packageId);const l=parseFloat(o.price_total||"0");n+=l,i.push({item_id:o.external_id.toString(),item_name:o.name||`Package ${e.packageId}`,currency:t.data?.currency||"USD",price:l,quantity:1,item_category:"uncategorized",item_variant:void 0,item_list_id:a.listId,item_list_name:a.listName,index:s}),this.trackedProducts.add(e.packageId)}),0===i.length)return void Ke.debug("No new products to track");const s=Me.formatEcommerceEvent("dl_view_item_list",{currency:t.data?.currency||"USD",value:n,items:i,item_list_id:a.listId,item_list_name:a.listName});Me.push(s),Ke.debug(`Tracked view_item_list with ${i.length} items`)}setupObserver(){"undefined"!=typeof window&&window.MutationObserver&&(this.observer=new MutationObserver(e=>{let t=!1;for(const i of e){if("childList"===i.type)for(let e=0;e<i.addedNodes.length;e++){const n=i.addedNodes[e];if(n&&n.nodeType===Node.ELEMENT_NODE){const e=n;if(e.hasAttribute("data-next-package-id")||e.querySelector("[data-next-package-id]")){t=!0;break}}}else"attributes"===i.type&&"data-next-package-id"===i.attributeName&&(t=!0);if(t)break}t&&(Ke.debug("Detected DOM changes with products"),this.scan())}),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-next-package-id"]}),Ke.debug("Mutation observer set up"))}reset(){this.trackedProducts.clear(),Ke.debug("ViewItemListTracker reset"),this.isInitialized&&this.scan()}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.trackedProducts.clear(),this.isInitialized=!1,Ke.debug("ViewItemListTracker destroyed")}getStatus(){return{initialized:this.isInitialized,trackedCount:this.trackedProducts.size,observing:null!==this.observer}}}We.getInstance();const Qe=R("UserDataTracker");class Je{constructor(){this.eventBus=B.getInstance(),this.lastTrackTime=0,this.trackDebounceMs=1e3,this.isInitialized=!1,this.unsubscribers=[]}static getInstance(){return Je.instance||(Je.instance=new Je),Je.instance}initialize(){this.isInitialized||"undefined"==typeof window||(this.isInitialized=!0,Me.initialize(),this.trackUserData(),this.setupListeners(),Qe.info("UserDataTracker initialized"))}trackUserData(){const e=Date.now();if(e-this.lastTrackTime<this.trackDebounceMs)return void Qe.debug("User data tracking debounced");this.lastTrackTime=e;const t=this.collectUserData();if(!t||0===Object.keys(t).length)return void Qe.debug("No user data to track");const i=Me.formatUserDataEvent(t);Me.push(i),Qe.debug("Tracked user data:",{hasUserId:!!t.userId,hasEmail:!!t.email,cartValue:t.cartValue,cartItems:t.cartItems})}collectUserData(){const e={};try{const t=sessionStorage.getItem("user_data");if(t){const i=JSON.parse(t);e.userId=i.id||i.userId,e.email=i.email,e.phone=i.phone,e.firstName=i.firstName,e.lastName=i.lastName}const i=sessionStorage.getItem("session_id"),n=sessionStorage.getItem("visitor_id")||localStorage.getItem("visitor_id");i&&(e.sessionId=i),n&&(e.visitorId=n)}catch(t){Qe.debug("Error accessing user data from storage:",t)}try{const t=Q.getState();t.items&&t.items.length>0?(e.cartValue=t.total||t.subtotal||0,e.cartItems=t.totalQuantity||0,e.cartProducts=t.items.map(e=>e.packageId?.toString()||"unknown")):(e.cartValue=0,e.cartItems=0,e.cartProducts=[])}catch(t){Qe.debug("Cart store not available or error accessing:",t)}try{const t=this.getCheckoutData();t&&Object.assign(e,t)}catch(t){Qe.debug("Error getting checkout data:",t)}return e}getCheckoutData(){if("undefined"==typeof document)return null;const e={};return[{selector:'[name="email"], #email, [type="email"]',key:"email"},{selector:'[name="phone"], #phone, [type="tel"]',key:"phone"},{selector:'[name="first_name"], [name="firstName"], #first-name',key:"firstName"},{selector:'[name="last_name"], [name="lastName"], #last-name',key:"lastName"},{selector:'[name="address"], [name="address1"], #address',key:"address"},{selector:'[name="city"], #city',key:"city"},{selector:'[name="state"], [name="province"], #state',key:"state"},{selector:'[name="zip"], [name="postal_code"], #zip',key:"postalCode"},{selector:'[name="country"], #country',key:"country"}].forEach(({selector:t,key:i})=>{const n=document.querySelector(t);n&&n.value&&(e[i]=n.value)}),Object.keys(e).length>0?e:null}setupListeners(){this.eventBus.on("route:changed",()=>{Qe.debug("Route changed, tracking user data"),this.trackUserData()}),this.eventBus.on("sdk:route-invalidated",()=>{Qe.debug("SDK route invalidated, tracking user data"),this.trackUserData()}),this.eventBus.on("user:logged-in",()=>{Qe.debug("User logged in, tracking user data"),setTimeout(()=>this.trackUserData(),100)}),this.eventBus.on("user:logged-out",()=>{Qe.debug("User logged out, tracking user data"),setTimeout(()=>this.trackUserData(),100)}),this.eventBus.on("cart:updated",()=>{Qe.debug("Cart updated, tracking user data"),this.trackUserData()});const e=Q.subscribe(()=>{Qe.debug("Cart store changed, tracking user data"),this.trackUserData()});if(this.unsubscribers.push(e),"undefined"!=typeof window){window.addEventListener("popstate",()=>{Qe.debug("Browser navigation, tracking user data"),this.trackUserData()});const e=history.pushState,t=history.replaceState;history.pushState=function(...t){e.apply(history,t),setTimeout(()=>Je.getInstance().trackUserData(),0)},history.replaceState=function(...e){t.apply(history,e),setTimeout(()=>Je.getInstance().trackUserData(),0)}}Qe.debug("User data tracking listeners set up")}forceTrack(){this.lastTrackTime=0,this.trackUserData()}reset(){this.lastTrackTime=0,this.trackUserData(),Qe.debug("UserDataTracker reset")}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.eventBus.removeAllListeners("route:changed"),this.eventBus.removeAllListeners("sdk:route-invalidated"),this.eventBus.removeAllListeners("user:logged-in"),this.eventBus.removeAllListeners("user:logged-out"),this.eventBus.removeAllListeners("cart:updated"),this.isInitialized=!1,Qe.debug("UserDataTracker destroyed")}getStatus(){return{initialized:this.isInitialized,lastTrackTime:this.lastTrackTime,listenersCount:this.unsubscribers.length}}}Je.getInstance();const Ge=R("AutoEventListener");class Ze{constructor(){this.eventBus=B.getInstance(),this.isInitialized=!1,this.eventHandlers=new Map,this.lastEventTimes=new Map,this.debounceConfig={"cart:item-added":1e3,"cart:item-removed":500,"cart:quantity-changed":500,"cart:updated":1e3}}static getInstance(){return Ze.instance||(Ze.instance=new Ze),Ze.instance}initialize(){this.isInitialized||(this.isInitialized=!0,Me.initialize(),this.setupCartEventListeners(),this.setupUpsellEventListeners(),this.setupCheckoutEventListeners(),this.setupPageEventListeners(),Ge.info("AutoEventListener initialized"))}shouldProcessEvent(e){const t=Date.now();return t-(this.lastEventTimes.get(e)||0)<(this.debounceConfig[e]||0)?(Ge.debug(`Event ${e} debounced`),!1):(this.lastEventTimes.set(e,t),!0)}setupCartEventListeners(){const e=async e=>{if(!this.shouldProcessEvent("cart:item-added"))return;const t=e.packageId,i=e.quantity||1,n=Y.getState(),a=n.getPackage(t);if(!a)return void Ge.warn("Package not found for add to cart:",t);const s=Be.getCurrentList(),r={item_id:a.external_id.toString(),item_name:a.name||`Package ${t}`,currency:n.data?.currency||"USD",price:parseFloat(a.price_total||"0"),quantity:1,item_category:"uncategorized",item_variant:void 0,...s&&{item_list_id:s.listId,item_list_name:s.listName}},o=Me.formatEcommerceEvent("dl_add_to_cart",{currency:r.currency,value:r.price*i,items:[r]});e.willRedirect&&(o._willRedirect=!0),Me.push(o),Ge.debug("Tracked add to cart:",t)};this.eventBus.on("cart:item-added",e),this.eventHandlers.set("cart:item-added",e);const t=async e=>{if(!this.shouldProcessEvent("cart:item-removed"))return;const t=e.packageId,i=e.quantity||1,n=Y.getState(),a=n.getPackage(t);if(!a)return void Ge.warn("Package not found for remove from cart:",t);const s={item_id:a.external_id.toString(),item_name:a.name||`Package ${t}`,currency:n.data?.currency||"USD",price:parseFloat(a.price_total||"0"),quantity:1,item_category:"uncategorized",item_variant:void 0},r=Me.formatEcommerceEvent("dl_remove_from_cart",{currency:s.currency,value:s.price*i,items:[s]});Me.push(r),Ge.debug("Tracked remove from cart:",t)};this.eventBus.on("cart:item-removed",t),this.eventHandlers.set("cart:item-removed",t);const i=async()=>{this.shouldProcessEvent("cart:updated")&&Me.push({event:"dl_cart_updated",cart:this.getCartData()})};this.eventBus.on("cart:updated",i),this.eventHandlers.set("cart:updated",i)}setupUpsellEventListeners(){const e=async e=>{const t=e.orderId,i=e.pagePath;if(!e.packageId)return Me.push({event:"dl_viewed_upsell",order_id:t,page_path:i,upsell:{package_id:"page_view",package_name:"Upsell Page View",currency:Y.getState().data?.currency||"USD"}}),void Ge.info("Tracked upsell page view:",i);const n=e.packageId,a=Y.getState(),s=a.getPackage(n);s?(Me.push({event:"dl_viewed_upsell",order_id:t,upsell:{package_id:n.toString(),package_name:s.name||`Package ${n}`,price:parseFloat(s.price||"0"),currency:a.data?.currency||"USD"}}),Ge.info("Tracked upsell view:",n)):Ge.warn("Package not found for upsell view:",n)};this.eventBus.on("upsell:viewed",e),this.eventHandlers.set("upsell:viewed",e);const t=async e=>{const t=e.packageId,i=e.quantity||1,n=e.orderId||e.order?.ref_id;let a=e.value;if(void 0===a){const e=Y.getState().getPackage(t);e?.price&&(a=parseFloat(e.price)*i)}const s={event:"dl_accepted_upsell",order_id:n,upsell:{package_id:t.toString(),package_name:e.packageName||`Package ${t}`,quantity:i,value:a||0,currency:e.currency||"USD"}};Ge.debug("Upsell accepted event data:",{willRedirect:e.willRedirect,data:e}),e.willRedirect&&(s._willRedirect=!0,Ge.debug("Marked upsell event for queueing due to redirect")),Me.push(s),Ge.info("Tracked upsell accepted:",t)};this.eventBus.on("upsell:accepted",t),this.eventBus.on("upsell:added",t),this.eventHandlers.set("upsell:accepted",t),this.eventHandlers.set("upsell:added",t);const i=async e=>{Me.push({event:"dl_skipped_upsell",order_id:e.orderId,upsell:{package_id:e.packageId?.toString()||"unknown",package_name:e.packageName||"Unknown Package"}}),Ge.info("Tracked upsell skipped:",e.packageId)};this.eventBus.on("upsell:skipped",i),this.eventHandlers.set("upsell:skipped",i)}setupCheckoutEventListeners(){const e=async e=>{const t=Q.getState(),i=Y.getState(),n=t.items.map((e,t)=>{const n=i.getPackage(e.packageId);return{item_id:n?.external_id?.toString()||e.packageId.toString(),item_name:n?.name||`Package ${e.packageId}`,currency:i.data?.currency||"USD",price:parseFloat(n?.price_total||"0"),quantity:e.quantity,item_category:i.data?.name||"uncategorized",item_variant:void 0,index:t}}),a=Me.formatEcommerceEvent("dl_begin_checkout",{currency:i.data?.currency||"USD",value:t.total||t.subtotal||0,items:n,coupon:e.coupon});Me.push(a),Ge.info("Tracked checkout started")};this.eventBus.on("checkout:started",e),this.eventHandlers.set("checkout:started",e);const t=async e=>{const t=Q.getState(),i=Y.getState(),n=t.items.map((e,t)=>{const n=i.getPackage(e.packageId);return{item_id:n?.external_id?.toString()||e.packageId.toString(),item_name:n?.name||`Package ${e.packageId}`,currency:i.data?.currency||"USD",price:parseFloat(n?.price_total||"0"),quantity:e.quantity,item_category:i.data?.name||"uncategorized",item_variant:void 0,index:t}}),a=Me.formatEcommerceEvent("dl_begin_checkout",{currency:i.data?.currency||"USD",value:t.total||t.subtotal||0,items:n,coupon:t.appliedCoupons?.[0]?.code,payment_type:e.method||"express"});Me.push(a),Ge.info("Tracked express checkout started",{method:e.method})};this.eventBus.on("express-checkout:started",t),this.eventHandlers.set("express-checkout:started",t);const i=async e=>{const t=e.ref_id||e.number||e.order_id||e.transaction_id,i=parseFloat(e.total_incl_tax||e.total||"0");let n=[];if(e.lines&&Array.isArray(e.lines)){const t=Y.getState();n=e.lines.map((i,n)=>({item_id:i.product_sku||i.id?.toString()||`line_${n}`,item_name:i.product_title||i.product_description||`Item ${i.id}`,currency:e.currency||"USD",price:parseFloat(i.price_incl_tax||i.price||"0"),quantity:parseInt(i.quantity?.toString()||"1"),item_category:t.data?.name||"uncategorized",item_variant:i.variant_title,discount:parseFloat(i.price_incl_tax_excl_discounts||"0")-parseFloat(i.price_incl_tax||"0"),index:n}))}else{const e=Q.getState(),t=Y.getState();n=e.items.map((e,i)=>{const n=t.getPackage(e.packageId);return{item_id:n?.external_id?.toString()||e.packageId.toString(),item_name:n?.name||`Package ${e.packageId}`,currency:t.data?.currency||"USD",price:parseFloat(n?.price_total||"0"),quantity:e.quantity,item_category:t.data?.name||"uncategorized",index:i}})}const a={transaction_id:t,currency:e.currency||"USD",value:i||0,items:n,coupon:e.discounts?.[0]?.code||e.coupon_code||e.coupon,shipping:parseFloat(e.shipping_incl_tax||e.shipping||"0"),tax:parseFloat(e.total_tax||e.tax||"0")},s=Me.formatEcommerceEvent("dl_purchase",a);s._willRedirect=!0,Ge.debug("Marked purchase event for queueing with _willRedirect = true"),Me.push(s),Ge.info("Tracked purchase:",t)};this.eventBus.on("order:completed",i),this.eventHandlers.set("order:completed",i)}setupPageEventListeners(){const e=async e=>{Me.push({event:"dl_page_view",page:{title:e.title||document.title,url:e.url||window.location.href,path:e.path||window.location.pathname,referrer:document.referrer}})};this.eventBus.on("page:viewed",e),this.eventHandlers.set("page:viewed",e);const t=async e=>{Me.push({event:"dl_route_changed",route:{from:e.from,to:e.to,path:e.path||window.location.pathname}})};this.eventBus.on("route:changed",t),this.eventHandlers.set("route:changed",t)}getCartData(){try{const e=Q.getState(),t=Y.getState();return{total_value:e.total||e.subtotal||0,total_items:e.totalQuantity||0,currency:t.data?.currency||"USD",items:e.items.map(e=>({package_id:e.packageId,quantity:e.quantity,price:t.getPackage(e.packageId)?.price||0}))}}catch(e){return Ge.error("Error getting cart data:",e),null}}reset(){this.lastEventTimes.clear(),Ge.debug("AutoEventListener reset")}destroy(){this.eventHandlers.forEach((e,t)=>{this.eventBus.off(t,e)}),this.eventHandlers.clear(),this.lastEventTimes.clear(),this.isInitialized=!1,Ge.debug("AutoEventListener destroyed")}getStatus(){return{initialized:this.isInitialized,listenersCount:this.eventHandlers.size,debounceConfig:{...this.debounceConfig}}}setDebounceConfig(e){Object.assign(this.debounceConfig,e),Ge.debug("Updated debounce config:",this.debounceConfig)}}Ze.getInstance();const Ye={visitor_type:{type:"string"},customer_id:{type:"string"},customer_email:{type:"string"},customer_phone:{type:"string"},customer_first_name:{type:"string"},customer_last_name:{type:"string"},customer_address_city:{type:"string"},customer_address_province:{type:"string"},customer_address_province_code:{type:"string"},customer_address_country:{type:"string"},customer_address_country_code:{type:"string"},customer_address_zip:{type:"string"},customer_order_count:{type:"number"},customer_total_spent:{type:"number"},customer_tags:{type:"string"}},Xe={item_id:{type:"string",required:!0},item_name:{type:"string",required:!0},affiliation:{type:"string"},coupon:{type:"string"},currency:{type:"string"},discount:{type:"number"},index:{type:"number"},item_brand:{type:"string"},item_category:{type:"string"},item_category2:{type:"string"},item_category3:{type:"string"},item_category4:{type:"string"},item_category5:{type:"string"},item_list_id:{type:"string"},item_list_name:{type:"string"},item_variant:{type:"string"},location_id:{type:"string"},price:{type:"number"},quantity:{type:"number"}},et={currency:{type:"string"},value:{type:"number"},coupon:{type:"string"},items:{type:"array",items:{type:"object",properties:Xe}}},tt={currency:{type:"string"},value:{type:"number"},impressions:{type:"array",items:{type:"object",properties:Xe}}},it={dl_user_data:{name:"dl_user_data",fields:{event:{type:"string",required:!0},user_properties:{type:"object",required:!0,properties:Ye}}},dl_sign_up:{name:"dl_sign_up",fields:{event:{type:"string",required:!0},user_properties:{type:"object",properties:Ye},method:{type:"string"}}},dl_login:{name:"dl_login",fields:{event:{type:"string",required:!0},user_properties:{type:"object",properties:Ye},method:{type:"string"}}},dl_view_item_list:{name:"dl_view_item_list",fields:{event:{type:"string",required:!0},ecommerce:{type:"object",required:!0,properties:{...tt,item_list_id:{type:"string"},item_list_name:{type:"string"}}},user_properties:{type:"object",properties:Ye}}},dl_view_search_results:{name:"dl_view_search_results",fields:{event:{type:"string",required:!0},search_term:{type:"string",required:!0},ecommerce:{type:"object",properties:tt},user_properties:{type:"object",properties:Ye}}},dl_select_item:{name:"dl_select_item",fields:{event:{type:"string",required:!0},ecommerce:{type:"object",required:!0,properties:{...et,item_list_id:{type:"string"},item_list_name:{type:"string"}}},user_properties:{type:"object",properties:Ye}}},dl_view_item:{name:"dl_view_item",fields:{event:{type:"string",required:!0},ecommerce:{type:"object",required:!0,properties:et},user_properties:{type:"object",properties:Ye}}},dl_add_to_cart:{name:"dl_add_to_cart",fields:{event:{type:"string",required:!0},ecommerce:{type:"object",required:!0,properties:et},user_properties:{type:"object",properties:Ye}}},dl_remove_from_cart:{name:"dl_remove_from_cart",fields:{event:{type:"string",required:!0},ecommerce:{type:"object",required:!0,properties:et},user_properties:{type:"object",properties:Ye}}},dl_view_cart:{name:"dl_view_cart",fields:{event:{type:"string",required:!0},ecommerce:{type:"object",required:!0,properties:et},user_properties:{type:"object",properties:Ye}}},dl_begin_checkout:{name:"dl_begin_checkout",fields:{event:{type:"string",required:!0},ecommerce:{type:"object",required:!0,properties:{...et,checkout_id:{type:"string"},checkout_step:{type:"number"}}},user_properties:{type:"object",properties:Ye}}},dl_purchase:{name:"dl_purchase",fields:{event:{type:"string",required:!0},ecommerce:{type:"object",required:!0,properties:{...et,transaction_id:{type:"string",required:!0},affiliation:{type:"string"},tax:{type:"number"},shipping:{type:"number"},discount:{type:"number"}}},user_properties:{type:"object",properties:Ye}}},dl_subscribe:{name:"dl_subscribe",fields:{event:{type:"string",required:!0},ecommerce:{type:"object",properties:{...et,subscription_id:{type:"string"},subscription_status:{type:"string"}}},user_properties:{type:"object",properties:Ye}}},dl_viewed_upsell:{name:"dl_viewed_upsell",fields:{event:{type:"string",required:!0},order_id:{type:"string",required:!0},upsell:{type:"object",required:!0,properties:{package_id:{type:"string",required:!0},package_name:{type:"string",required:!0},price:{type:"number"},currency:{type:"string"}}}}},dl_accepted_upsell:{name:"dl_accepted_upsell",fields:{event:{type:"string",required:!0},order_id:{type:"string",required:!0},upsell:{type:"object",required:!0,properties:{package_id:{type:"string",required:!0},package_name:{type:"string"},quantity:{type:"number"},value:{type:"number",required:!0},currency:{type:"string"}}}}},dl_skipped_upsell:{name:"dl_skipped_upsell",fields:{event:{type:"string",required:!0},order_id:{type:"string",required:!0},upsell:{type:"object",required:!0,properties:{package_id:{type:"string"},package_name:{type:"string"}}}}}};function nt(e){return it[e]}class at{constructor(e=!1){this.debug=e}validateEvent(e){const t={valid:!0,errors:[],warnings:[]};if(!e||"object"!=typeof e)return t.valid=!1,t.errors.push("Event data must be an object"),t;if(!e.event)return t.valid=!1,t.errors.push('Event must have an "event" field'),t;const i=nt(e.event);if(!i)return t.warnings.push(`No schema defined for event: ${e.event}`),t;const n=function(e,t){const i=[];function n(e,t,a){if(t.required&&null==e)return void i.push(`Missing required field: ${a}`);if(null==e)return;const s=Array.isArray(e)?"array":typeof e;if(s===t.type){if(t.enum&&!t.enum.includes(e)&&i.push(`Invalid value for ${a}: must be one of ${t.enum.join(", ")}`),"object"===t.type&&t.properties)for(const[i,s]of Object.entries(t.properties))n(e[i],s,`${a}.${i}`);"array"===t.type&&t.items&&e.forEach((e,i)=>{n(e,t.items,`${a}[${i}]`)})}else i.push(`Invalid type for ${a}: expected ${t.type}, got ${s}`)}for(const[a,s]of Object.entries(t.fields))n(e[a],s,a);return{valid:0===i.length,errors:i}}(e,i);return t.valid=n.valid,t.errors.push(...n.errors),this.performAdditionalValidation(e,t),this.debug&&t.valid,t}performAdditionalValidation(e,t){switch(e.ecommerce&&(e.ecommerce.currency&&!this.isValidCurrency(e.ecommerce.currency)&&t.warnings.push(`Invalid currency format: ${e.ecommerce.currency}`),void 0!==e.ecommerce.value&&e.ecommerce.value<0&&t.warnings.push("Ecommerce value should not be negative"),e.ecommerce.items&&Array.isArray(e.ecommerce.items)&&e.ecommerce.items.forEach((e,i)=>{this.validateProduct(e,`ecommerce.items[${i}]`,t)}),e.ecommerce.impressions&&Array.isArray(e.ecommerce.impressions)&&e.ecommerce.impressions.forEach((e,i)=>{this.validateProduct(e,`ecommerce.impressions[${i}]`,t)})),e.user_properties&&this.validateUserProperties(e.user_properties,t),e.event){case"dl_purchase":e.ecommerce?.transaction_id||(t.errors.push("dl_purchase event must have ecommerce.transaction_id"),t.valid=!1);break;case"dl_view_search_results":e.search_term||(t.errors.push("dl_view_search_results event must have search_term"),t.valid=!1);break;case"dl_viewed_upsell":case"dl_accepted_upsell":case"dl_skipped_upsell":this.validateUpsellEvent(e,t)}}validateProduct(e,t,i){if(!e||"object"!=typeof e)return i.errors.push(`${t} must be an object`),void(i.valid=!1);e.item_id||(i.errors.push(`${t}.item_id is required`),i.valid=!1),e.item_name||(i.errors.push(`${t}.item_name is required`),i.valid=!1);const n=["price","quantity","discount","index"];for(const a of n)void 0!==e[a]&&("number"!=typeof e[a]?(i.errors.push(`${t}.${a} must be a number`),i.valid=!1):"discount"!==a&&e[a]<0&&i.warnings.push(`${t}.${a} should not be negative`));void 0===e.quantity||Number.isInteger(e.quantity)||i.warnings.push(`${t}.quantity should be an integer`)}validateUserProperties(e,t){if("object"!=typeof e)return t.errors.push("user_properties must be an object"),void(t.valid=!1);e.customer_email&&!this.isValidEmail(e.customer_email)&&t.warnings.push("customer_email is not a valid email address"),void 0!==e.customer_order_count&&("number"==typeof e.customer_order_count&&Number.isInteger(e.customer_order_count)||t.warnings.push("customer_order_count should be an integer")),void 0!==e.customer_total_spent&&"number"!=typeof e.customer_total_spent&&t.warnings.push("customer_total_spent should be a number"),e.customer_address_country_code&&2!==e.customer_address_country_code.length&&t.warnings.push("customer_address_country_code should be a 2-letter ISO code"),e.customer_address_province_code&&e.customer_address_province_code.length>3&&t.warnings.push("customer_address_province_code seems too long")}isValidCurrency(e){return/^[A-Z]{3}$/.test(e)}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}validateUpsellEvent(e,t){if(e.order_id||(t.errors.push(`${e.event} must have order_id`),t.valid=!1),!e.upsell||"object"!=typeof e.upsell)return t.errors.push(`${e.event} must have upsell object`),void(t.valid=!1);e.upsell.package_id||(t.errors.push(`${e.event}.upsell.package_id is required`),t.valid=!1),"dl_accepted_upsell"===e.event&&void 0===e.upsell.value&&(t.errors.push("dl_accepted_upsell.upsell.value is required"),t.valid=!1),void 0!==e.upsell.price&&"number"!=typeof e.upsell.price&&(t.errors.push(`${e.event}.upsell.price must be a number`),t.valid=!1),void 0!==e.upsell.quantity&&"number"!=typeof e.upsell.quantity&&(t.errors.push(`${e.event}.upsell.quantity must be a number`),t.valid=!1),void 0!==e.upsell.value&&"number"!=typeof e.upsell.value&&(t.errors.push(`${e.event}.upsell.value must be a number`),t.valid=!1)}getAvailableSchemas(){return Object.keys(it)}getSchemaDetails(e){return nt(e)}generateSampleEvent(e){const t=nt(e);if(!t)return null;const i={event:e,event_id:"sample_"+Date.now(),timestamp:Date.now()};return this.generateSampleFromSchema(t.fields,i),i}generateSampleFromSchema(e,t){for(const[i,n]of Object.entries(e))if("event"!==i&&(n.required||Math.random()>.5))switch(n.type){case"string":t[i]=n.enum?n.enum[0]:`sample_${i}`;break;case"number":t[i]=i.includes("price")||i.includes("value")?99.99:1;break;case"boolean":t[i]=!0;break;case"object":t[i]={},n.properties&&this.generateSampleFromSchema(n.properties,t[i]);break;case"array":if(t[i]=[],n.items&&"object"===n.items.type&&n.items.properties){const e={};this.generateSampleFromSchema(n.items.properties,e),t[i].push(e)}}}}class st{static createEvent(e,t={}){return{event:e,event_id:this.generateEventId(),event_time:(new Date).toISOString(),user_properties:this.getUserProperties(),...this.getEventContext(),...t,_metadata:this.getEventMetadata()}}static generateEventId(){return`${Date.now()}_${Math.random().toString(36).substring(2,9)}`}static getUserProperties(){const e={visitor_type:"guest"};try{if("undefined"!=typeof window){const t=window.checkoutStore;if(t){const i=t.getState();if(i.billingAddress){const t=i.billingAddress;e.customer_first_name=t.first_name,e.customer_last_name=t.last_name,e.customer_address_city=t.city,e.customer_address_province=t.province,e.customer_address_province_code=t.province,e.customer_address_zip=t.postal,e.customer_address_country=t.country,e.customer_phone=t.phone}i.formData?.email&&(e.customer_email=i.formData.email),i.formData?.customerId&&(e.customer_id=String(i.formData.customerId),e.visitor_type="customer")}}}catch(t){}return e}static getEventContext(){const e={};return"undefined"!=typeof window&&(e.page_location=window.location.href,e.page_title=document.title,e.page_referrer=document.referrer,e.user_agent=navigator.userAgent,e.screen_resolution=`${window.screen.width}x${window.screen.height}`,e.viewport_size=`${window.innerWidth}x${window.innerHeight}`,e.session_id=this.getSessionId(),e.timestamp=Date.now()),e}static getEventMetadata(){return{pushed_at:Date.now(),debug_mode:!1,session_id:this.getSessionId(),sequence_number:this.getNextSequenceNumber(),source:"next-campaign-cart",version:"0.2.0"}}static getSessionId(){if("undefined"!=typeof window){let e=sessionStorage.getItem("analytics_session_id");return e||(e=`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,sessionStorage.setItem("analytics_session_id",e)),e}return`session_${Date.now()}`}static getNextSequenceNumber(){if("undefined"!=typeof window){const e=parseInt(sessionStorage.getItem("analytics_sequence")||"0",10)+1;return sessionStorage.setItem("analytics_sequence",String(e)),e}return 0}static getCurrency(){try{if("undefined"!=typeof window){const e=window.campaignStore;if(e){const t=e.getState().data;return t?.currency||"USD"}}}catch(e){}return"USD"}static formatEcommerceItem(e,t,i){const n=this.getCurrency();let a="Campaign";try{if("undefined"!=typeof window){const e=window.campaignStore;if(e){const t=e.getState().data;a=t?.name||"Campaign"}}}catch(d){}const s=String(e.packageId||e.package_id||e.id),r=e.product?.title||e.title||e.product_title||e.name||`Package ${s}`;let o=0;e.price_incl_tax?o="string"==typeof e.price_incl_tax?parseFloat(e.price_incl_tax):e.price_incl_tax:e.price&&(o="object"==typeof e.price&&"incl_tax"in e.price?e.price.incl_tax.value:"string"==typeof e.price?parseFloat(e.price):e.price);const l=e.quantity||1,c={item_id:s,item_name:r,item_category:a,price:"string"==typeof o?parseFloat(o):o,quantity:l,currency:n};if(e.package_profile||e.variant){const t=e.package_profile||e.variant;void 0!==t&&(c.item_variant=t)}return void 0!==t&&(c.index=t),i?.id&&(c.item_list_id=i.id),i?.name&&(c.item_list_name=i.name),c}static getListAttribution(){if("undefined"!=typeof window){const e=sessionStorage.getItem("analytics_list_id"),t=sessionStorage.getItem("analytics_list_name");if(e||t){const i={};return e&&(i.id=e),t&&(i.name=t),i}}}static setListAttribution(e,t){"undefined"!=typeof window&&(e&&sessionStorage.setItem("analytics_list_id",e),t&&sessionStorage.setItem("analytics_list_name",t))}static clearListAttribution(){"undefined"!=typeof window&&(sessionStorage.removeItem("analytics_list_id"),sessionStorage.removeItem("analytics_list_name"))}}class rt{static createViewItemListEvent(e,t,i){const n=st.getCurrency(),a=e.map((e,n)=>st.formatEcommerceItem(e,n,void 0!==t||void 0!==i?{...void 0!==t&&{id:t},...void 0!==i&&{name:i}}:void 0)),s=a.reduce((e,t)=>e+(t.price||0)*(t.quantity||1),0);st.setListAttribution(t,i);const r={currency:n,value:s,items:a};return st.createEvent("view_item_list",{ecommerce:r,event_category:"ecommerce",event_label:i||"Product List"})}static createViewItemEvent(e){const t=st.getCurrency(),i=st.formatEcommerceItem(e),n={currency:t,value:(i.price||0)*(i.quantity||1),items:[i]};return st.createEvent("view_item",{ecommerce:n,event_category:"ecommerce",event_label:i.item_name})}static createAddToCartEvent(e,t,i){const n=st.getCurrency(),a=t||i?{...void 0!==t&&{id:t},...void 0!==i&&{name:i}}:st.getListAttribution(),s=st.formatEcommerceItem(e,void 0,a),r={currency:n,value:(s.price||0)*(s.quantity||1),items:[s]};return st.createEvent("add_to_cart",{ecommerce:r,event_category:"ecommerce",event_label:s.item_name,list:a?.id||a?.name?a:void 0})}static createRemoveFromCartEvent(e){const t=st.getCurrency(),i=st.formatEcommerceItem(e),n={currency:t,value:(i.price||0)*(i.quantity||1),items:[i]};return st.createEvent("remove_from_cart",{ecommerce:n,event_category:"ecommerce",event_label:i.item_name})}static createSelectItemEvent(e,t,i){const n=st.getCurrency(),a=t||i?{...void 0!==t&&{id:t},...void 0!==i&&{name:i}}:st.getListAttribution(),s=st.formatEcommerceItem(e,void 0,a),r={currency:n,value:(s.price||0)*(s.quantity||1),items:[s]};return st.createEvent("select_item",{ecommerce:r,event_category:"ecommerce",event_label:s.item_name,list:a?.id||a?.name?a:void 0})}static createBeginCheckoutEvent(){const e=Q.getState(),t=st.getCurrency(),i=e.enrichedItems.map((e,t)=>st.formatEcommerceItem(e,t)),n={currency:t,value:e.totals.total.value,items:i};return e.appliedCoupons?.[0]?.code&&(n.coupon=e.appliedCoupons[0].code),st.createEvent("begin_checkout",{ecommerce:n,event_category:"ecommerce",event_value:e.totals.total.value})}static createPurchaseEvent(e){const t=Q.getState(),i=st.getCurrency(),n=e.order||e,a=n.ref_id||n.number||e.orderId||e.transactionId||`order_${Date.now()}`,s=parseFloat(n.total_incl_tax||n.total||e.total||t.totals.total.value||0),r=parseFloat(n.total_tax||e.tax||t.totals.tax.value||0),o=parseFloat(n.shipping_incl_tax||e.shipping||t.totals.shipping.value||0);let l=[];n.lines&&n.lines.length>0?l=n.lines.map((e,t)=>({item_id:String(e.package||e.product_id||e.id),item_name:e.product_title||e.name||"Unknown Product",item_category:e.campaign_name||"Campaign",item_variant:e.package_profile||e.variant,price:parseFloat(e.price_incl_tax||e.price||0),quantity:e.quantity||1,currency:n.currency||i,index:t})):(e.items||t.enrichedItems.length>0)&&(l=(e.items||t.enrichedItems).map((e,t)=>st.formatEcommerceItem(e,t)));const c={transaction_id:a,currency:n.currency||i,value:s,items:l,tax:r,shipping:o},d=n.vouchers?.[0]?.code||e.coupon||t.appliedCoupons?.[0]?.code;return d&&(c.coupon=d),st.clearListAttribution(),st.createEvent("purchase",{ecommerce:c,event_category:"ecommerce",event_value:s})}static createViewCartEvent(){const e=Q.getState(),t=st.getCurrency(),i=e.enrichedItems.map((e,t)=>st.formatEcommerceItem(e,t,{id:"cart",name:"Shopping Cart"})),n={currency:t,value:e.totals.total.value,items:i};return e.appliedCoupons?.[0]?.code&&(n.coupon=e.appliedCoupons[0].code),st.createEvent("view_cart",{ecommerce:n,event_category:"ecommerce",event_value:e.totals.total.value})}}class ot{static createUserDataEvent(e,t,i){const n={...st.getUserProperties(),...t};return st.createEvent(e,{user_properties:n,event_category:"user",...i})}static createSignUpEvent(e="email",t){return this.createUserDataEvent("sign_up",t,{event_label:e,custom_properties:{method:e,timestamp:(new Date).toISOString()}})}static createLoginEvent(e="email",t){const i={...t,visitor_type:t?.customer_id?"returning_customer":"guest"};return this.createUserDataEvent("login",i,{event_label:e,custom_properties:{method:e,timestamp:(new Date).toISOString()}})}static createSubscribeEvent(e="email",t,i){return this.createUserDataEvent("subscribe",i,{event_label:e,custom_properties:{channel:e,subscription_details:t,timestamp:(new Date).toISOString()}})}static createProfileUpdateEvent(e,t){return this.createUserDataEvent("profile_update",t,{event_label:`Updated: ${e.join(", ")}`,custom_properties:{updated_fields:e,timestamp:(new Date).toISOString()}})}static createEmailVerificationEvent(e,t){return this.createUserDataEvent("email_verification",t,{event_label:e,custom_properties:{verification_status:e,timestamp:(new Date).toISOString()}})}static createAccountDeletionEvent(e,t){return this.createUserDataEvent("account_deletion",t,{event_label:e||"user_initiated",custom_properties:{deletion_reason:e,timestamp:(new Date).toISOString()}})}static createPasswordResetEvent(e,t){return this.createUserDataEvent("password_reset",t,{event_label:e,custom_properties:{reset_step:e,timestamp:(new Date).toISOString()}})}static createConsentEvent(e,t,i){return this.createUserDataEvent("user_consent",i,{event_label:`${e}_${t?"granted":"denied"}`,custom_properties:{consent_type:e,consent_granted:t,timestamp:(new Date).toISOString()}})}}const lt=R("NextAnalytics");class ct{constructor(){this.initialized=!1,this.providers=new Map,this.validator=new at,this.listTracker=Ve.getInstance(),this.viewTracker=We.getInstance(),this.userTracker=Je.getInstance(),this.autoListener=Ze.getInstance(),"undefined"!=typeof window&&(window.NextDataLayerTransformFn=null)}static getInstance(){return ct.instance||(ct.instance=new ct),ct.instance}async initialize(){if(this.initialized)lt.debug("Analytics already initialized");else try{const e=oe.getState();if(!e.analytics?.enabled)return void lt.info("Analytics disabled in configuration");Me.initialize(),e.analytics.debug&&Me.setDebugMode(!0),await this.initializeProviders(e.analytics),Le.getInstance().processPendingEvents(),"auto"===e.analytics.mode&&this.initializeAutoTracking(),this.initialized=!0,lt.info("NextAnalytics initialized successfully",{providers:Array.from(this.providers.keys()),mode:e.analytics.mode}),this.track(ot.createUserDataEvent("dl_user_data"))}catch(e){throw lt.error("Failed to initialize analytics:",e),e}}async initializeProviders(e){if(e.providers?.nextCampaign?.enabled){const e=new Ne;await e.initialize(),this.providers.set("nextCampaign",e),Me.addProvider(e),lt.info("NextCampaign adapter initialized")}if(e.providers?.gtm?.enabled){const e=new $e;this.providers.set("gtm",e),Me.addProvider(e),lt.info("GTM adapter initialized")}if(e.providers?.facebook?.enabled&&e.providers.facebook.settings?.pixelId){const t=new qe(e.providers.facebook);this.providers.set("facebook",t),Me.addProvider(t),lt.info("Facebook Pixel adapter initialized",{blockedEvents:e.providers.facebook.blockedEvents||[]})}if(e.providers?.rudderstack?.enabled){const e=new Ue;this.providers.set("rudderstack",e),Me.addProvider(e),lt.info("RudderStack adapter initialized")}if(e.providers?.custom?.enabled&&e.providers.custom.settings?.endpoint){const t=new ze(e.providers.custom.settings);this.providers.set("custom",t),Me.addProvider(t),lt.info("Custom adapter initialized")}}initializeAutoTracking(){this.listTracker.initialize(),this.viewTracker.initialize(),this.userTracker.initialize(),this.autoListener.initialize(),lt.info("Auto-tracking initialized")}track(e){if(this.initialized||lt.warn("Analytics not initialized, queuing event:",e.event),Me.isDebugMode()){const t=this.validator.validateEvent(e);t.valid||(lt.error("Event validation failed:",t.errors),t.warnings.length>0&&lt.warn("Event validation warnings:",t.warnings))}Me.push(e)}setDebugMode(e){Me.setDebugMode(e),lt.info("Debug mode "+(e?"enabled":"disabled"))}setTransformFunction(e){Me.setTransformFunction(e)}invalidateContext(){Me.invalidateContext(),this.viewTracker.reset(),this.track(ot.createUserDataEvent("dl_user_data"))}getStatus(){return{initialized:this.initialized,debugMode:Me.isDebugMode(),providers:Array.from(this.providers.keys()),eventsTracked:Me.getEventCount()}}trackViewItemList(e,t,i){this.track(rt.createViewItemListEvent(e,t,i))}trackViewItem(e){this.track(rt.createViewItemEvent(e))}trackAddToCart(e,t,i){this.track(rt.createAddToCartEvent(e,t,i))}trackBeginCheckout(){this.track(rt.createBeginCheckoutEvent())}trackPurchase(e){this.track(rt.createPurchaseEvent(e))}trackSignUp(e){const t=e?{customer_email:e}:void 0;this.track(ot.createSignUpEvent("email",t))}trackLogin(e){const t=e?{customer_email:e}:void 0;this.track(ot.createLoginEvent("email",t))}}const dt=ct.getInstance();"undefined"!=typeof window&&(window.NextAnalytics=dt,window.NextDataLayerManager=Me,window.NextInvalidateContext=()=>{dt.invalidateContext()});const ut=Object.freeze(Object.defineProperty({__proto__:null,EcommerceEvents:rt,EventValidator:at,NextAnalytics:ct,UserEvents:ot,dataLayer:Me,nextAnalytics:dt},Symbol.toStringTag,{value:"Module"}));class pt{constructor(e){this.subscriptions=[],this.element=e,this.logger=R(this.constructor.name),this.eventBus=B.getInstance()}destroy(){this.subscriptions.forEach(e=>e()),this.subscriptions=[],this.cleanupEventListeners()}emit(e,t){this.eventBus.emit(e,t)}on(e,t){this.eventBus.on(e,t)}subscribe(e,t){const i=e.subscribe(t);this.subscriptions.push(i)}getAttribute(e){return this.element.getAttribute(e)}getRequiredAttribute(e){const t=this.getAttribute(e);if(!t)throw new Error(`Required attribute ${e} not found on element`);return t}hasAttribute(e){return this.element.hasAttribute(e)}setAttribute(e,t){this.element.setAttribute(e,t)}removeAttribute(e){this.element.removeAttribute(e)}addClass(e){this.element.classList.add(e)}removeClass(e){this.element.classList.remove(e)}hasClass(e){return this.element.classList.contains(e)}toggleClass(e,t){this.element.classList.toggle(e,t)}updateTextContent(e){this.element.textContent=e}updateInnerHTML(e){this.element.innerHTML=e}cleanupEventListeners(){}validateElement(){if(!this.element)throw new Error("Element is required")}handleError(e,t){const i=e instanceof Error?e.message:String(e);this.logger.error(`Error in ${t}:`,i),this.emit("error:occurred",{message:i,code:"ENHANCER_ERROR",details:{enhancer:this.constructor.name,context:t,element:this.element}})}}const ht=Object.freeze(Object.defineProperty({__proto__:null,ExitIntentEnhancer:class extends pt{constructor(){super(document.body),this.isEnabled=!1,this.triggerCount=0,this.lastTriggerTime=0,this.maxTriggers=3,this.cooldownPeriod=3e4,this.imageUrl="",this.action=null,this.popupElement=null,this.overlayElement=null,this.mouseLeaveHandler=null,this.scrollHandler=null}async initialize(){"loading"===document.readyState&&await new Promise(e=>{document.addEventListener("DOMContentLoaded",()=>e())})}async update(e){e&&"object"==typeof e&&e.image&&this.setup(e)}setup(e){this.imageUrl=e.image,this.action=e.action||null,this.isEnabled=!0,this.setupEventListeners(),this.logger.debug("Simple exit intent setup complete")}disable(){this.isEnabled=!1,this.cleanupEventListeners(),this.hidePopup()}setupEventListeners(){this.mouseLeaveHandler=e=>{this.shouldTrigger()&&e.clientY<=10&&this.triggerExitIntent()},document.addEventListener("mouseleave",this.mouseLeaveHandler),this.scrollHandler=()=>{if(this.shouldTrigger()){window.scrollY/(document.body.scrollHeight-window.innerHeight)*100>=50&&this.triggerExitIntent()}},window.addEventListener("scroll",this.scrollHandler,{passive:!0})}shouldTrigger(){return!!this.isEnabled&&(!this.popupElement&&(!(this.triggerCount>=this.maxTriggers)&&!(Date.now()-this.lastTriggerTime<this.cooldownPeriod)))}triggerExitIntent(){this.triggerCount++,this.lastTriggerTime=Date.now(),this.showPopup()}showPopup(){this.createPopupElements(),this.emit("exit-intent:shown",{imageUrl:this.imageUrl})}createPopupElements(){this.overlayElement=document.createElement("div"),this.overlayElement.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(0, 0, 0, 0.7);\n      z-index: 999999;\n      cursor: pointer;\n    ",this.popupElement=document.createElement("div"),this.popupElement.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      z-index: 1000000;\n      cursor: pointer;\n      max-width: 90vw;\n      max-height: 90vh;\n    ";const e=document.createElement("img");e.src=this.imageUrl,e.style.cssText="\n      max-width: 100%;\n      height: auto;\n      border-radius: 8px;\n      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\n    ",e.onerror=()=>{this.logger.error("Failed to load exit intent image:",this.imageUrl),this.hidePopup()},this.popupElement.appendChild(e),this.overlayElement.addEventListener("click",()=>{this.hidePopup(),this.emit("exit-intent:dismissed",{imageUrl:this.imageUrl})}),this.popupElement.addEventListener("click",async e=>{if(e.stopPropagation(),this.emit("exit-intent:clicked",{imageUrl:this.imageUrl}),this.action)try{await this.action()}catch(t){this.logger.error("Exit intent action failed:",t)}this.hidePopup()});const t=e=>{"Escape"===e.key&&(this.hidePopup(),this.emit("exit-intent:dismissed",{imageUrl:this.imageUrl}),document.removeEventListener("keydown",t))};document.addEventListener("keydown",t),document.body.appendChild(this.overlayElement),document.body.appendChild(this.popupElement),requestAnimationFrame(()=>{this.overlayElement&&(this.overlayElement.style.opacity="1"),this.popupElement&&(this.popupElement.style.opacity="0",this.popupElement.style.transform="translate(-50%, -50%) scale(0.8)",this.popupElement.style.transition="all 0.3s ease",requestAnimationFrame(()=>{this.popupElement&&(this.popupElement.style.opacity="1",this.popupElement.style.transform="translate(-50%, -50%) scale(1)")}))})}hidePopup(){this.popupElement&&(this.popupElement.style.transition="all 0.2s ease",this.popupElement.style.opacity="0",this.popupElement.style.transform="translate(-50%, -50%) scale(0.8)",setTimeout(()=>{this.popupElement&&(this.popupElement.remove(),this.popupElement=null)},200)),this.overlayElement&&(this.overlayElement.style.transition="opacity 0.2s ease",this.overlayElement.style.opacity="0",setTimeout(()=>{this.overlayElement&&(this.overlayElement.remove(),this.overlayElement=null)},200))}cleanupEventListeners(){this.mouseLeaveHandler&&(document.removeEventListener("mouseleave",this.mouseLeaveHandler),this.mouseLeaveHandler=null),this.scrollHandler&&(window.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null),this.hidePopup()}destroy(){this.cleanupEventListeners(),super.destroy()}}},Symbol.toStringTag,{value:"Module"}));const gt=Object.freeze(Object.defineProperty({__proto__:null,FomoPopupEnhancer:class extends pt{constructor(){super(document.body),this.isActive=!1,this.showCount=0,this.popupElement=null,this.timeoutIds=[],this.defaultItems=[],this.defaultCustomers={AU:["Jessica from Sydney","Emma from Melbourne","Olivia from Brisbane","Sophia from Perth"],GB:["Jane from London","Olivia from Manchester","Amelia from Birmingham","Isabella from Leeds"],CA:["Lily from Toronto","Emma from Vancouver","Ava from Montreal","Sophia from Calgary"],US:["Grace from New York","Hailey from Sacramento","Phoebe from Las Vegas","Jenny from Scottsdale"]},this.loadItemsFromCampaign(),this.config={items:this.defaultItems,customers:this.defaultCustomers,maxMobileShows:2,displayDuration:5e3,delayBetween:12e3,initialDelay:0,country:"US"}}async update(e){e&&this.setup(e)}loadItemsFromCampaign(){const e=Y.getState();e.data?.packages&&(this.defaultItems=e.data.packages.slice(0,5).map(e=>({text:e.name,image:e.image||""})).filter(e=>e.image)),0===this.defaultItems.length&&(this.defaultItems=[{text:"Popular Package",image:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ddd'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23999'%3EProduct%3C/text%3E%3C/svg%3E"}])}async initialize(){"loading"===document.readyState&&await new Promise(e=>{document.addEventListener("DOMContentLoaded",()=>e())}),this.injectStyles()}setup(e={}){e.items||this.loadItemsFromCampaign(),this.config={...this.config,...e,items:e.items||this.defaultItems,customers:void 0!==e.customers?e.customers:this.config.customers},e.country||(this.config.country=this.detectCountry()),this.logger.debug("FOMO popup configured:",this.config)}start(){if(this.isActive)return;this.isActive=!0,this.createPopupElement();const e=window.setTimeout(()=>{this.showNextPopup()},this.config.initialDelay||0);this.timeoutIds.push(e)}stop(){this.isActive=!1,this.timeoutIds.forEach(e=>clearTimeout(e)),this.timeoutIds=[],this.hidePopup(),this.showCount=0}showNextPopup(){if(!this.isActive)return;if(window.innerWidth<=768&&this.showCount>=(this.config.maxMobileShows||2))return void this.stop();const e=this.getRandomItem(),t=this.getRandomCustomer();this.updatePopupContent(e,t),this.showPopup();const i=window.setTimeout(()=>{this.hidePopup();const e=window.setTimeout(()=>{this.showNextPopup()},this.config.delayBetween||12e3);this.timeoutIds.push(e)},this.config.displayDuration||5e3);this.timeoutIds.push(i),this.showCount++}getRandomItem(){const e=this.config.items||[];return 0===e.length?{text:"Popular Package",image:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ddd'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23999'%3EProduct%3C/text%3E%3C/svg%3E"}:e[Math.floor(Math.random()*e.length)]}getRandomCustomer(){const e=this.config.country||"US",t=this.config.customers?.[e]||this.config.customers?.US||[];return t[Math.floor(Math.random()*t.length)]||"Someone"}detectCountry(){const e=Intl.DateTimeFormat().resolvedOptions().timeZone;return e.includes("Australia")?"AU":e.includes("London")||e.includes("Dublin")?"GB":e.includes("Toronto")||e.includes("Vancouver")?"CA":"US"}createPopupElement(){this.popupElement||(this.popupElement=document.createElement("div"),this.popupElement.className="next-fomo-wrapper",this.popupElement.innerHTML='\n      <div class="next-fomo-inner">\n        <div class="next-fomo-item">\n          <div class="next-fomo-thumb">\n            <img class="next-fomo-image" alt="Product">\n          </div>\n          <div class="next-fomo-desc">\n            <p>\n              <span class="next-fomo-customer"></span><br>\n              Just purchased:<br>\n              <span class="next-fomo-product"></span><br>\n              <span class="next-fomo-time">JUST NOW</span>\n            </p>\n          </div>\n        </div>\n      </div>\n    ',document.body.appendChild(this.popupElement))}updatePopupContent(e,t){if(!this.popupElement)return;const i=this.popupElement.querySelector(".next-fomo-image"),n=this.popupElement.querySelector(".next-fomo-customer"),a=this.popupElement.querySelector(".next-fomo-product");i&&(i.src=e.image),n&&(n.textContent=t),a&&(a.textContent=e.text),this.emit("fomo:shown",{customer:t,product:e.text,image:e.image})}showPopup(){this.popupElement&&(this.popupElement.style.display="none",this.popupElement.offsetHeight,this.popupElement.style.display="",requestAnimationFrame(()=>{this.popupElement&&this.popupElement.classList.add("next-fomo-show")}))}hidePopup(){this.popupElement&&this.popupElement.classList.remove("next-fomo-show")}injectStyles(){if(document.getElementById("next-fomo-styles"))return;const e=document.createElement("style");e.id="next-fomo-styles",e.textContent="\n      .next-fomo-wrapper {\n        position: fixed;\n        bottom: 20px;\n        left: 20px;\n        width: 320px;\n        background: white;\n        border-radius: 10px;\n        box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n        transform: translateY(120%);\n        transition: transform 0.8s ease;\n        z-index: 999998;\n      }\n      \n      .next-fomo-wrapper.next-fomo-show {\n        transform: translateY(0);\n      }\n      \n      @media (max-width: 768px) {\n        .next-fomo-wrapper {\n          width: calc(100% - 40px);\n          max-width: 320px;\n        }\n      }\n      \n      .next-fomo-item {\n        display: flex;\n        padding: 15px;\n        align-items: center;\n      }\n      \n      .next-fomo-thumb {\n        flex-shrink: 0;\n        margin-right: 15px;\n      }\n      \n      .next-fomo-thumb img {\n        width: 60px;\n        height: 60px;\n        object-fit: cover;\n        border-radius: 8px;\n      }\n      \n      .next-fomo-desc {\n        flex: 1;\n      }\n      \n      .next-fomo-desc p {\n        margin: 0;\n        font-size: 13px;\n        line-height: 1.4;\n        color: #333;\n      }\n      \n      .next-fomo-customer {\n        font-weight: 600;\n        color: #000;\n      }\n      \n      .next-fomo-product {\n        font-weight: 600;\n        color: #000;\n      }\n      \n      .next-fomo-time {\n        font-size: 11px;\n        color: #999;\n        text-transform: uppercase;\n      }\n    ",document.head.appendChild(e)}cleanupEventListeners(){this.stop(),this.popupElement&&(this.popupElement.remove(),this.popupElement=null)}destroy(){this.cleanupEventListeners(),super.destroy()}}},Symbol.toStringTag,{value:"Module"})),mt=R("AttributionCollector");const ft=Object.freeze(Object.defineProperty({__proto__:null,AttributionCollector:class{async collect(){const e=this.collectMetadata();return{affiliate:this.getStoredValue("affid")||this.getStoredValue("aff")||"",funnel:this.getFunnelName(),gclid:this.getStoredValue("gclid")||"",utm_source:this.getStoredValue("utm_source")||"",utm_medium:this.getStoredValue("utm_medium")||"",utm_campaign:this.getStoredValue("utm_campaign")||"",utm_content:this.getStoredValue("utm_content")||"",utm_term:this.getStoredValue("utm_term")||"",subaffiliate1:this.getStoredValue("subaffiliate1")||this.getStoredValue("sub1")||"",subaffiliate2:this.getStoredValue("subaffiliate2")||this.getStoredValue("sub2")||"",subaffiliate3:this.getStoredValue("subaffiliate3")||this.getStoredValue("sub3")||"",subaffiliate4:this.getStoredValue("subaffiliate4")||this.getStoredValue("sub4")||"",subaffiliate5:this.getStoredValue("subaffiliate5")||this.getStoredValue("sub5")||"",metadata:e,first_visit_timestamp:this.getFirstVisitTimestamp(),current_visit_timestamp:Date.now()}}collectMetadata(){const e={landing_page:window.location.href,referrer:document.referrer||"",device:navigator.userAgent||"",device_type:this.getDeviceType(),domain:window.location.hostname,timestamp:Date.now(),fb_fbp:this.getCookie("_fbp")||"",fb_fbc:this.getCookie("_fbc")||"",fb_pixel_id:this.getFacebookPixelId()},t=this.getStoredValue("fbclid");return t&&(e.fbclid=t),this.handleEverflowClickId(e),this.collectTrackingTags(e),e}getStoredValue(e){const t=new URLSearchParams(window.location.search);if(t.has(e)){const n=t.get(e)||"";try{sessionStorage.setItem(e,n)}catch(i){}return n}try{const t=sessionStorage.getItem(e);if(t)return t}catch(i){}try{const t=localStorage.getItem(e);if(t)return t}catch(i){}try{const t=localStorage.getItem("next-attribution");if(t){const i=JSON.parse(t);if(i.state&&i.state[e])return i.state[e]}}catch(i){}return""}getCookie(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length&&t.pop()?.split(";").shift()||""}getDeviceType(){const e=navigator.userAgent;return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e)?"mobile":"desktop"}getFunnelName(){try{const e=sessionStorage.getItem("next_funnel_name");if(e)return mt.debug(`Using persisted funnel from session: ${e}`),e;const t=localStorage.getItem("next_funnel_name");if(t)return mt.debug(`Using persisted funnel from localStorage: ${t}`),sessionStorage.setItem("next_funnel_name",t),t;const i=localStorage.getItem("next-attribution");if(i){const e=JSON.parse(i);if(e.state&&e.state.funnel)return mt.debug(`Using persisted funnel from attribution: ${e.state.funnel}`),sessionStorage.setItem("next_funnel_name",e.state.funnel),localStorage.setItem("next_funnel_name",e.state.funnel),e.state.funnel}}catch(t){}const e=document.querySelector('meta[name="os-tracking-tag"][data-tag-name="funnel_name"], meta[name="data-next-tracking-tag"][data-tag-name="funnel_name"], meta[name="next-funnel"]');if(e){const i=e.getAttribute("data-tag-value")||e.getAttribute("content");if(i){mt.debug(`New funnel found from meta tag: ${i}`);try{sessionStorage.setItem("next_funnel_name",i),localStorage.setItem("next_funnel_name",i),mt.info(`Persisted funnel name: ${i}`)}catch(t){}return i}}return""}handleEverflowClickId(e){const t=new URLSearchParams(window.location.search);let i=localStorage.getItem("evclid");if(t.has("evclid")?(i=t.get("evclid")||"",localStorage.setItem("evclid",i),sessionStorage.setItem("evclid",i),mt.debug(`Everflow click ID found in URL: ${i}`)):!i&&sessionStorage.getItem("evclid")&&(i=sessionStorage.getItem("evclid"),i&&(localStorage.setItem("evclid",i),mt.debug(`Everflow click ID found in sessionStorage: ${i}`))),t.has("sg_evclid")){const i=t.get("sg_evclid")||"";sessionStorage.setItem("sg_evclid",i),localStorage.setItem("sg_evclid",i),e.sg_evclid=i,mt.debug(`SG Everflow click ID found: ${i}`)}else{const t=localStorage.getItem("sg_evclid");t&&(e.sg_evclid=t)}i&&(e.everflow_transaction_id=i,mt.debug(`Added Everflow transaction ID to metadata: ${i}`))}collectTrackingTags(e){const t=document.querySelectorAll('meta[name="os-tracking-tag"], meta[name="data-next-tracking-tag"]');mt.debug(`Found ${t.length} tracking tags`),t.forEach(t=>{const i=t.getAttribute("data-tag-name"),n=t.getAttribute("data-tag-value"),a="true"===t.getAttribute("data-persist");if(i&&n&&(e[i]=n,mt.debug(`Added tracking tag: ${i} = ${n}`),a))try{sessionStorage.setItem(`tn_tag_${i}`,n),mt.debug(`Persisted tracking tag: ${i}`)}catch(s){}})}getFacebookPixelId(){const e=document.querySelector('meta[name="os-facebook-pixel"], meta[name="facebook-pixel-id"]');if(e){const t=e.getAttribute("content");if(t)return mt.debug(`Facebook Pixel ID found from meta tag: ${t}`),t}const t=document.querySelectorAll("script");for(const i of t){const e=i.textContent||"";if(e.includes("fbq(")&&e.includes("init")){const t=e.match(/fbq\s*\(\s*['"]init['"],\s*['"](\d+)['"]/);if(t&&t[1])return mt.debug(`Facebook Pixel ID found from script: ${t[1]}`),t[1]}}return""}getFirstVisitTimestamp(){try{const e=localStorage.getItem("next-attribution");if(e){const t=JSON.parse(e);if(t.state&&t.state.first_visit_timestamp)return t.state.first_visit_timestamp}}catch(e){}return Date.now()}}},Symbol.toStringTag,{value:"Module"})),yt={cart:{isEmpty:"isEmpty",hasItems:"!isEmpty",hasSavings:"totals.hasSavings",hasTotalSavings:"totals.hasTotalSavings",quantity:"totalQuantity",itemCount:"items.length",count:"totals.count",subtotal:{path:"totals.subtotal.formatted",preformatted:!0},total:{path:"totals.total.formatted",preformatted:!0},shipping:{path:"totals.shipping.formatted",preformatted:!0},tax:{path:"totals.tax.formatted",preformatted:!0},discounts:{path:"totals.discounts.formatted",preformatted:!0},savingsAmount:{path:"totals.savings.formatted",preformatted:!0,fallback:"$0.00"},savingsPercentage:{path:"totals.savingsPercentage.formatted",preformatted:!0,fallback:"0%"},compareTotal:{path:"totals.compareTotal.formatted",preformatted:!0},totalSavingsAmount:{path:"totals.totalSavings.formatted",preformatted:!0,fallback:"$0.00"},totalSavingsPercentage:{path:"totals.totalSavingsPercentage.formatted",preformatted:!0,fallback:"0%"},"subtotal.raw":{path:"totals.subtotal.value",format:"currency"},"total.raw":{path:"totals.total.value",format:"currency"},"shipping.raw":{path:"totals.shipping.value",format:"currency"},"tax.raw":{path:"totals.tax.value",format:"currency"},"discounts.raw":{path:"totals.discounts.value",format:"currency"},"savingsAmount.raw":{path:"totals.savings.value",format:"currency"},"savingsPercentage.raw":{path:"totals.savingsPercentage.value",format:"percentage"},"compareTotal.raw":{path:"totals.compareTotal.value",format:"currency"},"totalSavingsAmount.raw":{path:"totals.totalSavings.value",format:"currency"},"totalSavingsPercentage.raw":{path:"totals.totalSavingsPercentage.value",format:"percentage"},hasCoupons:{path:"appliedCoupons.length",format:"boolean",validator:e=>e>0},hasCoupon:{path:"appliedCoupons.length",format:"boolean",validator:e=>e>0},couponCount:{path:"appliedCoupons.length",format:"number"},"coupons[0].code":{path:"appliedCoupons.0.code",format:"text"},"coupons[0].discount":{path:"appliedCoupons.0.discount",format:"currency"},"coupons[1].code":{path:"appliedCoupons.1.code",format:"text"},"coupons[1].discount":{path:"appliedCoupons.1.discount",format:"currency"},discountCode:{path:"appliedCoupons.0.code",format:"text",fallback:""},discountCodes:{path:"appliedCoupons",format:"text",validator:e=>Array.isArray(e)&&0!==e.length?e.map(e=>e.code).join(", "):""}},package:{ref_id:{path:"ref_id",format:"number"},external_id:"external_id",qty:{path:"qty",format:"number"},price:{path:"price",format:"currency"},price_total:{path:"price_total",format:"currency"},price_retail:{path:"price_retail",format:"currency"},price_retail_total:{path:"price_retail_total",format:"currency"},price_recurring:{path:"price_recurring",format:"currency"},is_recurring:"is_recurring",interval:"interval",interval_count:{path:"interval_count",format:"number"},unitPrice:{path:"_calculated.unitPrice",format:"currency"},unitRetailPrice:{path:"_calculated.unitRetailPrice",format:"currency"},packageTotal:{path:"price_total",format:"currency"},comparePrice:{path:"price_retail_total",format:"currency"},compareTotal:{path:"price_retail_total",format:"currency"},savingsAmount:{path:"_calculated.savingsAmount",format:"currency",validator:e=>Math.max(0,Number(e)||0),fallback:0,debugInfo:!0},savingsPercentage:{path:"_calculated.savingsPercentage",format:"percentage",validator:e=>Math.min(100,Math.max(0,Number(e)||0)),fallback:0},unitSavings:{path:"_calculated.unitSavings",format:"currency"},unitSavingsPercentage:{path:"_calculated.unitSavingsPercentage",format:"percentage"},hasSavings:"_calculated.hasSavings",isRecurring:"is_recurring",isBundle:"_calculated.isBundle",unitsInPackage:{path:"qty",format:"number"},discountedPrice:{path:"_calculated.discountedPrice",format:"currency"},discountedPriceTotal:{path:"_calculated.discountedPriceTotal",format:"currency"},discountAmount:{path:"_calculated.discountAmount",format:"currency"},hasDiscount:"_calculated.hasDiscount",finalPrice:{path:"_calculated.finalPrice",format:"currency"},finalPriceTotal:{path:"_calculated.finalPriceTotal",format:"currency"}},selection:{hasSelection:{path:"hasSelection",format:"boolean"},packageId:{path:"packageId",format:"number"},quantity:{path:"quantity",format:"number"},name:"name",price:{path:"price",format:"currency"},total:{path:"total",format:"currency"},compareTotal:{path:"compareTotal",format:"currency"},unitPrice:{path:"unitPrice",format:"currency"},savingsAmount:{path:"savingsAmount",format:"currency"},savingsPercentage:{path:"savingsPercentage",format:"percentage"},hasSavings:{path:"hasSavings",format:"boolean"},isBundle:{path:"isBundle",format:"boolean"},totalUnits:{path:"totalUnits",format:"number"},monthlyPrice:{path:"monthlyPrice",format:"currency"},yearlyPrice:{path:"yearlyPrice",format:"currency"},pricePerDay:{path:"pricePerDay",format:"currency"},savingsPerUnit:{path:"savingsPerUnit",format:"currency"},discountAmount:{path:"discountAmount",format:"currency"},price_total:{path:"total",format:"currency"},price_retail_total:{path:"compareTotal",format:"currency"},savings:{path:"savingsAmount",format:"currency"},pricePerUnit:{path:"unitPrice",format:"currency"},totalQuantity:{path:"totalUnits",format:"number"},isMultiPack:{path:"isBundle",format:"boolean"},isSingleUnit:{path:"isSingleUnit",format:"boolean"},_expression:!0},shipping:{isFree:"_calculated.isFree",cost:"_calculated.cost",price:"_calculated.price",name:"_calculated.name",code:"_calculated.code",method:"_calculated.method",id:"_calculated.id",refId:"_calculated.refId"},order:{isLoading:"isLoading",hasError:"error",errorMessage:"error",id:"order.id",number:"order.number",ref_id:"order.ref_id",created_at:{path:"created_at",format:"date"},total_incl_tax:{path:"total_incl_tax",format:"currency"},order_status_url:"order_status_url",is_test:"is_test",supports_upsells:"supports_upsells",payment_method:{path:"payment_method",format:"text"},shipping_method:{path:"shipping_method",format:"text"},refId:"order.ref_id",createdAt:{path:"order.created_at",format:"date"},total:{path:"order.total_incl_tax",format:"currency",fallback:0},statusUrl:"order.order_status_url",isTest:"order.is_test",supportsUpsells:"order.supports_post_purchase_upsells",paymentMethod:{path:"order.payment_method",format:"text",fallback:"Credit Card"},shippingMethod:{path:"order.shipping_method",format:"text"},status:{path:"order.status",fallback:"Completed"},currency:"order.currency",testBadge:{path:"order.is_test",format:"text"},subtotal:{path:"order.total_excl_tax",format:"currency"},tax:{path:"order.total_tax",format:"currency"},shipping:{path:"order.shipping_incl_tax",format:"currency"},shippingExclTax:{path:"order.shipping_excl_tax",format:"currency"},shippingTax:{path:"order.shipping_tax",format:"currency"},discounts:{path:"order.total_discounts",format:"currency"},savings:{path:"_calculated.savings",format:"currency"},savingsAmount:{path:"_calculated.savingsAmount",format:"currency"},savingsPercentage:{path:"_calculated.savingsPercentage",format:"percentage"},hasSavings:"_calculated.hasSavings","customer.name":"customer.name","customer.firstName":"customer.firstName","customer.lastName":"customer.lastName","customer.email":"customer.email","customer.phone":"customer.phone","shippingAddress.full":{path:"shippingAddress.full",format:"text"},"shippingAddress.line1":{path:"shippingAddress.line1",format:"text"},"shippingAddress.line2":{path:"shippingAddress.line2",format:"text"},"shippingAddress.city":{path:"shippingAddress.city",format:"text"},"shippingAddress.state":{path:"shippingAddress.state",format:"text"},"shippingAddress.country":{path:"shippingAddress.country",format:"text"},"shippingAddress.zip":{path:"shippingAddress.zip",format:"text"},"shippingAddress.postcode":{path:"shippingAddress.postcode",format:"text"},"billingAddress.full":{path:"billingAddress.full",format:"text"},"billingAddress.line1":{path:"billingAddress.line1",format:"text"},"billingAddress.line2":{path:"billingAddress.line2",format:"text"},"billingAddress.city":{path:"billingAddress.city",format:"text"},"billingAddress.state":{path:"billingAddress.state",format:"text"},"billingAddress.country":{path:"billingAddress.country",format:"text"},"billingAddress.zip":{path:"billingAddress.zip",format:"text"},"billingAddress.postcode":{path:"billingAddress.postcode",format:"text"},hasItems:"_calculated.hasItems",isEmpty:"_calculated.isEmpty",hasShipping:"_calculated.hasShipping",hasTax:"_calculated.hasTax",hasDiscounts:"_calculated.hasDiscounts",hasUpsells:"_calculated.hasUpsells","lines.count":"_calculated.lines.count","lines.totalQuantity":"_calculated.lines.totalQuantity","lines.upsellCount":"_calculated.lines.upsellCount","lines.mainProduct":"_calculated.lines.mainProduct","lines.mainProductSku":"_calculated.lines.mainProductSku","total.formatted":"_formatted.total","createdAt.formatted":"_formatted.createdAt"}};function vt(e,t){const i=yt[e];if(!i)return null;const n=i[t];return n&&"boolean"!=typeof n?"string"==typeof n?{path:n}:n:null}function bt(e,t){const i=vt(e,t);return i?.path}class xt{static validatePercentage(e){const t=Number(e);return isNaN(t)?0:t>1&&t<=100?t:t>=0&&t<=1?100*t:t>100?100:Math.max(0,t)}static validateCurrency(e){if("string"==typeof e){const t=e.replace(/[$,]/g,"").trim(),i=Number(t);if(!isNaN(i))return Math.round(100*i)/100}const t=Number(e);return isNaN(t)?0:Math.round(100*t)/100}static validateNumber(e){const t=Number(e);return isNaN(t)?0:t}static validateBoolean(e){if("boolean"==typeof e)return e;if("string"==typeof e){const t=e.toLowerCase();return"true"===t||"1"===t||"yes"===t}return!!e}static validateDate(e){if(!e)return null;try{const t=new Date(e);return isNaN(t.getTime())?null:t}catch{return null}}static validateString(e){return null==e?"":String(e)}}const wt=class{static wrap(e,t,i){try{return e()}catch(n){return this.handleError(n,i||{operation:"unknown"}),t}}static async wrapAsync(e,t,i){try{return await e()}catch(n){return this.handleError(n,i||{operation:"unknown"}),t}}static tryStrategies(e,t,i){for(let a=0;a<e.length;a++)try{const t=e[a];if(t)return t()}catch(n){a===e.length-1&&this.handleError(n,{...i,operation:i?.operation||"tryStrategies",strategy:a})}return t}static addErrorHandler(e){this.errorHandlers.push(e)}static removeErrorHandler(e){const t=this.errorHandlers.indexOf(e);t>-1&&this.errorHandlers.splice(t,1)}static handleError(e,t){const i=`${t.operation}:${e.message}`,n=Date.now(),a=this.errorCache.get(i);if(a)if(n-a.lastError.getTime()<this.ERROR_WINDOW_MS){if(a.count++,a.count>this.ERROR_THRESHOLD)return}else a.count=1,a.lastError=new Date(n);else this.errorCache.set(i,{count:1,lastError:new Date(n)});this.logger.error(`[Display Error] ${t.operation}:`,{error:e.message,stack:e.stack,context:t}),this.errorHandlers.forEach(i=>{try{i(e,t)}catch(n){this.logger.error("Error in error handler:",n)}})}static clearErrorCache(){this.errorCache.clear()}static getErrorStats(){return new Map(this.errorCache)}};wt.logger=new N("DisplayErrorBoundary"),wt.errorHandlers=[],wt.errorCache=new Map,wt.ERROR_THRESHOLD=5,wt.ERROR_WINDOW_MS=6e4;let St=wt;const _t=class{static formatValue(e,t="auto",i){return St.wrap(()=>{if(null==e)return"";switch(t){case"currency":return this.formatCurrency(e,i?.hideZeroCents);case"number":return this.formatNumber(e);case"boolean":return this.formatBoolean(e);case"date":return this.formatDate(e);case"percentage":return this.formatPercentage(e);case"text":return String(e);default:return this.formatAuto(e,i)}},"",{operation:"formatValue",value:String(e),format:String(t)})}static formatCurrency(e,t){if("string"==typeof e&&e.includes("$"))return e;const i=xt.validateCurrency(e);return t?this.currencyFormatterNoZeroCents.format(i):this.currencyFormatter.format(i)}static formatNumber(e){const t=xt.validateNumber(e);return this.numberFormatter.format(t)}static formatBoolean(e){if("boolean"==typeof e)return e?"Yes":"No";if("string"==typeof e){const t=e.toLowerCase();if("true"===t||"1"===t||"yes"===t)return"Yes";if("false"===t||"0"===t||"no"===t)return"No"}return e?"Yes":"No"}static formatDate(e){if(!e)return"";try{const t=new Date(e);return isNaN(t.getTime())?String(e):this.dateFormatter.format(t)}catch{return String(e)}}static formatPercentage(e){const t=xt.validatePercentage(e);return`${Math.round(t)}%`}static formatAuto(e,t){if("boolean"==typeof e)return this.formatBoolean(e);if("number"==typeof e){if(Number.isInteger(e)&&e>=0&&e<=10)return e.toString();const i=e.toString();return i.includes(".")&&2===i.split(".")[1]?.length?this.formatCurrency(e,t?.hideZeroCents):(Number.isInteger(e),this.formatNumber(e))}if("string"==typeof e){const i=new Date(e);if(!isNaN(i.getTime())&&e.match(/\d{4}-\d{2}-\d{2}/))return this.formatDate(e);const n=Number(e);if(!isNaN(n)&&e.includes(".")){const e=n.toString();return e.includes(".")&&2===e.split(".")[1]?.length?this.formatCurrency(n,t?.hideZeroCents):this.formatNumber(n)}}return String(e)}};_t.currencyFormatter=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),_t.currencyFormatterNoZeroCents=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:2}),_t.numberFormatter=new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}),_t.dateFormatter=new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});let kt=_t;class Ct{static getNestedProperty(e,t){if(!e||!t)return;const i=t.split(".");let n=e;for(const a of i){if(null==n)return;if(a.includes("[")&&a.includes("]")){const[e,t]=a.split("["),i=parseInt(t?.replace("]","")||"");if(!e||isNaN(i))return;if(n=n[e],!(Array.isArray(n)&&i>=0&&i<n.length))return;n=n[i]}else n=n[a]}return n}static hasProperty(e,t){return void 0!==this.getNestedProperty(e,t)}static getPropertyWithFallbacks(e,t){for(const i of t){const t=this.getNestedProperty(e,i);if(void 0!==t)return t}}}class Et extends pt{constructor(){super(...arguments),this.formatType="auto",this.hideIfZero=!1,this.hideIfFalse=!1,this.hideZeroCents=!1,this.debugMode=!1}async initialize(){this.validateElement(),this.parseDisplayAttributes(),this.setupStoreSubscriptions(),await this.performInitialUpdate(),this.logger.debug(`${this.constructor.name} initialized with path: ${this.displayPath}`)}parseDisplayAttributes(){const e=this.getAttribute("data-next-display");if(!e)throw new Error(`${this.constructor.name}: data-next-display attribute is required`);this.displayPath=e;const t=me.parseDisplayPath(this.displayPath);this.property=t.property;const i=this.getAttribute("data-next-format")||this.getAttribute("data-format"),n=this.getDefaultFormatType(this.property||"");this.formatType=i||n,this.hideIfZero="true"===this.getAttribute("data-hide-if-zero"),this.hideIfFalse="true"===this.getAttribute("data-hide-if-false"),this.hideZeroCents="true"===this.getAttribute("data-hide-zero-cents");const a=this.getAttribute("data-divide-by");a&&(this.divideBy=parseFloat(a));const s=this.getAttribute("data-multiply-by");s&&(this.multiplyBy=parseFloat(s))}getDefaultFormatType(e){if(this.displayPath){const e=this.displayPath.split(".");if(e.length>=2){const[t,...i]=e;let n=i.join(".");"selection"===t&&i.length>=2&&(n=i.slice(1).join("."));const a=vt(t,n);if(a?.format)return a.format}}const t=e.toLowerCase();return t.endsWith(".raw")?"auto":t.includes("percentage")||t.includes("percent")||t.endsWith("pct")||t.endsWith("rate")?"percentage":["price","cost","amount","total","subtotal","retail","compare","savings","shipping","tax","discount","fee","charge","payment","balance","credit","debit","refund","revenue","msrp","value"].some(e=>t.includes(e))?"currency":t.startsWith("is")||t.startsWith("has")||t.startsWith("can")||t.startsWith("should")||t.startsWith("enabled")||t.startsWith("disabled")||t.includes("visible")||t.includes("active")?"boolean":t.includes("date")||t.includes("time")||t.endsWith("at")||t.endsWith("on")?"date":t.includes("quantity")||t.includes("count")||t.includes("qty")||t.includes("units")||t.includes("items")?"number":"auto"}getPropertyValueWithValidation(){return St.wrap(()=>{const e=this.getPropertyValue();if(this.displayPath){const i=me.parseDisplayPath(this.displayPath),n=vt(i.object,this.property||i.property);if(n){let i=e;if(n.validator&&null!=i)try{i=n.validator(i)}catch(t){this.logger.warn(`Validator failed for ${this.displayPath}:`,t),i=n.fallback}return null==i&&void 0!==n.fallback&&(i=n.fallback),i}}return e},void 0,{operation:"getPropertyValueWithValidation",property:this.property||"unknown",path:this.displayPath||"unknown"})}async performInitialUpdate(){await this.updateDisplay()}async updateDisplay(){if("none"!==this.element.style.display&&!this.element.classList.contains("next-hidden"))try{let e,t,i=this.getPropertyValueWithValidation();if(i&&"object"==typeof i&&"_preformatted"in i){const e=i.value||"";return this.updateElementContent(e),this.showElement(),void(this.debugMode&&this.element.setAttribute("data-format-debug",JSON.stringify({path:this.displayPath,property:this.property,format:"preformatted",rawValue:i,formattedValue:e})))}if(i&&"object"==typeof i&&"value"in i&&"format"in i){const n=i;e=n.value,t=n.format,n.metadata}else e=i;if("number"==typeof e||"string"==typeof e&&!isNaN(Number(e))){const t=Number(e);this.divideBy&&(e=t/this.divideBy),this.multiplyBy&&(e=t*this.multiplyBy)}if(e===this.lastValue)return;if(this.lastValue=e,this.shouldHideElement(e))return void this.hideElement();let n=t||this.formatType;!t&&this.property&&this.property.toLowerCase().includes("percentage")&&"auto"===this.formatType&&(n="percentage");const a=kt.formatValue(e,n,{hideZeroCents:this.hideZeroCents});this.debugMode&&this.element.setAttribute("data-format-debug",JSON.stringify({path:this.displayPath,property:this.property,format:n,rawValue:i,formattedValue:a})),this.updateElementContent(a),this.showElement()}catch(e){this.handleError(e,"updateDisplay"),this.updateElementContent("N/A")}}shouldHideElement(e){return!(!this.hideIfZero||0!==e&&"0"!==e&&0!==e)||!(!this.hideIfFalse||e)}updateElementContent(e){this.element instanceof HTMLInputElement||this.element instanceof HTMLTextAreaElement?this.element.value=e:this.element.textContent=e}hideElement(){this.element.style.display="none",this.addClass("display-hidden"),this.removeClass("display-visible")}showElement(){this.element.style.display="",this.addClass("display-visible"),this.removeClass("display-hidden")}update(){this.updateDisplay()}}const It=class{static findPackageId(e){let t=e.parentElement;for(;t;){for(const e of this.PACKAGE_ID_ATTRS){const i=t.getAttribute(e);if(i){const e=parseInt(i,10);if(!isNaN(e))return this.logger.debug(`Found context package ID: ${e} from element:`,t),e}}t=t.parentElement}this.logger.debug("No context package ID found in parent elements")}static getPackageId(e){for(const t of this.PACKAGE_ID_ATTRS){const i=e.getAttribute(t);if(i){const t=parseInt(i,10);if(!isNaN(t))return this.logger.debug(`Found direct package ID: ${t} from element:`,e),t}}return this.findPackageId(e)}};It.logger=R("PackageContextResolver"),It.PACKAGE_ID_ATTRS=["data-next-package-id","data-next-package","data-package-id"];let Pt=It;const At=Object.freeze(Object.defineProperty({__proto__:null,CartDisplayEnhancer:class extends Et{setupStoreSubscriptions(){this.subscribe(Q,this.handleCartUpdate.bind(this)),this.cartState=Q.getState()}handleCartUpdate(e){this.cartState=e,this.toggleClass("next-cart-empty",e.isEmpty),this.toggleClass("next-cart-has-items",!e.isEmpty),this.updateDisplay()}getPropertyValue(){if(!this.cartState||!this.property)return;const e=vt("cart",this.property);if(e){const{path:t,preformatted:i}=e;if(t.startsWith("!")){const e=t.substring(1);return!Ct.getNestedProperty(this.cartState,e)}const n=Ct.getNestedProperty(this.cartState,t);return i?{_preformatted:!0,value:n}:n}return Ct.getNestedProperty(this.cartState,this.property)}async performInitialUpdate(){if(this.displayPath){"package"===me.parseDisplayPath(this.displayPath).object&&this.logger.warn(`CartDisplayEnhancer is handling package property "${this.displayPath}" - this may be incorrect!`,{element:this.element.outerHTML.substring(0,200)+"...",hasPackageContext:void 0!==Pt.findPackageId(this.element)})}await super.performInitialUpdate()}getCartProperty(e,t){const i=this.cartState,n=this.property;this.cartState=e,this.property=t;const a=this.getPropertyValue();return void 0!==i&&(this.cartState=i),void 0!==n&&(this.property=n),a}refreshDisplay(){this.updateDisplay()}}},Symbol.toStringTag,{value:"Module"}));class Lt{static calculateSavings(e,t){return Math.max(0,e-t)}static calculateSavingsPercentage(e,t){const i=this.calculateSavings(e,t);if(e<=0||i<=0)return 0;const n=i/e*100;return Math.round(n)}static calculateUnitPrice(e,t){return t>0?e/t:0}static calculateLineTotal(e,t){return e*t}static calculatePackageMetrics(e){const t=e.priceTotal||e.price*e.quantity,i=e.retailPriceTotal||e.retailPrice*e.quantity,n=this.calculateUnitPrice(t,e.quantity),a=this.calculateUnitPrice(i,e.quantity);return{totalPrice:t,totalRetailPrice:i,totalSavings:this.calculateSavings(i,t),totalSavingsPercentage:this.calculateSavingsPercentage(i,t),unitPrice:n,unitRetailPrice:a,unitSavings:this.calculateSavings(a,n),unitSavingsPercentage:this.calculateSavingsPercentage(a,n),hasSavings:i>t}}}const Tt=Object.freeze(Object.defineProperty({__proto__:null,SelectionDisplayEnhancer:class extends Et{constructor(){super(...arguments),this.selectedItem=null,this.selectionChangeHandler=null}async initialize(){this.validateElement(),this.parseDisplayAttributes(),this.findAssociatedSelector(),this.setupStoreSubscriptions(),this.selectedItem&&this.loadPackageData(),await this.performInitialUpdate(),this.logger.debug("SelectionDisplayEnhancer initialized:",{displayPath:this.displayPath,selectorId:this.selectorId})}parseDisplayAttributes(){super.parseDisplayAttributes();const e=this.displayPath.split(".");if(e.length>=3&&"selection"===e[0]){const t=e[1];t&&(this.selectorId=t),this.property=e.slice(2).join("."),this.logger.debug("Extracted selector ID from display path:",{displayPath:this.displayPath,selectorId:this.selectorId,property:this.property})}else{const e=this.getAttribute("data-next-selector-id")||this.getAttribute("data-selector-id")||this.findSelectorIdFromContext();e&&(this.selectorId=e)}this.selectorId||this.logger.warn("No selector ID found for SelectionDisplayEnhancer")}findSelectorIdFromContext(){let e=this.element.parentElement;for(;e;){const t=e.getAttribute("data-next-selector-id")??void 0;if(t)return t;if(e.hasAttribute("data-next-cart-selector"))return e.getAttribute("data-next-selector-id")??e.getAttribute("data-next-id")??void 0;e=e.parentElement}}findAssociatedSelector(){if(!this.selectorId)return;const e=document.querySelector(`[data-next-selector-id="${this.selectorId}"]`);if(e){const t=e._getSelectedItem;if("function"==typeof t)this.selectedItem=t(),this.logger.debug("Got initial selected item from selector:",this.selectedItem);else{const t=e.querySelector('[data-next-selected="true"]');if(t){const e=parseInt(t.getAttribute("data-next-package-id")||"0",10),i=parseInt(t.getAttribute("data-next-quantity")||"1",10);e>0&&(this.selectedItem={packageId:e,quantity:i,element:t,name:void 0,price:void 0,shippingId:t.getAttribute("data-next-shipping-id")||void 0,isPreSelected:!0},this.logger.debug("Found selected item from DOM:",this.selectedItem))}}}else this.logger.debug(`Selector element not found for ID: ${this.selectorId}`)}setupStoreSubscriptions(){this.subscribe(Y,this.handleCampaignUpdate.bind(this)),this.campaignState=Y.getState(),this.needsCartData()&&(this.subscribe(Q,this.handleCartUpdate.bind(this)),this.cartState=Q.getState()),this.selectionChangeHandler=this.handleSelectionChange.bind(this),this.eventBus.on("selector:selection-changed",this.selectionChangeHandler),this.eventBus.on("selector:item-selected",this.selectionChangeHandler)}needsCartData(){return!!this.property&&["discountedPrice","finalPrice","discountAmount","appliedDiscountAmount","hasDiscount","appliedDiscounts","discountPercentage"].includes(this.property)}handleCampaignUpdate(e){this.campaignState=e,this.loadPackageData(),this.updateDisplay()}handleCartUpdate(e){this.cartState=e,this.updateDisplay()}handleSelectionChange(e){if(e.selectorId===this.selectorId){if(this.logger.debug("Selection changed:",e),e.item)this.selectedItem=e.item;else if(e.packageId){const e=document.querySelector(`[data-next-selector-id="${this.selectorId}"]`);if(e){const t=e._getSelectedItem;"function"==typeof t&&(this.selectedItem=t())}}this.loadPackageData(),this.updateDisplay()}}loadPackageData(){this.selectedItem&&this.campaignState&&(this.packageData=this.campaignState.packages?.find(e=>e.ref_id===this.selectedItem.packageId),this.packageData||this.logger.warn(`Package ${this.selectedItem.packageId} not found in campaign data`))}getPropertyValue(){if(this.selectedItem&&this.property)switch(this.property){case"hasSelection":return null!==this.selectedItem;case"packageId":return this.selectedItem.packageId;case"quantity":return this.selectedItem.quantity;case"name":return this.packageData?.name||this.selectedItem.name||"";case"price":return this.getSelectionPrice();case"total":case"price_total":return this.getSelectionTotal();case"compareTotal":case"price_retail_total":return this.getSelectionCompareTotal();case"savings":case"savingsAmount":return this.getSelectionSavingsAmount();case"savingsPercentage":return this.getSelectionSavingsPercentageFormatted();case"hasSavings":return this.getSelectionHasSavings();case"unitPrice":case"pricePerUnit":return this.getSelectionUnitPrice();case"totalUnits":case"totalQuantity":return this.getSelectionTotalUnits();case"discountAmount":return this.getSelectionDiscountAmount();case"discountedPrice":case"finalPrice":return this.calculateSelectionDiscountedPrice();case"appliedDiscountAmount":return this.calculateSelectionDiscountAmount();case"hasDiscount":return this.getSelectionHasDiscount();case"discountPercentage":return this.getSelectionDiscountPercentage();case"appliedDiscounts":return this.getSelectionAppliedDiscounts();case"isMultiPack":case"isBundle":return this.getSelectionIsBundle();case"isSingleUnit":return!this.getSelectionIsBundle();default:const e=this.parseCalculatedField(this.property);return void 0!==e?e:this.packageData?Ct.getNestedProperty(this.packageData,this.property):void 0}}getSelectionPrice(){return this.selectedItem?this.packageData?parseFloat(this.packageData.price||"0"):this.selectedItem.price||0:0}getSelectionTotal(){return this.selectedItem?this.packageData?parseFloat(this.packageData.price_total||"0")||parseFloat(this.packageData.price||"0")*this.selectedItem.quantity:(this.selectedItem.price||0)*this.selectedItem.quantity:0}getSelectionCompareTotal(){if(!this.selectedItem||!this.packageData)return 0;const e=parseFloat(this.packageData.price_retail_total||"0");if(e>0)return e;const t=parseFloat(this.packageData.price_retail||"0");return t>0?t*this.selectedItem.quantity:this.getSelectionTotal()}getSelectionMetrics(){const e=this.getSelectionTotal(),t=this.getSelectionCompareTotal();return{total:e,compareTotal:t,savings:Lt.calculateSavings(t,e),savingsPercentage:Lt.calculateSavingsPercentage(t,e)}}getSelectionSavingsAmount(){return this.getSelectionMetrics().savings}getSelectionSavingsPercentageFormatted(){return this.getSelectionMetrics().savingsPercentage}getSelectionHasSavings(){return this.getSelectionMetrics().savings>0}getSelectionUnitPrice(){const e=this.getSelectionTotal(),t=this.getSelectionTotalUnits();return t>0?e/t:0}getSelectionTotalUnits(){return this.selectedItem?this.packageData?.qty||1:0}getSelectionDiscountAmount(){return this.getSelectionSavingsAmount()}getSelectionIsBundle(){return this.getSelectionTotalUnits()>1}calculateSelectionDiscountAmount(){if(!this.selectedItem||!this.packageData||!this.cartState?.appliedCoupons?.length)return 0;let e=0;const t=this.getSelectionPrice(),i=this.selectedItem.quantity;for(const n of this.cartState.appliedCoupons)if(n.definition.packageIds&&n.definition.packageIds.includes(this.selectedItem.packageId))"percentage"===n.definition.type?e+=t*i*n.definition.value/100:"fixed"===n.definition.type&&(e+=n.definition.value*i);else if(!n.definition.packageIds||0===n.definition.packageIds.length)if("percentage"===n.definition.type)e+=t*i*n.definition.value/100;else if("fixed"===n.definition.type){const a=t*i,s=this.cartState.totals.subtotal.value;if(s>0){const t=a/s;e+=n.definition.value*t}}return e}calculateSelectionDiscountedPrice(){const e=this.getSelectionPrice(),t=this.calculateSelectionDiscountAmount(),i=this.selectedItem?.quantity||1,n=i>0?t/i:0;return Math.max(0,e-n)}getSelectionHasDiscount(){return this.calculateSelectionDiscountAmount()>0}getSelectionDiscountPercentage(){const e=this.getSelectionTotal(),t=this.calculateSelectionDiscountAmount();return e<=0?0:t/e*100}getSelectionAppliedDiscounts(){if(!this.selectedItem||!this.packageData||!this.cartState?.appliedCoupons?.length)return[];const e=[];for(const t of this.cartState.appliedCoupons){let i=0;if(t.definition.packageIds&&t.definition.packageIds.includes(this.selectedItem.packageId))"percentage"===t.definition.type?i=this.getSelectionTotal()*t.definition.value/100:"fixed"===t.definition.type&&(i=t.definition.value*this.selectedItem.quantity);else if(!t.definition.packageIds||0===t.definition.packageIds.length)if("percentage"===t.definition.type)i=this.getSelectionTotal()*t.definition.value/100;else if("fixed"===t.definition.type){const e=this.getSelectionTotal(),n=this.cartState.totals.subtotal.value;if(n>0){const a=e/n;i=t.definition.value*a}}i>0&&e.push({code:t.code,amount:i})}return e}parseCalculatedField(e){if(!this.selectedItem||!e)return;const t=["+","-","*","/"];for(const i of t)if(e.includes(i)){const t=e.split(i);if(2===t.length){const e=t[0]?.trim()||"",n=parseFloat(t[1]?.trim()||"0");let a=0;switch(e){case"total":case"price_total":a=this.getSelectionTotal();break;case"price":a=this.getSelectionPrice();break;case"savings":case"savingsAmount":a=this.getSelectionSavingsAmount();break;case"compareTotal":a=this.getSelectionCompareTotal();break;default:const t=this.property;this.property=e;const i=this.getPropertyValue();this.property=t,a="number"==typeof i?i:0}if(!isNaN(n))switch(i){case"+":return a+n;case"-":return a-n;case"*":return a*n;case"/":return 0!==n?a/n:0}}}}async performInitialUpdate(){!this.selectedItem&&this.selectorId&&(await new Promise(e=>setTimeout(e,50)),this.findAssociatedSelector(),this.selectedItem&&this.loadPackageData()),await this.updateDisplay()}async updateDisplay(){null!==this.selectedItem||"hasSelection"===this.property?await super.updateDisplay():this.hideElement()}destroy(){this.selectionChangeHandler&&(this.eventBus.off("selector:selection-changed",this.selectionChangeHandler),this.eventBus.off("selector:item-selected",this.selectionChangeHandler)),super.destroy()}}},Symbol.toStringTag,{value:"Module"})),Dt=class{static provide(e,t){this.contexts.set(e,t),this.contextElements.add(e)}static resolve(e){let t=e;for(;t;){if(this.contexts.has(t))return this.contexts.get(t);const e=t.getAttribute("data-next-package-id"),i=t.getAttribute("data-next-cart-item-id"),n=t.getAttribute("data-next-shipping-id"),a=t.getAttribute("data-next-selector-id");if(e||i||n||a){const s={};return e&&(s.packageId=parseInt(e,10)),i&&(s.cartItemId=i),n&&(s.shippingMethodId=n),a&&(s.selectionId=a),this.provide(t,s),s}t=t.parentElement}return null}static merge(e,t){return e?t?{...e,...t}:e:t}static clear(e){this.contexts.delete(e),this.contextElements.delete(e)}static clearAll(){this.contextElements.forEach(e=>{}),this.contexts=new WeakMap,this.contextElements.clear()}static getContextElements(){return Array.from(this.contextElements)}static validate(e,t){return t.every(t=>void 0!==e[t])}};Dt.contexts=new WeakMap,Dt.contextElements=new Set;let Mt=Dt;const Ft=Object.freeze(Object.defineProperty({__proto__:null,ProductDisplayEnhancer:class extends Et{async initialize(){this.validateElement(),this.parseDisplayAttributes(),this.detectPackageContext(),this.setupStoreSubscriptions(),await this.performInitialUpdate(),this.logger.debug(`ProductDisplayEnhancer initialized with package ${this.packageId}, path: ${this.displayPath}, format: ${this.formatType}`)}setupStoreSubscriptions(){this.subscribe(Y,this.handleCampaignUpdate.bind(this)),this.subscribe(Q,this.handleCartUpdate.bind(this)),this.campaignState=Y.getState(),this.loadPackageData()}handleCampaignUpdate(e){this.campaignState=e,this.loadPackageData(),this.updateDisplay()}handleCartUpdate(){this.updateDisplay()}detectPackageContext(){const e=Mt.resolve(this.element);this.contextPackageId=e?.packageId?e.packageId:Pt.findPackageId(this.element);const t=me.parseDisplayPath(this.displayPath);if("package"===t.object&&t.property.includes(".")){const e=t.property.split(".");e[0]&&!isNaN(Number(e[0]))&&(this.packageId=Number(e[0]),this.property=e.slice(1).join("."))}else this.contextPackageId&&(this.packageId=this.contextPackageId);this.packageId||this.logger.warn("No package context found - package ID required")}loadPackageData(){this.packageId&&this.campaignState&&(this.packageData=this.campaignState.packages?.find(e=>e.ref_id===this.packageId),this.packageData||this.logger.warn(`Package ${this.packageId} not found in campaign data`))}getPropertyValue(){if(!this.packageData||!this.property)return;if(this.displayPath?.startsWith("campaign."))return this.getCampaignProperty(this.campaignState,this.property);const e=this.getCalculatedProperty(this.property);return void 0!==e?e:this.getPackageValue(this.packageData,this.property)}updateElementContent(e){this.element instanceof HTMLInputElement||this.element instanceof HTMLTextAreaElement?this.element.value=e:this.element instanceof HTMLImageElement?(this.element.src=e,this.element.alt="Product image"):this.element.textContent=e}hideElement(){this.element.style.display="none",this.addClass("display-hidden"),this.removeClass("display-visible");const e=this.element.closest('[data-container="true"]');e&&(e.style.display="none")}showElement(){this.element.style.display="",this.addClass("display-visible"),this.removeClass("display-hidden");const e=this.element.closest('[data-container="true"]');e&&(e.style.display="")}update(e){e?this.handleCampaignUpdate(e):this.updateDisplay()}getCalculatedProperty(e){if(!this.packageData)return;const t={price:parseFloat(this.packageData.price||"0"),retailPrice:parseFloat(this.packageData.price_retail||"0"),quantity:this.packageData.qty||1,priceTotal:parseFloat(this.packageData.price_total||"0"),retailPriceTotal:parseFloat(this.packageData.price_retail_total||"0")},i=Lt.calculatePackageMetrics(t),n=bt("package",e);if(n&&n.startsWith("_calculated.")){switch(n.replace("_calculated.","")){case"savingsAmount":return i.totalSavings;case"savingsPercentage":return i.totalSavingsPercentage;case"hasSavings":return i.hasSavings;case"isBundle":return(this.packageData.qty||1)>1;case"discountedPrice":return this.calculateDiscountedPrice();case"discountedPriceTotal":return this.calculateDiscountedPriceTotal();case"discountAmount":return this.calculatePackageDiscountAmount();case"hasDiscount":return this.calculatePackageDiscountAmount()>0;case"finalPrice":return this.calculateFinalPrice();case"finalPriceTotal":return this.calculateFinalPriceTotal()}}switch(e){case"savingsAmount":case"savingsAmount.raw":return i.totalSavings;case"savingsPercentage":case"savingsPercentage.raw":return i.totalSavingsPercentage;case"unitPrice":return kt.formatCurrency(i.unitPrice);case"unitRetailPrice":return kt.formatCurrency(i.unitRetailPrice);case"unitSavings":return kt.formatCurrency(i.unitSavings);case"unitSavingsPercentage":return this.logger.warn("[PERCENTAGE DEBUG] ProductDisplayEnhancer returning unitSavingsPercentage:",{unitSavingsPercentage:i.unitSavingsPercentage,unitSavingsPercentageType:typeof i.unitSavingsPercentage}),i.unitSavingsPercentage;case"hasSavings":return i.hasSavings;case"hasRetailPrice":return i.unitRetailPrice>0&&i.unitRetailPrice!==i.unitPrice;case"isBundle":return(this.packageData.qty||1)>1;case"isRecurring":return!0===this.packageData.is_recurring;case"unitPrice.raw":return i.unitPrice;case"unitRetailPrice.raw":return i.unitRetailPrice;case"discountedPrice":return this.calculateDiscountedPrice();case"discountedPriceTotal":return this.calculateDiscountedPriceTotal();case"discountAmount":return this.calculatePackageDiscountAmount();case"hasDiscount":return this.calculatePackageDiscountAmount()>0;case"finalPrice":return this.calculateFinalPrice();case"finalPriceTotal":return this.calculateFinalPriceTotal();default:return}}calculatePackageDiscountAmount(){if(!this.packageData)return 0;const e=Q.getState(),t=e.appliedCoupons||[];let i=0;for(const n of t){const t=n.definition;if("package"===t.scope&&t.packageIds){if(!t.packageIds.includes(this.packageData.ref_id))continue}else if("package"===t.scope)continue;const a=parseFloat(this.packageData.price_total||"0")||parseFloat(this.packageData.price||"0")*(this.packageData.qty||1);if("percentage"===t.type){const e=a*(t.value/100);i+=t.maxDiscount?Math.min(e,t.maxDiscount):e}else if("fixed"===t.type&&"order"===t.scope){const n=e.subtotal;if(n>0){const e=a/n;i+=t.value*e}}}return Math.min(i,parseFloat(this.packageData.price_total||"0"))}calculateDiscountedPrice(){if(!this.packageData)return 0;const e=parseFloat(this.packageData.price||"0"),t=this.packageData.qty||1,i=this.calculatePackageDiscountAmount(),n=t>0?i/t:0;return Math.max(0,e-n)}calculateDiscountedPriceTotal(){if(!this.packageData)return 0;const e=parseFloat(this.packageData.price_total||"0")||parseFloat(this.packageData.price||"0")*(this.packageData.qty||1),t=this.calculatePackageDiscountAmount();return Math.max(0,e-t)}calculateFinalPrice(){return this.calculateDiscountedPrice()}calculateFinalPriceTotal(){return this.calculateDiscountedPriceTotal()}getPackageValue(e,t){const i=bt("package",t);return i&&!i.startsWith("_calculated.")?Ct.getNestedProperty(e,i):Ct.getNestedProperty(e,t)}getCampaignProperty(e,t){const i=e.data;if(!i)return"";switch(t){case"name":return i.name;case"currency":return i.currency;case"language":return i.language;default:return this.logger.warn(`Unknown campaign property: ${t}`),""}}getPackageProperty(e){const t=this.property;this.property=e;const i=this.getPropertyValue();return this.property=t,i}setPackageContext(e){this.packageId=e,this.loadPackageData(),this.updateDisplay()}}},Symbol.toStringTag,{value:"Module"}));const $t=Object.freeze(Object.defineProperty({__proto__:null,OrderDisplayEnhancer:class extends Et{constructor(){super(...arguments),this.orderState={}}async initialize(){await this.checkAndLoadOrderFromUrl(),await super.initialize()}setupStoreSubscriptions(){this.subscribe(se,this.handleOrderUpdate.bind(this)),this.orderState=se.getState()}getPropertyValue(){return this.getDisplayValue(this.orderState,this.displayPath)}update(e){e?this.handleOrderUpdate(e):super.update()}async checkAndLoadOrderFromUrl(){const e=new URLSearchParams(window.location.search).get("ref_id");if(e){const i=se.getState();if(!i.order&&!i.isLoading&&i.refId!==e)try{const t=oe.getState();this.apiClient=new ce(t.apiKey),await i.loadOrder(e,this.apiClient)}catch(t){this.logger.error("Failed to auto-load order:",t)}}}handleOrderUpdate(e){try{this.orderState=e,e.isLoading?(this.addClass("next-loading"),this.removeClass("next-loaded"),this.removeClass("next-error")):e.error?(this.removeClass("next-loading"),this.removeClass("next-loaded"),this.addClass("next-error")):e.order&&(this.removeClass("next-loading"),this.addClass("next-loaded"),this.removeClass("next-error")),this.updateDisplay()}catch(t){this.handleError(t,"handleOrderUpdate"),this.updateElementContent("N/A"),this.addClass("next-error")}}updateElementContent(e){"A"===this.element.tagName&&this.displayPath?.includes("statusUrl")?(this.element.href=e,this.element.textContent||(this.element.textContent="View Order Status")):super.updateElementContent(e)}getDisplayValue(e,t){const i=me.parseDisplayPath(t).property;if(!i)return"";const n=i,a=e.order;if(!a)return e.isLoading?"Loading...":e.error?"Error":"";const s=bt("order",n);if(s){if(s.startsWith("_calculated."))return this.getCalculatedProperty(a,s.substring(12));if(s.startsWith("order.")){const e=Ct.getNestedProperty(a,s.substring(6));if(void 0!==e)return e}else{const t=Ct.getNestedProperty(e,s);if(void 0!==t)return t}}const r=n.split(".");if(r.length>1&&r[0]&&!this.isComplexOrderProperty(r[0])){const e=Ct.getNestedProperty(a,n);if(void 0!==e)return e}switch(r[0]){case"created_at":case"createdAt":const e=a.attribution?.metadata?.timestamp;return e?"raw"===r[1]?e:kt.formatDate(new Date(e)):"";case"testBadge":return a.is_test?"ðŸ§ª TEST ORDER":"";case"user":case"customer":return this.getOrderUserProperty(a,r.slice(1).join(".")||"");case"shippingAddress":return this.getOrderAddressProperty(a.shipping_address,r.slice(1).join(".")||"");case"billingAddress":return this.getOrderAddressProperty(a.billing_address,r.slice(1).join(".")||"");case"items":case"lines":return this.getOrderLinesProperty(a,r.slice(1).join(".")||"");case"attribution":return this.getOrderAttributionProperty(a.attribution,r.slice(1).join(".")||"");default:return this.logger.warn(`Unknown order property: ${n}`),""}}getOrderUserProperty(e,t){const i=e.user;if(!i)return"";switch(t){case"":case"name":return`${i.first_name||""} ${i.last_name||""}`.trim();case"email":return String(i.email||"");case"firstName":return String(i.first_name||"");case"lastName":return String(i.last_name||"");case"phone":return String(i.phone_number||"");case"acceptsMarketing":return i.accepts_marketing;case"language":return String(i.language||"");case"ip":return String(i.ip||"");default:return""}}getOrderAddressProperty(e,t){if(!e)return"";switch(t){case"":case"full":return this.formatAddress(e);case"name":return`${e.first_name||""} ${e.last_name||""}`.trim();case"line1":return String(e.line1||"");case"line2":return String(e.line2||"");case"city":return String(e.line4||"");case"state":return String(e.state||"");case"zip":case"postcode":return String(e.postcode||"");case"country":return String(e.country||"");case"phone":return String(e.phone_number||"");default:return""}}getOrderLinesProperty(e,t){const i=e.lines||[];switch(t){case"count":return i.length;case"totalQuantity":return i.reduce((e,t)=>e+(t.quantity||0),0);case"upsellCount":return i.filter(e=>e.is_upsell).length;case"mainProduct":return i[0]?.product_title||"";case"mainProductSku":return i[0]?.product_sku||"";default:const e=t.match(/^\[(\d+)\]\.(.+)$/);if(e&&e[1]&&e[2]){const t=parseInt(e[1],10),n=e[2],a=i[t];if(a&&n)return this.getOrderLineProperty(a,n)}return""}}getOrderLineProperty(e,t){switch(t){case"title":case"product_title":return e.product_title||"";case"sku":case"product_sku":return e.product_sku||"";case"quantity":return e.quantity||0;case"price":return kt.formatCurrency(parseFloat(e.price_incl_tax||"0"));case"price.raw":return parseFloat(e.price_incl_tax||"0");case"priceExclTax":return kt.formatCurrency(parseFloat(e.price_excl_tax||"0"));case"priceExclTax.raw":return parseFloat(e.price_excl_tax||"0");case"priceExclTaxExclDiscounts":return kt.formatCurrency(parseFloat(e.price_excl_tax_excl_discounts||"0"));case"priceExclTaxExclDiscounts.raw":return parseFloat(e.price_excl_tax_excl_discounts||"0");case"priceInclTaxExclDiscounts":return kt.formatCurrency(parseFloat(e.price_incl_tax_excl_discounts||"0"));case"priceInclTaxExclDiscounts.raw":return parseFloat(e.price_incl_tax_excl_discounts||"0");case"total":return kt.formatCurrency(parseFloat(e.price_incl_tax||"0")*(e.quantity||1));case"total.raw":return parseFloat(e.price_incl_tax||"0")*(e.quantity||1);case"totalExclTax":return kt.formatCurrency(parseFloat(e.price_excl_tax||"0")*(e.quantity||1));case"totalExclTax.raw":return parseFloat(e.price_excl_tax||"0")*(e.quantity||1);case"isUpsell":return e.is_upsell||!1;case"image":return e.image||"";default:return""}}getOrderAttributionProperty(e,t){if(!e)return"";switch(t){case"source":case"utm_source":return e.utm_source||"";case"medium":case"utm_medium":return e.utm_medium||"";case"campaign":case"utm_campaign":return e.utm_campaign||"";case"term":case"utm_term":return e.utm_term||"";case"content":case"utm_content":return e.utm_content||"";case"gclid":return e.gclid||"";case"funnel":return e.funnel||"";case"affiliate":return e.affiliate||"";case"hasTracking":return!!(e.utm_source||e.utm_medium||e.gclid);default:return""}}formatAddress(e){if(!e)return"";return[e.line1,e.line2,e.line4,e.state,e.postcode,e.country].filter(Boolean).map(e=>String(e)).join(", ")}isComplexOrderProperty(e){return["user","customer","total","subtotal","tax","shipping","discounts","shippingAddress","billingAddress","items","lines","attribution","created_at"].includes(e)}getCalculatedProperty(e,t){switch(t){case"savings":case"savingsAmount":if(e.lines&&e.lines.length>0){const t=e.lines.reduce((e,t)=>e+parseFloat(t.price_incl_tax_excl_discounts||t.price_incl_tax||"0")*t.quantity,0),i=parseFloat(e.total_incl_tax||"0");return Math.max(0,t-i)}return parseFloat(e.total_discounts||"0");case"savingsPercentage":if(e.lines&&e.lines.length>0){const t=e.lines.reduce((e,t)=>e+parseFloat(t.price_incl_tax_excl_discounts||t.price_incl_tax||"0")*t.quantity,0),i=parseFloat(e.total_incl_tax||"0");if(t>0&&t>i)return(t-i)/t*100}return 0;case"hasSavings":return parseFloat(e.total_discounts||"0")>0||!!(e.lines&&e.lines.length>0)&&e.lines.some(e=>parseFloat(e.price_incl_tax_excl_discounts||"0")>parseFloat(e.price_incl_tax||"0"));case"hasItems":return e.lines&&e.lines.length>0;case"isEmpty":return!e.lines||0===e.lines.length;case"hasShipping":return parseFloat(e.shipping_incl_tax||"0")>0;case"hasTax":return parseFloat(e.total_tax||"0")>0;case"hasDiscounts":return parseFloat(e.total_discounts||"0")>0;case"hasUpsells":return e.lines?.some(e=>e.is_upsell)||!1;case"lines.count":return e.lines?.length||0;case"lines.totalQuantity":return e.lines?.reduce((e,t)=>e+(t.quantity||0),0)||0;case"lines.upsellCount":return e.lines?.filter(e=>e.is_upsell).length||0;case"lines.mainProduct":return e.lines?.[0]?.product_title||"";case"lines.mainProductSku":return e.lines?.[0]?.product_sku||"";default:return}}}},Symbol.toStringTag,{value:"Module"}));const qt=Object.freeze(Object.defineProperty({__proto__:null,ShippingDisplayEnhancer:class extends Et{async initialize(){this.validateElement(),this.parseDisplayAttributes(),this.detectShippingContext(),this.shippingId?(this.setupStoreSubscriptions(),await this.performInitialUpdate(),this.logger.debug(`ShippingDisplayEnhancer initialized with shipping ID ${this.shippingId}`)):this.logger.warn("ShippingDisplayEnhancer requires data-next-shipping-id context")}setupStoreSubscriptions(){this.subscribe(Y,this.handleCampaignUpdate.bind(this)),this.loadShippingMethod()}handleCampaignUpdate(){this.loadShippingMethod(),this.updateDisplay()}detectShippingContext(){const e=this.element.closest("[data-next-shipping-id]");if(!e)return;const t=e.getAttribute("data-next-shipping-id");t&&(this.shippingId=parseInt(t,10))}loadShippingMethod(){if(!this.shippingId)return;const e=Y.getState(),t=(e.data?.shipping_methods||[]).find(e=>e.ref_id===this.shippingId);t&&(this.shippingMethod=t),this.shippingMethod||this.logger.warn(`Shipping method ${this.shippingId} not found in campaign data`)}getPropertyValue(){if(!this.shippingMethod||!this.property)return;const e=bt("shipping",this.property);if(e&&e.startsWith("_calculated.")){const t=e.replace("_calculated.","");return this.getCalculatedProperty(t)}switch(this.property){case"isFree":return 0===parseFloat(this.shippingMethod.price||"0");case"cost":case"price":return kt.formatValue(parseFloat(this.shippingMethod.price||"0"),"currency");case"cost.raw":case"price.raw":return parseFloat(this.shippingMethod.price||"0");case"name":case"code":return this.shippingMethod.code;case"id":case"refId":return this.shippingMethod.ref_id;case"method":return this.shippingMethod;default:return}}getCalculatedProperty(e){if(this.shippingMethod)switch(e){case"isFree":return 0===parseFloat(this.shippingMethod.price||"0");case"cost":case"price":return kt.formatValue(parseFloat(this.shippingMethod.price||"0"),"currency");case"name":case"code":return this.shippingMethod.code;case"id":case"refId":return this.shippingMethod.ref_id;case"method":return this.shippingMethod;default:return}}update(){this.updateDisplay()}}},Symbol.toStringTag,{value:"Module"}));const Ot=Object.freeze(Object.defineProperty({__proto__:null,CartToggleEnhancer:class extends pt{constructor(){super(...arguments),this.quantity=1,this.syncPackageIds=[],this.isSyncMode=!1,this.isUpsell=!1}async initialize(){if(this.validateElement(),!this.hasAttribute("data-next-toggle"))throw new Error("data-next-toggle attribute is required");this.findStateContainer(),this.resolvePackageIdentifier(),this.checkSyncMode(),this.isSyncMode||this.setQuantity(),this.detectUpsellContext(),this.setupEventListeners(),this.updateState(Q.getState()),await this.checkAutoAdd(),this.logger.debug("Toggle initialized:",{packageId:this.packageId,quantity:this.quantity,isSyncMode:this.isSyncMode,syncPackageIds:this.syncPackageIds,isUpsell:this.isUpsell})}findStateContainer(){let e=this.element;for(;e&&e!==document.body;){if(e.hasAttribute("data-next-toggle-container")||e.hasAttribute("data-next-bump")||e.hasAttribute("data-next-upsell-item")||e.classList.contains("upsell")||e.classList.contains("bump")){this.stateContainer=e;break}if(e.hasAttribute("data-next-package-id")||e.hasAttribute("data-package-id")){this.stateContainer=e;break}e=e.parentElement}this.stateContainer||(this.stateContainer=this.element)}resolvePackageIdentifier(){const e=this.getAttribute("data-next-package-id")||this.getAttribute("data-package-id");if(!e){if(this.stateContainer&&this.stateContainer!==this.element){const e=this.stateContainer.getAttribute("data-next-package-id")||this.stateContainer.getAttribute("data-package-id");if(e)return void(this.packageId=parseInt(e,10))}throw new Error("Package identifier required: data-next-package-id")}this.packageId=parseInt(e,10)}checkSyncMode(){const e=this.getAttribute("data-next-package-sync")||this.stateContainer?.getAttribute("data-next-package-sync"),t=this.getAttribute("data-next-qty-sync")||this.stateContainer?.getAttribute("data-next-qty-sync");if(e)this.syncPackageIds=e.split(",").map(e=>parseInt(e.trim(),10)).filter(e=>!isNaN(e)),this.syncPackageIds.length>0&&(this.isSyncMode=!0,this.quantity=0);else if(t){const e=parseInt(t,10);isNaN(e)||(this.syncPackageIds=[e],this.isSyncMode=!0,this.quantity=0)}}setQuantity(){const e=this.getAttribute("data-next-quantity")||this.getAttribute("data-quantity")||this.stateContainer?.getAttribute("data-next-quantity");this.quantity=e?parseInt(e,10):1}detectUpsellContext(){this.isUpsell="true"===this.getAttribute("data-next-is-upsell")||!0===this.stateContainer?.hasAttribute("data-next-upsell")||!0===this.stateContainer?.hasAttribute("data-next-bump")||null!==this.element.closest("[data-next-upsell-section]")||null!==this.element.closest("[data-next-bump-section]")}async checkAutoAdd(){if(("true"===this.getAttribute("data-next-selected")||"true"===this.stateContainer?.getAttribute("data-next-selected"))&&this.packageId){const t=Q.getState();if(!this.isInCart(t)){this.logger.debug("Auto-adding item on page load:",{packageId:this.packageId,quantity:this.quantity});try{this.isSyncMode&&this.updateSyncedQuantity(t),await this.addToCart()}catch(e){this.logger.error("Failed to auto-add item:",e)}}}}setupEventListeners(){this.clickHandler=this.handleClick.bind(this),this.element.addEventListener("click",this.clickHandler),this.subscribe(Q,e=>this.updateState(e))}async handleClick(e){e.preventDefault();try{this.setLoadingState(!0);const e=Q.getState();this.isSyncMode&&this.updateSyncedQuantity(e);const t=this.isInCart(e);this.logger.debug("Toggle click:",{packageId:this.packageId,isInCart:t,quantity:this.quantity,isSyncMode:this.isSyncMode}),t?await this.removeFromCart():await this.addToCart()}catch(t){this.handleError(t,"handleClick")}finally{this.setLoadingState(!1)}}async addToCart(){const e=Q.getState();if(this.logger.debug("Adding to cart:",{packageId:this.packageId,quantity:this.quantity}),this.packageId){let i=`Package ${this.packageId}`,n=0;try{const e=Y.getState().getPackage(this.packageId);e?(i=e.name,n=parseFloat(e.price),this.logger.debug("Found package data:",{title:i,price:n})):this.logger.debug("Package not found in campaign store")}catch(t){this.logger.debug("Error getting package data:",t)}await e.addItem({packageId:this.packageId,quantity:this.quantity,title:i,price:n,isUpsell:this.isUpsell}),this.logger.debug("Added to cart successfully")}}async removeFromCart(){const e=Q.getState();this.packageId&&await e.removeItem(this.packageId)}updateState(e){const t=this.isInCart(e);this.stateContainer&&(this.stateContainer.setAttribute("data-in-cart",String(t)),this.stateContainer.setAttribute("data-next-active",String(t)),this.stateContainer.classList.toggle("next-in-cart",t),this.stateContainer.classList.toggle("next-not-in-cart",!t),this.stateContainer.classList.toggle("next-active",t),this.stateContainer.classList.toggle("os--active",t)),this.setAttribute("data-in-cart",String(t)),this.setAttribute("data-next-active",String(t)),this.toggleClass("next-in-cart",t),this.toggleClass("next-not-in-cart",!t),this.toggleClass("next-active",t);const i=this.getAttribute("data-add-text"),n=this.getAttribute("data-remove-text");i&&n&&this.updateTextContent(t?n:i),this.isSyncMode&&this.syncPackageIds.length>0&&this.handleSyncUpdate(e)}updateSyncedQuantity(e){if(0===this.syncPackageIds.length)return;let t=0;this.syncPackageIds.forEach(i=>{const n=e.items.find(e=>e.packageId===i);if(n){const e=n.qty||1,a=n.quantity*e;t+=a,this.logger.debug(`Sync package ${i}: ${n.quantity} packages Ã— ${e} items/package = ${a} total`)}}),this.quantity=t,this.logger.debug(`Total sync quantity: ${this.quantity} (from packages: ${this.syncPackageIds.join(", ")})`)}async handleSyncUpdate(e){if(!this.packageId||0===this.syncPackageIds.length)return;let t=0,i=!1;this.syncPackageIds.forEach(n=>{const a=e.items.find(e=>e.packageId===n);if(a){i=!0;const e=a.qty||1;t+=a.quantity*e}});const n=e.items.find(e=>e.packageId===this.packageId);i&&t>0?n&&n.quantity!==t&&(this.logger.debug(`Auto-sync: Updating quantity to ${t}`),await Q.getState().updateQuantity(this.packageId,t)):n&&!e.swapInProgress?(this.logger.debug("Auto-sync: No synced packages found and not swapping - removing item"),await this.removeFromCart()):n&&e.swapInProgress&&this.logger.debug("Auto-sync: Swap in progress - keeping item for now")}isInCart(e){return!!this.packageId&&e.items.some(e=>e.packageId===this.packageId)}setLoadingState(e){e?(this.addClass("next-loading"),this.setAttribute("disabled","true")):(this.removeClass("next-loading"),this.removeAttribute("disabled"))}update(){this.updateState(Q.getState())}cleanupEventListeners(){this.clickHandler&&this.element.removeEventListener("click",this.clickHandler)}}},Symbol.toStringTag,{value:"Module"}));class Ut extends pt{constructor(){super(...arguments),this.isProcessing=!1}async executeAction(e,t){if(this.isProcessing)return Promise.reject(new Error("Already processing"));this.isProcessing=!0,t?.showLoading&&this.setLoadingState(!0),t?.disableOnProcess&&this.element.setAttribute("disabled","true");try{const t=await e();return this.emit("action:success",{action:this.constructor.name,data:{element:this.element}}),t}catch(i){throw this.handleError(i,"executeAction"),this.emit("action:failed",{action:this.constructor.name,error:i instanceof Error?i:new Error(String(i))}),i}finally{this.isProcessing=!1,t?.showLoading&&this.setLoadingState(!1),t?.disableOnProcess&&this.element.removeAttribute("disabled")}}setLoadingState(e){this.toggleClass("loading",e),this.toggleClass("next-loading",e),this.setAttribute("aria-busy",e.toString()),(this.element instanceof HTMLButtonElement||this.element instanceof HTMLInputElement||this.element instanceof HTMLSelectElement)&&(this.element.disabled=e)}isActionProcessing(){return this.isProcessing}setLoadingContent(e){null!==e?this.setAttribute("data-loading-text",e):this.removeAttribute("data-loading-text")}debounceAction(e,t){let i;return(...n)=>(clearTimeout(i),new Promise((a,s)=>{i=setTimeout(()=>{try{const t=e(...n);t instanceof Promise?t.then(a).catch(s):a(t)}catch(t){s(t)}},t)}))}throttleAction(e,t){let i,n;return(...a)=>(i||(i=!0,setTimeout(()=>{i=!1},t),n=e(...a)),n)}}function Nt(e,t=["debug","debugger"]){try{const i=new URL(e,window.location.origin),n=new URLSearchParams(window.location.search);return t.forEach(e=>{const t=n.get(e);t&&!i.searchParams.has(e)&&i.searchParams.append(e,t)}),"true"!==n.get("debug")||i.searchParams.has("debug")||i.searchParams.append("debug","true"),"true"!==n.get("debugger")||i.searchParams.has("debugger")||i.searchParams.append("debugger","true"),i.href}catch(i){return e}}const zt=Object.freeze(Object.defineProperty({__proto__:null,AddToCartEnhancer:class extends Ut{constructor(){super(...arguments),this.quantity=1,this.clearCart=!1}async initialize(){this.validateElement();const e=this.getAttribute("data-next-package-id");e&&(this.packageId=parseInt(e,10));const t=this.getAttribute("data-next-quantity");this.quantity=t?parseInt(t,10):1;const i=this.getAttribute("data-next-selector-id");i&&(this.selectorId=i);const n=this.getAttribute("data-next-url");n&&(this.redirectUrl=n);const a=this.getAttribute("data-next-clear-cart");this.clearCart="true"===a,this.clickHandler=this.handleClick.bind(this),this.element.addEventListener("click",this.clickHandler),this.selectorId&&this.setupSelectorListener(),this.updateButtonState(),this.logger.debug("AddToCartEnhancer initialized",{packageId:this.packageId,selectorId:this.selectorId,quantity:this.quantity,redirectUrl:this.redirectUrl,clearCart:this.clearCart})}setupSelectorListener(){setTimeout(()=>{const e=this.findSelectorElement();e?(this.selectedItem=this.getSelectedItemFromElement(e),this.updateButtonState()):this.logger.warn(`Selector with id "${this.selectorId}" not found. Button may not work properly.`)},100),this.eventBus.on("selector:item-selected",this.handleSelectorChange.bind(this)),this.eventBus.on("selector:selection-changed",this.handleSelectorChange.bind(this))}findSelectorElement(){return document.querySelector(`[data-next-cart-selector][data-next-selector-id="${this.selectorId}"], [data-next-package-selector][data-next-selector-id="${this.selectorId}"]`)}getSelectedItemFromElement(e){const t=e._getSelectedItem;if("function"==typeof t)return t();const i=e._selectedItem;if(i)return i;const n=e.getAttribute("data-selected-package");if(n){const e=parseInt(n,10);if(!isNaN(e))return{packageId:e,quantity:1,element:null,price:void 0,name:void 0,isPreSelected:!1,shippingId:void 0}}return null}handleSelectorChange(e){if(e.selectorId!==this.selectorId)return;const t=this.findSelectorElement();t?this.selectedItem=this.getSelectedItemFromElement(t):e.item?this.selectedItem=e.item:e.packageId?this.selectedItem={packageId:e.packageId,quantity:e.quantity||1,element:null,price:void 0,name:void 0,isPreSelected:!1,shippingId:void 0}:this.selectedItem=null,this.updateButtonState()}updateButtonState(){if(this.selectorId){const e=null!==this.selectedItem;this.setEnabled(e)}else this.packageId&&this.setEnabled(!0)}setEnabled(e){e?(this.element.removeAttribute("disabled"),this.removeClass("next-disabled")):(this.element.setAttribute("disabled","true"),this.addClass("next-disabled"))}async handleClick(e){e.preventDefault(),await this.executeAction(async()=>{await this.addToCart()},{showLoading:!0,disableOnProcess:!0})}async addToCart(){const e=Q.getState();let t,i=this.quantity;if(this.selectorId&&this.selectedItem?(t=this.selectedItem.packageId,i=this.selectedItem.quantity||this.quantity):this.packageId&&(t=this.packageId),t)try{if(this.clearCart&&(this.logger.debug("Clearing cart before adding item"),await e.clear()),await e.addItem({packageId:t,quantity:i,isUpsell:void 0}),this.updateButtonState(),this.eventBus.emit("cart:item-added",{packageId:t,quantity:i,source:this.selectorId?"selector":"direct"}),this.redirectUrl){const e=Nt(this.redirectUrl);this.logger.debug("Redirecting to:",e),window.location.href=e}}catch(n){throw this.logger.error("Failed to add item to cart:",n),n}else this.logger.warn("No package ID available for add-to-cart action")}update(e){}destroy(){this.clickHandler&&this.element.removeEventListener("click",this.clickHandler),this.selectorId&&(this.eventBus.off("selector:item-selected",this.handleSelectorChange.bind(this)),this.eventBus.off("selector:selection-changed",this.handleSelectorChange.bind(this))),super.destroy()}}},Symbol.toStringTag,{value:"Module"}));class Rt{constructor(e){this.options={backdropDismiss:!0,...e}}async show(){return new Promise(e=>{this.resolve=e,this.createModal()})}createModal(){this.backdrop=document.createElement("div"),this.backdrop.className="next-modal-backdrop "+(this.options.className?this.options.className+"-backdrop":""),this.backdrop.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(0, 0, 0, 0.5);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 10000;\n      animation: fadeIn 0.2s ease-out;\n    ",this.modal=document.createElement("div"),this.modal.className=`next-modal ${this.options.className||""}`,this.modal.style.cssText="\n      background: white;\n      border-radius: 8px;\n      padding: 0;\n      max-width: 500px;\n      width: 90%;\n      max-height: 90vh;\n      overflow: hidden;\n      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);\n      animation: slideIn 0.3s ease-out;\n    ";const e=this.options.buttons.map((e,t)=>{const i=this.getDefaultButtonStyles(e.action),n=e.style||i,a=e.className||`next-modal-${e.action}`;return e.href?`<a \n          href="${e.href}" \n          target="${e.target||"_self"}"\n          class="${a}" \n          data-action="${e.action}"\n          data-index="${t}"\n          style="${n}"\n        >${e.text}</a>`:`<button \n        class="${a}" \n        data-action="${e.action}"\n        data-index="${t}"\n        style="${n}"\n      >${e.text}</button>`}).join("");this.modal.innerHTML=`\n      <div class="next-modal-header" style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between;">\n        <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: #1a202c;">\n          ${this.options.title}\n        </h3>\n        <button class="next-modal-close" data-action="cancel" style="\n          background: none;\n          border: none;\n          font-size: 24px;\n          color: #718096;\n          cursor: pointer;\n          padding: 0;\n          width: 32px;\n          height: 32px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border-radius: 4px;\n          transition: all 0.2s;\n        ">&times;</button>\n      </div>\n      <div class="next-modal-body" style="padding: 24px; max-height: 60vh; overflow-y: auto;">\n        <div style="color: #4a5568; line-height: 1.6;">\n          ${this.options.content}\n        </div>\n      </div>\n      <div class="next-modal-footer" style="padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; gap: 12px; justify-content: flex-end;">\n        ${e}\n      </div>\n    `,this.style=document.createElement("style"),this.style.textContent="\n      @keyframes fadeIn {\n        from { opacity: 0; }\n        to { opacity: 1; }\n      }\n      @keyframes slideIn {\n        from { \n          opacity: 0;\n          transform: translateY(-20px);\n        }\n        to { \n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n      .next-modal-close:hover {\n        background: #f7fafc !important;\n      }\n      .next-modal-cancel:hover {\n        border-color: #cbd5e0 !important;\n        background: #f7fafc !important;\n      }\n      .next-modal-confirm:hover {\n        background: var(--brand--color--primary, #3182ce) !important;\n        filter: brightness(0.9);\n      }\n      .next-modal a {\n        text-decoration: none;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n      }\n    ",document.head.appendChild(this.style),this.backdrop.appendChild(this.modal),document.body.appendChild(this.backdrop);this.modal.querySelectorAll("[data-action]").forEach(e=>{"A"!==e.tagName?e.addEventListener("click",e=>this.handleAction(e)):e.addEventListener("click",e=>{const t=e.currentTarget.getAttribute("data-action")||"custom",i=this.resolve;this.cleanup(),i&&i(t)})}),this.options.backdropDismiss&&this.backdrop.addEventListener("click",e=>{e.target===this.backdrop&&this.handleDismiss()}),this.handleEscapeKey=this.handleEscapeKey.bind(this),document.addEventListener("keydown",this.handleEscapeKey)}getDefaultButtonStyles(e){return"confirm"===e?"\n          padding: 10px 20px;\n          border: none;\n          background: var(--brand--color--primary, #3182ce);\n          color: white;\n          border-radius: 6px;\n          font-size: 16px;\n          cursor: pointer;\n          font-weight: 500;\n          transition: all 0.2s;\n        ":"\n          padding: 10px 20px;\n          border: 1px solid #e2e8f0;\n          background: white;\n          border-radius: 6px;\n          font-size: 16px;\n          cursor: pointer;\n          color: #4a5568;\n          transition: all 0.2s;\n        "}handleEscapeKey(e){"Escape"===e.key&&this.options.backdropDismiss&&this.handleDismiss()}handleAction(e){const t=e.currentTarget.getAttribute("data-action")||"custom",i=this.resolve;this.cleanup(),i&&i(t)}handleDismiss(){const e=this.resolve;this.cleanup(),e&&e("backdrop")}cleanup(){this.backdrop&&this.backdrop.remove(),this.style&&this.style.remove(),document.removeEventListener("keydown",this.handleEscapeKey),this.backdrop=void 0,this.modal=void 0,this.style=void 0,this.resolve=void 0}static async show(e){return new Rt(e).show()}static async showDuplicateUpsell(){return"cancel"===await Rt.show({title:"Already Added!",content:"You've already added this item to your order. Would you like to add it again?",buttons:[{text:"Yes, Add Again",action:"cancel"},{text:"Skip to Next",action:"confirm"}]})}static async showRecentPurchaseWarning(){return await Rt.show({title:"Attention",content:"Your initial order has been successfully processed. Please check your email for the order confirmation. Entering your payment details again will result in a secondary purchase.",buttons:[{text:"Close",action:"cancel"},{text:"Back",action:"confirm"}]})}}class Ht{constructor(){this.overlay=null,this.showTime=0}show(){this.overlay||(this.showTime=Date.now(),this.overlay=document.createElement("div"),this.overlay.className="next-loading-overlay",this.overlay.innerHTML='\n      <style>\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n        .next-loading-spinner .spinner {\n          width: 30px;\n          height: 30px;\n          border: 3px solid rgba(0, 0, 0, 0.1);\n          border-top-color: var(--brand--color--primary, #000);\n          border-radius: 50%;\n          animation: spin 1s linear infinite;\n        }\n      </style>\n      <div class="next-loading-spinner">\n        <div class="spinner"></div>\n      </div>\n    ',Object.assign(this.overlay.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(255, 255, 255, 0.9)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:"9999"}),document.body.appendChild(this.overlay))}hide(e=!1){if(this.overlay)if(e)document.body.removeChild(this.overlay),this.overlay=null;else{const e=Date.now()-this.showTime,t=Math.max(0,3e3-e);setTimeout(()=>{this.overlay&&(document.body.removeChild(this.overlay),this.overlay=null)},t)}}}const jt=Object.freeze(Object.defineProperty({__proto__:null,AcceptUpsellEnhancer:class extends Ut{constructor(e){super(e),this.quantity=1,this.loadingOverlay=new Ht}async initialize(){this.validateElement(),this.pageShowHandler=e=>{e.persisted&&(this.loadingOverlay.hide(!0),this.setEnabled(!0))},window.addEventListener("pageshow",this.pageShowHandler);const e=this.getAttribute("data-next-package-id");e&&(this.packageId=parseInt(e,10));const t=this.getAttribute("data-next-quantity");this.quantity=t?parseInt(t,10):1;const i=this.getAttribute("data-next-selector-id");i&&(this.selectorId=i);const n=this.getAttribute("data-next-url");n&&(this.nextUrl=n);const a=oe.getState();this.apiClient=new ce(a.apiKey),this.clickHandler=this.handleClick.bind(this),this.element.addEventListener("click",this.clickHandler),this.selectorId&&this.setupSelectorListener(),this.subscribe(se,()=>this.updateButtonState()),this.updateButtonState(),this.logger.debug("AcceptUpsellEnhancer initialized",{packageId:this.packageId,selectorId:this.selectorId,quantity:this.quantity,nextUrl:this.nextUrl})}setupSelectorListener(){setTimeout(()=>{const e=this.findSelectorElement();e?(this.selectedItem=this.getSelectedItemFromElement(e),this.updateButtonState()):this.logger.warn(`Selector with id "${this.selectorId}" not found. Button may not work properly.`)},100),this.eventBus.on("upsell-selector:item-selected",this.handleSelectorChange.bind(this)),this.eventBus.on("selector:item-selected",this.handleSelectorChange.bind(this)),this.eventBus.on("selector:selection-changed",this.handleSelectorChange.bind(this))}findSelectorElement(){return document.querySelector(`[data-next-upsell-selector][data-next-selector-id="${this.selectorId}"], [data-next-upsell-select="${this.selectorId}"], [data-next-upsell][data-next-selector-id="${this.selectorId}"]`)}getSelectedItemFromElement(e){const t=e._getSelectedPackageId;if("function"==typeof t){const e=t();if(e)return{packageId:e,quantity:1,element:null,price:void 0,name:void 0,isPreSelected:!1,shippingId:void 0}}const i=e._selectedPackageId;return i?{packageId:i,quantity:1,element:null,price:void 0,name:void 0,isPreSelected:!1,shippingId:void 0}:null}handleSelectorChange(e){if(e.selectorId!==this.selectorId)return;const t=this.findSelectorElement();t?this.selectedItem=this.getSelectedItemFromElement(t):e.packageId?this.selectedItem={packageId:e.packageId,quantity:e.quantity||1,element:null,price:void 0,name:void 0,isPreSelected:!1,shippingId:void 0}:this.selectedItem=null,this.updateButtonState()}updateButtonState(){const e=se.getState().canAddUpsells(),t=!(!this.packageId&&!this.selectedItem);this.setEnabled(e&&t)}setEnabled(e){e?(this.element.removeAttribute("disabled"),this.removeClass("next-disabled")):(this.element.setAttribute("disabled","true"),this.addClass("next-disabled"))}async handleClick(e){e.preventDefault(),await this.executeAction(async()=>{await this.acceptUpsell()},{showLoading:!1,disableOnProcess:!0})}async acceptUpsell(){const e=se.getState();let t,i=this.quantity;if(this.selectorId&&this.selectedItem?(t=this.selectedItem.packageId,i=this.selectedItem.quantity||this.quantity):this.packageId&&(t=this.packageId),!t)return void this.logger.warn("No package ID available for accept-upsell action");if(!e.order||!this.apiClient)return void this.logger.error("No order loaded or API client not initialized");if(this.checkIfUpsellAlreadyAccepted(t)){if(!(await this.showDuplicateUpsellDialog())){let e=this.nextUrl;if(!e){const t=document.querySelector('meta[name="next-upsell-decline-url"]');e=t?.getAttribute("content")||void 0,e&&this.logger.debug("Using fallback decline URL from meta tag:",e)}if(e){const t=Nt(e);window.location.href=t}return}}try{this.loadingOverlay.show();const n={lines:[{package_id:t,quantity:i}]},a=e.order.lines?.map(e=>e.id)||[],s=await e.addUpsell(n,this.apiClient);if(!s)throw new Error("Failed to add upsell");const r=s.lines?.find(e=>e.is_upsell&&!a.includes(e.id)),o=r?.price_incl_tax?parseFloat(r.price_incl_tax):0;this.eventBus.emit("upsell:accepted",{packageId:t,quantity:i,orderId:e.order.ref_id,value:o});let l=this.nextUrl;if(!l){const e=document.querySelector('meta[name="next-upsell-accept-url"]');l=e?.getAttribute("content")||void 0,l&&this.logger.debug("Using fallback accept URL from meta tag:",l)}if(l){const e=Nt(l);window.location.href=e}else this.loadingOverlay.hide()}catch(n){throw this.logger.error("Failed to accept upsell:",n),this.loadingOverlay.hide(!0),n}}checkIfUpsellAlreadyAccepted(e){const t=se.getState();if(t.completedUpsells.includes(e.toString()))return!0;return t.upsellJourney.some(t=>t.packageId===e.toString()&&"accepted"===t.action)}async showDuplicateUpsellDialog(){const e=await Rt.showDuplicateUpsell();return this.logger.info(e?"User confirmed to add duplicate upsell":"User declined to add duplicate upsell"),e}update(e){}destroy(){this.clickHandler&&this.element.removeEventListener("click",this.clickHandler),this.pageShowHandler&&window.removeEventListener("pageshow",this.pageShowHandler),this.selectorId&&(this.eventBus.off("upsell-selector:item-selected",this.handleSelectorChange.bind(this)),this.eventBus.off("selector:item-selected",this.handleSelectorChange.bind(this)),this.eventBus.off("selector:selection-changed",this.handleSelectorChange.bind(this))),super.destroy()}}},Symbol.toStringTag,{value:"Module"}));function Vt(e){return function(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}(e)&&e>=0}function Bt(e){if(!("string"==typeof(t=e)&&t.length>0))return;var t;const i=e.match(/\$?(\d+\.?\d*)/);if(!i||!i[1])return;const n=parseFloat(i[1]);return function(e){return Vt(e)}(n)?n:void 0}const Kt=class{static extractPrice(e){for(const t of this.PRICE_SELECTORS){const i=e.querySelector(t);if(i?.textContent){const e=Bt(i.textContent.trim());if(void 0!==e)return e}}}static extractName(e){for(const t of this.NAME_SELECTORS){const i=e.querySelector(t),n=i?.textContent?.trim();if(n)return n}}static extractQuantity(e){const t=e.getAttribute("data-next-quantity")||e.getAttribute("data-quantity")||e.getAttribute("data-qty");return t&&parseInt(t,10)||1}};Kt.PRICE_SELECTORS=[".pb-quantity__price.pb--current",".price",'[data-next-display*="price"]',".next-price",".product-price",".item-price"],Kt.NAME_SELECTORS=[".card-title","h1, h2, h3, h4, h5, h6",".title",".name",'[data-next-display*="name"]',".product-name",".item-name"];let Wt=Kt;const Qt=Object.freeze(Object.defineProperty({__proto__:null,PackageSelectorEnhancer:class extends pt{constructor(){super(...arguments),this.items=[],this.selectedItem=null,this.clickHandlers=new Map,this.mutationObserver=null}async initialize(){this.validateElement(),this.selectorId=this.getRequiredAttribute("data-next-selector-id")||this.getRequiredAttribute("data-next-id")||`selector-${Date.now()}`,this.mode=this.getAttribute("data-next-selection-mode")||"swap",this.initializeSelectorCards(),this.setupMutationObserver(),this.subscribe(Q,this.syncWithCart.bind(this)),this.syncWithCart(Q.getState()),this.element._getSelectedItem=()=>this.selectedItem,this.element._getSelectedPackageId=()=>this.selectedItem?.packageId,this.logger.debug("Initialized package selector:",{selectorId:this.selectorId,mode:this.mode,itemCount:this.items.length,element:this.element,initialSelectedPackage:this.selectedItem?.packageId}),this.logger.info(`Selector "${this.selectorId}" initialized with ${this.items.length} items in ${this.mode} mode`)}initializeSelectorCards(){this.element.querySelectorAll("[data-next-selector-card]").forEach(e=>{e instanceof HTMLElement&&this.registerCard(e)}),0===this.items.length&&this.logger.warn("No selector cards found in selector",this.element)}registerCard(e){const t=e.getAttribute("data-next-package-id");if(!t)return void this.logger.warn("Card missing package ID attribute",e);const i=parseInt(t,10),n=parseInt(e.getAttribute("data-next-quantity")||"1",10),a="true"===e.getAttribute("data-next-selected"),s=e.getAttribute("data-next-shipping-id"),r=this.items.findIndex(t=>t.element===e);if(-1!==r){const e=this.items[r];return e&&(e.packageId=i,e.quantity=n,e.isPreSelected=a,e.shippingId=s||void 0,this.updateItemPackageData(e)),void this.logger.debug("Updated existing selector card:",{packageId:i,quantity:n,isPreSelected:a,shippingId:s})}let o;try{o=Y.getState().getPackage(i)||void 0}catch(p){this.logger.debug("Package data not yet available for:",i)}const l=o?.price?parseFloat(o.price):Wt.extractPrice(e),c=o?.name||Wt.extractName(e)||`Package ${i}`,d={element:e,packageId:i,quantity:n,price:l,name:c,isPreSelected:a,shippingId:s||void 0};this.items.push(d);const u=e=>this.handleCardClick(e,d);this.clickHandlers.set(e,u),e.addEventListener("click",u),e.classList.add("next-selector-card"),this.logger.debug("Registered selector card:",{packageId:i,quantity:n,isPreSelected:a,shippingId:s})}setupMutationObserver(){this.mutationObserver=new MutationObserver(e=>{e.forEach(e=>{if("attributes"===e.type&&e.target instanceof HTMLElement){const t=e.target;t.hasAttribute("data-next-selector-card")&&"data-next-package-id"===e.attributeName&&this.handlePackageIdChange(t)}"childList"===e.type&&(e.addedNodes.forEach(e=>{if(e instanceof HTMLElement){e.hasAttribute("data-next-selector-card")&&this.registerCard(e);e.querySelectorAll("[data-next-selector-card]").forEach(e=>{e instanceof HTMLElement&&this.registerCard(e)})}}),e.removedNodes.forEach(e=>{e instanceof HTMLElement&&this.handleCardRemoval(e)}))})}),this.mutationObserver.observe(this.element,{attributes:!0,attributeFilter:["data-next-package-id","data-next-quantity","data-next-selected","data-next-shipping-id"],childList:!0,subtree:!0})}handlePackageIdChange(e){const t=this.items.find(t=>t.element===e);if(!t)return void this.registerCard(e);const i=e.getAttribute("data-next-package-id");if(!i)return void this.logger.warn("Card package ID removed",e);const n=parseInt(i,10),a=t.packageId;n!==a&&(t.packageId=n,t.quantity=parseInt(e.getAttribute("data-next-quantity")||"1",10),t.shippingId=e.getAttribute("data-next-shipping-id")||void 0,this.updateItemPackageData(t),this.selectedItem===t&&"swap"===this.mode&&this.updateCart({...t,packageId:a},t).catch(e=>{this.logger.error("Failed to update cart after package ID change:",e)}),this.syncWithCart(Q.getState()),this.logger.debug("Package ID changed on selector card:",{oldPackageId:a,newPackageId:n,isSelected:this.selectedItem===t}))}updateItemPackageData(e){try{const t=Y.getState().getPackage(e.packageId);t?(e.price=t.price?parseFloat(t.price):e.price,e.name=t.name||e.name):(e.price=Wt.extractPrice(e.element),e.name=Wt.extractName(e.element)||`Package ${e.packageId}`)}catch(t){this.logger.debug("Failed to update package data:",t)}}handleCardRemoval(e){const t=[];e.hasAttribute("data-next-selector-card")&&t.push(e);e.querySelectorAll("[data-next-selector-card]").forEach(e=>{e instanceof HTMLElement&&t.push(e)}),t.forEach(e=>{const t=this.items.findIndex(t=>t.element===e);if(-1!==t){const i=this.items[t],n=this.clickHandlers.get(e);n&&(e.removeEventListener("click",n),this.clickHandlers.delete(e)),this.items.splice(t,1),this.selectedItem===i&&(this.selectedItem=null,this.element.removeAttribute("data-selected-package")),this.logger.debug("Removed selector card:",{packageId:i?.packageId})}})}async handleCardClick(e,t){e.preventDefault();try{if(this.selectedItem===t)return;const e=this.selectedItem;this.selectItem(t),this.eventBus.emit("selector:item-selected",{selectorId:this.selectorId,packageId:t.packageId,previousPackageId:e?.packageId||void 0,mode:this.mode,pendingAction:"select"===this.mode||void 0}),this.element.setAttribute("data-selected-package",t.packageId.toString()),this.element._selectedItem=t,"swap"===this.mode&&(await this.updateCart(e,t),t.shippingId&&await this.setShippingMethod(t.shippingId))}catch(i){this.handleError(i,"handleCardClick")}}selectItem(e){this.items.forEach(e=>{e.element.classList.remove("next-selected"),e.element.setAttribute("data-next-selected","false")}),e.element.classList.add("next-selected"),e.element.setAttribute("data-next-selected","true"),this.selectedItem=e,this.element.setAttribute("data-selected-package",e.packageId.toString()),this.logger.debug(`Selected item in selector ${this.selectorId}:`,{packageId:e.packageId,name:e.name,quantity:e.quantity}),this.emit("selector:selection-changed",{selectorId:this.selectorId,packageId:e.packageId,item:e})}async updateCart(e,t){const i=Q.getState();e&&e.packageId!==t.packageId?await i.swapPackage(e.packageId,{packageId:t.packageId,quantity:t.quantity,isUpsell:!1}):i.hasItem(t.packageId)||await i.addItem({packageId:t.packageId,quantity:t.quantity,isUpsell:!1})}async setShippingMethod(e){try{const t=parseInt(e,10);if(isNaN(t))return void this.logger.error("Invalid shipping ID:",e);const i=Q.getState();await i.setShippingMethod(t),this.logger.debug(`Shipping method ${t} set via selector`)}catch(t){this.logger.error("Failed to set shipping method:",t)}}syncWithCart(e){try{this.items.forEach(t=>{const i=e.items.some(e=>e.packageId===t.packageId);t.element.classList.toggle("next-in-cart",i),t.element.setAttribute("data-next-in-cart",i.toString())});const t=this.items.filter(t=>e.items.some(e=>e.packageId===t.packageId));if(t.length>0&&"swap"===this.mode){const e=t[0];e&&this.selectedItem!==e&&this.selectItem(e)}else if(!this.selectedItem){const e=this.items.filter(e=>e.isPreSelected);e.length>1&&(this.logger.warn(`Multiple pre-selected items found in selector ${this.selectorId}. Only one should be pre-selected.`),e.slice(1).forEach(e=>{e.element.classList.remove("next-selected"),e.element.setAttribute("data-next-selected","false"),e.isPreSelected=!1}));const t=e[0];t&&(this.selectItem(t),"select"!==this.mode&&this.updateCart(null,t).catch(e=>{this.logger.error("Failed to add pre-selected item:",e)}))}}catch(t){this.handleError(t,"syncWithCart")}}update(){this.syncWithCart(Q.getState())}getSelectedItem(){return this.selectedItem}getSelectorConfig(){return{id:this.selectorId,mode:this.mode,itemCount:this.items.length}}cleanupEventListeners(){this.clickHandlers.forEach((e,t)=>{t.removeEventListener("click",e)}),this.clickHandlers.clear(),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null)}destroy(){this.cleanupEventListeners(),this.items.forEach(e=>{e.element.classList.remove("next-selector-card","next-selected","next-in-cart")}),super.destroy()}}},Symbol.toStringTag,{value:"Module"}));const Jt=Object.freeze(Object.defineProperty({__proto__:null,TimerEnhancer:class extends pt{constructor(){super(...arguments),this.duration=0,this.persistenceId="",this.format="mm:ss",this.startTime=0}async initialize(){this.validateElement();const e=this.getRequiredAttribute("data-duration");this.duration=parseInt(e,10),this.persistenceId=this.getAttribute("data-persistence-id")||"default-timer",this.format=this.getAttribute("data-format")||"mm:ss",this.loadStartTime(),this.startTimer(),this.logger.debug(`Initialized timer: ${this.duration}s, persistence: ${this.persistenceId}`)}update(){}loadStartTime(){const e=localStorage.getItem(`next-timer-${this.persistenceId}`);e?this.startTime=parseInt(e,10):(this.startTime=Date.now(),localStorage.setItem(`next-timer-${this.persistenceId}`,this.startTime.toString()))}startTimer(){this.updateDisplay(),this.interval=window.setInterval(()=>{this.updateDisplay()},1e3)}updateDisplay(){const e=Math.floor((Date.now()-this.startTime)/1e3),t=Math.max(0,this.duration-e);if(0===t)return void this.handleTimerExpired();const i=this.formatTime(t);(this.element.querySelector("[data-next-timer-display]")||this.element).textContent=i}formatTime(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),n=e%60,a=e=>e.toString().padStart(2,"0");switch(this.format){case"hh:mm:ss":return`${a(t)}:${a(i)}:${a(n)}`;case"mm:ss":default:return`${a(i)}:${a(n)}`;case"ss":return a(n)}}handleTimerExpired(){this.interval&&(clearInterval(this.interval),this.interval=void 0),localStorage.removeItem(`next-timer-${this.persistenceId}`),this.element.style.display="none";document.querySelectorAll(`[data-next-timer-expired][data-persistence-id="${this.persistenceId}"]`).forEach(e=>{e.style.display=""}),this.emit("timer:expired",{persistenceId:this.persistenceId}),this.logger.debug(`Timer expired: ${this.persistenceId}`)}destroy(){this.interval&&clearInterval(this.interval),super.destroy()}}},Symbol.toStringTag,{value:"Module"}));const Gt=Object.freeze(Object.defineProperty({__proto__:null,ConditionalDisplayEnhancer:class extends pt{constructor(){super(...arguments),this.packageContext=null,this.selectorId=null,this.dependsOnCart=!1,this.dependsOnPackage=!1,this.dependsOnSelection=!1,this.dependsOnOrder=!1,this.dependsOnShipping=!1,this.selectionChangeHandler=null}async initialize(){this.validateElement();const e=Pt.findPackageId(this.element);this.packageContext=void 0!==e?e:null,this.selectorId=this.detectSelectorContext();const t=this.getAttribute("data-next-show"),i=this.getAttribute("data-next-hide");if(t)this.condition=me.parseCondition(t),this.showCondition=!0;else{if(!i)throw new Error("Either data-next-show or data-next-hide is required");this.condition=me.parseCondition(i),this.showCondition=!1}this.analyzeDependencies(),this.dependsOnCart&&this.subscribe(Q,this.handleStateUpdate.bind(this)),this.dependsOnPackage&&this.subscribe(Y,this.handleCampaignUpdate.bind(this)),this.dependsOnSelection&&(this.selectionChangeHandler=this.handleSelectionChange.bind(this),this.eventBus.on("selector:selection-changed",this.selectionChangeHandler),this.eventBus.on("selector:item-selected",this.selectionChangeHandler)),this.dependsOnOrder&&this.subscribe(se,this.handleOrderUpdate.bind(this)),this.dependsOnShipping&&this.subscribe(Y,this.handleShippingUpdate.bind(this)),this.dependsOnCart?this.handleStateUpdate(Q.getState()):this.dependsOnPackage?this.handlePackageUpdate():this.dependsOnSelection?this.handleSelectionUpdate():this.dependsOnOrder?this.handleOrderUpdate(se.getState()):this.dependsOnShipping&&this.handleShippingUpdate(),this.logger.debug("Initialized conditional display:",{condition:this.condition,packageContext:this.packageContext,selectorId:this.selectorId,dependsOnCart:this.dependsOnCart,dependsOnPackage:this.dependsOnPackage,dependsOnSelection:this.dependsOnSelection,dependsOnOrder:this.dependsOnOrder,dependsOnShipping:this.dependsOnShipping})}update(){this.dependsOnCart?this.handleStateUpdate(Q.getState()):this.dependsOnPackage?this.handlePackageUpdate():this.dependsOnSelection?this.handleSelectionUpdate():this.dependsOnOrder&&this.handleOrderUpdate(se.getState())}analyzeDependencies(){this.dependsOnCart=this.conditionDependsOnCart(this.condition),this.dependsOnPackage=this.conditionDependsOnPackage(this.condition),this.dependsOnSelection=this.conditionDependsOnSelection(this.condition),this.dependsOnOrder=this.conditionDependsOnOrder(this.condition),this.dependsOnShipping=this.conditionDependsOnShipping(this.condition),this.dependsOnCart||this.dependsOnPackage||this.dependsOnSelection||this.dependsOnOrder||this.dependsOnShipping||(this.dependsOnCart=!0)}conditionDependsOnCart(e){switch(e.type){case"property":case"function":return"cart"===e.object;case"comparison":return"cart"===e.left.object||e.right&&"object"==typeof e.right&&"cart"===e.right.object;default:return!1}}conditionDependsOnPackage(e){switch(e.type){case"property":case"function":return"package"===e.object;case"comparison":return"package"===e.left.object||e.right&&"object"==typeof e.right&&"package"===e.right.object;default:return!1}}conditionDependsOnSelection(e){switch(e.type){case"property":case"function":return"selection"===e.object||e.object&&e.object.startsWith("selection.");case"comparison":const t="selection"===e.left.object||e.left.object&&e.left.object.startsWith("selection."),i=e.right&&"object"==typeof e.right&&("selection"===e.right.object||e.right.object&&e.right.object.startsWith("selection."));return t||i;default:return!1}}conditionDependsOnOrder(e){switch(e.type){case"property":case"function":return"order"===e.object;case"comparison":return"order"===e.left.object||e.right&&"object"==typeof e.right&&"order"===e.right.object;default:return!1}}conditionDependsOnShipping(e){switch(e.type){case"property":case"function":return"shipping"===e.object;case"comparison":return"shipping"===e.left.object||e.right&&"object"==typeof e.right&&"shipping"===e.right.object;default:return!1}}handleCampaignUpdate(){this.dependsOnPackage&&this.handlePackageUpdate()}handleOrderUpdate(e){try{const t=this.evaluateOrderCondition(e),i=this.showCondition?t:!t;this.element.style.display=i?"":"none",this.toggleClass("next-condition-met",t),this.toggleClass("next-condition-not-met",!t),this.toggleClass("next-visible",i),this.toggleClass("next-hidden",!i)}catch(t){this.handleError(t,"handleOrderUpdate")}}handlePackageUpdate(){try{const e=this.evaluatePackageCondition(),t=this.showCondition?e:!e;this.element.style.display=t?"":"none",this.toggleClass("next-condition-met",e),this.toggleClass("next-condition-not-met",!e),this.toggleClass("next-visible",t),this.toggleClass("next-hidden",!t)}catch(e){this.handleError(e,"handlePackageUpdate")}}handleShippingUpdate(){try{const e=this.evaluateShippingCondition(),t=this.showCondition?e:!e;this.element.style.display=t?"":"none",this.toggleClass("next-condition-met",e),this.toggleClass("next-condition-not-met",!e),this.toggleClass("next-visible",t),this.toggleClass("next-hidden",!t)}catch(e){this.handleError(e,"handleShippingUpdate")}}evaluatePackageCondition(){try{switch(this.condition.type){case"property":return this.evaluatePackageProperty(this.condition);case"comparison":return this.evaluatePackageComparison(this.condition);default:return this.logger.warn(`Unsupported condition type for package: ${this.condition.type}`),!1}}catch(e){return this.logger.error("Error evaluating package condition:",e),!1}}evaluateOrderCondition(e){try{switch(this.condition.type){case"property":return this.evaluateOrderProperty(e,this.condition);case"comparison":return this.evaluateOrderComparison(e,this.condition);default:return this.logger.warn(`Unsupported condition type for order: ${this.condition.type}`),!1}}catch(t){return this.logger.error("Error evaluating order condition:",t),!1}}evaluatePackageProperty(e){const t=this.getPackagePropertyValue(e.property);return Boolean(t)}evaluatePackageComparison(e){const t=this.getPackagePropertyValue(e.left.property),i=e.right;switch(e.operator){case">":return Number(t)>Number(i);case">=":return Number(t)>=Number(i);case"<":return Number(t)<Number(i);case"<=":return Number(t)<=Number(i);case"==":case"===":return t===i;case"!=":case"!==":return t!==i;default:return!1}}evaluateOrderProperty(e,t){const i=this.getOrderPropertyValue(e,t.property);return Boolean(i)}evaluateOrderComparison(e,t){const i=this.getOrderPropertyValue(e,t.left.property),n=t.right;switch(t.operator){case">":return Number(i)>Number(n);case">=":return Number(i)>=Number(n);case"<":return Number(i)<Number(n);case"<=":return Number(i)<=Number(n);case"==":case"===":return i===n;case"!=":case"!==":return i!==n;default:return!1}}handleStateUpdate(e){try{const t=this.evaluateCondition(e),i=this.showCondition?t:!t;this.element.style.display=i?"":"none",this.toggleClass("next-condition-met",t),this.toggleClass("next-condition-not-met",!t),this.toggleClass("next-visible",i),this.toggleClass("next-hidden",!i)}catch(t){this.handleError(t,"handleStateUpdate")}}evaluateCondition(e){try{switch(this.condition.type){case"property":return this.evaluateProperty(e,this.condition);case"function":return this.evaluateFunction(e,this.condition);case"comparison":return this.evaluateComparison(e,this.condition);default:return this.logger.warn(`Unknown condition type: ${this.condition.type}`),!1}}catch(t){return this.logger.error("Error evaluating condition:",t),!1}}detectSelectorContext(){if(this.condition){if(this.condition.property&&this.condition.property.includes(".")){const e=this.condition.property.split(".");if(e.length>=2)return this.logger.debug("Found selector ID in property:",e[0]),e[0]}if(this.condition.left&&this.condition.left.property&&this.condition.left.property.includes(".")){const e=this.condition.left.property.split(".");if(e.length>=2)return this.logger.debug("Found selector ID in comparison:",e[0]),e[0]}}const e=this.getAttribute("data-next-selector-id")||this.getAttribute("data-selector-id");if(e)return e;let t=this.element;for(;t;){const e=t.getAttribute("data-next-selector-id");if(e)return e;if(t.hasAttribute("data-next-cart-selector"))return t.getAttribute("data-next-selector-id")||t.getAttribute("data-next-id")||null;t=t.parentElement}return null}handleSelectionChange(e){this.selectorId&&e.selectorId!==this.selectorId||this.handleSelectionUpdate()}handleSelectionUpdate(){try{const e=this.evaluateSelectionCondition(),t=this.showCondition?e:!e;this.element.style.display=t?"":"none",this.toggleClass("next-condition-met",e),this.toggleClass("next-condition-not-met",!e),this.toggleClass("next-visible",t),this.toggleClass("next-hidden",!t)}catch(e){this.handleError(e,"handleSelectionUpdate")}}evaluateSelectionCondition(){try{switch(this.condition.type){case"property":return this.evaluateSelectionProperty(this.condition);case"comparison":return this.evaluateSelectionComparison(this.condition);default:return this.logger.warn(`Unsupported condition type for selection: ${this.condition.type}`),!1}}catch(e){return this.logger.error("Error evaluating selection condition:",e),!1}}evaluateShippingCondition(){try{switch(this.condition.type){case"property":return this.evaluateShippingProperty(this.condition);case"comparison":return this.evaluateShippingComparison(this.condition);default:return this.logger.warn(`Unsupported condition type for shipping: ${this.condition.type}`),!1}}catch(e){return this.logger.error("Error evaluating shipping condition:",e),!1}}evaluateSelectionProperty(e){const t=this.getSelectionPropertyValue(e.property);return Boolean(t)}evaluateSelectionComparison(e){const t=this.getSelectionPropertyValue(e.left.property),i=e.right;switch(e.operator){case">":return Number(t)>Number(i);case">=":return Number(t)>=Number(i);case"<":return Number(t)<Number(i);case"<=":return Number(t)<=Number(i);case"==":case"===":return t===i;case"!=":case"!==":return t!==i;default:return!1}}evaluateShippingProperty(e){const t=this.getShippingPropertyValue(e.property);return Boolean(t)}evaluateShippingComparison(e){const t=this.getShippingPropertyValue(e.left.property),i=e.right;switch(e.operator){case">":return Number(t)>Number(i);case">=":return Number(t)>=Number(i);case"<":return Number(t)<Number(i);case"<=":return Number(t)<=Number(i);case"==":case"===":return t===i;case"!=":case"!==":return t!==i;default:return!1}}evaluateProperty(e,t){const i=this.getPropertyValue(e,t.object,t.property);return Boolean(i)}evaluateFunction(e,t){const{object:i,method:n,args:a}=t;if("cart"===i)switch(n){case"hasItem":if(a.length>0){const t=a[0];return e.items.some(e=>e.packageId===t)}return!1;case"hasItems":return!e.isEmpty;default:return this.logger.warn(`Unknown cart method: ${n}`),!1}return!1}evaluateComparison(e,t){const i=this.getPropertyValue(e,t.left.object,t.left.property),n=t.right;switch(t.operator){case">":return Number(i)>Number(n);case">=":return Number(i)>=Number(n);case"<":return Number(i)<Number(n);case"<=":return Number(i)<=Number(n);case"==":case"===":return i===n;case"!=":case"!==":return i!==n;default:return!1}}getPropertyValue(e,t,i){if("cart"===t)switch(i){case"total":case"total.value":return e.totals.total.value;case"subtotal":case"subtotal.value":return e.totals.subtotal.value;case"shipping":case"shipping.value":return e.totals.shipping.value;case"tax":case"tax.value":return e.totals.tax.value;case"discounts":case"discounts.value":return e.totals.discounts.value;case"count":return e.totalQuantity;case"isEmpty":return e.isEmpty;case"hasItems":return!e.isEmpty;case"hasShipping":return e.totals.shipping.value>0;case"hasFreeShipping":return 0===e.totals.shipping.value;case"savingsAmount":case"savingsAmount.value":return e.totals.savings.value;case"savingsPercentage":case"savingsPercentage.value":return e.totals.savingsPercentage.value;case"compareTotal":case"compareTotal.value":return e.totals.compareTotal.value;case"hasSavings":return e.totals.hasSavings;default:const t=vt("cart",i);if(t){const{path:i,validator:n}=t;if(i.startsWith("!")){const t=i.substring(1);return!Ct.getNestedProperty(e,t)}let a=Ct.getNestedProperty(e,i);return n&&void 0!==a&&(a=n(a)),a}return Ct.getNestedProperty(e,i)}if("package"===t)return this.getPackagePropertyValue(i);if("selection"===t||t&&t.startsWith("selection.")){let e=this.selectorId,n=i;if(t.startsWith("selection.")){const a=t.split(".");a.length>=2&&(e=a[1]??null,a.length>2&&(n=a.slice(2).join(".")+(i?"."+i:"")))}return this.getSelectionPropertyValue(n,e)}if("order"===t){const e=se.getState();return this.getOrderPropertyValue(e,i)}return"shipping"===t?this.getShippingPropertyValue(i):null}getSelectionPropertyValue(e,t){let i=t||this.selectorId,n=e;if(e&&e.includes(".")){const t=e.split(".");t.length>=2&&(i=t[0]??null,n=t.slice(1).join("."))}if(!i)return this.logger.warn("Selection condition used but no selector context found"),null;const a=document.querySelector(`[data-next-selector-id="${i}"]`);if(!a)return this.logger.debug(`Selector element not found for ID: ${i}`),null;const s=a._getSelectedItem,r="function"==typeof s?s():null;if(!r)return"hasSelection"!==n&&null;let o;try{o=Y.getState().getPackage(r.packageId)??void 0}catch(l){this.logger.debug("Could not get package data for selection")}switch(n){case"hasSelection":return!0;case"packageId":return r.packageId;case"quantity":case"totalUnits":case"totalQuantity":return r.quantity||1;case"name":return o?.name||r.name||"";case"price":return o?parseFloat(o.price||"0"):r.price||0;case"total":case"price_total":return o?parseFloat(o.price_total||"0")||parseFloat(o.price||"0")*r.quantity:(r.price||0)*r.quantity;case"hasSavings":if(!o)return!1;return Lt.calculatePackageMetrics({price:parseFloat(o.price||"0"),retailPrice:parseFloat(o.price_retail||"0"),quantity:r.quantity,priceTotal:parseFloat(o.price_total||"0"),retailPriceTotal:parseFloat(o.price_retail_total||"0")}).hasSavings;case"savingsAmount":if(!o)return 0;return Lt.calculatePackageMetrics({price:parseFloat(o.price||"0"),retailPrice:parseFloat(o.price_retail||"0"),quantity:r.quantity,priceTotal:parseFloat(o.price_total||"0"),retailPriceTotal:parseFloat(o.price_retail_total||"0")}).totalSavings;case"savingsPercentage":if(!o)return 0;return Lt.calculatePackageMetrics({price:parseFloat(o.price||"0"),retailPrice:parseFloat(o.price_retail||"0"),quantity:r.quantity,priceTotal:parseFloat(o.price_total||"0"),retailPriceTotal:parseFloat(o.price_retail_total||"0")}).totalSavingsPercentage;case"compareTotal":case"price_retail_total":if(!o)return 0;const e=parseFloat(o.price_retail_total||"0");if(e>0)return e;const t=parseFloat(o.price_retail||"0");return t>0?t*r.quantity:this.getSelectionPropertyValue("total",i);case"isBundle":case"isMultiPack":return(r.quantity||1)>1;case"isSingleUnit":return 1===(r.quantity||1);default:return o?Ct.getNestedProperty(o,n):null}}getPackagePropertyValue(e){if(!this.packageContext)return this.logger.warn("Package condition used but no package context found"),null;try{const t=Y.getState().getPackage(this.packageContext);return t?this.calculatePackageProperty(t,e):(this.logger.warn(`Package ${this.packageContext} not found in campaign data`),null)}catch(t){return this.logger.error(`Error getting package property ${e}:`,t),null}}calculatePackageProperty(e,t){const i=parseFloat(e.price)||0,n=parseFloat(e.price_retail||e.price)||0,a=parseFloat(e.price_total||"0")||i*(e.qty||1),s=parseFloat(e.price_retail_total||"0")||n*(e.qty||1),r=e.qty||1,o=Lt.calculatePackageMetrics({price:i,retailPrice:n,quantity:r,priceTotal:a,retailPriceTotal:s});switch(t){case"name":return e.name;case"price":case"price.raw":return i;case"quantity":case"qty":return r;case"image":return e.image;case"isRecurring":return e.is_recurring;case"interval":return e.interval;case"intervalCount":return e.interval_count;case"hasRetailPrice":return n>0&&n!==i;case"hasSavings":case"hasDiscount":return o.hasSavings;case"savingsAmount":case"totalSavings":case"savingsAmount.raw":return o.totalSavings;case"savingsPercentage":case"totalSavingsPercentage":return o.totalSavingsPercentage;case"priceRetailTotal":return o.totalRetailPrice;case"unitPrice":return o.unitPrice;case"unitRetailPrice":return o.unitRetailPrice;case"unitSavings":return o.unitSavings;case"unitSavingsPercentage":return o.unitSavingsPercentage;case"isBundle":return r>1;case"isSubscription":return!0===e.is_recurring;case"isOneTime":return!e.is_recurring;case"priceRetail.raw":return n;default:return Ct.getNestedProperty(e,t)}}getShippingPropertyValue(e){const t=this.element.closest("[data-next-shipping-id]");if(!t)return this.logger.warn("Shipping condition used but no shipping context found"),null;const i=t.getAttribute("data-next-shipping-id");if(!i)return null;const n=Y.getState(),a=(n.data?.shipping_methods||[]).find(e=>e.ref_id===parseInt(i,10));if(!a)return this.logger.warn(`Shipping method ${i} not found in campaign data`),null;switch(e){case"isFree":return 0===parseFloat(a.price||"0");case"cost":case"price":return parseFloat(a.price||"0");case"name":case"code":return a.code;case"id":case"refId":return a.ref_id;case"method":return a;default:return null}}getOrderPropertyValue(e,t){const i=e.order;switch(t){case"exists":case"hasOrder":return!!i;case"isLoaded":return!e.isLoading&&!!i;case"isLoading":return e.isLoading;case"hasError":return!!e.error;case"cacheFresh":case"isCacheFresh":if(!i||!e.orderLoadedAt)return!1;return Date.now()-e.orderLoadedAt<9e5;case"cacheExpired":case"isCacheExpired":if(!i||!e.orderLoadedAt)return!1;return Date.now()-e.orderLoadedAt>=9e5;case"isRecent":case"isRecentOrder":if(!i)return!1;const t=i.attribution?.metadata?.timestamp;if(!t)return!1;return Date.now()-t<9e5;case"isExpired":if(!i)return!1;const n=i.attribution?.metadata?.timestamp;if(!n)return!1;return Date.now()-n>=9e5;case"isNewOrder":case"wasPlacedRecently":if(!i)return!1;const a=i.attribution?.metadata?.timestamp;if(!a)return!1;return Date.now()-a<9e5;case"isOldOrder":case"wasPlacedLongAgo":if(!i)return!1;const s=i.attribution?.metadata?.timestamp;if(!s)return!1;return Date.now()-s>=9e5}if(!i)return!1;switch(t){case"isTest":return i.is_test||!1;case"hasItems":return i.lines&&i.lines.length>0;case"isEmpty":return!i.lines||0===i.lines.length;case"hasShipping":return parseFloat(i.shipping_incl_tax||"0")>0;case"hasTax":return parseFloat(i.total_tax||"0")>0;case"hasDiscounts":return parseFloat(i.total_discounts||"0")>0;case"hasUpsells":return i.lines?.some(e=>e.is_upsell)||!1;case"supportsUpsells":case"acceptsUpsells":case"supportsPostPurchaseUpsells":return i.supports_post_purchase_upsells||!1;case"total":return parseFloat(i.total_incl_tax||"0");case"subtotal":return parseFloat(i.total_excl_tax||"0");case"tax":return parseFloat(i.total_tax||"0");case"shipping":return parseFloat(i.shipping_incl_tax||"0");case"shippingExclTax":return parseFloat(i.shipping_excl_tax||"0");case"shippingTax":return parseFloat(i.shipping_tax||"0");case"discounts":return parseFloat(i.total_discounts||"0");case"itemCount":return i.lines?.length||0;case"totalQuantity":return i.lines?.reduce((e,t)=>e+(t.quantity||0),0)||0;default:return Ct.getNestedProperty(i,t)}}destroy(){this.selectionChangeHandler&&(this.eventBus.off("selector:selection-changed",this.selectionChangeHandler),this.eventBus.off("selector:item-selected",this.selectionChangeHandler)),super.destroy()}}},Symbol.toStringTag,{value:"Module"}));class Zt{constructor(){this.cachePrefix="next_country_",this.cacheExpiry=36e5,this.baseUrl="https://cdn-countries.muddy-wind-c7ca.workers.dev",this.config={},this.logger=new N("CountryService")}static getInstance(){return Zt.instance||(Zt.instance=new Zt),Zt.instance}setConfig(e){this.config={...e},this.logger.debug("Address configuration updated:",this.config)}getConfig(){return{...this.config}}async getLocationData(){const e=this.getFromCache("location_data");if(e)return await this.applyCountryFiltering(e);try{const e=await fetch(`${this.baseUrl}/location`);if(!e.ok)throw new Error(`Failed to fetch location data: ${e.statusText}`);const t=await e.json();return this.setCache("location_data",t),this.logger.debug("Location data fetched",{detectedCountry:t.detectedCountryCode,countriesCount:t.countries?.length}),await this.applyCountryFiltering(t)}catch(t){return this.logger.error("Failed to fetch location data:",t),await this.applyCountryFiltering(this.getFallbackLocationData())}}async getCountryStates(e){const t=`states_${e}`,i=this.getFromCache(t);if(i)return{...i,states:this.applyStateFiltering(i.states||[])};try{const i=await fetch(`${this.baseUrl}/countries/${e}/states`);if(!i.ok)throw new Error(`Failed to fetch states for ${e}: ${i.statusText}`);const n=await i.json();return this.setCache(t,n),this.logger.debug(`States data fetched for ${e}`,{statesCount:n.states?.length,stateLabel:n.countryConfig?.stateLabel}),{...n,states:this.applyStateFiltering(n.states||[])}}catch(n){return this.logger.error(`Failed to fetch states for ${e}:`,n),{countryConfig:this.getDefaultCountryConfig(e),states:[]}}}async getCountryConfig(e){const t=await this.getLocationData();if(t.detectedCountryCode===e)return t.detectedCountryConfig;return(await this.getCountryStates(e)).countryConfig}validatePostalCode(e,t,i){if(!e)return!1;if(e.length<i.postcodeMinLength||e.length>i.postcodeMaxLength)return!1;if(i.postcodeRegex)try{return new RegExp(i.postcodeRegex).test(e)}catch(n){return this.logger.error("Invalid postal code regex:",n),!0}return!0}clearCache(){try{const e=[];for(let t=0;t<sessionStorage.length;t++){const i=sessionStorage.key(t);i&&i.startsWith(this.cachePrefix)&&e.push(i)}e.forEach(e=>sessionStorage.removeItem(e)),this.logger.debug("Country service cache cleared")}catch(e){this.logger.warn("Failed to clear cache:",e)}}clearCountryCache(e){try{const t=this.cachePrefix+`states_${e}`;sessionStorage.removeItem(t),this.logger.debug(`Cache cleared for country: ${e}`)}catch(t){this.logger.warn(`Failed to clear cache for country ${e}:`,t)}}getFromCache(e){try{const t=this.cachePrefix+e,i=sessionStorage.getItem(t);if(!i)return null;const{data:n,timestamp:a}=JSON.parse(i);return Date.now()-a>this.cacheExpiry?(sessionStorage.removeItem(t),null):n}catch(t){return this.logger.warn("Failed to read from cache:",t),null}}setCache(e,t){try{const i=this.cachePrefix+e,n={data:t,timestamp:Date.now()};sessionStorage.setItem(i,JSON.stringify(n))}catch(i){this.logger.warn("Failed to write to cache:",i)}}getDefaultCountryConfig(e){return{US:{stateLabel:"State",stateRequired:!0,postcodeLabel:"ZIP Code",postcodeRegex:"^\\d{5}(-\\d{4})?$",postcodeMinLength:5,postcodeMaxLength:10,postcodeExample:"12345 or 12345-6789",currencyCode:"USD",currencySymbol:"$"},CA:{stateLabel:"Province",stateRequired:!0,postcodeLabel:"Postal Code",postcodeRegex:"^[A-Z]\\d[A-Z] ?\\d[A-Z]\\d$",postcodeMinLength:6,postcodeMaxLength:7,postcodeExample:"K1A 0B1",currencyCode:"CAD",currencySymbol:"$"},GB:{stateLabel:"County",stateRequired:!1,postcodeLabel:"Postcode",postcodeRegex:"^[A-Z]{1,2}\\d{1,2}[A-Z]?\\s?\\d[A-Z]{2}$",postcodeMinLength:5,postcodeMaxLength:8,postcodeExample:"SW1A 1AA",currencyCode:"GBP",currencySymbol:"Â£"}}[e]||{stateLabel:"State/Province",stateRequired:!1,postcodeLabel:"Postal Code",postcodeRegex:null,postcodeMinLength:2,postcodeMaxLength:20,postcodeExample:null,currencyCode:"USD",currencySymbol:"$"}}getFallbackLocationData(){return{detectedCountryCode:"US",detectedCountryConfig:this.getDefaultCountryConfig("US"),detectedStates:[],countries:[{code:"US",name:"United States",phonecode:"+1",currencyCode:"USD",currencySymbol:"$"},{code:"CA",name:"Canada",phonecode:"+1",currencyCode:"CAD",currencySymbol:"$"},{code:"GB",name:"United Kingdom",phonecode:"+44",currencyCode:"GBP",currencySymbol:"Â£"},{code:"AU",name:"Australia",phonecode:"+61",currencyCode:"AUD",currencySymbol:"$"},{code:"DE",name:"Germany",phonecode:"+49",currencyCode:"EUR",currencySymbol:"â‚¬"}]}}async applyCountryFiltering(e){let t=[...e.countries];this.config.countries&&this.config.countries.length>0?t=this.config.countries.map(e=>({code:e.code,name:e.name,phonecode:"",currencyCode:"USD",currencySymbol:"$"})):this.config.showCountries&&this.config.showCountries.length>0&&(t=t.filter(e=>this.config.showCountries.includes(e.code)));let i=e.detectedCountryCode,n=e.detectedCountryConfig;if(this.config.defaultCountry){if(t.some(e=>e.code===this.config.defaultCountry)){i=this.config.defaultCountry;try{n=(await this.getCountryStates(this.config.defaultCountry)).countryConfig}catch(a){this.logger.warn(`Failed to fetch config for default country ${this.config.defaultCountry}, using fallback:`,a),n=this.getDefaultCountryConfig(this.config.defaultCountry)}}}return{...e,countries:t,detectedCountryCode:i,detectedCountryConfig:n}}applyStateFiltering(e){const t=["AS","UM-81","GU","UM-84","UM-86","UM-67","UM-89","UM-71","UM-76","MP","UM-95","PR","UM","VI","UM-79"];let i=e.filter(e=>!t.includes(e.code));return this.config.dontShowStates&&this.config.dontShowStates.length>0&&(i=i.filter(e=>!this.config.dontShowStates.includes(e.code))),i}}class Yt{static findField(e,t={}){const i=t.container||document,n=[`[data-next-checkout-field="${e}"]`,`[os-checkout-field="${e}"]`,`input[name="${e}"]`,`select[name="${e}"]`,`textarea[name="${e}"]`,`#${e}`,`[data-field="${e}"]`,`[data-field-name="${e}"]`],a=t.customSelectors||n;for(const r of a)try{const e=i.querySelector(r);if(e){const i=e;if(!t.includeHidden&&null===i.offsetParent)continue;if(!t.includeDisabled&&"disabled"in i){if(i.disabled)continue}return i}}catch(s){}return null}static findFields(e,t={}){const i=new Map;return e.forEach(e=>{const n=this.findField(e,t);n&&i.set(e,n)}),i}static findFieldWrapper(e,t){const i=t||[".form-group",".frm-flds",".form-input",".select-form-wrapper",".field-wrapper",".input-wrapper",".form-field"];for(const n of i){const t=e.closest(n);if(t)return t}return e.parentElement}static findFormContainer(e){return e.closest("form")}static findFieldLabel(e){if(e.id){const t=document.querySelector(`label[for="${e.id}"]`);if(t)return t}let t=e.parentElement;for(;t;){const e=t.querySelector("label");if(e)return e;if("LABEL"===t.tagName)return t;t=t.parentElement}const i=this.findFieldWrapper(e);if(i){const e=i.querySelector("label");if(e)return e}return null}static findAllFormFields(e,t={}){const i=['input:not([type="hidden"]):not([type="submit"]):not([type="button"])',"select","textarea"];t.includeButtons&&i.push("button",'input[type="submit"]','input[type="button"]');const n=[];return e.querySelectorAll(i.join(", ")).forEach(e=>{n.push(e)}),n}static findFieldsByAttribute(e,t,i=document.body){const n=[],a=`[${e}]`;return i.querySelectorAll(a).forEach(i=>{const a=i.getAttribute(e);t&&a?"string"==typeof t?a.includes(t)&&n.push(i):t instanceof RegExp&&t.test(a)&&n.push(i):n.push(i)}),n}static isFormField(e){return["INPUT","SELECT","TEXTAREA"].includes(e.tagName)}static getFieldType(e){return e instanceof HTMLInputElement?e.type||"text":e instanceof HTMLSelectElement?"select":e instanceof HTMLTextAreaElement?"textarea":"unknown"}static getFieldValue(e){return e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement?e.value:""}static setFieldValue(e,t){return(e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement)&&(e.value=t,e.dispatchEvent(new Event("change",{bubbles:!0})),!0)}}class Xt{constructor(e){this.isReady=!1,this.environmentKey=e,this.logger=R("CreditCardService"),this.validationState=this.initializeValidationState(),e||this.logger.error("No Spreedly environment key provided")}async initialize(){try{if(this.isReady)return void this.logger.debug("CreditCardService already initialized, skipping");if(this.findCreditCardFields(),!this.numberField||!this.cvvField)return void this.logger.debug("Credit card fields not found, skipping Spreedly initialization");await this.loadSpreedlyScript(),this.setupSpreedly(),this.logger.debug("CreditCardService initialized successfully")}catch(e){throw this.logger.error("Failed to initialize CreditCardService:",e),e}}async tokenizeCard(e){if(!this.isReady)throw new Error("Credit card service is not ready");if(!e.full_name||!e.month||!e.year)throw new Error("Credit card data is incomplete");return this.logger.debug("Tokenizing credit card"),new Promise((t,i)=>{const n=this.onTokenCallback,a=this.onErrorCallback;this.onTokenCallback=(e,i)=>{n&&n(e,i),n?this.onTokenCallback=n:delete this.onTokenCallback,a?this.onErrorCallback=a:delete this.onErrorCallback,t(e)},this.onErrorCallback=e=>{a&&a(e),n?this.onTokenCallback=n:delete this.onTokenCallback,a?this.onErrorCallback=a:delete this.onErrorCallback,i(new Error(e.join(". ")))};const s=setTimeout(()=>{n?this.onTokenCallback=n:delete this.onTokenCallback,a?this.onErrorCallback=a:delete this.onErrorCallback,i(new Error("Credit card tokenization timed out"))},3e4),r=t,o=i;t=e=>{clearTimeout(s),r(e)},i=e=>{clearTimeout(s),o(e)},window.Spreedly.tokenizeCreditCard(e)})}validateCreditCard(e){const t={};let i=!0;const n=this.monthField?.getAttribute("data-next-checkout-field")||this.monthField?.getAttribute("os-checkout-field")||"cc-month",a=this.yearField?.getAttribute("data-next-checkout-field")||this.yearField?.getAttribute("os-checkout-field")||"cc-year";if(e.month&&""!==e.month.trim()){const a=parseInt(e.month,10);a<1||a>12?(t[n]="Please select a valid month",this.setCreditCardFieldError("month","Please select a valid month"),i=!1):this.setCreditCardFieldValid("month")}else t[n]="Expiration month is required",this.setCreditCardFieldError("month","Expiration month is required"),i=!1;if(e.year&&""!==e.year.trim()){const s=new Date,r=s.getFullYear(),o=s.getMonth()+1,l=parseInt(e.year,10),c=l<100?2e3+l:l;if(c<r||c>r+20)t[a]="Please select a valid year",this.setCreditCardFieldError("year","Please select a valid year"),i=!1;else if(c===r&&e.month){parseInt(e.month,10)<o?(t[n]="Card has expired",t[a]="Card has expired",this.setCreditCardFieldError("month","Card has expired"),this.setCreditCardFieldError("year","Card has expired"),i=!1):this.setCreditCardFieldValid("year")}else this.setCreditCardFieldValid("year")}else t[a]="Expiration year is required",this.setCreditCardFieldError("year","Expiration year is required"),i=!1;const s={isValid:i};return Object.keys(t).length>0&&(s.errors=t),s}checkSpreedlyFieldsReady(){const e=[];return this.validationState.number.isValid||e.push({field:"number",message:"Please enter a valid credit card number"}),this.validationState.cvv.isValid||e.push({field:"cvv",message:"Please enter a valid CVV"}),{hasEmptyFields:e.length>0,errors:e}}clearAllErrors(){this.clearCreditCardFieldError("number"),this.clearCreditCardFieldError("cvv"),this.clearCreditCardFieldError("month"),this.clearCreditCardFieldError("year"),this.hidePaymentErrorContainers()}clearFields(){if(window.Spreedly&&this.isReady)try{window.Spreedly.reload(),this.logger.debug("Spreedly fields reloaded")}catch(e){this.logger.warn("Failed to reload Spreedly fields:",e)}this.monthField instanceof HTMLSelectElement&&(this.monthField.selectedIndex=0),this.yearField instanceof HTMLSelectElement&&(this.yearField.selectedIndex=0),this.validationState=this.initializeValidationState(),this.clearAllErrors()}hidePaymentErrorContainers(){const e=document.querySelector('[data-next-component="credit-error"]');e instanceof HTMLElement&&(e.style.display="none",e.classList.remove("visible"))}setOnReady(e){this.onReadyCallback=e,this.isReady&&e()}setOnError(e){this.onErrorCallback=e}setOnToken(e){this.onTokenCallback=e}get ready(){return this.isReady}focusField(e){window.Spreedly&&this.isReady&&(window.Spreedly.transferFocus(e),this.logger.debug(`Focusing ${e} field`))}initializeValidationState(){return{number:{isValid:!1,hasError:!1},cvv:{isValid:!1,hasError:!1},month:{isValid:!1,hasError:!1},year:{isValid:!1,hasError:!1}}}findCreditCardFields(){const e=Yt.findField("cc-number")||document.getElementById("spreedly-number");e&&(this.numberField=e);const t=Yt.findField("cvv")||document.getElementById("spreedly-cvv");t&&(this.cvvField=t);const i=Yt.findField("cc-month")||Yt.findField("exp-month");i&&(this.monthField=i);const n=Yt.findField("cc-year")||Yt.findField("exp-year");n&&(this.yearField=n),this.logger.debug("Credit card fields found:",{number:!!this.numberField,cvv:!!this.cvvField,month:!!this.monthField,year:!!this.yearField})}async loadSpreedlyScript(){if(void 0===window.Spreedly)return this.logger.debug("Loading Spreedly script..."),new Promise((e,t)=>{const i=document.createElement("script");i.src="https://core.spreedly.com/iframe/iframe-v1.min.js",i.async=!0,i.onload=()=>{this.logger.debug("Spreedly script loaded"),e()},i.onerror=()=>{this.logger.error("Failed to load Spreedly script"),t(new Error("Failed to load Spreedly script"))},document.head.appendChild(i)});this.logger.debug("Spreedly already loaded")}setupSpreedly(){try{this.numberField&&(this.numberField.id="spreedly-number",this.numberField.setAttribute("data-spreedly","number"),this.numberField.style.transition="border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out"),this.cvvField&&(this.cvvField.id="spreedly-cvv",this.cvvField.setAttribute("data-spreedly","cvv"),this.cvvField.style.transition="border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out"),window.Spreedly.init(this.environmentKey,{numberEl:"spreedly-number",cvvEl:"spreedly-cvv"}),this.setupSpreedlyEventListeners(),this.setupFieldClickHandlers(),this.addFocusStyles(),this.logger.debug("Spreedly setup complete")}catch(e){throw this.logger.error("Error setting up Spreedly:",e),e}}addFocusStyles(){const e="spreedly-focus-styles";if(!document.getElementById(e)){const t=document.createElement("style");t.id=e,t.textContent="\n        /* Spreedly field focus states */\n        #spreedly-number.next-focused,\n        #spreedly-number.has-focus,\n        #spreedly-cvv.next-focused,\n        #spreedly-cvv.has-focus {\n          border-color: #80bdff !important;\n          outline: 0 !important;\n          box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;\n        }\n        \n        /* Bootstrap-style focus */\n        .form-control#spreedly-number.next-focused,\n        .form-control#spreedly-number.has-focus,\n        .form-control#spreedly-cvv.next-focused,\n        .form-control#spreedly-cvv.has-focus {\n          border-color: #80bdff !important;\n          box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;\n        }\n        \n        /* Parent container focus states */\n        .frm-flds.next-focused,\n        .form-group.next-focused,\n        .field-group.next-focused {\n          /* Add any parent-level focus styles here if needed */\n        }\n        \n        /* Ensure smooth transitions */\n        #spreedly-number,\n        #spreedly-cvv {\n          transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;\n        }\n      ",document.head.appendChild(t)}}setupFieldClickHandlers(){if(this.numberField){(this.numberField.closest(".frm-flds, .form-group, .form-field, .field-group")||this.numberField).addEventListener("click",e=>{const t=e.target;"INPUT"!==t.tagName&&"SELECT"!==t.tagName&&"TEXTAREA"!==t.tagName&&window.Spreedly&&this.isReady&&(window.Spreedly.transferFocus("number"),this.logger.debug("Transferring focus to credit card number field"))}),this.numberField.addEventListener("click",()=>{window.Spreedly&&this.isReady&&window.Spreedly.transferFocus("number")})}if(this.cvvField){(this.cvvField.closest(".frm-flds, .form-group, .form-field, .field-group")||this.cvvField).addEventListener("click",e=>{const t=e.target;"INPUT"!==t.tagName&&"SELECT"!==t.tagName&&"TEXTAREA"!==t.tagName&&window.Spreedly&&this.isReady&&(window.Spreedly.transferFocus("cvv"),this.logger.debug("Transferring focus to CVV field"))}),this.cvvField.addEventListener("click",()=>{window.Spreedly&&this.isReady&&window.Spreedly.transferFocus("cvv")})}}setupSpreedlyEventListeners(){window.Spreedly.on("ready",()=>{this.logger.info("[Spreedly Event: ready] iFrame initialized and ready for configuration"),this.applySpreedlyConfig(),this.isReady=!0,this.onReadyCallback&&this.onReadyCallback()}),window.Spreedly.on("errors",e=>{this.logger.error("[Spreedly Event: errors] Tokenization failed:",e.map(e=>({attribute:e.attribute,key:e.key,message:e.message})));const t=e.map(e=>e.message&&""!==e.message.trim()?e.message:"errors.unexpected_error"===e.key||0===e.status?"Unable to process payment. Please check your internet connection and try again.":"An error occurred processing your payment. Please try again.");this.onErrorCallback&&this.onErrorCallback(t),this.showSpreedlyErrors(e)}),window.Spreedly.on("paymentMethod",(e,t)=>{this.logger.info("[Spreedly Event: paymentMethod] Successfully tokenized!",{token:e,last4:t.last_four_digits,cardType:t.card_type,fingerprint:t.fingerprint}),this.clearAllErrors(),this.onTokenCallback?(this.logger.debug("[Spreedly] Invoking token callback"),this.onTokenCallback(e,t)):this.logger.error("[Spreedly] No onTokenCallback registered!")}),window.Spreedly.on("validation",e=>{this.logger.info("[Spreedly Event: validation] Validation requested:",{cardType:e.cardType,validNumber:e.validNumber,validCvv:e.validCvv,numberLength:e.numberLength,cvvLength:e.cvvLength,iin:e.iin}),void 0!==e.validNumber&&(this.validationState.number.isValid=e.validNumber,this.validationState.number.hasError=!e.validNumber),void 0!==e.validCvv&&(this.validationState.cvv.isValid=e.validCvv,this.validationState.cvv.hasError=!e.validCvv)}),window.Spreedly.on("fieldEvent",(e,t,i,n)=>{this.handleSpreedlyFieldEvent(e,t,n)}),window.Spreedly.on("consoleError",e=>{this.logger.error("[Spreedly Event: consoleError] Error from iFrame:",{message:e.msg,url:e.url,line:e.line,col:e.col})})}applySpreedlyConfig(){try{window.Spreedly.setFieldType("number","text"),window.Spreedly.setFieldType("cvv","text"),window.Spreedly.setNumberFormat("prettyFormat"),window.Spreedly.setPlaceholder("number","Credit Card Number"),window.Spreedly.setPlaceholder("cvv","CVV *");const e='color: #212529; font-size: .925rem; font-weight: 400; width: 100%; height:100%; font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Liberation Sans",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";';window.Spreedly.setStyle("number",e),window.Spreedly.setStyle("cvv",e),window.Spreedly.setRequiredAttribute("number"),window.Spreedly.setRequiredAttribute("cvv"),this.logger.debug("Spreedly configuration applied")}catch(e){this.logger.error("Error applying Spreedly configuration:",e)}}handleSpreedlyFieldEvent(e,t,i){if("focus"===t?this.handleFieldFocus(e):"blur"===t&&this.handleFieldBlur(e),"input"===t&&i)if("number"===e&&void 0!==i.validNumber){const e=this.validationState.number.isValid,t=this.validationState.number.hasError;if(this.validationState.number.isValid=i.validNumber,this.validationState.number.hasError=!i.validNumber,e!==i.validNumber&&this.logger.info(`[Spreedly] Card number validation changed: ${e} -> ${i.validNumber}`),i.validNumber&&(t||e!==i.validNumber)){this.logger.info("[Spreedly] Card number is now valid, clearing error"),this.clearCreditCardFieldError("number");const e=te.getState();e.clearError("cc-number"),e.clearError("card_number")}else if(!i.validNumber&&e){this.logger.info("[Spreedly] Card number is now invalid, showing error"),this.setCreditCardFieldError("number","Please enter a valid credit card number");te.getState().setError("cc-number","Please enter a valid credit card number")}}else if("cvv"===e&&void 0!==i.validCvv){const e=this.validationState.cvv.isValid,t=this.validationState.cvv.hasError;if(this.validationState.cvv.isValid=i.validCvv,this.validationState.cvv.hasError=!i.validCvv,e!==i.validCvv&&this.logger.info(`[Spreedly] CVV validation changed: ${e} -> ${i.validCvv}`),i.validCvv&&(t||e!==i.validCvv)){this.logger.info("[Spreedly] CVV is now valid, clearing error"),this.clearCreditCardFieldError("cvv");const e=te.getState();e.clearError("cvv"),e.clearError("card_cvv")}else if(!i.validCvv&&e){this.logger.info("[Spreedly] CVV is now invalid, showing error"),this.setCreditCardFieldError("cvv","Please enter a valid CVV");te.getState().setError("cvv","Please enter a valid CVV")}}}handleFieldFocus(e){const t="number"===e?this.numberField:"cvv"===e?this.cvvField:null;if(t){t.classList.add("next-focused","has-focus");const i=t.closest(".frm-flds, .form-group, .form-field, .field-group");i&&i.classList.add("next-focused","has-focus");const n=t.closest(".credit-card-field, .form-input-wrapper");n&&n.classList.add("next-focused","has-focus"),this.logger.debug(`Field focused: ${e}`)}}handleFieldBlur(e){const t="number"===e?this.numberField:"cvv"===e?this.cvvField:null;if(t){t.classList.remove("next-focused","has-focus");const i=t.closest(".frm-flds, .form-group, .form-field, .field-group");i&&i.classList.remove("next-focused","has-focus");const n=t.closest(".credit-card-field, .form-input-wrapper");n&&n.classList.remove("next-focused","has-focus"),this.logger.debug(`Field blurred: ${e}`)}}showSpreedlyErrors(e){this.logger.info("[Spreedly] Showing errors:",e);const t=document.querySelector('[data-next-component="credit-error"]');if(t instanceof HTMLElement){const i=t.querySelector('[data-next-component="credit-error-text"]');if(i){const n=e.map(e=>e.message).join(". ");i.textContent=n,t.style.display="flex",t.classList.add("visible"),this.logger.debug("[Spreedly] Error displayed with message:",n),setTimeout(()=>{"flex"===t.style.display&&(t.style.display="none",t.classList.remove("visible"),this.logger.debug("[Spreedly] Error auto-hidden after 10 seconds"))},1e4)}}else this.logger.error("[Spreedly] Could not find error container to display errors");e.forEach(e=>{const t=e.attribute;"number"===t||"card_number"===t?this.setCreditCardFieldError("number",e.message):"cvv"===t&&this.setCreditCardFieldError("cvv",e.message)})}setCreditCardFieldValid(e){this.validationState[e].isValid=!0,this.validationState[e].hasError=!1,delete this.validationState[e].errorMessage;const t=this.getFieldElement(e);if(t){t.classList.remove("has-error","next-error-field"),t.classList.add("no-error");const e=Yt.findFieldWrapper(t);e&&(e.classList.remove("has-error","addErrorIcon"),e.classList.add("addTick"))}}setCreditCardFieldError(e,t){this.validationState[e].isValid=!1,this.validationState[e].hasError=!0,this.validationState[e].errorMessage=t,this.logger.debug(`[Spreedly] Setting error for field: ${e} - ${t}`);let i=null;if("number"===e?i='[data-next-checkout-field="cc-number"], #spreedly-number':"cvv"===e?i='[data-next-checkout-field="cvv"], #spreedly-cvv':"month"===e?i='[data-next-checkout-field="cc-month"], [data-next-checkout-field="exp-month"]':"year"===e&&(i='[data-next-checkout-field="cc-year"], [data-next-checkout-field="exp-year"]'),!i)return void this.logger.warn(`[Spreedly] No selector found for field type: ${e}`);document.querySelectorAll(i).forEach(e=>{if(e instanceof HTMLElement){e.classList.remove("no-error"),e.classList.add("has-error","next-error-field");const i=e.closest(".form-group, .frm-flds, .field-group");if(i){i.classList.remove("addTick"),i.classList.add("has-error","addErrorIcon");i.querySelectorAll(".next-error-label").forEach(e=>e.remove());const e=document.createElement("div");e.className="next-error-label",e.setAttribute("role","alert"),e.setAttribute("aria-live","polite"),e.textContent=t,i.appendChild(e),this.logger.debug(`[Spreedly] Added error label: ${t}`)}}})}clearCreditCardFieldError(e){this.validationState[e].hasError=!1,delete this.validationState[e].errorMessage,this.logger.debug(`[Spreedly] Clearing error for field: ${e}`);let t=null;if("number"===e?t='[data-next-checkout-field="cc-number"], #spreedly-number':"cvv"===e?t='[data-next-checkout-field="cvv"], #spreedly-cvv':"month"===e?t='[data-next-checkout-field="cc-month"], [data-next-checkout-field="exp-month"]':"year"===e&&(t='[data-next-checkout-field="cc-year"], [data-next-checkout-field="exp-year"]'),!t)return void this.logger.warn(`[Spreedly] No selector found for field type: ${e}`);document.querySelectorAll(t).forEach(e=>{if(e instanceof HTMLElement){e.classList.remove("has-error","next-error-field");const t=e.closest(".form-group, .frm-flds, .field-group");if(t){t.classList.remove("has-error","addErrorIcon");t.querySelectorAll('.next-error-label, .error-message, [role="alert"]').forEach(e=>{this.logger.debug(`[Spreedly] Removing error label: ${e.textContent}`),e.remove()})}}})}getFieldElement(e){switch(e){case"number":return this.numberField;case"cvv":return this.cvvField;case"month":return this.monthField;case"year":return this.yearField;default:return}}destroy(){this.clearAllErrors(),this.isReady=!1,delete this.onReadyCallback,delete this.onErrorCallback,delete this.onTokenCallback,this.logger.debug("CreditCardService destroyed")}}const ei={wrapperClass:"form-group",errorClass:"next-error-field",errorLabelClass:"next-error-label",successClass:"no-error",iconErrorClass:"addErrorIcon",iconSuccessClass:"addTick"};class ti{constructor(e={}){this.options={...ei,...e}}showFieldError(e,t){const i=Yt.findFieldWrapper(e);if(!i)return;this.clearFieldError(e),e.classList.add("has-error",this.options.errorClass),e.classList.remove(this.options.successClass),i.classList.add(this.options.iconErrorClass),i.classList.remove(this.options.iconSuccessClass);const n=document.createElement("div");n.className=this.options.errorLabelClass,n.textContent=t,n.setAttribute("role","alert"),n.setAttribute("aria-live","polite");const a=e.closest(`.${this.options.wrapperClass}`);a?a.appendChild(n):i.appendChild(n)}clearFieldError(e){const t=Yt.findFieldWrapper(e);if(e.classList.remove("has-error",this.options.errorClass),t){t.classList.remove(this.options.iconErrorClass);const i=t.querySelector(`.${this.options.errorLabelClass}`);i&&i.remove();const n=e.closest(`.${this.options.wrapperClass}`);if(n){const e=n.querySelector(`.${this.options.errorLabelClass}`);e&&e.remove()}}}showFieldValid(e){const t=Yt.findFieldWrapper(e);this.clearFieldError(e),e.classList.add(this.options.successClass),t&&t.classList.add(this.options.iconSuccessClass)}clearAllErrors(e){e.querySelectorAll(`.${this.options.errorLabelClass}`).forEach(e=>e.remove());e.querySelectorAll(`.${this.options.errorClass}, .has-error`).forEach(e=>{e.classList.remove("has-error",this.options.errorClass)});e.querySelectorAll(`.${this.options.iconErrorClass}`).forEach(e=>{e.classList.remove(this.options.iconErrorClass)})}displayErrors(e,t){this.clearAllErrors(t),Object.entries(e).forEach(([e,i])=>{const n=this.findField(e,t);n&&this.showFieldError(n,i)})}findField(e,t){const i=[`[data-next-checkout-field="${e}"]`,`[os-checkout-field="${e}"]`,`[name="${e}"]`,`#${e}`];for(const n of i){const e=t.querySelector(n);if(e)return e}return null}static showToastError(e,t=1e4){const i=document.querySelector('[next-checkout-element="spreedly-error"]');if(!(i instanceof HTMLElement))return;const n=i.querySelector('[data-os-message="error"]');n instanceof HTMLElement&&(n.textContent=e,i.style.display="flex",setTimeout(()=>{"flex"===i.style.display&&(i.style.display="none")},t))}static hideToastError(){const e=document.querySelector('[next-checkout-element="spreedly-error"]');e instanceof HTMLElement&&(e.style.display="none")}}new ti;const ii={EMAIL:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,PHONE:/^[\d\s\-\+\(\)]+$/,NAME:/^[A-Za-zÃ€-Ã¿]+(?:[' -][A-Za-zÃ€-Ã¿]+)*$/};class ni{constructor(e,t,i){this.rules=new Map,this.errors=new Map,this.logger=e,this.countryService=t,this.phoneInputManager=i,this.errorManager=new ti,this.initializeValidationRules()}setCreditCardService(e){this.creditCardService=e}setPhoneValidator(e){this.phoneValidator=e}initializeValidationRules(){const e={type:"required",message:"This field is required"},t={type:"name",message:"Name can only contain letters, spaces, hyphens, and apostrophes"};this.rules.set("email",[e,{type:"email",message:"Please enter a valid email address"}]),this.rules.set("fname",[e,t]),this.rules.set("lname",[e,t]),this.rules.set("address1",[e]),this.rules.set("city",[e]),this.rules.set("postal",[e]),this.rules.set("country",[e]),this.rules.set("phone",[{type:"phone",message:"Please enter a valid phone number"}])}validateField(e,t,i){const n=this.rules.get(e)||[];let a,s=!0;for(const o of n)if(!this.applyRule(o,t,i)){a=o.message||`${this.formatFieldName(e,i)} is invalid`,this.setError(e,a),s=!1;break}s&&this.clearError(e);const r={isValid:s};return void 0!==a&&(r.message=a),r}async validateForm(e,t,i,n=!1,a,s=!0){let r,o=!0;const l={},c=t.get(e.country),d=["email","fname","lname","address1","city"];if(c?.stateRequired&&d.push("province"),d.push("postal","country"),d.forEach(t=>{e[t]&&""!==e[t].trim()||(l[t]=`${this.formatFieldName(t,i)} is required`,r||(r=t),o=!1)}),e.fname&&e.fname.trim()&&!this.isValidName(e.fname)&&(l.fname="First name can only contain letters, spaces, hyphens, and apostrophes",r||(r="fname"),o=!1),e.lname&&e.lname.trim()&&!this.isValidName(e.lname)&&(l.lname="Last name can only contain letters, spaces, hyphens, and apostrophes",r||(r="lname"),o=!1),e.email&&!this.isValidEmail(e.email)&&(l.email="Please enter a valid email address",o&&(r="email"),o=!1),e.phone){let t=!1;if(this.phoneValidator)t=this.phoneValidator(e.phone,"shipping");else if(this.phoneInputManager){t=this.phoneInputManager.validatePhoneNumber(!0);const i=this.phoneInputManager.getFormattedPhoneNumber(!0);i&&(e.phone=i)}else t=this.isValidPhone(e.phone);t||(l.phone="Please enter a valid phone number",o&&(r="phone"),o=!1)}if(e.postal&&e.country){const i=t.get(e.country);if(i&&!this.countryService.validatePostalCode(e.postal,e.country,i)){const e=i.postcodeExample?`Please enter a valid ${i.postcodeLabel.toLowerCase()} (e.g. ${i.postcodeExample})`:`Please enter a valid ${i.postcodeLabel.toLowerCase()}`;l.postal=e,o&&(r="postal"),o=!1}}if(n){const t=e.paymentMethod||"credit-card";if("credit-card"===t||"card_token"===t){const t={full_name:`${e.fname||""} ${e.lname||""}`.trim(),month:e["exp-month"]||e["cc-month"]||"",year:e["exp-year"]||e["cc-year"]||""};if(this.creditCardService){const e=this.creditCardService.checkSpreedlyFieldsReady();e.hasEmptyFields&&(e.errors.forEach(e=>{const t="number"===e.field?"cc-number":"cvv";l[t]=e.message,o&&"number"===e.field?r="cc-number":o&&!r&&(r=t)}),o=!1);const i=this.creditCardService.validateCreditCard(t);!i.isValid&&i.errors&&Object.entries(i.errors).forEach(([e,t])=>{l[e]=t,o&&(r=e,o=!1)})}}}if(!s&&a){const e=this.validateBillingAddress(a,t);Object.entries(e.errors).forEach(([e,t])=>{const i={first_name:"billing-fname",last_name:"billing-lname",address1:"billing-address1",city:"billing-city",province:"billing-province",postal:"billing-postal",country:"billing-country",phone:"billing-phone"}[e]||`billing-${e}`;l[i]=t,o&&(r=i,o=!1)}),e.isValid||(o=!1)}return{isValid:o,...r&&{firstErrorField:r},errors:l}}applyRule(e,t,i){switch(e.type){case"required":return null!=t&&""!==t.toString().trim();case"email":return!t||this.isValidEmail(t);case"phone":return!t||(this.phoneInputManager?this.phoneInputManager.validatePhoneNumber(!0):this.isValidPhone(t));case"name":return!t||this.isValidName(t);case"postal":if(!t||!i?.country)return!0;const n=i.countryConfigs?.get(i.country);return!n||this.countryService.validatePostalCode(t,i.country,n);case"custom":return!e.validator||e.validator(t,i);default:return!0}}isValidEmail(e){return ii.EMAIL.test(e)}isValidPhone(e){return ii.PHONE.test(e)&&e.replace(/\D/g,"").length>=10}isValidName(e){return ii.NAME.test(e.trim())}formatFieldName(e,t){return{fname:"First name",lname:"Last name",address1:"Address",address2:"Address line 2",city:"City",province:t?.stateLabel||"State/Province",postal:t?.postcodeLabel||"Postal code",country:"Country",email:"Email",phone:"Phone number"}[e]||e}validateBillingAddress(e,t){const i={};let n=!0;const a=["first_name","last_name","address1","city","country"],s=t.get(e?.country);if(s?.stateRequired&&a.push("province"),a.push("postal"),a.forEach(t=>{const a=e?.[t];if(a&&""!==a.trim()){if(("first_name"===t||"last_name"===t)&&a.trim()&&!this.isValidName(a)){const e="first_name"===t?"First name":"Last name";i[t]=`Billing ${e.toLowerCase()} can only contain letters, spaces, hyphens, and apostrophes`,n=!1}}else{const e="first_name"===t?"First name":"last_name"===t?"Last name":"address1"===t?"Address":"city"===t?"City":"province"===t?"State/Province":"postal"===t?"ZIP/Postal code":"country"===t?"Country":t;i[t]=`Billing ${e.toLowerCase()} is required`,n=!1}}),e?.phone){let t=!1;t=this.phoneValidator?this.phoneValidator(e.phone,"billing"):this.isValidPhone(e.phone),t||(i.phone="Please enter a valid billing phone number",n=!1)}if(e?.postal&&e?.country){const a=t.get(e.country);if(a&&!this.countryService.validatePostalCode(e.postal,e.country,a)){const e=a.postcodeExample?`Please enter a valid billing ${a.postcodeLabel.toLowerCase()} (e.g. ${a.postcodeExample})`:`Please enter a valid billing ${a.postcodeLabel.toLowerCase()}`;i.postal=e,n=!1}}return{isValid:n,errors:i}}setError(e,t){this.errors.set(e,t),this.showError(e,t)}clearError(e){this.errors.delete(e),this.hideError(e)}clearAllErrors(){this.errors.clear();document.querySelectorAll("[data-next-checkout-field], [os-checkout-field]").forEach(e=>{const t=e.getAttribute("data-next-checkout-field")||e.getAttribute("os-checkout-field");t&&this.hideError(t)}),this.creditCardService&&this.creditCardService.clearAllErrors()}showError(e,t){const i=this.findFormField(e);i&&this.errorManager.showFieldError(i,t)}hideError(e){const t=this.findFormField(e);t&&(this.errorManager.clearFieldError(t),this.errorManager.showFieldValid(t))}findFormField(e){return Yt.findField(e)}focusFirstErrorField(e){if(!e)return;if(["cc-month","cc-year","number","cvv","exp-month","exp-year"].includes(e))return void this.focusCreditCardErrorField(e);const t=this.findFormField(e);t&&"focus"in t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.focus()},800))}focusCreditCardErrorField(e){if("cc-number"===e||"number"===e)"undefined"!=typeof window&&window.Spreedly&&window.Spreedly.transferFocus("number");else if("cvv"===e)"undefined"!=typeof window&&window.Spreedly&&window.Spreedly.transferFocus("cvv");else{const t=this.findFormField(e);t&&"focus"in t&&t.focus()}}isValid(){return 0===this.errors.size}destroy(){this.clearAllErrors(),this.logger.debug("CheckoutValidator destroyed")}}class ai{constructor(){this.handlers=new Map,this.bindings=[]}addHandler(e,t,i,n){if(!e)return;this.handlers.has(e)||this.handlers.set(e,new Map);const a=this.handlers.get(e);if(a.has(t)){const i=a.get(t);e.removeEventListener(t,i)}e.addEventListener(t,i,n),a.set(t,i);const s={element:e,event:t,handler:i};void 0!==n&&(s.options=n),this.bindings.push(s)}addHandlers(e){e.forEach(e=>{this.addHandler(e.element,e.event,e.handler,e.options)})}removeHandler(e,t){if(!e)return;const i=this.handlers.get(e);if(!i)return;const n=i.get(t);n&&(e.removeEventListener(t,n),i.delete(t),this.bindings=this.bindings.filter(i=>!(i.element===e&&i.event===t))),0===i.size&&this.handlers.delete(e)}removeElementHandlers(e){const t=this.handlers.get(e);t&&(t.forEach((t,i)=>{e.removeEventListener(i,t)}),this.handlers.delete(e),this.bindings=this.bindings.filter(t=>t.element!==e))}removeAllHandlers(){this.handlers.forEach((e,t)=>{e.forEach((e,i)=>{t.removeEventListener(i,e)})}),this.handlers.clear(),this.bindings=[]}addDelegatedHandler(e,t,i,n){this.addHandler(e,i,i=>{const a=i.target.closest(t);a&&e.contains(a)&&n(i,a)})}addDebouncedHandler(e,t,i,n=300){let a;this.addHandler(e,t,e=>{a&&clearTimeout(a),a=window.setTimeout(()=>{i(e)},n)})}addThrottledHandler(e,t,i,n=300){let a=!1;this.addHandler(e,t,e=>{a||(i(e),a=!0,setTimeout(()=>{a=!1},n))})}addOnceHandler(e,t,i){this.addHandler(e,t,n=>{i(n),this.removeHandler(e,t)})}getActiveBindings(){return[...this.bindings]}hasHandler(e,t){const i=this.handlers.get(e);return!!i&&i.has(t)}}class si{constructor(e,t,i,n){this.floatingLabels=new Map,this.loadingStates=new Map,this.lastErrorsString="",this.form=e,this.fields=t,this.logger=i,n&&(this.billingFields=n),this.errorManager=new ti,this.eventManager=new ai}initialize(){this.initializeFloatingLabels(),this.logger.debug("UIService initialized")}showLoading(e){this.loadingStates.set(e,!0),this.form.classList.add("next-processing");const t=this.form.querySelector(`[data-section="${e}"]`);t instanceof HTMLElement&&t.classList.add("next-loading"),this.logger.debug(`Showing loading state for section: ${e}`)}hideLoading(e){this.loadingStates.set(e,!1);Array.from(this.loadingStates.values()).some(e=>e)||this.form.classList.remove("next-processing");const t=this.form.querySelector(`[data-section="${e}"]`);t instanceof HTMLElement&&t.classList.remove("next-loading"),this.logger.debug(`Hiding loading state for section: ${e}`)}updateProgress(e){const t=this.form.querySelector(".next-progress-bar");if(t instanceof HTMLElement){const i=t.querySelector(".next-progress-fill");if(i instanceof HTMLElement){const t=Math.min(100,Math.max(0,25*e));i.style.width=`${t}%`,i.setAttribute("aria-valuenow",t.toString())}}this.logger.debug(`Updated progress to step: ${e}`)}displayErrors(e,t){this.errorManager.clearAllErrors(this.form);const i={};Object.entries(e).forEach(([e,t])=>{if("cc-number"===e||"cvv"===e){const t="cc-number"===e?"spreedly-number":"spreedly-cvv",i=document.getElementById(t);if(i&&i.classList.contains("no-error"))return}i[e]=t}),Object.entries(i).forEach(([e,t])=>{let i=this.fields.get(e);!i&&e.startsWith("billing-")&&this.billingFields&&(i=this.billingFields.get(e)),i?this.errorManager.showFieldError(i,t):this.logger.warn(`Field element not found for error: ${e}`)}),t&&this.focusFirstError(t)}focusFirstError(e){let t=this.fields.get(e);if(!t&&e.startsWith("billing-")&&this.billingFields&&(t=this.billingFields.get(e)),!t)return void this.logger.warn(`Field '${e}' not found for scrolling`);const i=(t.closest(".frm-flds")||t).getBoundingClientRect().top+window.scrollY-100;window.scrollTo({top:Math.max(0,i),behavior:"smooth"}),(t instanceof HTMLInputElement||t instanceof HTMLSelectElement||t instanceof HTMLTextAreaElement)&&setTimeout(()=>{try{t.focus(),t.style.outline="2px solid #ff6b6b",t.style.outlineOffset="2px",setTimeout(()=>{t.style.outline="",t.style.outlineOffset=""},2e3)}catch(e){this.logger.debug("Could not focus field after scroll:",e)}},300),this.logger.debug(`Scrolled to field: ${e}`)}updateFieldState(e,t){let i=this.fields.get(e);if(!i&&e.startsWith("billing-")&&this.billingFields&&(i=this.billingFields.get(e)),i){switch(i.classList.remove("next-error-field","next-valid-field","next-neutral-field"),t){case"valid":i.classList.add("next-valid-field");break;case"invalid":i.classList.add("next-error-field");break;case"neutral":i.classList.add("next-neutral-field")}this.logger.debug(`Updated field ${e} state to: ${t}`)}else this.logger.warn(`Field '${e}' not found for state update`)}handleCheckoutUpdate(e,t){const i=JSON.stringify(e.errors||{});i!==this.lastErrorsString&&(this.lastErrorsString=i,e.errors&&Object.keys(e.errors).length>0?t(e.errors):t({})),e.isProcessing?this.showLoading("checkout"):this.hideLoading("checkout")}handleCartUpdate(e){e.isEmpty&&this.logger.warn("Cart is empty, redirecting to cart page")}updatePaymentFormVisibility(e){this.logger.debug("Updating payment form visibility for method:",e);this.form.querySelectorAll("[data-next-payment-method]").forEach(t=>{if(t instanceof HTMLElement){const i=t.querySelector('input[type="radio"]'),n=t.querySelector("[data-next-payment-form]");if(!(i instanceof HTMLInputElement&&n instanceof HTMLElement))return;if(i&&n){const a=i.value===e;this.logger.debug(`Payment method ${i.value}: ${a?"selected":"not selected"}`),a?(t.classList.add("next-selected"),n.setAttribute("data-next-payment-state","expanded"),this.expandPaymentForm(n),this.clearPaymentFormErrors(n)):(t.classList.remove("next-selected"),n.setAttribute("data-next-payment-state","collapsed"),this.collapsePaymentForm(n),this.clearPaymentFormErrors(n))}}})}expandPaymentForm(e){if(e.classList.contains("payment-method__form--expanded"))return;e.classList.remove("payment-method__form--collapsed"),e.classList.add("payment-method__form--expanded");const t=e.offsetHeight,i=e.style.overflow;e.style.overflow="hidden",e.style.height="auto";const n=e.scrollHeight;e.style.height=t+"px",e.offsetHeight,e.style.height=n+"px",setTimeout(()=>{e.style.height="",e.style.overflow=i},300),this.logger.debug("Expanded payment form")}collapsePaymentForm(e){if(e.classList.contains("payment-method__form--collapsed"))return;const t=e.scrollHeight;e.style.overflow="hidden",e.style.height=t+"px",e.offsetHeight,e.style.height="0px",setTimeout(()=>{e.classList.add("payment-method__form--collapsed"),e.classList.remove("payment-method__form--expanded")},300),this.logger.debug("Collapsed payment form")}clearPaymentFormErrors(e){this.errorManager.clearAllErrors(e);e.querySelectorAll("input, select, textarea").forEach(e=>{e.classList.add("no-error")}),this.logger.debug("Cleared payment form errors")}initializeFloatingLabels(){this.logger.debug("Initializing floating labels");this.form.querySelectorAll(".form-group").forEach(e=>{const t=e.querySelector(".label-checkout"),i=e.querySelector("input[data-next-checkout-field], input[os-checkout-field], select[data-next-checkout-field], select[os-checkout-field]");t instanceof HTMLLabelElement&&(i instanceof HTMLInputElement||i instanceof HTMLSelectElement)&&this.setupFloatingLabel(i,t)}),this.logger.debug(`Initialized ${this.floatingLabels.size} floating labels`),this.startPeriodicCheck()}setupFloatingLabel(e,t){if(!t){const i=e.closest(".form-group");if(i){const e=i.querySelector(".label-checkout");e instanceof HTMLLabelElement&&(t=e)}}t?(this.floatingLabels.set(e,t),this.setupLabelStyles(t),this.setupFieldStyles(e),this.updateLabelState(e,t),this.eventManager.addHandler(e,"input",e=>this.handleInput(e)),this.eventManager.addHandler(e,"focus",e=>this.handleFocus(e)),this.eventManager.addHandler(e,"blur",e=>this.handleBlur(e)),this.eventManager.addHandler(e,"change",e=>this.handleInput(e)),this.eventManager.addHandler(e,"animationstart",e=>this.handleAutofill(e)),this.logger.debug("Set up floating label for field:",e.getAttribute("data-next-checkout-field")||e.name)):this.logger.warn("No label found for floating label setup")}setupLabelStyles(e){e.style.transition||(e.style.transition="all 0.15s ease-in-out")}setupFieldStyles(e){const t=e.closest(".form-input");t instanceof HTMLElement&&(t.style.position="relative")}handleInput(e){const t=e.target,i=this.floatingLabels.get(t);i&&this.updateLabelState(t,i)}handleFocus(e){const t=e.target,i=this.floatingLabels.get(t);i&&this.hasValue(t)&&this.floatLabelUp(i,t)}handleBlur(e){const t=e.target,i=this.floatingLabels.get(t);i&&this.updateLabelState(t,i)}handleAutofill(e){if("autofill"===e.animationName){const t=e.target,i=this.floatingLabels.get(t);i&&setTimeout(()=>{this.updateLabelState(t,i)},100)}}updateLabelState(e,t){this.hasValue(e)?this.floatLabelUp(t,e):this.floatLabelDown(t,e)}hasValue(e){return e instanceof HTMLSelectElement?""!==e.value&&e.value!==e.querySelector("option")?.value:""!==e.value.trim()}floatLabelUp(e,t){e.classList.contains("has-value")||(e.classList.add("has-value"),t.style.paddingTop="14px",this.logger.debug("Added has-value class for field:",t.getAttribute("data-next-checkout-field")||t.name))}floatLabelDown(e,t){e.classList.contains("has-value")&&(e.classList.remove("has-value"),t.style.paddingTop="",this.logger.debug("Removed has-value class for field:",t.getAttribute("data-next-checkout-field")||t.name))}startPeriodicCheck(){this.periodicCheckInterval=window.setInterval(()=>{this.checkAllFieldsForChanges()},500)}checkAllFieldsForChanges(){this.floatingLabels.forEach((e,t)=>{(t instanceof HTMLInputElement||t instanceof HTMLSelectElement)&&this.updateLabelState(t,e)})}updateLabelsForPopulatedData(){this.floatingLabels.forEach((e,t)=>{(t instanceof HTMLInputElement||t instanceof HTMLSelectElement)&&this.updateLabelState(t,e)}),this.logger.debug("Updated all floating labels for populated data")}handleResponsiveUI(){const e=window.innerWidth<=768,t=window.innerWidth<=1024&&window.innerWidth>768;this.form.classList.toggle("next-mobile",e),this.form.classList.toggle("next-tablet",t),this.form.classList.toggle("next-desktop",!e&&!t),e&&this.floatingLabels.forEach((e,t)=>{t.addEventListener("focus",()=>{this.floatLabelUp(e,t)})}),this.logger.debug("Handled responsive UI adjustments for "+(e?"mobile":t?"tablet":"desktop"))}enhanceAccessibility(){this.fields.forEach((e,t)=>{if(e instanceof HTMLInputElement||e instanceof HTMLSelectElement){const i=e.parentElement?.querySelector(".next-error-label");if(i){const n=`${t}-error`;i.id=n,e.setAttribute("aria-describedby",n),e.setAttribute("aria-invalid","true")}else e.removeAttribute("aria-describedby"),e.setAttribute("aria-invalid","false");(e.hasAttribute("required")||"true"===e.getAttribute("data-required"))&&e.setAttribute("aria-required","true")}}),this.logger.debug("Enhanced accessibility features")}destroy(){this.periodicCheckInterval&&(clearInterval(this.periodicCheckInterval),delete this.periodicCheckInterval),this.eventManager.removeAllHandlers(),this.floatingLabels.clear(),this.loadingStates.clear(),this.logger.debug("UIService destroyed")}}class ri extends pt{constructor(){super(...arguments),this.config={autoCreate:!0,triggerOn:"emailEntry",emailField:"email",includeUtmData:!0,sessionTimeout:30},this.hasTriggered=!1,this.updateTimeout=0}async initialize(){this.validateElement(),this.logger.info("Initializing ProspectCartEnhancer",{element:this.element.tagName,config:this.config});const e=oe.getState();this.apiClient=new ce(e.apiKey),this.loadConfig(),this.findEmailField(),this.subscribe(Q,this.handleCartUpdate.bind(this)),this.setupTriggers(),this.checkExistingProspectCart(),this.logger.debug("ProspectCartEnhancer initialized",{emailFieldFound:!!this.emailField,triggerOn:this.config.triggerOn,autoCreate:this.config.autoCreate})}update(e){e?.config&&(this.config={...this.config,...e.config},this.setupTriggers())}loadConfig(){const e=this.getAttribute("data-prospect-config");if(e)try{const t=JSON.parse(e);this.config={...this.config,...t}}catch(t){this.logger.warn("Invalid prospect config JSON:",t)}if(this.hasAttribute("data-auto-create")&&(this.config.autoCreate="false"!==this.getAttribute("data-auto-create")),this.hasAttribute("data-trigger-on")){const e=this.getAttribute("data-trigger-on");!e||"formStart"!==e&&"emailEntry"!==e&&"manual"!==e||(this.config.triggerOn=e)}if(this.hasAttribute("data-email-field")){const e=this.getAttribute("data-email-field");e&&(this.config.emailField=e)}}findEmailField(){const e=['[data-next-checkout-field="email"]','[os-checkout-field="email"]',`input[name="${this.config.emailField}"]`,'input[type="email"]','input[data-field="email"]','input[name*="email"]'];for(const t of e){const e=this.element.querySelector(t);if(e){this.emailField=e,this.logger.debug("Found email field with selector:",t);break}}this.emailField||this.logger.warn("Email field not found for prospect cart")}setupTriggers(){if(this.config.autoCreate)switch(this.config.triggerOn){case"formStart":this.setupFormStartTrigger();break;case"emailEntry":this.setupEmailEntryTrigger()}}setupFormStartTrigger(){this.element.querySelectorAll("input, select, textarea").forEach(e=>{const t=()=>{this.hasTriggered||(this.createProspectCart(),this.hasTriggered=!0)};e.addEventListener("focus",t,{once:!0}),e.addEventListener("input",t,{once:!0})})}setupEmailEntryTrigger(){if(!this.emailField)return void this.logger.warn("Cannot setup email entry trigger - email field not found");let e;this.logger.debug("Setting up email entry trigger on field:",this.emailField),this.emailField.addEventListener("blur",()=>{this.logger.debug("Email blur event triggered, value:",this.emailField.value),!this.hasTriggered&&this.isValidEmail(this.emailField.value)&&(this.logger.info("Valid email detected, creating prospect cart"),this.createProspectCart(),this.hasTriggered=!0)}),this.emailField.addEventListener("input",()=>{clearTimeout(e),e=window.setTimeout(()=>{!this.hasTriggered&&this.isValidEmail(this.emailField.value)&&(this.createProspectCart(),this.hasTriggered=!0)},2e3)})}checkExistingProspectCart(){const e=sessionStorage.getItem("next_prospect_cart");if(e)try{const t=JSON.parse(e);new Date(t.expires_at)>new Date?(this.prospectCart=t,this.logger.debug("Restored existing prospect cart:",t.id)):sessionStorage.removeItem("next_prospect_cart")}catch(t){this.logger.warn("Failed to parse stored prospect cart:",t),sessionStorage.removeItem("next_prospect_cart")}}async createProspectCart(){if(this.prospectCart)this.logger.debug("Prospect cart already exists");else{this.logger.info("Starting prospect cart creation");try{const e=Q.getState(),t=this.emailField?.value||"";if(this.logger.debug("Cart state:",{isEmpty:e.isEmpty,itemCount:e.items.length,items:e.items,email:t}),e.isEmpty||0===e.items.length)return void this.logger.warn("No items in cart, skipping prospect cart creation");const i=this.element.querySelector('[data-next-checkout-field="fname"], [os-checkout-field="fname"], input[name="first_name"]')?.value||"",n=this.element.querySelector('[data-next-checkout-field="lname"], [os-checkout-field="lname"], input[name="last_name"]')?.value||"",a=this.config.includeUtmData?{...this.collectUtmData(),...e.attribution}:e.attribution||{},s={first_name:i,last_name:n,language:"en",accepts_marketing:!1};t&&(s.email=t);const r={lines:e.items.map(e=>({package_id:e.packageId,quantity:e.quantity,is_upsell:e.is_upsell||!1})),user:s};Object.keys(a).length>0&&(r.attribution=a);const o=await this.apiClient.createCart(r);this.prospectCart={id:o.checkout_url,prospect_id:o.checkout_url,created_at:(new Date).toISOString(),expires_at:new Date(Date.now()+60*(this.config.sessionTimeout||30)*1e3).toISOString(),utm_data:this.collectUtmData(),cart_data:o},t&&(this.prospectCart.email=t),sessionStorage.setItem("next_prospect_cart",JSON.stringify(this.prospectCart)),this.emitProspectEvent("cart-created",{cart:o,prospectCart:this.prospectCart}),this.logger.info("Prospect cart created with checkout URL:",o.checkout_url)}catch(e){this.logger.error("Failed to create prospect cart:",e)}}}async updateProspectCart(){this.prospectCart&&this.logger.debug("Prospect cart update skipped - using standard cart API")}collectUtmData(){const e=new URLSearchParams(window.location.search),t={};["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(i=>{const n=e.get(i);n&&(t[i]=n)});const i=sessionStorage.getItem("next_utm_data");if(i)try{const e=JSON.parse(i);Object.assign(t,e)}catch(n){this.logger.warn("Failed to parse stored UTM data:",n)}return Object.keys(t).length>0&&sessionStorage.setItem("next_utm_data",JSON.stringify(t)),t}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}handleCartUpdate(e){this.prospectCart&&!e.isEmpty&&(clearTimeout(this.updateTimeout),this.updateTimeout=window.setTimeout(()=>{this.updateProspectCart()},1e3))}emitProspectEvent(e,t){const i=new CustomEvent(`next:prospect-${e}`,{detail:t,bubbles:!0});this.element.dispatchEvent(i)}async createCartManually(){return await this.createProspectCart(),this.prospectCart||null}getCurrentProspectCart(){return this.prospectCart||null}async abandonCart(){this.prospectCart&&(this.emitProspectEvent("cart-abandoned",{prospectCart:this.prospectCart}),sessionStorage.removeItem("next_prospect_cart"),this.prospectCart=void 0,this.logger.info("Prospect cart marked as abandoned"))}async convertCart(){this.prospectCart&&(this.emitProspectEvent("cart-converted",{prospectCart:this.prospectCart}),sessionStorage.removeItem("next_prospect_cart"),this.prospectCart=void 0,this.logger.info("Prospect cart converted to order"))}updateEmail(e){this.emailField&&(this.emailField.value=e),!this.hasTriggered&&this.isValidEmail(e)?(this.createProspectCart(),this.hasTriggered=!0):this.prospectCart&&this.updateProspectCart()}}const oi={"credit-card":"card_token",card_token:"card_token",paypal:"paypal",apple_pay:"apple_pay",google_pay:"google_pay"},li={paypal:"paypal","apple-pay":"apple_pay","google-pay":"google_pay"};class ci{constructor(e,t,i,n,a){this.logger=e,this.showLoadingCallback=t,this.hideLoadingCallback=i,this.emitCallback=n,this.orderManager=a}async handleExpressCheckout(e,t,i,n){let a=!1;try{if(this.showLoadingCallback(),i)return this.logger.warn("Cannot checkout with empty cart"),this.emitCallback("express-checkout:error",{method:e,error:"Cart is empty"}),void(a=!0);const n=li[e]||e;this.emitCallback("express-checkout:started",{method:n,itemCount:t.length}),this.logger.info(`Express checkout initiated with ${e}`);const s=await this.orderManager.createExpressOrder(t,n);this.emitCallback("express-checkout:completed",{method:n,order:s}),this.orderManager.handleOrderRedirect(s)}catch(s){if(a=!0,this.logger.error("Express checkout failed:",s),s.responseData){const t=s.responseData;"paypal"===e&&t.payment_details?this.displayPayPalError(t.payment_details):"apple_pay"!==e&&"google_pay"!==e||!t.payment_details||this.displayExpressPaymentError(e,t.payment_details)}throw this.emitCallback("express-checkout:failed",{method:e,error:s instanceof Error?s.message:"Unknown error"}),s}finally{this.hideLoadingCallback(a)}}displayPayPalError(e){const t=document.querySelector('[data-next-component="paypal-error"]'),i=document.querySelector('[data-next-component="paypal-error-text"]');t instanceof HTMLElement&&i&&(i.textContent=e+" Please try a different payment method.",t.style.display="flex",this.logger.info("PayPal error displayed:",e)),this.displayGeneralPaymentError(e)}displayExpressPaymentError(e,t){const i=`${"apple_pay"===e?"Apple Pay":"Google Pay"} error: ${t}. Please try a different payment method.`;this.displayGeneralPaymentError(i)}displayGeneralPaymentError(e){const t=document.querySelector('[data-next-component="credit-error"]'),i=document.querySelector('[data-next-component="credit-error-text"]');t instanceof HTMLElement&&i&&(i.textContent=e,t.style.display="flex")}}function di(){const e=document.querySelector('meta[name="next-success-url"]')||document.querySelector('meta[name="next-next-url"]')||document.querySelector('meta[name="os-next-page"]');return e?.content?e.content.startsWith("/")?window.location.origin+e.content:e.content:window.location.origin+"/success"}function ui(){const e=document.querySelector('meta[name="next-failure-url"]')||document.querySelector('meta[name="os-failure-url"]');if(e?.content)return e.content.startsWith("/")?window.location.origin+e.content:e.content;const t=new URL(window.location.href);return t.searchParams.set("payment_failed","true"),t.href}class pi{buildOrder(e,t,i,n,a,s=!0,r,o=[]){const l={first_name:e.fname||"",last_name:e.lname||"",line1:e.address1||"",line2:e.address2,line4:e.city||"",state:e.province,postcode:e.postal,country:e.country||"",phone_number:e.phone};let c;!s&&a&&(c={first_name:a.first_name||"",last_name:a.last_name||"",line1:a.address1||"",line4:a.city||"",country:a.country||"",...a.address2&&{line2:a.address2},...a.province&&{state:a.province},...a.postal&&{postcode:a.postal},...a.phone&&{phone_number:a.phone}});const d={payment_method:this.mapPaymentMethod(i),...n&&{card_token:n}},u=he.getState().getAttributionForApi();return{lines:t.map(e=>({package_id:e.packageId,quantity:e.quantity,is_upsell:!1})),shipping_address:l,...c&&{billing_address:c},billing_same_as_shipping_address:s,shipping_method:r?.id||1,payment_detail:d,user:{email:e.email,first_name:e.fname||"",last_name:e.lname||"",language:"en",phone_number:e.phone,accepts_marketing:e.accepts_marketing||!1},vouchers:o,attribution:u,success_url:di(),payment_failed_url:ui()}}buildExpressOrder(e,t){return{lines:e.map(e=>({package_id:e.packageId,quantity:e.quantity,is_upsell:!1})),payment_detail:{payment_method:t},shipping_method:1,success_url:di(),payment_failed_url:ui()}}buildTestOrder(e){return{lines:e.length>0?e.map(e=>({package_id:e.packageId,quantity:e.quantity,is_upsell:!1})):[{package_id:1,quantity:1,is_upsell:!1}],shipping_address:{first_name:"Test",last_name:"Order",line1:"Test Address 123",line2:"",line4:"Tempe",state:"AZ",postcode:"85281",country:"US",phone_number:"+14807581224"},billing_same_as_shipping_address:!0,shipping_method:1,payment_detail:{payment_method:"card_token",card_token:"test_card"},user:{email:"test@test.com",first_name:"Test",last_name:"Order",language:"en",phone_number:"+14807581224",accepts_marketing:!1},vouchers:[],attribution:this.getTestAttribution(),success_url:di(),payment_failed_url:ui()}}mapPaymentMethod(e){return oi[e]||"card_token"}getTestAttribution(){const e=he.getState().getAttributionForApi();return{...e,utm_source:"konami_code",utm_medium:"test",utm_campaign:"debug_test_order",utm_content:"test_mode",metadata:{...e.metadata,test_order:!0,test_timestamp:Date.now()}}}}function hi(e,t,i){let n;if(e.payment_complete_url)t.debug(`Using payment_complete_url from API: ${e.payment_complete_url}`),n=e.payment_complete_url;else{const i=function(e){const t=document.querySelector('meta[name="next-success-url"]')||document.querySelector('meta[name="next-next-url"]')||document.querySelector('meta[name="os-next-page"]');if(!t?.content)return null;const i=t.content,n=i.startsWith("http")?new URL(i):new URL(i,window.location.origin);return e&&n.searchParams.append("ref_id",e),n.href}(e.ref_id);i?(t.debug(`Using success URL from meta tag: ${i}`),n=i):e.order_status_url?(t.debug(`Using order_status_url from API: ${e.order_status_url}`),n=e.order_status_url):(t.warn("No order_status_url found in API response - using fallback URL"),n=`${window.location.origin}/checkout/confirmation/?ref_id=${e.ref_id||""}`)}if(n){const e=Nt(n);t.info("Redirecting to:",e),window.location.href=e}else t.error("No redirect URL could be determined"),i("order:redirect-missing",{order:e})}class gi{constructor(e,t,i){this.apiClient=e,this.logger=t,this.emitCallback=i,this.orderBuilder=new pi}async createOrder(e,t,i,n,a,s=!0,r,o=[]){try{if(!e.email||!e.fname||!e.lname)throw new Error("Missing required customer information");if(0===t.length)throw new Error("Cannot create order with empty cart");if(("credit-card"===i||"card_token"===i)&&!n)throw new Error("Payment token is required for credit card payments");const l=this.orderBuilder.buildOrder(e,t,i,n,a,s,r,o);this.logger.debug("Creating order with data:",{...l,payment_detail:{...l.payment_detail,card_token:l.payment_detail.card_token?"MASKED":void 0}});const c=await this.apiClient.createOrder(l);if(!c.ref_id)throw new Error("Invalid order response: missing ref_id");return this.logger.info("Order created successfully",{ref_id:c.ref_id,number:c.number,total:c.total_incl_tax,payment_method:i}),c}catch(l){if(this.logger.error("Failed to create order:",l),400===l.status&&l.responseData){const e=l.responseData;if(e.payment_details||e.payment_response_code){this.emitCallback("payment:error",{message:e.payment_details||"Payment failed",code:e.payment_response_code,details:e});let t="Payment failed: ";throw e.payment_details?t+=e.payment_details:t+="Please check your payment information and try again.",new Error(t)}}if(l instanceof Error){if(l.message.includes("Rate limited"))throw new Error("Too many requests. Please wait a moment and try again.");if(l.message.includes("401")||l.message.includes("403"))throw new Error("Authentication error. Please refresh the page and try again.");if(l.message.includes("400"))throw new Error("Invalid order data. Please check your information and try again.");if(l.message.includes("500"))throw new Error("Server error. Please try again in a few moments.")}throw l}}async createExpressOrder(e,t){this.logger.info("createExpressOrder called with:",{paymentMethod:t,itemCount:e.length});try{if(0===e.length)throw new Error("Cannot create express order with empty cart");const i=this.orderBuilder.buildExpressOrder(e,t);this.logger.debug("Creating express order with minimal data:",i),this.logger.info("Express order data built");const n=await this.apiClient.createOrder(i);return this.logger.info("Express order created:",{ref_id:n.ref_id,has_order_status_url:!!n.order_status_url,has_payment_complete_url:!!n.payment_complete_url}),n}catch(i){throw this.logger.error("Failed to create express order:",i),i}}async createTestOrder(e){try{const t=this.orderBuilder.buildTestOrder(e);this.logger.debug("Creating test order with data:",t);return await this.apiClient.createOrder(t)}catch(t){throw this.logger.error("Failed to create test order:",t),t}}handleOrderRedirect(e){this.logger.info("handleOrderRedirect called with order:",{ref_id:e.ref_id,has_order_status_url:!!e.order_status_url,has_payment_complete_url:!!e.payment_complete_url});try{if(!e.ref_id)return this.logger.error("Cannot redirect: order missing ref_id"),void this.emitCallback("order:redirect-missing",{order:e});hi(e,this.logger,this.emitCallback)}catch(t){this.logger.error("Error handling order redirect:",t),this.emitCallback("order:redirect-missing",{order:e})}}async handleTokenizedPayment(e,t,i){try{if(!e)throw new Error("Payment token is required");this.logger.debug("Handling tokenized payment",{token:e.substring(0,8)+"...",pmData:t?"present":"missing"});const n=await i();this.emitCallback("order:completed",n),this.handleOrderRedirect(n)}catch(n){throw this.logger.error("Failed to process tokenized payment:",n),n}}async getOrderStatus(e){try{return await this.apiClient.getOrder(e)}catch(t){throw this.logger.error("Failed to get order status:",t),t}}}const mi=["[data-next-checkout-field]","[os-checkout-field]"],fi='[os-checkout-element="different-billing-address"], [data-next-component="different-billing-address"]',yi={credit:"credit-card",paypal:"paypal","apple-pay":"apple_pay","google-pay":"google_pay"},vi={"credit-card":"card_token",card_token:"card_token",paypal:"paypal",apple_pay:"apple_pay",google_pay:"google_pay"},bi={fname:"first_name",lname:"last_name",address1:"address1",address2:"address2",city:"city",province:"province",postal:"postal",country:"country",phone:"phone"};const xi=Object.freeze(Object.defineProperty({__proto__:null,CheckoutFormEnhancer:class extends pt{constructor(e){super(e),this.fields=new Map,this.billingFields=new Map,this.paymentButtons=new Map,this.countries=[],this.countryConfigs=new Map,this.detectedCountryCode="US",this.phoneInputs=new Map,this.isIntlTelInputAvailable=!1,this.googleMapsLoaded=!1,this.googleMapsLoading=!1,this.googleMapsLoadPromise=null,this.autocompleteInstances=new Map,this.enableAutocomplete=!0,this.locationElements=null,this.locationFieldsShown=!1,this.loadingOverlay=new Ht}async initialize(){if(this.validateElement(),!(this.element instanceof HTMLFormElement))throw new Error("CheckoutFormEnhancer must be applied to a form element");this.form=this.element,this.form.noValidate=!0,this.loadingOverlay=new Ht;const e=oe.getState();this.apiClient=new ce(e.apiKey),this.countryService=Zt.getInstance(),this.orderManager=new gi(this.apiClient,this.logger,(e,t)=>this.emit(e,t)),this.expressProcessor=new ci(this.logger,()=>this.loadingOverlay.show(),e=>this.loadingOverlay.hide(e),(e,t)=>this.emit(e,t),this.orderManager),this.isIntlTelInputAvailable=!!window.intlTelInput&&!!window.intlTelInputUtils,this.validator=new ni(this.logger,this.countryService,void 0),this.scanAllFields();this.setupBillingForm()&&this.scanBillingFields(),this.ui=new si(this.form,this.fields,this.logger,this.billingFields),this.ui.initialize(),e.spreedlyEnvironmentKey&&await this.initializeCreditCard(e.spreedlyEnvironmentKey,e.debug),await this.initializeAddressManagement(e),this.initializePhoneInputs(),await this.initializeAddressAutocomplete(),this.validator.setPhoneValidator((e,t="shipping")=>{if(!this.isIntlTelInputAvailable)return/^[\d\s\-\+\(\)]+$/.test(e);const i=this.phoneInputs.get(t);return i?i.isValidNumber():/^[\d\s\-\+\(\)]+$/.test(e)}),this.populateExpirationFields(),this.setupEventHandlers(),this.subscribe(te,this.handleCheckoutUpdate.bind(this)),this.subscribe(Q,this.handleCartUpdate.bind(this)),this.subscribe(oe,this.handleConfigUpdate.bind(this)),this.boundHandleTestDataFilled=this.handleTestDataFilled.bind(this),this.boundHandleKonamiActivation=this.handleKonamiActivation.bind(this),document.addEventListener("checkout:test-data-filled",this.boundHandleTestDataFilled),document.addEventListener("next:test-mode-activated",this.boundHandleKonamiActivation),this.populateFormData(),this.initializeLocationFieldVisibility(),await this.initializeProspectCart(),this.eventBus.on("payment:error",e=>{e.message&&this.displayPaymentError(e.message)}),window.addEventListener("pageshow",t=>{if(t.persisted||"back_forward"===performance.getEntriesByType("navigation")[0]?.type){this.logger.info("Page restored from bfcache, resetting express checkout state"),this.loadingOverlay.hide(!0);const t=te.getState();t.isProcessing&&(this.logger.info("Resetting processing state after bfcache restore"),t.setProcessing(!1)),"apple_pay"!==t.paymentMethod&&"google_pay"!==t.paymentMethod&&"paypal"!==t.paymentMethod||(this.logger.info("Resetting payment method from",t.paymentMethod,"to credit-card"),t.setPaymentMethod("credit-card"),t.setPaymentToken("")),this.creditCardService&&e.spreedlyEnvironmentKey&&(this.logger.info("Re-initializing credit card service after bfcache restore"),this.creditCardService.initialize().catch(e=>{this.logger.error("Failed to re-initialize credit card service:",e)})),this.handlePurchaseEvent()}}),this.handlePurchaseEvent(),this.logger.debug("CheckoutFormEnhancer initialized"),this.emit("checkout:form-initialized",{form:this.form})}scanAllFields(){mi.forEach(e=>{this.form.querySelectorAll(e).forEach(t=>{const i=t.getAttribute(e.includes("data-next")?"data-next-checkout-field":"os-checkout-field");i&&t instanceof HTMLElement&&this.fields.set(i,t)})});const e=this.form.querySelector('button[type="submit"]')||this.form.querySelector("[data-next-checkout-submit]")||this.form.querySelector("[os-checkout-submit]");e instanceof HTMLButtonElement?(this.submitButton=e,this.logger.debug("Found submit button:",e)):this.logger.warn("Submit button not found in checkout form");["[data-next-checkout-payment]","[os-checkout-payment]"].forEach(e=>{document.querySelectorAll(e).forEach(t=>{const i=t.getAttribute(e.includes("data-next")?"data-next-checkout-payment":"os-checkout-payment");i&&t instanceof HTMLElement&&this.paymentButtons.set(i,t)})}),this.scanExpirationFields()}scanBillingFields(){['[os-checkout-field^="billing-"]','[data-next-checkout-field^="billing-"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{const t=e.getAttribute("os-checkout-field")||e.getAttribute("data-next-checkout-field");t&&e instanceof HTMLElement&&this.billingFields.set(t,e)})})}scanExpirationFields(){const e=['[data-next-checkout-field="cc-month"]','[data-next-checkout-field="exp-month"]','[os-checkout-field="cc-month"]','[os-checkout-field="exp-month"]',"#credit_card_exp_month"].map(e=>document.querySelector(e)).find(e=>null!==e),t=['[data-next-checkout-field="cc-year"]','[data-next-checkout-field="exp-year"]','[os-checkout-field="cc-year"]','[os-checkout-field="exp-year"]',"#credit_card_exp_year"].map(e=>document.querySelector(e)).find(e=>null!==e);if(e){const t="exp-month"===e.getAttribute("data-next-checkout-field")||"exp-month"===e.getAttribute("os-checkout-field");t&&!this.fields.has("exp-month")?this.fields.set("exp-month",e):t||this.fields.has("cc-month")||this.fields.has("exp-month")||this.fields.set("cc-month",e)}if(t){const e="exp-year"===t.getAttribute("data-next-checkout-field")||"exp-year"===t.getAttribute("os-checkout-field");e&&!this.fields.has("exp-year")?this.fields.set("exp-year",t):e||this.fields.has("cc-year")||this.fields.has("exp-year")||this.fields.set("cc-year",t)}}populateExpirationFields(){const e=this.fields.get("cc-month")||this.fields.get("exp-month"),t=this.fields.get("cc-year")||this.fields.get("exp-year");if(e instanceof HTMLSelectElement){e.innerHTML='<option value="">Month</option>';for(let t=1;t<=12;t++){const i=t.toString().padStart(2,"0"),n=document.createElement("option");n.value=i,n.textContent=i,e.appendChild(n)}}if(t instanceof HTMLSelectElement){t.innerHTML='<option value="">Year</option>';const e=(new Date).getFullYear();for(let i=0;i<20;i++){const n=e+i,a=document.createElement("option");a.value=n.toString(),a.textContent=n.toString(),t.appendChild(a)}}}setupBillingForm(){const e=document.querySelector(fi);if(!e)return!1;const t=document.querySelector('[os-checkout-component="shipping-form"], [data-next-component="shipping-form"]');if(!t)return!1;const i=e.querySelector('[os-checkout-component="billing-form"], [data-next-component="billing-form"]');if(!i)return!1;const n=t.querySelectorAll('[data-next-component="shipping-field-row"]');return i.innerHTML="",n.forEach(e=>{const t=e.cloneNode(!0);this.convertShippingFieldsToBilling(t),i.appendChild(t)}),this.setInitialBillingFormState(),!0}convertShippingFieldsToBilling(e){e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(e=>{e.remove()}),e.querySelectorAll("[data-next-checkout-field]").forEach(e=>{const t=e.getAttribute("data-next-checkout-field");t&&!t.startsWith("billing-")&&e.setAttribute("data-next-checkout-field",`billing-${t}`)}),e.querySelectorAll("[os-checkout-field]").forEach(e=>{const t=e.getAttribute("os-checkout-field");t&&!t.startsWith("billing-")&&e.setAttribute("os-checkout-field",`billing-${t}`)}),e.querySelectorAll("input, select, textarea").forEach(e=>{const t=e;t.name&&!t.name.startsWith("billing_")&&(t.name=t.name.startsWith("shipping_")?t.name.replace("shipping_","billing_"):`billing_${t.name}`),t.id&&!t.id.startsWith("billing_")&&(t.id=t.id.startsWith("shipping_")?t.id.replace("shipping_","billing_"):`billing_${t.id}`),"checkbox"===t.type||"radio"===t.type?t.checked=!1:t.value=""})}setInitialBillingFormState(){const e=this.form.querySelector('input[name="use_shipping_address"]'),t=document.querySelector(fi);e&&t&&(e.checked?this.collapseBillingForm(t):this.expandBillingForm(t))}expandBillingForm(e){e.style.transition="none",e.style.height="auto";const t=e.offsetHeight;e.style.height="0",e.offsetHeight,e.style.transition="height 0.3s ease-in-out, padding 0.3s ease-in-out, margin-top 0.3s ease-in-out",e.style.height=`${t}px`,e.style.padding="20px 2px",e.style.marginTop="20px",e.style.overflow="visible",setTimeout(()=>{e.style.height="auto"},300),e.classList.add("billing-form-expanded"),e.classList.remove("billing-form-collapsed")}collapseBillingForm(e){const t=e.offsetHeight;e.style.height=`${t}px`,e.style.overflow="hidden",e.offsetHeight,e.style.transition="height 0.3s ease-in-out, padding 0.3s ease-in-out, margin-top 0.3s ease-in-out",e.style.height="0",e.style.padding="2px",e.style.marginTop="0",e.classList.add("billing-form-collapsed"),e.classList.remove("billing-form-expanded")}async loadGoogleMapsAPI(){const e=oe.getState().googleMapsConfig;if(!1!==e.enableAutocomplete)if(e.apiKey)if(this.googleMapsLoaded)this.logger.debug("Google Maps API already loaded");else{if(this.googleMapsLoading)return this.logger.debug("Google Maps API loading in progress, waiting..."),this.googleMapsLoadPromise;this.googleMapsLoading=!0,this.googleMapsLoadPromise=this.performGoogleMapsLoad(e);try{await this.googleMapsLoadPromise,this.googleMapsLoaded=!0,this.logger.info("Google Maps API loaded successfully")}catch(t){this.logger.error("Failed to load Google Maps API:",t)}finally{this.googleMapsLoading=!1}}else this.logger.warn("Google Maps API key not found. Autocomplete will be disabled.");else this.logger.debug("Google Maps Autocomplete is disabled in configuration")}async performGoogleMapsLoad(e){if(void 0===window.google||void 0===window.google.maps)return new Promise((t,i)=>{const n=document.createElement("script"),a=e.region?`&region=${e.region}`:"";n.src=`https://maps.googleapis.com/maps/api/js?key=${e.apiKey}&libraries=places${a}&loading=async`,n.async=!0,n.defer=!0,n.onload=async()=>{this.logger.debug("Google Maps API script loaded successfully");let e=0;for(;e<10;){if(void 0!==window.google&&void 0!==window.google.maps&&void 0!==window.google.maps.places&&void 0!==window.google.maps.places.Autocomplete)return this.logger.debug("Google Maps Places API fully initialized"),void t();e++,this.logger.debug(`Waiting for Google Maps API to initialize... (attempt ${e}/10)`),await new Promise(e=>setTimeout(e,100))}i(new Error("Google Maps API not fully available after script load"))},n.onerror=()=>{const e=new Error("Failed to load Google Maps API script");this.logger.error(e.message),i(e)};if(document.querySelector('script[src*="maps.googleapis.com"]')){if(this.logger.debug("Google Maps script already in DOM, waiting for load..."),void 0!==window.google&&void 0!==window.google.maps&&void 0!==window.google.maps.places&&void 0!==window.google.maps.places.Autocomplete)return void t();return void(async()=>{let e=0;for(;e<10;){if(void 0!==window.google&&void 0!==window.google.maps&&void 0!==window.google.maps.places&&void 0!==window.google.maps.places.Autocomplete)return this.logger.debug("Existing Google Maps script fully loaded"),void t();e++,await new Promise(e=>setTimeout(e,100))}i(new Error("Existing Google Maps script failed to fully initialize"))})()}document.head.appendChild(n)});this.logger.debug("Google Maps API already available")}isGoogleMapsLoaded(){return this.googleMapsLoaded&&void 0!==window.google&&void 0!==window.google.maps}isGoogleMapsPlacesAvailable(){return this.isGoogleMapsLoaded()&&void 0!==window.google.maps.places&&void 0!==window.google.maps.places.Autocomplete}async initializeAddressManagement(e){try{this.addClass("next-loading-countries"),e.addressConfig&&this.countryService.setConfig(e.addressConfig);const t=e.googleMapsConfig||{};this.enableAutocomplete=!1!==t.enableAutocomplete&&!!t.apiKey;const i=await this.countryService.getLocationData();this.countries=i.countries,this.detectedCountryCode=i.detectedCountryCode;const n=this.fields.get("country");if(n instanceof HTMLSelectElement&&(this.populateCountryDropdown(n,i.countries,i.detectedCountryCode),i.detectedCountryCode&&(this.updateFormData({country:i.detectedCountryCode}),this.clearError("country"))),this.countryConfigs.set(i.detectedCountryCode,i.detectedCountryConfig),i.detectedCountryCode){const e=this.fields.get("province");e instanceof HTMLSelectElement&&(await this.updateStateOptions(i.detectedCountryCode,e),this.currentCountryConfig=i.detectedCountryConfig),this.updateFormLabels(i.detectedCountryConfig)}this.billingFields.size>0&&this.populateBillingCountryDropdown()}catch(t){this.logger.error("Failed to load country data:",t)}finally{this.removeClass("next-loading-countries")}}populateCountryDropdown(e,t,i){const n=e.options[0];e.innerHTML="",n&&!n.value&&(n.disabled=!0,e.appendChild(n)),t.forEach(t=>{const n=document.createElement("option");n.value=t.code,n.textContent=t.name,t.code===i&&(n.selected=!0),e.appendChild(n)}),i&&e.dispatchEvent(new Event("change",{bubbles:!0}))}populateBillingCountryDropdown(){const e=this.billingFields.get("billing-country");if(!(e instanceof HTMLSelectElement))return;const t=e.options[0];e.innerHTML="",t&&!t.value&&(t.disabled=!0,e.appendChild(t)),this.countries.forEach(t=>{const i=document.createElement("option");i.value=t.code,i.textContent=t.name,e.appendChild(i)})}async updateStateOptions(e,t){t.disabled=!0;const i=t.innerHTML;t.innerHTML='<option value="">Loading...</option>';try{const i=await this.countryService.getCountryStates(e);this.countryConfigs.set(e,i.countryConfig),this.currentCountryConfig=i.countryConfig,this.updateFormLabels(i.countryConfig);const n=i.states&&i.states.length>0,a=i.countryConfig.stateRequired,s=t.closest(".frm-flds, .form-group, .form-field, .field-group")||t.parentElement;if(!a&&!n)return s&&(s.style.display="none"),t.removeAttribute("required"),this.updateFormData({province:""}),void this.clearError("province");s&&(s.style.display=""),t.innerHTML="";const r=document.createElement("option");if(r.value="",r.textContent=`Select ${i.countryConfig.stateLabel}`,r.disabled=!0,r.selected=!0,t.appendChild(r),i.states.forEach(e=>{const i=document.createElement("option");i.value=e.code,i.textContent=e.name,t.appendChild(i)}),i.countryConfig.stateRequired?t.setAttribute("required","required"):t.removeAttribute("required"),this.updateFormData({province:""}),this.clearError("province"),t.value="",i.states.length>0&&i.countryConfig.stateRequired){const e=i.states[0];e&&(t.value=e.code,this.updateFormData({province:e.code}),this.clearError("province"),t.dispatchEvent(new Event("change",{bubbles:!0})))}}catch(n){this.logger.error("Failed to load states:",n),t.innerHTML=i}finally{t.disabled=!1}}updateFormLabels(e){const t=this.form.querySelector('label[for*="province"], label[for*="state"]');if(t){const i=e.stateRequired?" *":"";t.textContent=e.stateLabel+i}const i=this.form.querySelector('label[for*="postal"], label[for*="zip"]');i&&(i.textContent=e.postcodeLabel+" *");const n=this.fields.get("postal");n instanceof HTMLInputElement&&(n.placeholder=e.postcodeLabel)}updateBillingFormLabels(e){const t=document.querySelector('[os-checkout-element="different-billing-address"]');if(!t)return;const i=t.querySelector('label[for*="billing"][for*="province"], label[for*="billing"][for*="state"]');if(i){const t=e.stateRequired?" *":"";i.textContent=`Billing ${e.stateLabel}${t}`}const n=t.querySelector('label[for*="billing"][for*="postal"], label[for*="billing"][for*="zip"]');n&&(n.textContent=`Billing ${e.postcodeLabel} *`);const a=this.billingFields.get("billing-postal");a instanceof HTMLInputElement&&(a.placeholder=`Billing ${e.postcodeLabel}`)}async initializeAddressAutocomplete(){if(this.enableAutocomplete)try{this.setupLazyAutocompleteLoading()}catch(e){this.logger.error("Failed to initialize autocomplete:",e)}else this.logger.debug("Google Maps autocomplete disabled, skipping initialization")}setupLazyAutocompleteLoading(){const e=this.fields.get("address1"),t=this.billingFields.get("billing-address1");let i=!1,n=!1;const a=async()=>{if(!n&&!i){i=!0,this.logger.info("User focused on address field, loading Google Maps API...");try{await this.initializeGoogleMapsAutocomplete(),n=!0,e&&e.removeEventListener("focus",a),t&&t.removeEventListener("focus",a)}catch(s){this.logger.error("Failed to load Google Maps on focus:",s)}finally{i=!1}}};e instanceof HTMLInputElement&&e.addEventListener("focus",a),t instanceof HTMLInputElement&&t.addEventListener("focus",a)}async initializeGoogleMapsAutocomplete(){try{if(await this.loadGoogleMapsAPI(),await new Promise(e=>setTimeout(e,100)),this.logger.debug("Google Maps status:",{google:void 0!==window.google,maps:void 0!==window.google?.maps,places:void 0!==window.google?.maps?.places,Autocomplete:void 0!==window.google?.maps?.places?.Autocomplete}),!this.isGoogleMapsPlacesAvailable())return void this.logger.warn("Google Places API not available, skipping autocomplete setup");this.logger.debug("Google Maps API loaded, setting up autocomplete"),this.setupAutocomplete()}catch(e){this.logger.warn("Failed to load Google Maps API:",e)}}setupAutocomplete(){const e=this.fields.get("address1"),t=this.billingFields.get("billing-address1"),i=this.detectedCountryCode||"US";e instanceof HTMLInputElement&&this.createAutocompleteInstance(e,"address1",i,"shipping"),t instanceof HTMLInputElement&&this.createAutocompleteInstance(t,"billing-address1",i,"billing"),this.setupAutocompleteCountryChangeListeners()}createAutocompleteInstance(e,t,i,n){try{const a="shipping"===n?this.fields.get("country"):this.billingFields.get("billing-country"),s=a instanceof HTMLSelectElement&&a.value?a.value:i,r={types:["address"],fields:["address_components","formatted_address"],componentRestrictions:{country:s}};if(!window.google?.maps?.places)return void this.logger.warn("Google Maps Places API not loaded, skipping autocomplete initialization");if(!window.google.maps.places.Autocomplete)return void this.logger.warn("Google Maps Autocomplete API not available");const o=new window.google.maps.places.Autocomplete(e,r);this.autocompleteInstances.set(t,o),this.logger.debug(`Autocomplete created for ${t}, restricted to: ${s}`),o.addListener("place_changed",async()=>{const e=o.getPlace();e&&e.address_components?await this.fillAddressFromAutocomplete(e,n):this.logger.debug("No valid place data returned from autocomplete")}),e.addEventListener("keydown",e=>{"Enter"===e.key&&e.preventDefault()})}catch(a){this.logger.error(`Failed to create autocomplete for ${t}:`,a)}}async fillAddressFromAutocomplete(e,t){if(!e.address_components)return;const i=this.parseAddressComponents(e.address_components);if(!i)return void this.logger.warn("Failed to parse address components");const n=i.country?.short,a="shipping"===t,s=a?"":"billing-",r=a?this.fields:this.billingFields,o=te.getState(),l=r.get(`${s}address1`);if(l instanceof HTMLInputElement){const e=i.street_number?.long||"",t=i.route?.long||"";let a="";"BR"===n&&t&&e?(a=`${t}, ${e}`,i.sublocality_level_1?a+=` - ${i.sublocality_level_1.long}`:i.sublocality&&(a+=` - ${i.sublocality.long}`)):a=[e,t].filter(Boolean).join(" "),l.value=a,l.dispatchEvent(new Event("change",{bubbles:!0}))}let c="",d="";if("BR"===n&&e.formatted_address&&(!i.administrative_area_level_2||!i.administrative_area_level_1)){const t=e.formatted_address.split(",");if(t.length>=3){const e=t[t.length-3]?.trim();if(e&&e.includes(" - ")){const[t,i]=e.split(" - ").map(e=>e.trim());c=t||"",d=i||""}}}const u=r.get(`${s}city`);if(u instanceof HTMLInputElement){let e="";"BR"===n?i.administrative_area_level_2?e=i.administrative_area_level_2.long:c&&(e=c):i.locality?e=i.locality.long:i.postal_town?e=i.postal_town.long:i.administrative_area_level_2?e=i.administrative_area_level_2.long:i.sublocality&&"BR"!==n?e=i.sublocality.long:i.sublocality_level_1&&"BR"!==n&&(e=i.sublocality_level_1.long),e?(u.value=e,u.dispatchEvent(new Event("change",{bubbles:!0})),this.logger.debug(`City set to: ${e} (type: ${i.locality?"locality":i.postal_town?"postal_town":i.sublocality?"sublocality":"sublocality_level_1"})`)):this.logger.warn("No suitable city component found in address")}const p=r.get(`${s}postal`);p instanceof HTMLInputElement&&i?.postal_code&&(p.value=i.postal_code.long,p.dispatchEvent(new Event("change",{bubbles:!0})));const h=r.get(`${s}country`);if(h instanceof HTMLSelectElement&&i?.country){const e=i.country.short;h.value!==e&&(h.value=e,h.dispatchEvent(new Event("change",{bubbles:!0})),this.logger.debug(`Country set to ${e}`));const t=r.get(`${s}province`);t instanceof HTMLSelectElement&&(i?.administrative_area_level_1?this.setStateWithRetry(t,i.administrative_area_level_1.short,s):"BR"===e&&d&&this.setStateWithRetry(t,d,s))}if(a){const e={};if(i.street_number||i.route){const t=i.street_number?.long||"",a=i.route?.long||"";let s="";"BR"===n&&a&&t?(s=`${a}, ${t}`,i.sublocality_level_1?s+=` - ${i.sublocality_level_1.long}`:i.sublocality&&(s+=` - ${i.sublocality.long}`)):s=[t,a].filter(Boolean).join(" "),e.address1=s}"BR"===n&&i.administrative_area_level_2?e.city=i.administrative_area_level_2.long:i.locality?e.city=i.locality.long:i.postal_town?e.city=i.postal_town.long:i.administrative_area_level_2?e.city=i.administrative_area_level_2.long:i.sublocality&&"BR"!==n?e.city=i.sublocality.long:i.sublocality_level_1&&(e.city=i.sublocality_level_1.long),i.postal_code&&(e.postal=i.postal_code.long),i.country&&(e.country=i.country.short),i.administrative_area_level_1&&(e.province=i.administrative_area_level_1.short),o.updateFormData(e)}else{const e={...o.billingAddress||{first_name:"",last_name:"",address1:"",city:"",province:"",postal:"",country:"",phone:""}};if(i.street_number||i.route){const t=i.street_number?.long||"",a=i.route?.long||"";let s="";"BR"===n&&a&&t?(s=`${a}, ${t}`,i.sublocality_level_1?s+=` - ${i.sublocality_level_1.long}`:i.sublocality&&(s+=` - ${i.sublocality.long}`)):s=[t,a].filter(Boolean).join(" "),e.address1=s}"BR"===n&&i.administrative_area_level_2?e.city=i.administrative_area_level_2.long:i.locality?e.city=i.locality.long:i.postal_town?e.city=i.postal_town.long:i.administrative_area_level_2?e.city=i.administrative_area_level_2.long:i.sublocality&&"BR"!==n?e.city=i.sublocality.long:i.sublocality_level_1&&(e.city=i.sublocality_level_1.long),i.postal_code&&(e.postal=i.postal_code.long),i.country&&(e.country=i.country.short),i.administrative_area_level_1&&(e.province=i.administrative_area_level_1.short),o.setBillingAddress(e)}this.emit("address:autocomplete-filled",{type:t,components:i})}parseAddressComponents(e){const t={};return e.forEach(e=>{e.types.forEach(i=>{"political"!==i&&(t[i]={long:e.long_name,short:e.short_name})})}),this.logger.debug("Parsed address components:",{availableTypes:Object.keys(t),cityRelatedComponents:{locality:t.locality?.long,postal_town:t.postal_town?.long,sublocality:t.sublocality?.long,sublocality_level_1:t.sublocality_level_1?.long},allComponents:t}),t}async setStateWithRetry(e,t,i,n=0){if(n>=5)return void this.logger.warn(`Failed to set state ${t} after 5 attempts`);await new Promise(e=>setTimeout(e,300*Math.pow(1.5,n)));Array.from(e.options).some(e=>e.value===t)?(e.value=t,e.dispatchEvent(new Event("change",{bubbles:!0})),this.logger.debug(`State set to ${t}`)):this.setStateWithRetry(e,t,i,n+1)}setupAutocompleteCountryChangeListeners(){const e=this.fields.get("country");e instanceof HTMLSelectElement&&e.addEventListener("change",()=>{const t=this.autocompleteInstances.get("address1"),i=e.value;t&&i&&2===i.length&&(t.setComponentRestrictions&&t.setComponentRestrictions({country:i}),this.logger.debug(`Shipping autocomplete restricted to: ${i}`))});const t=this.billingFields.get("billing-country");t instanceof HTMLSelectElement&&t.addEventListener("change",()=>{const e=this.autocompleteInstances.get("billing-address1"),i=t.value;e&&i&&2===i.length&&(e.setComponentRestrictions&&e.setComponentRestrictions({country:i}),this.logger.debug(`Billing autocomplete restricted to: ${i}`))})}initializeLocationFieldVisibility(){if(this.locationElements=this.form.querySelectorAll('[data-next-component="location"], [data-next-component-location="location"]'),!this.locationElements||0===this.locationElements.length)return void this.logger.debug("No location elements found");this.hideLocationFields();const e=this.fields.get("address1");e instanceof HTMLInputElement&&(e.addEventListener("input",this.handleAddressInput.bind(this)),e.addEventListener("change",this.handleAddressInput.bind(this)),e.addEventListener("blur",this.handleAddressInput.bind(this)),e.value&&e.value.trim().length>0&&this.showLocationFields()),this.eventBus.on("address:autocomplete-filled",e=>{"shipping"===e.type&&this.showLocationFields()});const t=te.getState();t.formData.address1&&t.formData.address1.trim().length>0&&this.showLocationFields(),this.logger.debug("Location field visibility initialized",{locationElementsCount:this.locationElements.length})}handleAddressInput(e){const t=e.target;t.value&&t.value.trim().length>0&&this.showLocationFields()}hideLocationFields(){this.locationElements&&(this.locationElements.forEach(e=>{e instanceof HTMLElement&&(e.style.display="none",e.classList.add("next-location-hidden"))}),this.locationFieldsShown=!1,this.logger.debug("Location fields hidden"))}showLocationFields(){!this.locationFieldsShown&&this.locationElements&&(this.locationElements.forEach(e=>{e instanceof HTMLElement&&(e.style.display="flex",e.classList.remove("next-location-hidden"))}),this.locationFieldsShown=!0,this.eventBus.emit("checkout:location-fields-shown",{}),this.form.dispatchEvent(new CustomEvent("checkout:location-fields-shown")),this.logger.debug("Location fields shown"))}async initializeProspectCart(){try{this.prospectCartEnhancer=new ri(this.form),await this.prospectCartEnhancer.initialize(),this.form.addEventListener("next:prospect-cart-created",e=>{const t=e;this.logger.info("Prospect cart created",t.detail)}),this.form.addEventListener("next:prospect-cart-abandoned",e=>{const t=e;this.logger.info("Prospect cart abandoned",t.detail)}),this.logger.debug("ProspectCartEnhancer initialized")}catch(e){this.logger.warn("Failed to initialize ProspectCartEnhancer:",e)}}initializePhoneInputs(){if(!this.isIntlTelInputAvailable)return;const e=this.fields.get("phone"),t=this.billingFields.get("billing-phone");e instanceof HTMLInputElement&&this.initializePhoneInput("shipping",e),t instanceof HTMLInputElement&&this.initializePhoneInput("billing",t)}initializePhoneInput(e,t){try{const i=this.phoneInputs.get(e);i&&i.destroy();const n="shipping"===e?"country":"billing-country",a="shipping"===e?this.fields.get(n):this.billingFields.get(n),s=a instanceof HTMLSelectElement&&a.value?a.value.toLowerCase():this.detectedCountryCode.toLowerCase(),r="true"===t.getAttribute("data-next-required")||t.hasAttribute("required");t.placeholder=r?"Phone*":"Phone (Optional)";const o=window.intlTelInput(t,{separateDialCode:!1,nationalMode:!0,autoPlaceholder:"off",utilsScript:"https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",preferredCountries:["us","ca","gb","au"],allowDropdown:!1,initialCountry:s,formatOnDisplay:!0});if(this.phoneInputs.set(e,o),t.addEventListener("input",()=>{if(o&&window.intlTelInputUtils){const i=t.value,n=o.getSelectedCountryData();if(i&&n.iso2){const e=window.intlTelInputUtils.formatNumber(i,n.iso2,window.intlTelInputUtils.numberFormat.NATIONAL);if(e!==i){const n=t.selectionStart||0,a=i.length,s=e.length;t.value=e;const r=n+(s-a);t.setSelectionRange(r,r)}}const a=o.getNumber();if("shipping"===e)this.updateFormData({phone:a});else{const e=te.getState(),t=e.billingAddress||{first_name:"",last_name:"",address1:"",city:"",province:"",postal:"",country:"",phone:""};e.setBillingAddress({...t,phone:a})}}}),t.addEventListener("blur",()=>{if(o&&window.intlTelInputUtils){const e=o.getSelectedCountryData(),i=t.value;if(i&&e.iso2){const n=window.intlTelInputUtils.formatNumber(i,e.iso2,window.intlTelInputUtils.numberFormat.NATIONAL);t.value=n}}}),a instanceof HTMLSelectElement){const e=()=>{const e=a.value;e&&o&&o.setCountry(e.toLowerCase())};a.addEventListener("change",e)}}catch(i){this.logger.error(`Failed to initialize ${e} phone field:`,i)}}async initializeCreditCard(e,t){try{this.addClass("next-loading-spreedly"),this.creditCardService=new Xt(e),this.creditCardService.setOnReady(()=>{this.removeClass("next-loading-spreedly"),this.emit("checkout:spreedly-ready",{}),this.logger.debug("[Spreedly] Credit card service ready")}),this.creditCardService.setOnError(e=>{if(this.logger.warn("[Spreedly] Credit card validation errors:",e),this.emit("payment:error",{errors:e}),e&&e.length>0){const t=e.map(e=>e.message||e).join(". ");this.displayPaymentError(t)}}),this.creditCardService.setOnToken((e,t)=>{this.logger.info("[Spreedly] Payment token received:",{token:e,pmData:t}),this.handleTokenizedPayment(e,t)}),await this.creditCardService.initialize(),this.validator.setCreditCardService(this.creditCardService)}catch(i){throw this.logger.error("Failed to initialize credit card service:",i),this.removeClass("next-loading-spreedly"),i}}clearAllCheckoutFields(){try{this.fields.forEach(e=>{e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement?"checkbox"===e.type||"radio"===e.type?e.checked=!1:e.value="":e instanceof HTMLSelectElement&&(e.selectedIndex=0)}),this.billingFields.forEach(e=>{e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement?"checkbox"===e.type||"radio"===e.type?e.checked=!1:e.value="":e instanceof HTMLSelectElement&&(e.selectedIndex=0)}),this.creditCardService&&"function"==typeof this.creditCardService.clearFields&&this.creditCardService.clearFields();const e=te.getState();e.reset(),e.clearAllErrors();const t=this.fields.get("country");t instanceof HTMLSelectElement&&this.detectedCountryCode&&(t.value=this.detectedCountryCode,t.dispatchEvent(new Event("change",{bubbles:!0})));const i=this.form.querySelector('input[name="use_shipping_address"]');i&&(i.checked=!0,i.dispatchEvent(new Event("change",{bubbles:!0}))),this.logger.info("All checkout fields cleared")}catch(e){this.logger.error("Error clearing checkout fields:",e)}}async handlePurchaseEvent(){const e=sessionStorage.getItem("next-order");if(e)try{const t=JSON.parse(e),i=t?.state?.order;if(!i?.ref_id||!i?.number)return;const n=sessionStorage.getItem("next-shown-order-warnings"),a=n?JSON.parse(n):[];if(a.includes(i.ref_id))return void this.logger.debug("Already shown warning for order",i.ref_id);this.logger.info("Fresh purchase detected, showing attention modal",{orderNumber:i.number,refId:i.ref_id});te.getState().setProcessing(!1);const s=await Rt.show({title:"Attention",content:"Your initial order has been successfully processed. Please check your email for the order confirmation. Entering your payment details again will result in a secondary purchase.",buttons:[{text:"Close",action:"cancel"},{text:"Back",action:"confirm"}],className:"purchase-warning-modal"});if(a.push(i.ref_id),sessionStorage.setItem("next-shown-order-warnings",JSON.stringify(a)),"confirm"===s){const e=this.getSuccessUrl();if(e){const t=new URL(e,window.location.origin);!t.searchParams.has("ref_id")&&i.ref_id&&t.searchParams.set("ref_id",i.ref_id),window.location.href=t.href}}else this.populateFormData(),this.ui&&this.ui.hideLoading("checkout"),this.clearAllCheckoutFields()}catch(t){this.logger.error("Failed to parse order data from sessionStorage:",t);te.getState().setProcessing(!1)}}buildOrderData(e,t){const i={first_name:e.formData.fname||"",last_name:e.formData.lname||"",line1:e.formData.address1||"",line2:e.formData.address2,line4:e.formData.city||"",state:e.formData.province,postcode:e.formData.postal,country:e.formData.country||"",phone_number:e.formData.phone};let n;!e.sameAsShipping&&e.billingAddress&&(n={first_name:e.billingAddress.first_name||"",last_name:e.billingAddress.last_name||"",line1:e.billingAddress.address1||"",line4:e.billingAddress.city||"",country:e.billingAddress.country||"",...e.billingAddress.address2&&{line2:e.billingAddress.address2},...e.billingAddress.province&&{state:e.billingAddress.province},...e.billingAddress.postal&&{postcode:e.billingAddress.postal},...e.billingAddress.phone&&{phone_number:e.billingAddress.phone}});const a={payment_method:vi[e.paymentMethod]||"card_token",...e.paymentToken&&{card_token:e.paymentToken}},s=he.getState().getAttributionForApi();return{lines:t.items.map(e=>({package_id:e.packageId,quantity:e.quantity,is_upsell:!1})),shipping_address:i,...n&&{billing_address:n},billing_same_as_shipping_address:e.sameAsShipping,shipping_method:e.shippingMethod?.id||1,payment_detail:a,user:{email:e.formData.email,first_name:e.formData.fname||"",last_name:e.formData.lname||"",language:"en",phone_number:e.formData.phone,accepts_marketing:e.formData.accepts_marketing||!1},vouchers:e.vouchers||[],attribution:s,success_url:this.getSuccessUrl(),payment_failed_url:this.getFailureUrl()}}async createOrder(){const e=te.getState(),t=Q.getState();try{if(!e.formData.email||!e.formData.fname||!e.formData.lname)throw new Error("Missing required customer information");if(0===t.items.length)throw new Error("Cannot create order with empty cart");if(("credit-card"===e.paymentMethod||"card_token"===e.paymentMethod)&&!e.paymentToken)throw new Error("Payment token is required for credit card payments");const i=this.buildOrderData(e,t),n=await this.apiClient.createOrder(i);if(!n.ref_id)throw new Error("Invalid order response: missing ref_id");return this.logger.info("Order created successfully",{ref_id:n.ref_id,number:n.number,total:n.total_incl_tax,payment_method:e.paymentMethod}),n}catch(i){if(this.logger.error("Failed to create order:",i),400===i.status&&i.responseData){const e=i.responseData;if(this.logger.warn("API 400 error response:",e),e.message&&Array.isArray(e.message)){const t=e.message.map(e=>"object"==typeof e&&null!==e?e.message||JSON.stringify(e):String(e)).join(". ");throw this.displayPaymentError(t),new Error(t)}if(e.message&&"string"==typeof e.message)throw this.displayPaymentError(e.message),new Error(e.message);if(e.payment_details||e.payment_response_code){this.logger.warn("Payment error detected:",{payment_details:e.payment_details,payment_response_code:e.payment_response_code}),this.displayPaymentError(e.payment_details||"Payment failed. Please check your payment information.");let t="Payment failed: ";throw e.payment_details?t+=e.payment_details:t+="Please check your payment information and try again.",new Error(t)}if(e.errors){const t=Object.entries(e.errors).map(([,e])=>Array.isArray(e)?e.join(". "):e).join(". ");throw this.displayPaymentError(t),new Error(t)}}if(i instanceof Error){if(i.message.includes("Rate limited"))throw new Error("Too many requests. Please wait a moment and try again.");if(i.message.includes("401")||i.message.includes("403"))throw new Error("Authentication error. Please refresh the page and try again.");if(i.message.includes("400"))throw new Error("Invalid order data. Please check your information and try again.");if(i.message.includes("500"))throw new Error("Server error. Please try again in a few moments.")}throw i}}async createTestOrder(){const e=Q.getState();try{const t={lines:e.items.length>0?e.items.map(e=>({package_id:e.packageId,quantity:e.quantity,is_upsell:!1})):[{package_id:1,quantity:1,is_upsell:!1}],shipping_address:{first_name:"Test",last_name:"Order",line1:"Test Address 123",line2:"",line4:"Tempe",state:"AZ",postcode:"85281",country:"US",phone_number:"+14807581224"},billing_same_as_shipping_address:!0,shipping_method:1,payment_detail:{payment_method:"card_token",card_token:"test_card"},user:{email:"test@test.com",first_name:"Test",last_name:"Order",language:"en",phone_number:"+14807581224",accepts_marketing:!1},vouchers:[],attribution:this.getTestAttribution(),success_url:this.getSuccessUrl(),payment_failed_url:this.getFailureUrl()};return await this.apiClient.createOrder(t)}catch(t){throw this.logger.error("Failed to create test order:",t),t}}getTestAttribution(){const e=he.getState().getAttributionForApi();return{...e,utm_source:"konami_code",utm_medium:"test",utm_campaign:"debug_test_order",utm_content:"test_mode",metadata:{...e.metadata,test_order:!0,test_timestamp:Date.now()}}}handleOrderRedirect(e){let t;if(e.payment_complete_url)t=e.payment_complete_url;else{const i=this.getNextPageUrlFromMeta(e.ref_id);t=i||(e.order_status_url?e.order_status_url:`${window.location.origin}/checkout/confirmation/?ref_id=${e.ref_id||""}`)}if(t){const e=this.preserveQueryParams(t);window.location.href=e}else{te.getState().setProcessing(!1),this.emit("order:redirect-missing",{order:e})}}getNextPageUrlFromMeta(e){const t=document.querySelector('meta[name="next-success-url"]')||document.querySelector('meta[name="next-next-url"]')||document.querySelector('meta[name="os-next-page"]');if(!t?.content)return null;const i=t.content,n=i.startsWith("http")?new URL(i):new URL(i,window.location.origin);return e&&n.searchParams.append("ref_id",e),n.href}preserveQueryParams(e,t=["debug","debugger"]){try{const i=new URL(e,window.location.origin),n=new URLSearchParams(window.location.search);return t.forEach(e=>{const t=n.get(e);t&&!i.searchParams.has(e)&&i.searchParams.append(e,t)}),i.href}catch(i){return e}}getSuccessUrl(){const e=document.querySelector('meta[name="next-success-url"]')||document.querySelector('meta[name="next-next-url"]')||document.querySelector('meta[name="os-next-page"]');return e?.content?e.content.startsWith("/")?window.location.origin+e.content:e.content:window.location.origin+"/success"}async validateExpressCheckoutFields(e,t){const i={};let n=null;for(const a of t){const t=e[a];if(!t||"string"==typeof t&&!t.trim()){const e={email:"Email",fname:"First Name",lname:"Last Name",phone:"Phone",address1:"Address",city:"City",province:"State/Province",postal:"ZIP/Postal Code",country:"Country"}[a]||a;i[a]=`${e} is required`,n||(n=a)}if("email"===a&&t){/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||(i[a]="Please enter a valid email address",n||(n=a))}}return{isValid:0===Object.keys(i).length,errors:i,firstErrorField:n}}getFailureUrl(){const e=document.querySelector('meta[name="next-failure-url"]')||document.querySelector('meta[name="os-failure-url"]');if(e?.content)return e.content.startsWith("/")?window.location.origin+e.content:e.content;const t=new URL(window.location.href);return t.searchParams.set("payment_failed","true"),t.href}async handleFormSubmit(e){e.preventDefault();const t=te.getState(),i=Q.getState();try{if(t.clearAllErrors(),t.setProcessing(!0),this.loadingOverlay.show(),this.isIntlTelInputAvailable){const e=this.phoneInputs.get("shipping");if(e){const i=e.isValidNumber();if(!i&&t.formData.phone)t.setError("phone","Please enter a valid phone number");else if(i){const i=e.getNumber();i&&t.updateFormData({phone:i})}}if(!t.sameAsShipping&&t.billingAddress){const e=this.phoneInputs.get("billing");if(e){!e.isValidNumber()&&t.billingAddress.phone&&t.setError("billing-phone","Please enter a valid phone number")}}}const e=["paypal","apple_pay","google_pay"].includes(t.paymentMethod),n=oe.getState(),a=n.paymentConfig?.expressCheckout?.requireValidation;if(this.logger.debug("Express payment config:",{isExpressPayment:e,paymentMethod:t.paymentMethod,requireExpressValidation:a,hasExpressProcessor:!!this.expressProcessor,fullConfig:n.paymentConfig?.expressCheckout}),e&&this.expressProcessor&&!a)return this.logger.info(`Processing express checkout for ${t.paymentMethod} (skipping validation)`),this.loadingOverlay.hide(!0),void(await this.expressProcessor.handleExpressCheckout(t.paymentMethod,i.items,i.isEmpty,()=>i.reset()));e&&a&&this.logger.info(`Express payment ${t.paymentMethod} requires validation (requireValidation: true)`);const s="credit-card"===t.paymentMethod||"card_token"===t.paymentMethod||e&&a;let r;if(e&&a&&n.paymentConfig?.expressCheckout?.requiredFields){const e=n.paymentConfig.expressCheckout.requiredFields;r=await this.validateExpressCheckoutFields(t.formData,e)}else r=await this.validator.validateForm(t.formData,this.countryConfigs,this.currentCountryConfig,s,t.billingAddress,t.sameAsShipping);if(!r.isValid){if(this.logger.warn("Validation failed",{paymentMethod:t.paymentMethod,isExpressPayment:e,requireExpressValidation:a,errors:r.errors,firstErrorField:r.firstErrorField}),r.errors&&Object.entries(r.errors).forEach(([e,i])=>{t.setError(e,i),this.validator.showError(e,i)}),e&&a){const e=Object.keys(r.errors||{}),i={email:"Email",fname:"First Name",lname:"Last Name",phone:"Phone",address1:"Address",city:"City",province:"State/Province",postal:"ZIP/Postal Code",country:"Country","cc-month":"Expiration Month","cc-year":"Expiration Year","exp-month":"Expiration Month","exp-year":"Expiration Year","billing-fname":"Billing First Name","billing-lname":"Billing Last Name","billing-address1":"Billing Address","billing-city":"Billing City","billing-province":"Billing State/Province","billing-postal":"Billing ZIP/Postal Code","billing-country":"Billing Country"},n=`Please fill in the following required fields: ${e.map(e=>i[e]||e).join(", ")}`;t.setError("general",n),this.displayPaymentError(n)}return r.firstErrorField&&setTimeout(()=>{this.validator.focusFirstErrorField(r.firstErrorField)},100),t.setProcessing(!1),void this.loadingOverlay.hide(!0)}if(this.emit("checkout:started",{formData:t.formData,paymentMethod:t.paymentMethod}),e&&this.expressProcessor)return this.logger.info(`Processing express checkout for ${t.paymentMethod} (after validation)`),this.loadingOverlay.hide(!0),void(await this.expressProcessor.handleExpressCheckout(t.paymentMethod,i.items,i.isEmpty,()=>i.reset()));if("credit-card"===t.paymentMethod||"card_token"===t.paymentMethod){if(this.creditCardService?.ready){const e={full_name:`${t.formData.fname||""} ${t.formData.lname||""}`.trim(),month:t.formData["cc-month"]||t.formData["exp-month"]||"",year:t.formData["cc-year"]||t.formData["exp-year"]||""};return void(await this.creditCardService.tokenizeCard(e))}throw new Error("Credit card payment system is not ready. Please refresh the page and try again.")}await this.processOrder()}catch(n){this.handleError(n,"handleFormSubmit"),t.setError("general","Failed to process order. Please try again."),t.setProcessing(!1),this.loadingOverlay.hide(!0)}}async processOrder(){try{const e=await this.createOrder();this.prospectCartEnhancer&&await this.prospectCartEnhancer.convertCart(),this.emit("order:completed",e),this.handleOrderRedirect(e)}catch(e){throw te.getState().setProcessing(!1),this.loadingOverlay.hide(!0),e}}async handleTokenizedPayment(e,t){try{const i=te.getState();i.setPaymentToken(e),this.emit("payment:tokenized",{token:e,pmData:t,paymentMethod:i.paymentMethod}),await this.processOrder()}catch(i){this.logger.error("Failed to process tokenized payment:",i);const e=te.getState();i.message&&i.message.includes("Payment failed:")?e.setError("general",i.message):e.setError("general","Payment processing failed. Please try again."),e.setProcessing(!1),this.loadingOverlay.hide(!0)}}async handleFieldChange(e){const t=e.target,i=this.getFieldNameFromElement(t);if(!i)return;const n=te.getState();if(i.startsWith("billing-")){if(this.handleBillingFieldChange(i,t.value,n),"billing-country"===i){const e=this.billingFields.get("billing-province");e instanceof HTMLSelectElement&&await this.updateBillingStateOptions(t.value,e,n.formData.province)}}else{if(this.updateFormData({[i]:t.value}),n.clearError(i),"country"===i){const e=this.fields.get("province");e instanceof HTMLSelectElement&&await this.updateStateOptions(t.value,e)}"address1"===i&&t.value&&t.value.trim().length>0&&this.showLocationFields(),"email"===i&&this.prospectCartEnhancer&&this.prospectCartEnhancer.updateEmail(t.value)}t.value&&""!==t.value.trim()&&this.validator.clearError(i)}async updateBillingStateOptions(e,t,i){t.disabled=!0;const n=t.innerHTML;t.innerHTML='<option value="">Loading...</option>';try{const n=await this.countryService.getCountryStates(e);this.updateBillingFormLabels(n.countryConfig),t.innerHTML="";const a=document.createElement("option");a.value="",a.textContent=`Select ${n.countryConfig.stateLabel}`,a.disabled=!0,a.selected=!0,t.appendChild(a),n.states.forEach(e=>{const i=document.createElement("option");i.value=e.code,i.textContent=e.name,t.appendChild(i)}),n.countryConfig.stateRequired?t.setAttribute("required","required"):t.removeAttribute("required"),i&&(t.value=i)}catch(a){this.logger.error("Failed to load billing states:",a),t.innerHTML=n}finally{t.disabled=!1}}getFieldNameFromElement(e){const t=e.getAttribute("data-next-checkout-field")||e.getAttribute("os-checkout-field");return t||((e instanceof HTMLInputElement||e instanceof HTMLSelectElement)&&e.name?e.name:null)}handleBillingFieldChange(e,t,i){const n=e.replace("billing-",""),a=i.billingAddress||{first_name:"",last_name:"",address1:"",city:"",province:"",postal:"",country:"",phone:""},s=bi[n]||n;i.setBillingAddress({...a,[s]:t})}handlePaymentMethodChange(e){const t=e.target,i=te.getState(),n=yi[t.value]||"credit-card";i.setPaymentMethod(n);const a=document.querySelector('[data-next-component="paypal-error"]');a instanceof HTMLElement&&(a.style.display="none");const s=document.querySelector('[data-next-component="credit-error"]');s instanceof HTMLElement&&(s.style.display="none"),this.ui.updatePaymentFormVisibility(t.value)}handleShippingMethodChange(e){const t=e.target,i=te.getState(),n=parseInt(t.value);if(isNaN(n))return;const a=[{id:1,name:"Standard Shipping",price:0,code:"standard"},{id:2,name:"Subscription Shipping",price:5,code:"subscription"},{id:3,name:"Expedited: Standard Overnight",price:28,code:"overnight"}].find(e=>e.id===n);if(a){i.setShippingMethod(a);Q.getState().setShippingMethod(a.id)}}handleBillingAddressToggle(e){const t=e.target,i=te.getState();i.setSameAsShipping(t.checked);const n=document.querySelector(fi);n instanceof HTMLElement&&(t.checked?this.collapseBillingForm(n):(this.expandBillingForm(n),setTimeout(()=>{const e=i.formData.country,t=this.billingFields.get("billing-country");e&&t instanceof HTMLSelectElement&&(t.value=e,t.dispatchEvent(new Event("change",{bubbles:!0}))),i.setBillingAddress({first_name:"",last_name:"",address1:"",address2:"",city:"",province:"",postal:"",country:e||"",phone:""})},50)))}setupEventHandlers(){this.submitHandler=this.handleFormSubmit.bind(this),this.form.addEventListener("submit",this.submitHandler),this.changeHandler=this.handleFieldChange.bind(this),[...this.fields.values(),...this.billingFields.values()].forEach(e=>{(e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement)&&(e.addEventListener("change",this.changeHandler),e.addEventListener("blur",this.changeHandler))}),this.paymentMethodChangeHandler=this.handlePaymentMethodChange.bind(this);this.form.querySelectorAll(['[data-next-checkout-field="payment-method"]','[os-checkout-field="payment-method"]','input[name="payment_method"]'].join(", ")).forEach(e=>{e.addEventListener("change",this.paymentMethodChangeHandler)}),this.shippingMethodChangeHandler=this.handleShippingMethodChange.bind(this);this.form.querySelectorAll('input[name="shipping_method"]').forEach(e=>{e.addEventListener("change",this.shippingMethodChangeHandler)}),this.billingAddressToggleHandler=this.handleBillingAddressToggle.bind(this);const e=this.form.querySelector('input[name="use_shipping_address"]');e&&e.addEventListener("change",this.billingAddressToggleHandler)}updateFormData(e){te.getState().updateFormData(e)}clearError(e){te.getState().clearError(e)}populateFormData(){const e=te.getState();this.fields.forEach((t,i)=>{e.formData[i]&&(t instanceof HTMLInputElement||t instanceof HTMLSelectElement)&&(t.value=e.formData[i])}),this.ui.updateLabelsForPopulatedData()}handleTestDataFilled(e){setTimeout(()=>{this.populateFormData(),this.fields.forEach(e=>{(e instanceof HTMLInputElement||e instanceof HTMLSelectElement)&&e.dispatchEvent(new Event("change",{bubbles:!0}))}),this.ui.updateLabelsForPopulatedData()},150)}async handleKonamiActivation(e){const t=te.getState(),i=e,n=i.detail?.method;if("konami"===n)try{const e={email:"test@test.com",fname:"Test",lname:"Order",phone:"+14807581224",address1:"Test Address 123",address2:"",city:"Tempe",province:"AZ",postal:"85281",country:"US",accepts_marketing:!1};t.clearAllErrors(),this.validator.clearAllErrors(),t.updateFormData(e),t.setPaymentMethod("credit-card"),t.setPaymentToken("test_card"),t.setSameAsShipping(!0),t.setShippingMethod({id:1,name:"Standard Shipping",price:0,code:"standard"}),this.populateFormData(),setTimeout(async()=>{try{const e=await this.createTestOrder();this.emit("order:completed",e),this.handleOrderRedirect(e)}catch(e){this.logger.error("Failed to create test order:",e)}},1e3)}catch(a){this.logger.error("Error filling test data for Konami order:",a)}}handleCheckoutUpdate(e){e.errors&&Object.keys(e.errors).length>0?Object.entries(e.errors).forEach(([e,t])=>{this.validator.setError(e,t)}):this.validator.clearAllErrors(),e.formData?.address1&&e.formData.address1.trim().length>0&&this.showLocationFields(),e.isProcessing?this.submitButton&&(this.submitButton.disabled=!0,this.submitButton.setAttribute("aria-busy","true")):this.submitButton&&(this.submitButton.disabled=!1,this.submitButton.setAttribute("aria-busy","false"))}handleCartUpdate(e){e.isEmpty&&this.logger.warn("Cart is empty")}async handleConfigUpdate(e){try{e.spreedlyEnvironmentKey&&!this.creditCardService&&await this.initializeCreditCard(e.spreedlyEnvironmentKey,e.debug||!1)}catch(t){this.logger.error("Error handling config update:",t)}}setSuccessUrl(e){this.setOrCreateMetaTag("next-success-url",e),this.setOrCreateMetaTag("next-next-url",e),this.setOrCreateMetaTag("os-next-page",e)}setFailureUrl(e){this.setOrCreateMetaTag("next-failure-url",e),this.setOrCreateMetaTag("os-failure-url",e)}setOrCreateMetaTag(e,t){let i=document.querySelector(`meta[name="${e}"]`);i||(i=document.createElement("meta"),i.name=e,document.head.appendChild(i)),i.content=t}validateField(e,t){const i=this.validator.validateField(e,t);return{isValid:i.isValid,...i.message&&{errorMessage:i.message}}}clearAllValidationErrors(){te.getState().clearAllErrors(),this.validator.clearAllErrors()}update(){this.scanAllFields(),this.initializePhoneInputs()}cleanupEventListeners(){if(this.submitHandler&&this.form.removeEventListener("submit",this.submitHandler),this.changeHandler&&[...this.fields.values(),...this.billingFields.values()].forEach(e=>{e.removeEventListener("change",this.changeHandler),e.removeEventListener("blur",this.changeHandler)}),this.paymentMethodChangeHandler){this.form.querySelectorAll(['[data-next-checkout-field="payment-method"]','[os-checkout-field="payment-method"]','input[name="payment_method"]'].join(", ")).forEach(e=>{e.removeEventListener("change",this.paymentMethodChangeHandler)})}if(this.shippingMethodChangeHandler){this.form.querySelectorAll('input[name="shipping_method"]').forEach(e=>{e.removeEventListener("change",this.shippingMethodChangeHandler)})}if(this.billingAddressToggleHandler){const e=this.form.querySelector('input[name="use_shipping_address"]');e&&e.removeEventListener("change",this.billingAddressToggleHandler)}this.boundHandleTestDataFilled&&document.removeEventListener("checkout:test-data-filled",this.boundHandleTestDataFilled),this.boundHandleKonamiActivation&&document.removeEventListener("next:test-mode-activated",this.boundHandleKonamiActivation)}displayPaymentError(e){this.logger.info("[Payment Error] Displaying error:",e),setTimeout(()=>{const t=document.querySelector('[data-next-component="credit-error"]');if(t instanceof HTMLElement){const i=t.querySelector('[data-next-component="credit-error-text"]');i&&(i.textContent=e),t.style.display="flex",t.style.visibility="visible",t.style.opacity="1",t.classList.add("visible"),t.classList.remove("hidden"),"none"===t.style.display&&(t.style.removeProperty("display"),t.style.display="flex"),this.logger.info("[Payment Error] Error container shown with message:",e),setTimeout(()=>{t.style.display="none",t.classList.remove("visible")},1e4)}else this.logger.error("[Payment Error] Could not find error container element")},100),this.emit("payment:error",{errors:[e]})}destroy(){this.validator&&this.validator.destroy(),this.creditCardService&&this.creditCardService.destroy(),this.prospectCartEnhancer&&this.prospectCartEnhancer.destroy(),this.phoneInputs.forEach(e=>{try{e.destroy()}catch(t){}}),this.phoneInputs.clear(),this.autocompleteInstances.clear(),this.fields.clear(),this.billingFields.clear(),this.paymentButtons.clear(),super.destroy()}}},Symbol.toStringTag,{value:"Module"}));const wi=Object.freeze(Object.defineProperty({__proto__:null,ExpressCheckoutContainerEnhancer:class extends pt{constructor(e){super(e),this.buttonInstances=new Map,this.buttonClickHandlers=new Map,this.loadingOverlay=new Ht}async initialize(){this.validateElement();if("container"!==this.getAttribute("data-next-express-checkout"))throw new Error("ExpressCheckoutContainerEnhancer can only be used on container elements");if(this.buttonsContainer=this.element.querySelector('[data-next-express-checkout="buttons"]'),!this.buttonsContainer)return void this.logger.warn('No buttons container found with data-next-express-checkout="buttons"');this.errorElement=document.querySelector('[data-next-component="express-error"]'),this.errorTextElement=document.querySelector('[data-next-component="express-error-text"]'),this.errorElement&&(this.errorElement.style.display="none");const e=oe.getState(),t=new ce(e.apiKey);this.orderManager=new gi(t,this.logger,(e,t)=>this.emit(e,t)),this.expressProcessor=new ci(this.logger,()=>this.loadingOverlay.show(),e=>this.loadingOverlay.hide(e),(e,t)=>this.emit(e,t),this.orderManager),this.subscribe(oe,this.handleConfigUpdate.bind(this)),this.subscribe(Y,this.handleCampaignUpdate.bind(this)),this.subscribe(Q,this.handleCartUpdate.bind(this)),this.handleConfigUpdate(oe.getState()),this.handleCampaignUpdate(Y.getState()),this.logger.debug("ExpressCheckoutContainerEnhancer initialized")}handleConfigUpdate(e){this.paymentConfig=e.paymentConfig,this.updateExpressCheckoutButtons()}handleCampaignUpdate(e){this.availableExpressMethods=e.data?.available_express_payment_methods,this.updateExpressCheckoutButtons()}async updateExpressCheckoutButtons(){if(this.buttonsContainer)if(this.availableExpressMethods&&this.availableExpressMethods.length>0){this.showContainer(),this.clearButtons();for(const e of this.availableExpressMethods)switch(e.code){case"paypal":this.createPayPalButton();break;case"apple_pay":this.createApplePayButton();break;case"google_pay":this.createGooglePayButton();break;default:this.logger.warn(`Unknown express payment method: ${e.code}`)}this.logger.debug("Express checkout buttons updated from campaign data",{methods:this.availableExpressMethods.map(e=>e.code)})}else if(this.paymentConfig?.expressCheckout){const{enabled:e,methods:t}=this.paymentConfig.expressCheckout;if(!e)return void this.hideContainer();if(!Object.values(t||{}).some(e=>e))return void this.hideContainer();this.showContainer(),this.clearButtons(),t.paypal&&this.createPayPalButton(),t.applePay&&this.createApplePayButton(),t.googlePay&&this.createGooglePayButton(),this.logger.debug("Express checkout buttons updated from config",{paypal:t.paypal,applePay:t.applePay,googlePay:t.googlePay})}else this.hideContainer();else this.hideContainer()}hideContainer(){this.element.style.display="none",this.logger.debug("Express checkout container hidden - no methods enabled")}showContainer(){this.element.style.display="",this.logger.debug("Express checkout container shown")}clearButtons(){for(const[e,t]of this.buttonClickHandlers){const i=this.buttonInstances.get(e);i&&i.removeEventListener("click",t)}if(this.buttonClickHandlers.clear(),this.buttonsContainer)for(;this.buttonsContainer.firstChild;)this.buttonsContainer.removeChild(this.buttonsContainer.firstChild);this.buttonInstances.clear()}async handleButtonClick(e,t){t.preventDefault();if(t.currentTarget.disabled)return;this.errorElement&&(this.errorElement.style.display="none");for(const[,s]of this.buttonInstances)s.setAttribute("disabled","true");const i=Q.getState(),n=te.getState();try{n.setProcessing(!0),n.setPaymentMethod(e),await this.expressProcessor.handleExpressCheckout(e,i.items,i.isEmpty,()=>i.reset()),setTimeout(()=>{for(const[,e]of this.buttonInstances)i.isEmpty||e.removeAttribute("disabled")},3e3)}catch(a){if(this.handleError(a,"handleButtonClick"),n.setError("payment","Express checkout failed. Please try again."),this.errorElement&&this.errorTextElement){const e=a instanceof Error?a.message:"Express checkout failed";this.errorTextElement.textContent=`${e}. Please try a different payment method.`,this.errorElement.style.display="flex",this.errorElement.style.position="relative",this.errorElement.style.zIndex="10000"}for(const[,e]of this.buttonInstances)i.isEmpty||e.removeAttribute("disabled")}finally{n.setProcessing(!1)}}handleCartUpdate(e){for(const[,t]of this.buttonInstances)e.isEmpty?(t.setAttribute("disabled","true"),t.classList.add("next-cart-empty")):(t.removeAttribute("disabled"),t.classList.remove("next-cart-empty"))}async createPayPalButton(){const e=this.createButton("paypal","cc-paypal",'<?xml version="1.0" encoding="UTF-8"?>\n<svg width="86px" height="22px" viewBox="0 0 86 22" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <title>paypal</title>\n  <g id="-Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n    <g id="express-checkout-cta" transform="translate(-204.000000, -15.000000)" fill-rule="nonzero">\n      <g id="paypal" transform="translate(204.000000, 15.000000)">\n        <path d="M66.4793651,5.73913043 L61.8380952,5.73913043 C61.5650794,5.73913043 61.2920635,6.01242236 61.1555556,6.28571429 L59.2444444,18.310559 C59.2444444,18.5838509 59.3809524,18.7204969 59.6539683,18.7204969 L62.1111111,18.7204969 C62.384127,18.7204969 62.5206349,18.5838509 62.5206349,18.310559 L63.0666667,14.8944099 C63.0666667,14.621118 63.3396825,14.3478261 63.7492063,14.3478261 L65.2507937,14.3478261 C68.3904762,14.3478261 70.1650794,12.8447205 70.5746032,9.83850932 C70.847619,8.60869565 70.5746032,7.51552795 70.0285714,6.83229814 C69.2095238,6.14906832 67.9809524,5.73913043 66.4793651,5.73913043 M67.0253968,10.2484472 C66.752381,11.8881988 65.5238095,11.8881988 64.2952381,11.8881988 L63.4761905,11.8881988 L64.0222222,8.74534161 C64.0222222,8.60869565 64.1587302,8.47204969 64.431746,8.47204969 L64.7047619,8.47204969 C65.5238095,8.47204969 66.3428571,8.47204969 66.752381,9.01863354 C67.0253968,9.1552795 67.0253968,9.56521739 67.0253968,10.2484472" id="Shape" fill="#139AD6"></path>\n        <g id="Group" transform="translate(25.800000, 5.739130)" fill="#263B80">\n          <path d="M7.23492063,0 L2.59365079,0 C2.32063492,0 2.04761905,0.273291925 1.91111111,0.546583851 L0,12.5714286 C0,12.8447205 0.136507937,12.9813665 0.40952381,12.9813665 L2.59365079,12.9813665 C2.86666667,12.9813665 3.13968254,12.7080745 3.27619048,12.4347826 L3.82222222,9.1552795 C3.82222222,8.88198758 4.0952381,8.60869565 4.5047619,8.60869565 L6.00634921,8.60869565 C9.14603175,8.60869565 10.9206349,7.10559006 11.3301587,4.09937888 C11.6031746,2.86956522 11.3301587,1.77639752 10.784127,1.0931677 C9.96507937,0.409937888 8.87301587,0 7.23492063,0 M7.78095238,4.50931677 C7.50793651,6.14906832 6.27936508,6.14906832 5.05079365,6.14906832 L4.36825397,6.14906832 L4.91428571,3.00621118 C4.91428571,2.86956522 5.05079365,2.73291925 5.32380952,2.73291925 L5.5968254,2.73291925 C6.41587302,2.73291925 7.23492063,2.73291925 7.64444444,3.27950311 C7.78095238,3.41614907 7.91746032,3.82608696 7.78095238,4.50931677" id="Shape"></path>\n          <path d="M21.2952381,4.37267081 L19.1111111,4.37267081 C18.9746032,4.37267081 18.7015873,4.50931677 18.7015873,4.64596273 L18.5650794,5.32919255 L18.4285714,5.05590062 C17.8825397,4.37267081 16.9269841,4.09937888 15.8349206,4.09937888 C13.3777778,4.09937888 11.1936508,6.01242236 10.784127,8.60869565 C10.5111111,9.97515528 10.9206349,11.2049689 11.6031746,12.0248447 C12.2857143,12.8447205 13.2412698,13.1180124 14.4698413,13.1180124 C16.5174603,13.1180124 17.6095238,11.8881988 17.6095238,11.8881988 L17.4730159,12.5714286 C17.4730159,12.8447205 17.6095238,12.9813665 17.8825397,12.9813665 L19.9301587,12.9813665 C20.2031746,12.9813665 20.4761905,12.7080745 20.6126984,12.4347826 L21.8412698,4.7826087 C21.7047619,4.64596273 21.431746,4.37267081 21.2952381,4.37267081 M18.1555556,8.74534161 C17.8825397,9.97515528 16.9269841,10.931677 15.5619048,10.931677 C14.8793651,10.931677 14.3333333,10.6583851 14.0603175,10.3850932 C13.7873016,9.97515528 13.6507937,9.42857143 13.6507937,8.74534161 C13.7873016,7.51552795 14.8793651,6.55900621 16.1079365,6.55900621 C16.7904762,6.55900621 17.2,6.83229814 17.6095238,7.10559006 C18.0190476,7.51552795 18.1555556,8.19875776 18.1555556,8.74534161" id="Shape"></path>\n        </g>\n        <path d="M80.4031746,10.1118012 L78.2190476,10.1118012 C78.0825397,10.1118012 77.8095238,10.2484472 77.8095238,10.3850932 L77.6730159,11.068323 L77.5365079,10.7950311 C76.9904762,10.1118012 76.0349206,9.83850932 74.9428571,9.83850932 C72.4857143,9.83850932 70.3015873,11.7515528 69.8920635,14.3478261 C69.6190476,15.7142857 70.0285714,16.9440994 70.7111111,17.7639752 C71.3936508,18.5838509 72.3492063,18.8571429 73.5777778,18.8571429 C75.6253968,18.8571429 76.7174603,17.6273292 76.7174603,17.6273292 L76.5809524,18.310559 C76.5809524,18.5838509 76.7174603,18.7204969 76.9904762,18.7204969 L79.0380952,18.7204969 C79.3111111,18.7204969 79.584127,18.447205 79.7206349,18.173913 L80.9492063,10.5217391 C80.8126984,10.3850932 80.6761905,10.1118012 80.4031746,10.1118012 M77.2634921,14.484472 C76.9904762,15.7142857 76.0349206,16.6708075 74.6698413,16.6708075 C73.9873016,16.6708075 73.4412698,16.3975155 73.168254,16.1242236 C72.8952381,15.7142857 72.7587302,15.1677019 72.7587302,14.484472 C72.8952381,13.2546584 73.9873016,12.2981366 75.215873,12.2981366 C75.8984127,12.2981366 76.3079365,12.5714286 76.7174603,12.8447205 C77.2634921,13.2546584 77.4,13.9378882 77.2634921,14.484472" id="Shape" fill="#139AD6"></path>\n        <path d="M58.9714286,10.1118012 L56.6507937,10.1118012 C56.3777778,10.1118012 56.2412698,10.2484472 56.1047619,10.3850932 L53.1015873,15.0310559 L51.7365079,10.6583851 C51.6,10.3850932 51.4634921,10.2484472 51.0539683,10.2484472 L48.8698413,10.2484472 C48.5968254,10.2484472 48.4603175,10.5217391 48.4603175,10.7950311 L50.9174603,18.0372671 L48.5968254,21.3167702 C48.4603175,21.5900621 48.5968254,22 48.8698413,22 L51.0539683,22 C51.3269841,22 51.4634921,21.863354 51.6,21.7267081 L59.1079365,10.931677 C59.5174603,10.5217391 59.2444444,10.1118012 58.9714286,10.1118012" id="Path" fill="#263B80"></path>\n        <path d="M82.9968254,6.14906832 L81.0857143,18.447205 C81.0857143,18.7204969 81.2222222,18.8571429 81.4952381,18.8571429 L83.4063492,18.8571429 C83.6793651,18.8571429 83.952381,18.5838509 84.0888889,18.310559 L86,6.28571429 C86,6.01242236 85.8634921,5.8757764 85.5904762,5.8757764 L83.4063492,5.8757764 C83.2698413,5.73913043 83.1333333,5.8757764 82.9968254,6.14906832" id="Path" fill="#139AD6"></path>\n        <path d="M15.6984127,1.63975155 C14.7428571,0.546583851 12.968254,4.85463981e-15 10.5111111,4.85463981e-15 L3.68571429,4.85463981e-15 C3.27619048,4.85463981e-15 2.86666667,0.409937888 2.73015873,0.819875776 L0,18.7204969 C0,19.1304348 0.273015873,19.4037267 0.546031746,19.4037267 L4.77777778,19.4037267 L5.86984127,12.7080745 L5.86984127,12.9813665 C6.00634921,12.5714286 6.41587302,12.1614907 6.82539683,12.1614907 L8.87301587,12.1614907 C12.831746,12.1614907 15.8349206,10.5217391 16.7904762,6.01242236 C16.7904762,5.8757764 16.7904762,5.73913043 16.7904762,5.60248447 C16.6539683,5.60248447 16.6539683,5.60248447 16.7904762,5.60248447 C16.9269841,3.82608696 16.6539683,2.73291925 15.6984127,1.63975155" id="Path" fill="#263B80"></path>\n        <path d="M16.6539683,5.60248447 L16.6539683,5.60248447 C16.6539683,5.73913043 16.6539683,5.8757764 16.6539683,6.01242236 C15.6984127,10.6583851 12.6952381,12.1614907 8.73650794,12.1614907 L6.68888889,12.1614907 C6.27936508,12.1614907 5.86984127,12.5714286 5.73333333,12.9813665 L4.36825397,21.3167702 C4.36825397,21.5900621 4.5047619,21.863354 4.91428571,21.863354 L8.46349206,21.863354 C8.87301587,21.863354 9.28253968,21.5900621 9.28253968,21.1801242 L9.28253968,21.0434783 L9.96507937,16.8074534 L9.96507937,16.5341615 C9.96507937,16.1242236 10.3746032,15.8509317 10.784127,15.8509317 L11.3301587,15.8509317 C14.7428571,15.8509317 17.4730159,14.484472 18.1555556,10.3850932 C18.4285714,8.74534161 18.2920635,7.24223602 17.4730159,6.28571429 C17.3365079,6.01242236 17.0634921,5.73913043 16.6539683,5.60248447" id="Path" fill="#139AD6"></path>\n        <path d="M15.6984127,5.19254658 C15.5619048,5.19254658 15.4253968,5.05590062 15.2888889,5.05590062 C15.152381,5.05590062 15.015873,5.05590062 14.8793651,4.91925466 C14.3333333,4.7826087 13.7873016,4.7826087 13.1047619,4.7826087 L7.78095238,4.7826087 C7.64444444,4.7826087 7.50793651,4.7826087 7.37142857,4.91925466 C7.0984127,5.05590062 6.96190476,5.32919255 6.96190476,5.60248447 L5.86984127,12.7080745 L5.86984127,12.9813665 C6.00634921,12.5714286 6.41587302,12.1614907 6.82539683,12.1614907 L8.87301587,12.1614907 C12.831746,12.1614907 15.8349206,10.5217391 16.7904762,6.01242236 C16.7904762,5.8757764 16.7904762,5.73913043 16.9269841,5.60248447 C16.6539683,5.46583851 16.5174603,5.32919255 16.2444444,5.32919255 C15.8349206,5.19254658 15.8349206,5.19254658 15.6984127,5.19254658" id="Path" fill="#232C65"></path>\n      </g>\n    </g>\n  </g>\n</svg>');e.style.backgroundColor="hsla(42.121212121212125, 100.00%, 61.18%, 1.00)",this.buttonInstances.set("paypal",e),this.buttonsContainer.appendChild(e);const t=e=>this.handleButtonClick("paypal",e);this.buttonClickHandlers.set("paypal",t),e.addEventListener("click",t),this.emit("express-checkout:initialized",{method:"paypal",element:e}),this.logger.debug("PayPal express checkout button created")}async createApplePayButton(){const e=this.createButton("apple_pay","cc-apple-pay",'<?xml version="1.0" encoding="UTF-8"?>\n<svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%" viewBox="0 0 512 252.2">\n  <defs></defs>\n  <path class="st0" fill="white" d="M93.6,69.1c-6,7.1-15.6,12.7-25.2,11.9-1.2-9.6,3.5-19.8,9-26.1,6-7.3,16.5-12.5,25-12.9,1,10-2.9,19.8-8.8,27.1M102.3,82.9c-13.9-.8-25.8,7.9-32.4,7.9s-16.8-7.5-27.8-7.3c-14.3.2-27.6,8.3-34.9,21.2-15,25.8-3.9,64,10.6,85,7.1,10.4,15.6,21.8,26.8,21.4,10.6-.4,14.8-6.9,27.6-6.9s16.6,6.9,27.8,6.7c11.6-.2,18.9-10.4,26-20.8,8.1-11.8,11.4-23.3,11.6-23.9-.2-.2-22.4-8.7-22.6-34.3-.2-21.4,17.5-31.6,18.3-32.2-10-14.8-25.6-16.4-31-16.8M182.6,53.9v155.9h24.2v-53.3h33.5c30.6,0,52.1-21,52.1-51.4s-21.1-51.2-51.3-51.2h-58.5ZM206.8,74.3h27.9c21,0,33,11.2,33,30.9s-12,31-33.1,31h-27.8v-61.9ZM336.6,211c15.2,0,29.3-7.7,35.7-19.9h.5v18.7h22.4v-77.6c0-22.5-18-37-45.7-37s-44.7,14.7-45.4,34.9h21.8c1.8-9.6,10.7-15.9,22.9-15.9s23.1,6.9,23.1,19.6v8.6l-30.2,1.8c-28.1,1.7-43.3,13.2-43.3,33.2s15.7,33.6,38.2,33.6ZM343.1,192.5c-12.9,0-21.1-6.2-21.1-15.7s7.9-15.5,23-16.4l26.9-1.7v8.8c0,14.6-12.4,25-28.8,25ZM425.1,252.2c23.6,0,34.7-9,44.4-36.3l42.5-119.2h-24.6l-28.5,92.1h-.5l-28.5-92.1h-25.3l41,113.5-2.2,6.9c-3.7,11.7-9.7,16.2-20.4,16.2s-5.6-.2-7.1-.4v18.7c1.4.4,7.4.6,9.2.6Z" />\n</svg>');e.style.color="hsla(0, 0.00%, 100.00%, 1.00)",this.buttonInstances.set("apple_pay",e),this.buttonsContainer.appendChild(e);const t=e=>this.handleButtonClick("apple_pay",e);this.buttonClickHandlers.set("apple_pay",t),e.addEventListener("click",t),this.emit("express-checkout:initialized",{method:"apple_pay",element:e}),this.logger.debug("Apple Pay express checkout button created")}async createGooglePayButton(){const e=this.createButton("google_pay","cc-google-pay",'<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 41 20.3" width="100%" height="100%">\n  <path fill="#ffffff" fill-rule="evenodd" d="M19.5,5.9v4.1h2.5c.6,0,1.1-.2,1.5-.6.4-.4.6-.9.6-1.4s-.2-1-.6-1.4c-.4-.4-.9-.6-1.5-.6h-2.5ZM19.5,11.5v4.7h-1.5V4.5h4c1,0,1.9.3,2.6,1,.7.7,1.1,1.5,1.1,2.5s-.4,1.8-1.1,2.5c-.7.7-1.6,1-2.6,1h-2.5s0,0,0,0ZM27.2,13.7c0,.4.2.7.5,1,.3.3.7.4,1.2.4.6,0,1.2-.2,1.7-.7.5-.5.7-1,.7-1.6-.5-.4-1.1-.6-2-.6s-1.1.1-1.5.4c-.4.3-.6.7-.6,1.1M29.1,7.9c1.1,0,2,.3,2.6.9.6.6,1,1.4,1,2.4v4.9h-1.4v-1.1h0c-.6.9-1.5,1.4-2.5,1.4s-1.6-.3-2.2-.8c-.6-.5-.9-1.2-.9-2s.3-1.5.9-2,1.5-.7,2.5-.7,1.6.2,2.2.5v-.3c0-.5-.2-1-.6-1.3-.4-.4-.9-.6-1.5-.5-.8,0-1.5.4-2,1.1l-1.3-.8c.7-1,1.8-1.6,3.2-1.6M41,8.2l-5,11.5h-1.6l1.9-4-3.3-7.5h1.6l2.4,5.7h0l2.3-5.8h1.6Z" />\n  <path fill="#4285f4" fill-rule="evenodd" d="M13.4,10.4c0-.5,0-.9-.1-1.4h-6.3v2.6h3.6c-.2.8-.6,1.6-1.3,2v1.7h2.2c1.3-1.2,2-2.9,2-4.9" />\n  <path fill="#34a853" fill-rule="evenodd" d="M7,17c1.8,0,3.3-.6,4.5-1.6l-2.2-1.7c-.6.4-1.4.6-2.3.6-1.8,0-3.2-1.2-3.8-2.8H1v1.7c1.1,2.3,3.5,3.7,6,3.7" />\n  <path fill="#fabb05" fill-rule="evenodd" d="M3.2,11.6c-.3-.8-.3-1.7,0-2.6v-1.7H1c-.5.9-.7,2-.7,3,0,1.1.3,2.1.7,3l2.2-1.7h0Z" />\n  <path fill="#e94235" fill-rule="evenodd" d="M7,6.2c1,0,1.9.3,2.6,1h0s1.9-1.9,1.9-1.9c-1.2-1.1-2.7-1.7-4.5-1.7-2.5,0-4.9,1.4-6,3.7l2.2,1.7c.5-1.6,2-2.8,3.8-2.8" />\n</svg>');this.buttonInstances.set("google_pay",e),this.buttonsContainer.appendChild(e);const t=e=>this.handleButtonClick("google_pay",e);this.buttonClickHandlers.set("google_pay",t),e.addEventListener("click",t),this.emit("express-checkout:initialized",{method:"google_pay",element:e}),this.logger.debug("Google Pay express checkout button created")}createButton(e,t,i){const n=document.createElement("button");n.className=`payment-btn ${t}`,n.setAttribute("data-next-express-checkout",e),n.setAttribute("data-action","submit"),n.style.position="relative",n.style.display="flex",n.style.width="100%",n.style.height="2.75rem",n.style.justifyContent="center",n.style.alignItems="center",n.style.borderRadius="4px",n.style.backgroundColor="hsla(0, 0.00%, 0.00%, 1.00)",n.style.border="none",n.style.cursor="pointer";const a=document.createElement("div");a.setAttribute("next-slot","content");const s=document.createElement("div");"apple_pay"!==e&&"google_pay"!==e||(s.className="payment-btn__logo",s.style.height="1.5rem"),s.innerHTML=i,a.appendChild(s),n.appendChild(a);const r=document.createElement("div");return r.className="payment-btn-spinner",r.setAttribute("next-slot","spinner"),r.innerHTML='<div class="spinner"></div>',n.appendChild(r),n}update(){this.handleConfigUpdate(oe.getState())}destroy(){this.clearButtons(),super.destroy()}}},Symbol.toStringTag,{value:"Module"}));class Si{static render(e,t){const{data:i,formatters:n={},defaultValues:a={}}=t;return e.replace(/\{([^}]+)\}/g,(e,t)=>{try{const e=this.getValue(i,t),s=this.formatValue(e,t,n);return""===s||null==s?a[t]||"":String(s)}catch(s){return a[t]||""}})}static getValue(e,t){const i=t.split(".");let n=e;for(const a of i){if(null==n)return;n=n[a]}return n}static formatValue(e,t,i){if(t.endsWith(".raw"))return e;const n=["price","total","savings","amount","cost","fee","charge","compare","retail","recurring","subtotal","tax","shipping","discount","credit","balance","payment","refund"].some(e=>t.toLowerCase().includes(e.toLowerCase()));return n&&"number"==typeof e?i.currency?i.currency(e):e:n&&"string"==typeof e&&!isNaN(parseFloat(e))?i.currency?i.currency(parseFloat(e)):e:t.includes("date")||t.includes("created_at")?i.date?i.date(e):e:"string"==typeof e&&(t.includes("name")||t.includes("title")||t.includes("description"))&&i.escapeHtml?i.escapeHtml(e):e}static validateTemplate(e,t){const i=[],n=this.extractPlaceholders(e);for(const s of n){const e=s.replace(".raw","");t.some(t=>t.startsWith(e))||i.push(`Unknown placeholder: {${s}}`)}const a=e.match(/\{[^}]*$/g);return a&&i.push(`Unclosed placeholders found: ${a.join(", ")}`),i}static extractPlaceholders(e){return(e.match(/\{([^}]+)\}/g)||[]).map(e=>e.slice(1,-1))}static createDefaultFormatters(){return{currency:e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e),date:e=>{if(!e)return"";try{const t=new Date(e);return isNaN(t.getTime())?String(e):new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(t)}catch{return String(e)}},escapeHtml:e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML}}}}const _i=Object.freeze(Object.defineProperty({__proto__:null,CartItemListEnhancer:class extends pt{async initialize(){this.validateElement();const e=this.getAttribute("data-item-template-id"),t=this.getAttribute("data-item-template-selector");if(e){const t=document.getElementById(e);this.template=t?.innerHTML.trim()??""}else if(t){const e=document.querySelector(t);this.template=e?.innerHTML.trim()??""}else this.template=this.getAttribute("data-item-template")||this.element.innerHTML.trim();this.template&&""!==this.template.replace(/<!--[\s\S]*?-->/g,"").trim()||(this.template=this.getDefaultItemTemplate()),this.emptyTemplate=this.getAttribute("data-empty-template")||'<div class="cart-empty">Your cart is empty</div>';const i=this.getAttribute("data-title-map");if(i)try{this.titleMap=JSON.parse(i)}catch(n){this.logger.warn("Invalid title map JSON:",n)}this.subscribe(Q,this.handleCartUpdate.bind(this)),this.handleCartUpdate(Q.getState()),this.logger.debug("CartItemListEnhancer initialized")}update(e){e&&this.handleCartUpdate(e)}async handleCartUpdate(e){try{e.isEmpty||0===e.items.length?this.renderEmptyCart():await this.renderCartItems(e.items)}catch(t){this.handleError(t,"handleCartUpdate")}}renderEmptyCart(){this.element.innerHTML=this.emptyTemplate||"",this.addClass("cart-empty"),this.removeClass("cart-has-items")}async renderCartItems(e){this.removeClass("cart-empty"),this.addClass("cart-has-items");const t=Y.getState(),i=[];for(const n of e){const e=await this.renderCartItem(n,t);e&&i.push(e)}this.element.innerHTML=i.join(""),await this.enhanceNewElements()}async renderCartItem(e,t){try{const i=t.getPackage(e.packageId);if(!i)return this.logger.warn(`Package data not found for item ${e.packageId}`),"";const n=this.prepareCartItemData(e,i),a=this.template||this.getDefaultItemTemplate(),s={...Si.createDefaultFormatters(),currency:e=>kt.formatCurrency(e)};return Si.render(a,{data:{item:n},formatters:s})}catch(i){return this.logger.error("Error rendering cart item:",i),""}}getDefaultItemTemplate(){return'\n      <div class="cart-item" data-cart-item-id="{item.id}" data-package-id="{item.packageId}">\n        <div class="cart-item-image">\n          <img src="{item.image}" alt="{item.name}" onerror="this.style.display=\'none\';">\n          <span style="font-size: 1.5em;">ðŸ“¦</span>\n        </div>\n        <div class="cart-item-details">\n          <h4 class="cart-item-name">{item.name}</h4>\n          <div class="cart-item-pricing">\n            <div class="current-price">{item.price} each</div>\n            <div class="compare-price {item.showCompare}" style="text-decoration: line-through; color: #999;">{item.comparePrice}</div>\n            <div class="savings {item.showSavings}" style="color: #0d7519; font-weight: bold;">Save {item.savingsAmount} ({item.savingsPct})</div>\n            <div class="frequency">{item.frequency}</div>\n            <div class="recurring-price {item.showRecurring}" style="color: #666;">Then {item.recurringPrice} recurring</div>\n          </div>\n        </div>\n        <div class="quantity-controls">\n          <button class="quantity-btn" data-next-quantity="decrease" data-package-id="{item.packageId}">-</button>\n          <span class="quantity-display">{item.quantity}</span>\n          <button class="quantity-btn" data-next-quantity="increase" data-package-id="{item.packageId}">+</button>\n        </div>\n        <div class="cart-item-total">\n          <div class="line-total">{item.lineTotal}</div>\n          <div class="line-compare {item.showCompare}" style="text-decoration: line-through; color: #999; font-size: 0.9em;">{item.lineCompare}</div>\n        </div>\n        <button class="remove-btn" data-next-remove-item data-package-id="{item.packageId}" data-confirm="true" data-confirm-message="Remove this item from your cart?">Remove</button>\n      </div>\n    '.trim()}async enhanceNewElements(){const e=this.element.querySelectorAll("[data-next-quantity]"),t=this.element.querySelectorAll("[data-next-remove-item]");if(e.length>0){const{QuantityControlEnhancer:t}=await Promise.resolve().then(()=>Ei);for(const n of Array.from(e))if(n instanceof HTMLElement)try{const e=new t(n);await e.initialize(),this.logger.debug("Enhanced quantity control button",n)}catch(i){this.logger.error("Failed to enhance quantity button:",i,n)}}if(t.length>0){const{RemoveItemEnhancer:e}=await Promise.resolve().then(()=>Ii);for(const n of Array.from(t))if(n instanceof HTMLElement)try{const t=new e(n);await t.initialize(),this.logger.debug("Enhanced remove button",n)}catch(i){this.logger.error("Failed to enhance remove button:",i,n)}}this.logger.debug(`Enhanced ${e.length} quantity buttons and ${t.length} remove buttons`)}prepareCartItemData(e,t){const i=e.price,n=i*e.quantity,a=parseFloat(t.price||"0"),s=parseFloat(t.price_total||"0"),r=parseFloat(t.price_retail||t.price||"0"),o=parseFloat(t.price_retail_total||"0"),l=t.qty||1,c=Lt.calculatePackageMetrics({price:a,retailPrice:r,quantity:l,priceTotal:s,retailPriceTotal:o}),d=c.totalRetailPrice*e.quantity,u=c.totalSavings*e.quantity,p=parseFloat(t.price_recurring||"0"),h=parseFloat(t.price_recurring_total||"0"),g=t.is_recurring&&p>0,m=g?t.interval_count&&t.interval_count>1?`Every ${t.interval_count} ${t.interval}s`:`Per ${t.interval}`:"One time",f=window.nextConfig?.productTitleMap||{},y=this.titleMap||f;let v=y[e.packageId]||y[String(e.packageId)];const b=window.nextConfig?.productTitleTransform;if(!v&&"function"==typeof b)try{v=b(e.packageId,t.name)}catch(x){this.logger.warn("Error in productTitleTransform:",x)}return{id:e.id,packageId:e.packageId,title:v||e.title||t.name,name:v||t.name,quantity:e.quantity,price:i,unitPrice:c.unitPrice,lineTotal:n,lineCompare:c.hasSavings?d:0,comparePrice:c.hasSavings?c.totalRetailPrice:0,unitComparePrice:c.unitRetailPrice,recurringPrice:g?p:0,savingsAmount:u>0?u:0,unitSavings:c.unitSavings,packagePrice:a,packagePriceTotal:c.totalPrice,packageRetailPrice:r,packageRetailTotal:c.totalRetailPrice,packageSavings:c.totalSavings>0?c.totalSavings:0,recurringTotal:g?h:0,savingsPct:c.totalSavingsPercentage>0?`${Math.round(c.totalSavingsPercentage)}%`:"",packageSavingsPct:c.totalSavingsPercentage>0?`${Math.round(c.totalSavingsPercentage)}%`:"",packageQty:l,frequency:m,isRecurring:g?"true":"false",hasSavings:u>0?"true":"false",hasPackageSavings:c.hasSavings?"true":"false",image:t.image||"",sku:t.external_id?String(t.external_id):"","price.raw":i,"unitPrice.raw":c.unitPrice,"lineTotal.raw":n,"lineCompare.raw":d,"comparePrice.raw":c.totalRetailPrice,"unitComparePrice.raw":c.unitRetailPrice,"recurringPrice.raw":p,"savingsAmount.raw":u,"unitSavings.raw":c.unitSavings,"packagePrice.raw":a,"packagePriceTotal.raw":c.totalPrice,"packageRetailPrice.raw":r,"packageRetailTotal.raw":c.totalRetailPrice,"packageSavings.raw":c.totalSavings,"recurringTotal.raw":h,"savingsPct.raw":Math.round(c.totalSavingsPercentage),"packageSavingsPct.raw":Math.round(c.totalSavingsPercentage),showCompare:c.hasSavings?"show":"hide",showSavings:u>0?"show":"hide",showUnitPrice:l>1?"show":"hide",showUnitCompare:l>1&&c.unitSavings>0?"show":"hide",showUnitSavings:l>1&&c.unitSavings>0?"show":"hide",showRecurring:g?"show":"hide",showPackageSavings:c.totalSavings>0?"show":"hide",showPackageTotal:c.totalPrice>0?"show":"hide",showRecurringTotal:g&&h>0?"show":"hide"}}getItemCount(){return this.element.querySelectorAll("[data-cart-item-id]").length}getItemElements(){return this.element.querySelectorAll("[data-cart-item-id]")}refreshItem(e){const t=Q.getState();this.handleCartUpdate(t)}}},Symbol.toStringTag,{value:"Module"}));const ki=Object.freeze(Object.defineProperty({__proto__:null,OrderItemListEnhancer:class extends pt{async initialize(){this.validateElement();const e=this.getAttribute("data-item-template-id"),t=this.getAttribute("data-item-template-selector");if(e){const t=document.getElementById(e);this.template=t?.innerHTML.trim()??""}else if(t){const e=document.querySelector(t);this.template=e?.innerHTML.trim()??""}else this.template=this.getAttribute("data-item-template")||this.element.innerHTML.trim();this.template&&""!==this.template.replace(/<!--[\s\S]*?-->/g,"").trim()||(this.template=this.getDefaultItemTemplate()),this.emptyTemplate=this.getAttribute("data-empty-template")||'<div class="order-empty">No items found in order</div>',await this.checkAndLoadOrderFromUrl(),this.subscribe(se,this.handleOrderUpdate.bind(this)),this.handleOrderUpdate(se.getState()),this.logger.debug("OrderItemListEnhancer initialized")}update(e){e&&this.handleOrderUpdate(e)}async checkAndLoadOrderFromUrl(){const e=new URLSearchParams(window.location.search).get("ref_id");if(e){const i=se.getState();if(!i.order&&!i.isLoading&&i.refId!==e)try{const t=oe.getState();this.apiClient=new ce(t.apiKey),await i.loadOrder(e,this.apiClient)}catch(t){this.logger.error("Failed to auto-load order:",t)}}}async handleOrderUpdate(e){try{const t=e.order;if(e.isLoading)return this.element.innerHTML='<div class="status-message">Loading order items...</div>',this.addClass("order-loading"),this.removeClass("order-has-items"),void this.removeClass("order-empty");if(e.error)return this.element.innerHTML='<div class="status-message">Error loading order items</div>',this.addClass("order-error"),this.removeClass("order-has-items"),this.removeClass("order-empty"),void this.removeClass("order-loading");t&&t.lines&&0!==t.lines.length?await this.renderOrderItems(t.lines):this.renderEmptyOrder()}catch(t){this.handleError(t,"handleOrderUpdate")}}renderEmptyOrder(){this.element.innerHTML=this.emptyTemplate||"",this.addClass("order-empty"),this.removeClass("order-has-items"),this.removeClass("order-loading"),this.removeClass("order-error")}async renderOrderItems(e){this.removeClass("order-empty"),this.removeClass("order-loading"),this.removeClass("order-error"),this.addClass("order-has-items");const t=[];for(const i of e){const e=this.renderOrderItem(i);e&&t.push(e)}this.element.innerHTML=t.join("")}renderOrderItem(e){try{const t=this.prepareOrderLineData(e),i=this.template||this.getDefaultItemTemplate(),n={...Si.createDefaultFormatters(),currency:e=>kt.formatCurrency(e)};return Si.render(i,{data:{item:t},formatters:n})}catch(t){return this.logger.error("Error rendering order item:",t),""}}getDefaultItemTemplate(){return'\n      <div class="order-item" data-order-line-id="{item.id}">\n        <div class="order-item-image {item.showImage}">\n          <img src="{item.image}" alt="{item.name}" onerror="this.style.display=\'none\';">\n          <span class="item-fallback-icon" style="font-size: 1.5em;">ðŸ“¦</span>\n        </div>\n        <div class="order-item-details">\n          <h4 class="order-item-name">\n            {item.name}\n            <span class="upsell-badge {item.showUpsell}" style="background: #e7f3ff; color: #0056b3; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-left: 8px;">{item.upsellBadge}</span>\n          </h4>\n          <div class="order-item-meta">\n            <div class="item-sku">SKU: {item.sku}</div>\n            <div class="item-variant {item.showVariant}">Variant: {item.variant}</div>\n            <div class="item-description {item.showDescription}" style="color: #6c757d; font-size: 0.9em;">{item.description}</div>\n          </div>\n          <div class="order-item-pricing">\n            <div class="unit-price">{item.price} each</div>\n            <div class="tax-info {item.showTax}" style="color: #666; font-size: 0.9em;">Tax: {item.unitTax}</div>\n          </div>\n        </div>\n        <div class="quantity-info">\n          <span class="quantity-label">Qty:</span>\n          <span class="quantity-value">{item.quantity}</span>\n        </div>\n        <div class="order-item-total">\n          <div class="line-total">{item.lineTotal}</div>\n          <div class="line-tax {item.showTax}" style="color: #666; font-size: 0.9em;">Tax: {item.lineTax}</div>\n        </div>\n      </div>\n    '.trim()}prepareOrderLineData(e){const t=parseFloat(e.price_incl_tax||"0"),i=parseFloat(e.price_excl_tax||"0"),n=e.quantity||1,a=n>0?t/n:t,s=n>0?i/n:i,r=a-s,o=t-i,l=e.is_upsell?"UPSELL":"";return{id:String(e.id||""),title:e.product_title||"Unknown Product",name:e.product_title||"Unknown Product",sku:e.product_sku||"",quantity:String(n),price:a,priceExclTax:s,unitTax:r,lineTotal:t,lineTotalExclTax:i,lineTax:o,image:e.image||"",description:e.product_description||"",variant:e.variant_title||"",isUpsell:e.is_upsell?"true":"false",upsellBadge:l,hasImage:e.image?"true":"false",hasDescription:e.product_description?"true":"false",hasVariant:e.variant_title?"true":"false",hasTax:r>0?"true":"false",showUpsell:e.is_upsell?"show":"hide",showImage:e.image?"show":"hide",showDescription:e.product_description?"show":"hide",showVariant:e.variant_title?"show":"hide",showTax:r>0?"show":"hide"}}getItemCount(){return this.element.querySelectorAll("[data-order-line-id]").length}getItemElements(){return this.element.querySelectorAll("[data-order-line-id]")}}},Symbol.toStringTag,{value:"Module"}));class Ci extends pt{setupCartSubscription(){this.subscribe(Q,this.handleCartUpdate.bind(this)),this.cartState=Q.getState()}isCartEmpty(){return this.cartState?.isEmpty??!0}getCartItem(e){return this.cartState?.items.find(t=>t.packageId===e)}getTotalQuantity(){return this.cartState?.totalQuantity??0}getCartTotals(){return this.cartState?.totals??{subtotal:{value:0,formatted:"$0.00"},shipping:{value:0,formatted:"$0.00"},tax:{value:0,formatted:"$0.00"},discounts:{value:0,formatted:"$0.00"},total:{value:0,formatted:"$0.00"},count:0,isEmpty:!0,savings:{value:0,formatted:"$0.00"},savingsPercentage:{value:0,formatted:"0%"},compareTotal:{value:0,formatted:"$0.00"},hasSavings:!1}}getCartItems(){return this.cartState?.items??[]}hasPackageInCart(e){return void 0!==this.getCartItem(e)}}const Ei=Object.freeze(Object.defineProperty({__proto__:null,QuantityControlEnhancer:class extends Ci{constructor(){super(...arguments),this.step=1,this.min=0,this.max=99}async initialize(){this.validateElement();const e=this.getRequiredAttribute("data-next-quantity");if(!["increase","decrease","set"].includes(e))throw new Error(`Invalid quantity action: ${e}. Must be 'increase', 'decrease', or 'set'`);this.action=e;const t=this.getRequiredAttribute("data-package-id");if(this.packageId=parseInt(t,10),isNaN(this.packageId))throw new Error(`Invalid package ID: ${t}`);this.step=parseInt(this.getAttribute("data-step")||"1",10)||1,this.min=parseInt(this.getAttribute("data-min")||"0",10)||0,this.max=parseInt(this.getAttribute("data-max")||"99",10)||99,this.setupEventListeners(),this.setupCartSubscription(),this.logger.debug(`QuantityControlEnhancer initialized for package ${this.packageId} with action ${this.action}`)}update(e){e&&this.handleCartUpdate(e)}setupEventListeners(){"set"!==this.action||"INPUT"!==this.element.tagName&&"SELECT"!==this.element.tagName?this.element.addEventListener("click",this.handleClick.bind(this)):(this.element.addEventListener("change",this.handleQuantityChange.bind(this)),this.element.addEventListener("blur",this.handleQuantityChange.bind(this)),this.element instanceof HTMLInputElement&&"number"===this.element.type&&this.element.addEventListener("input",this.handleNumberInput.bind(this)))}async handleClick(e){if(e.preventDefault(),e.stopPropagation(),!this.hasClass("disabled")&&!this.element.hasAttribute("disabled"))try{this.addClass("processing"),await this.updateQuantity()}catch(t){this.handleError(t,"handleClick")}finally{this.removeClass("processing")}}async handleQuantityChange(e){if("set"!==this.action)return;const t=e.target,i=parseInt(t.value,10);if(isNaN(i)||i<this.min)t.value=String(this.min);else if(i>this.max)t.value=String(this.max);else try{this.addClass("processing");const e=Q.getState();0===i?await e.removeItem(this.packageId):await e.updateQuantity(this.packageId,i)}catch(n){this.handleError(n,"handleQuantityChange");const e=Q.getState().getItemQuantity(this.packageId);t.value=String(e)}finally{this.removeClass("processing")}}handleNumberInput(e){const t=e.target,i=parseInt(t.value,10);i<this.min&&(t.value=String(this.min)),i>this.max&&(t.value=String(this.max))}async updateQuantity(){const e=Q.getState(),t=e.getItemQuantity(this.packageId);let i;switch(this.action){case"increase":i=Math.min(t+this.step,this.max);break;case"decrease":i=Math.max(t-this.step,this.min);break;default:return}i!==t?(i<=0?(await e.removeItem(this.packageId),this.logger.debug(`Removed item ${this.packageId} from cart`)):(await e.updateQuantity(this.packageId,i),this.logger.debug(`Updated quantity for item ${this.packageId} to ${i}`)),this.emitQuantityChangeEvent(t,i)):this.logger.debug("Quantity unchanged, no action needed")}handleCartUpdate(e){const t=this.getCartItem(this.packageId),i=t?.quantity||0,n=i>0;this.updateButtonState(i),"set"===this.action&&(this.element instanceof HTMLInputElement||this.element instanceof HTMLSelectElement)&&this.element.value!==String(i)&&(this.element.value=String(i)),this.toggleClass("has-item",n),this.toggleClass("empty",!n),this.element.setAttribute("data-quantity",String(i)),this.element.setAttribute("data-in-cart",String(n))}updateButtonState(e){const t=e<this.max,i=e>this.min;switch(this.action){case"increase":this.toggleClass("disabled",!t),this.element.toggleAttribute("disabled",!t),this.setAttribute("aria-disabled",String(!t));break;case"decrease":this.toggleClass("disabled",!i),this.element.toggleAttribute("disabled",!i),this.setAttribute("aria-disabled",String(!i));break;case"set":this.element instanceof HTMLInputElement&&(this.element.min=String(this.min),this.element.max=String(this.max),this.element.step=String(this.step))}this.updateButtonContent(e)}updateButtonContent(e){const t=this.getAttribute("data-original-content")||this.element.innerHTML;this.hasAttribute("data-original-content")||this.setAttribute("data-original-content",this.element.innerHTML);const i=t.replace(/\{quantity\}/g,String(e)).replace(/\{step\}/g,String(this.step));this.element.innerHTML!==i&&(this.element.innerHTML=i)}emitQuantityChangeEvent(e,t){this.emit("cart:quantity-changed",{packageId:this.packageId,quantity:t,oldQuantity:e})}getCurrentQuantity(){return Q.getState().getItemQuantity(this.packageId)}setQuantity(e){const t=Math.max(this.min,Math.min(this.max,e)),i=Q.getState();return t<=0?i.removeItem(this.packageId):i.updateQuantity(this.packageId,t)}getConstraints(){return{min:this.min,max:this.max,step:this.step}}}},Symbol.toStringTag,{value:"Module"}));const Ii=Object.freeze(Object.defineProperty({__proto__:null,RemoveItemEnhancer:class extends pt{constructor(){super(...arguments),this.confirmRemoval=!1,this.confirmMessage="Are you sure you want to remove this item?"}async initialize(){this.validateElement();const e=this.getRequiredAttribute("data-package-id");if(this.packageId=parseInt(e,10),isNaN(this.packageId))throw new Error(`Invalid package ID: ${e}`);this.confirmRemoval="true"===this.getAttribute("data-confirm"),this.confirmMessage=this.getAttribute("data-confirm-message")||this.confirmMessage,this.element.addEventListener("click",this.handleClick.bind(this)),this.subscribe(Q,this.handleCartUpdate.bind(this)),this.handleCartUpdate(Q.getState()),this.logger.debug(`RemoveItemEnhancer initialized for package ${this.packageId}`)}update(e){e&&this.handleCartUpdate(e)}async handleClick(e){if(e.preventDefault(),e.stopPropagation(),!this.hasClass("disabled")&&!this.element.hasAttribute("disabled")&&(!this.confirmRemoval||confirm(this.confirmMessage)))try{this.addClass("processing"),await this.removeItem()}catch(t){this.handleError(t,"handleClick")}finally{this.removeClass("processing")}}async removeItem(){const e=Q.getState();0!==e.getItemQuantity(this.packageId)?(await e.removeItem(this.packageId),this.logger.debug(`Removed item ${this.packageId} from cart`),this.emitRemoveEvent(),this.addRemovalFeedback()):this.logger.debug(`Item ${this.packageId} not in cart, nothing to remove`)}emitRemoveEvent(){this.emit("cart:item-removed",{packageId:this.packageId})}handleCartUpdate(e){const t=e.items.find(e=>e.packageId===this.packageId)?.quantity||0,i=t>0;this.toggleClass("disabled",!i),this.element.toggleAttribute("disabled",!i),this.setAttribute("aria-disabled",String(!i)),this.toggleClass("has-item",i),this.toggleClass("empty",!i),this.element.setAttribute("data-quantity",String(t)),this.element.setAttribute("data-in-cart",String(i)),this.updateButtonContent(t)}updateButtonContent(e){const t=this.getAttribute("data-original-content")||this.element.innerHTML;this.hasAttribute("data-original-content")||this.setAttribute("data-original-content",this.element.innerHTML);const i=t.replace(/\{quantity\}/g,String(e));this.element.innerHTML!==i&&(this.element.innerHTML=i)}addRemovalFeedback(){this.addClass("item-removed");const e=this.element.closest("[data-cart-item-id], .cart-item");e instanceof HTMLElement&&(e.classList.add("removing"),setTimeout(()=>{e.classList.remove("removing")},300)),setTimeout(()=>{this.removeClass("item-removed")},300)}getCurrentQuantity(){return Q.getState().getItemQuantity(this.packageId)}isInCart(){return this.getCurrentQuantity()>0}setConfirmation(e,t){this.confirmRemoval=e,t&&(this.confirmMessage=t)}}},Symbol.toStringTag,{value:"Module"})),Pi=class e extends pt{constructor(e){super(e),this.quantity=1,this.actionButtons=[],this.isSelector=!1,this.options=new Map,this.quantityBySelectorId=new Map,this.loadingOverlay=new Ht}async initialize(){if(this.validateElement(),this.pageShowHandler=e=>{e.persisted&&(this.loadingOverlay.hide(!0),this.setProcessingState(!1))},window.addEventListener("pageshow",this.pageShowHandler),setTimeout(()=>{this.trackUpsellPageView()},100),this.selectorId=this.getAttribute("data-next-selector-id")||"",this.isSelector=!!this.selectorId,this.isSelector)this.initializeSelectorMode();else{const e=this.getAttribute("data-next-package-id");if(!e)throw new Error("UpsellEnhancer requires data-next-package-id attribute (or use selector mode with data-next-selector-id)");if(this.packageId=parseInt(e,10),isNaN(this.packageId))throw new Error("Invalid package ID provided");const t=se.getState();t.order&&t.markUpsellViewed(this.packageId.toString())}const e=this.getAttribute("data-next-quantity");e&&(this.quantity=parseInt(e,10)||1);const t=oe.getState();this.apiClient=new ce(t.apiKey),this.scanUpsellElements(),this.setupEventHandlers(),this.subscribe(se,this.handleOrderUpdate.bind(this)),this.updateUpsellDisplay(),this.logger.debug("UpsellEnhancer initialized",{mode:this.isSelector?"selector":"direct",packageId:this.packageId,selectorId:this.selectorId,quantity:this.quantity,actionButtons:this.actionButtons.length,options:this.options.size,currentPagePath:this.currentPagePath}),this.emit("upsell:initialized",{packageId:this.packageId||0,element:this.element})}trackUpsellPageView(){const t=document.querySelector('meta[name="next-page-type"]');if(t&&"upsell"===t.getAttribute("content")&&(this.currentPagePath=window.location.pathname,!e.pageViewTracked||e.currentPagePath!==this.currentPagePath)){e.pageViewTracked=!0,e.currentPagePath=this.currentPagePath;const t=se.getState();t.order&&(t.markUpsellPageViewed(this.currentPagePath),this.logger.debug("Tracked upsell page view:",this.currentPagePath),this.eventBus.emit("upsell:viewed",{pagePath:this.currentPagePath,orderId:t.order.ref_id}))}}initializeSelectorMode(){this.selectorId&&!this.quantityBySelectorId.has(this.selectorId)&&this.quantityBySelectorId.set(this.selectorId,this.quantity);this.element.querySelectorAll("[data-next-upsell-option]").forEach(e=>{if(e instanceof HTMLElement){const t=e.getAttribute("data-next-package-id");if(t){const i=parseInt(t,10);isNaN(i)||(this.options.set(i,e),e.addEventListener("click",()=>this.selectOption(i)),"true"===e.getAttribute("data-next-selected")&&this.selectOption(i))}}});let e=null;if(e="SELECT"===this.element.tagName?this.element:this.element.querySelector(`[data-next-upsell-select="${this.selectorId}"]`),e&&(e.addEventListener("change",()=>{const t=e.value;if(t){const e=parseInt(t,10);isNaN(e)||this.selectOption(e)}else delete this.selectedPackageId,delete this.packageId}),e.value)){const t=parseInt(e.value,10);isNaN(t)||this.selectOption(t)}}selectOption(e){this.options.forEach((t,i)=>{i===e?(t.classList.add("next-selected"),t.setAttribute("data-next-selected","true")):(t.classList.remove("next-selected"),t.setAttribute("data-next-selected","false"))}),this.selectedPackageId=e,this.packageId=e,this.eventBus.emit("upsell-selector:item-selected",{selectorId:this.selectorId||"",packageId:e}),this.element._selectedPackageId=e,this.logger.debug("Upsell option selected:",{packageId:e,selectorId:this.selectorId})}scanUpsellElements(){["[data-next-upsell-action]"].forEach(e=>{this.element.querySelectorAll(e).forEach(e=>{e instanceof HTMLElement&&(this.actionButtons.push(e),this.logger.debug("Found upsell action button:",e))})});const e=this.element.querySelector('[data-next-upsell-quantity="increase"]'),t=this.element.querySelector('[data-next-upsell-quantity="decrease"]'),i=e?.getAttribute("data-next-quantity-selector-id")||t?.getAttribute("data-next-quantity-selector-id")||this.selectorId;e&&e.addEventListener("click",()=>{if(i){const e=this.quantityBySelectorId.get(i)||1;this.quantityBySelectorId.set(i,Math.min(10,e+1)),this.currentQuantitySelectorId=i}else this.quantity=Math.min(10,this.quantity+1);this.updateQuantityDisplay()}),t&&t.addEventListener("click",()=>{if(i){const e=this.quantityBySelectorId.get(i)||1;this.quantityBySelectorId.set(i,Math.max(1,e-1)),this.currentQuantitySelectorId=i}else this.quantity=Math.max(1,this.quantity-1);this.updateQuantityDisplay()});this.element.querySelectorAll("[data-next-upsell-quantity-toggle]").forEach(e=>{if(e instanceof HTMLElement){const t=parseInt(e.getAttribute("data-next-upsell-quantity-toggle")||"1",10);e.addEventListener("click",()=>{this.quantity=t,this.updateQuantityDisplay(),this.updateQuantityToggles()}),t===this.quantity&&e.classList.add("next-selected")}})}updateQuantityDisplay(){const e=this.element.querySelector('[data-next-upsell-quantity="display"]');if(e){const t=e.getAttribute("data-next-quantity-selector-id")||this.currentQuantitySelectorId||this.selectorId;t&&this.quantityBySelectorId.has(t)?e.textContent=this.quantityBySelectorId.get(t).toString():e.textContent=this.quantity.toString()}}updateQuantityToggles(){this.element.querySelectorAll("[data-next-upsell-quantity-toggle]").forEach(e=>{if(e instanceof HTMLElement){parseInt(e.getAttribute("data-next-upsell-quantity-toggle")||"1",10)===this.quantity?e.classList.add("next-selected"):e.classList.remove("next-selected")}})}setupEventHandlers(){this.clickHandler=this.handleActionClick.bind(this),this.actionButtons.forEach(e=>{e.addEventListener("click",this.clickHandler)})}async handleActionClick(e){e.preventDefault();const t=e.currentTarget,i=t.getAttribute("data-next-upsell-action")||"";let n=t.getAttribute("data-next-url")||t.getAttribute("data-next-next-url")||t.getAttribute("data-os-next-url")||void 0;if(!n){if("add"===i||"accept"===i){const e=document.querySelector('meta[name="next-upsell-accept-url"]');n=e?.getAttribute("content")||void 0}else if("skip"===i||"decline"===i){const e=document.querySelector('meta[name="next-upsell-decline-url"]');n=e?.getAttribute("content")||void 0}n&&this.logger.debug("Using fallback URL from meta tag:",n)}switch(this.logger.debug("Upsell action clicked:",{action:i,nextUrl:n}),i){case"add":case"accept":await this.addUpsellToOrder(n);break;case"skip":case"decline":this.skipUpsell(n);break;default:this.logger.warn(`Unknown upsell action: ${i}`)}}async addUpsellToOrder(e){const t=se.getState();if(this.logger.debug("Order state check:",{hasOrder:!!t.order,supportsUpsells:t.order?.supports_post_purchase_upsells,isProcessingUpsell:t.isProcessingUpsell,canAddUpsells:t.canAddUpsells()}),!t.canAddUpsells()){if(this.logger.warn("Order does not support upsells or is currently processing"),!t.isProcessingUpsell||!t.order?.supports_post_purchase_upsells)return void this.showError("Unable to add upsell at this time");if(this.logger.warn("Processing flag stuck, resetting..."),t.setProcessingUpsell(!1),!t.canAddUpsells())return void this.showError("Unable to add upsell at this time");this.logger.info("Reset successful, continuing with upsell...")}const i=this.isSelector?this.selectedPackageId:this.packageId;if(i&&this.checkIfUpsellAlreadyAccepted(i)){if(!(await this.showDuplicateUpsellDialog()))return void(e&&this.navigateToUrl(e))}if(this.logger.debug("Package selection:",{isSelector:this.isSelector,packageId:this.packageId,selectedPackageId:this.selectedPackageId,packageToAdd:i}),!i)return this.logger.warn("No package selected for upsell"),void this.showError("Please select an option first");try{this.setProcessingState(!0),this.loadingOverlay.show(),this.emit("upsell:adding",{packageId:i});let n=this.quantity;this.selectorId&&this.quantityBySelectorId.has(this.selectorId)&&(n=this.quantityBySelectorId.get(this.selectorId));const a={lines:[{package_id:i,quantity:n}]};this.logger.info("Adding upsell to order:",a);const s=await t.addUpsell(a,this.apiClient);if(!s)throw new Error("Failed to add upsell - no updated order returned");{this.logger.info("Upsell added successfully"),this.showSuccess();let a=0;const r=t.order?.lines?.map(e=>e.id)||[],o=s.lines?.find(e=>e.is_upsell&&!r.includes(e.id));if(o?.price_incl_tax)a=parseFloat(o.price_incl_tax);else{const e=Y.getState().getPackage(i);e?.price&&(a=parseFloat(e.price)*this.quantity)}this.emit("upsell:added",{packageId:i,quantity:n,order:s,value:a}),e?this.navigateToUrl(e,s.ref_id):this.loadingOverlay.hide()}}catch(n){this.logger.error("Failed to add upsell:",n),this.showError(n instanceof Error?n.message:"Failed to add upsell"),this.emit("upsell:error",{packageId:this.packageId||0,error:n instanceof Error?n.message:"Unknown error"}),this.loadingOverlay.hide(!0)}finally{this.setProcessingState(!1)}}skipUpsell(e){if(this.logger.info("Upsell skipped by user"),this.addClass("next-skipped"),this.disableActions(),this.packageId){se.getState().markUpsellSkipped(this.packageId.toString(),this.currentPagePath)}const t=se.getState(),i={};void 0!==this.packageId&&(i.packageId=this.packageId),void 0!==t.order?.ref_id&&(i.orderId=t.order.ref_id),this.emit("upsell:skipped",i),e&&this.navigateToUrl(e)}navigateToUrl(e,t){if(e)try{const i=new URL(e,window.location.origin),n=se.getState(),a=t||n.order?.ref_id;a&&!i.searchParams.has("ref_id")&&i.searchParams.append("ref_id",a);const s=Nt(i.href,["debug","debugger","test"]);this.logger.info(`Navigating to ${s}`),window.location.href=s}catch(i){this.logger.error("Invalid URL for navigation:",e,i);const t=Nt(e);window.location.href=t}else this.logger.warn("No URL provided for navigation")}handleOrderUpdate(e){this.updateUpsellDisplay(),e.isProcessingUpsell?this.setProcessingState(!0):this.setProcessingState(!1),e.upsellError&&this.showError(e.upsellError)}updateUpsellDisplay(){se.getState().canAddUpsells()?this.showUpsellOffer():this.hideUpsellOffer()}setProcessingState(e){e?(this.addClass("next-processing"),this.disableActions()):(this.removeClass("next-processing"),this.enableActions())}disableActions(){this.actionButtons.forEach(e=>{e instanceof HTMLButtonElement&&(e.disabled=!0),e.classList.add("next-disabled")})}enableActions(){this.actionButtons.forEach(e=>{e instanceof HTMLButtonElement&&(e.disabled=!1),e.classList.remove("next-disabled")})}showUpsellOffer(){this.removeClass("next-hidden"),this.removeClass("next-error"),this.addClass("next-available")}hideUpsellOffer(){this.addClass("next-hidden"),this.removeClass("next-available")}showSuccess(){this.addClass("next-success"),setTimeout(()=>{this.removeClass("next-success")},3e3)}showError(e){this.addClass("next-error"),this.removeClass("next-processing"),this.logger.error("Upsell error:",e),setTimeout(()=>{this.removeClass("next-error")},5e3)}checkIfUpsellAlreadyAccepted(e){const t=se.getState();if(t.completedUpsells.includes(e.toString()))return!0;return t.upsellJourney.some(t=>t.packageId===e.toString()&&"accepted"===t.action)}async showDuplicateUpsellDialog(){const e=await Rt.showDuplicateUpsell();return this.logger.info(e?"User confirmed to add duplicate upsell":"User declined to add duplicate upsell"),e}update(){this.scanUpsellElements(),this.updateUpsellDisplay()}cleanupEventListeners(){this.clickHandler&&this.actionButtons.forEach(e=>{e.removeEventListener("click",this.clickHandler)})}destroy(){this.pageShowHandler&&window.removeEventListener("pageshow",this.pageShowHandler),this.actionButtons=[],super.destroy()}};Pi.pageViewTracked=!1,Pi.currentPagePath=null;let Ai=Pi;const Li=Object.freeze(Object.defineProperty({__proto__:null,UpsellEnhancer:Ai},Symbol.toStringTag,{value:"Module"}));const Ti=Object.freeze(Object.defineProperty({__proto__:null,CouponEnhancer:class extends Ut{constructor(){super(...arguments),this.input=null,this.button=null,this.display=null,this.template=null,this.unsubscribe=null}async initialize(){this.logger.debug("Enhancing coupon element:",this.element),this.input=this.element.querySelector('input[os-checkout-field="coupon"]')||this.element.querySelector('input[data-next-coupon="input"]')||this.element.querySelector('input[type="text"]')||this.element.querySelector("input"),this.button=this.element.querySelector("button")||this.element.querySelector('[data-next-coupon="apply"]'),this.display=this.element.querySelector('[data-next-coupon="display"]')||this.element.querySelector('[pb-checkout="coupon-display"]')||this.element.parentElement?.querySelector('[data-next-coupon="display"]')||document.querySelector('[data-next-coupon="display"]'),this.template=this.display?.querySelector('[pb-checkout="coupon-card"]')||null,this.input&&this.button?(this.setupInputListener(),this.setupButtonListener(),this.updateButtonState(),this.renderAppliedCoupons(),this.unsubscribe=Q.subscribe(e=>e.appliedCoupons,()=>this.renderAppliedCoupons()),this.logger.info("Coupon enhancer initialized successfully")):this.logger.warn("Required coupon elements not found",{input:!!this.input,button:!!this.button})}setupInputListener(){this.input&&(this.input.addEventListener("input",()=>{this.updateButtonState()}),this.input.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),this.applyCoupon())}))}setupButtonListener(){this.button&&this.button.addEventListener("click",e=>{e.preventDefault(),this.applyCoupon()})}updateButtonState(){if(!this.input||!this.button)return;this.input.value.trim().length>0?(this.button.classList.remove("next-disabled"),this.button.disabled=!1):(this.button.classList.add("next-disabled"),this.button.disabled=!0)}async applyCoupon(){if(!this.input||!this.button)return;const e=this.input.value.trim();e&&await this.executeAction(async()=>{this.logger.debug("Applying coupon:",e);const t=await Q.getState().applyCoupon(e);t.success?(this.input&&(this.input.value=""),this.updateButtonState(),this.showMessage(t.message,"success"),this.logger.info("Coupon applied successfully:",e),this.eventBus.emit("coupon:applied",{code:e})):(this.showMessage(t.message,"error"),this.logger.warn("Coupon application failed:",t.message),this.eventBus.emit("coupon:validation-failed",{code:e,message:t.message}))},{showLoading:!0,disableOnProcess:!0})}renderAppliedCoupons(){if(!this.display||!this.template)return void this.logger.debug("No display area or template found for coupons");const e=Q.getState().getCoupons();this.display.querySelectorAll('[pb-checkout="coupon-card"]:not([data-template])').forEach(e=>e.remove()),this.template.style.display="none",this.template.setAttribute("data-template","true"),e.forEach(e=>{const t=this.template.cloneNode(!0);t.removeAttribute("data-template"),t.style.display="";const i=t.querySelector('[pb-checkout="coupon-title"]');i&&(i.textContent=e.code);const n=t.querySelector('[pb-checkout="coupon-description"]');n&&e.definition.description&&(n.textContent=e.definition.description);const a=t.querySelector('[pb-checkout="coupon-discount"]');if(a){const t=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e.discount);a.textContent=`-${t}`}const s=t.querySelector('[pb-checkout="coupon-remove"]');s&&s.addEventListener("click",()=>{this.removeCoupon(e.code)}),this.display.appendChild(t)}),this.logger.debug("Rendered applied coupons:",e.length)}removeCoupon(e){this.logger.debug("Removing coupon:",e),Q.getState().removeCoupon(e),this.eventBus.emit("coupon:removed",{code:e}),this.showMessage(`Coupon ${e} removed`,"info")}showMessage(e,t){this.logger.debug(`Showing message [${t}]:`,e);const i=document.querySelector('[data-next-coupon="messages"]')||document.querySelector(".coupon-messages")||this.element?.querySelector(".messages");if(i){i.innerHTML="";const n=document.createElement("div");n.className=`coupon-message coupon-message--${t}`,n.textContent=e,i.appendChild(n),setTimeout(()=>{n.remove()},5e3)}}async update(){this.renderAppliedCoupons()}destroy(){this.logger.debug("Destroying coupon enhancer"),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),super.destroy(),this.input=null,this.button=null,this.display=null,this.template=null,this.logger.debug("Coupon enhancer destroyed")}}},Symbol.toStringTag,{value:"Module"})),Di=class extends pt{constructor(){super(...arguments),this.accordions=new Map}async initialize(){this.enhance()}enhance(){const e=this.element.getAttribute("data-next-accordion");if(!e)return void this.logger.warn("No accordion ID found on element");const t=this.parseConfig(this.element),i=new Fi(e,this.element,t);this.accordions.set(e,i),this.setupEventListeners(i),this.logger.debug(`Accordion enhanced: ${e}`)}update(e){}parseConfig(e){return{openText:e.getAttribute("data-open-text")||"Hide",closeText:e.getAttribute("data-close-text")||"Show",toggleClass:e.getAttribute("data-toggle-class")||"next-expanded",initialState:e.getAttribute("data-initial-state")||"closed",animationDuration:parseInt(e.getAttribute("data-animation-duration")||"300")}}setupEventListeners(e){e.triggers.forEach(t=>{t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.toggleAccordion(e)})}),e.triggers.forEach(t=>{t.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),this.toggleAccordion(e))}),t.hasAttribute("tabindex")||t.setAttribute("tabindex","0"),t.setAttribute("aria-expanded",e.isOpen.toString()),t.setAttribute("aria-controls",e.id)}),e.panels.forEach(t=>{t.setAttribute("aria-labelledby",e.id),t.setAttribute("id",`${e.id}-content`)})}toggleAccordion(e){const t=e.isOpen;t?this.closeAccordion(e):this.openAccordion(e),this.eventBus.emit("accordion:toggled",{id:e.id,isOpen:!t,element:e.element})}openAccordion(e){e.isOpen=!0,e.panels.forEach(t=>{const i=t.style.height;t.style.height="auto";const n=t.offsetHeight;t.style.height=i,t.offsetHeight,t.style.height=n+"px",setTimeout(()=>{t.classList.add(e.config.toggleClass),setTimeout(()=>{e.isOpen&&(t.style.height="auto")},e.config.animationDuration||300)},10)}),e.element.classList.add(e.config.toggleClass),e.textElements.forEach(t=>{e.config.openText&&(t.textContent=e.config.openText)}),e.triggers.forEach(e=>{e.setAttribute("aria-expanded","true")}),this.logger.debug(`Accordion opened: ${e.id}`),this.eventBus.emit("accordion:opened",{id:e.id,element:e.element})}closeAccordion(e){e.isOpen=!1,e.panels.forEach(t=>{const i=t.offsetHeight;t.style.height=i+"px",t.offsetHeight,t.style.height="0px",setTimeout(()=>{t.classList.remove(e.config.toggleClass)},e.config.animationDuration||300)}),e.element.classList.remove(e.config.toggleClass),e.textElements.forEach(t=>{e.config.closeText&&(t.textContent=e.config.closeText)}),e.triggers.forEach(e=>{e.setAttribute("aria-expanded","false")}),this.logger.debug(`Accordion closed: ${e.id}`),this.eventBus.emit("accordion:closed",{id:e.id,element:e.element})}openAccordionById(e){const t=this.accordions.get(e);t&&!t.isOpen&&this.openAccordion(t)}closeAccordionById(e){const t=this.accordions.get(e);t&&t.isOpen&&this.closeAccordion(t)}toggleAccordionById(e){const t=this.accordions.get(e);t&&this.toggleAccordion(t)}getAccordionState(e){const t=this.accordions.get(e);return t?t.isOpen:null}getAllAccordions(){return Array.from(this.accordions.keys())}destroy(){this.accordions.clear(),super.destroy()}};Di.selector="[data-next-accordion]";let Mi=Di;class Fi{constructor(e,t,i){this.id=e,this.element=t,this.config=i,this.triggers=[],this.panels=[],this.textElements=[],this.findComponents(),this.isOpen=this.detectInitialState(),this.initializeState()}detectInitialState(){const e=this.config.toggleClass,t=this.panels.some(t=>t.classList.contains(e)),i=this.element.classList.contains(e);return!(!t&&!i)||"open"===this.config.initialState}findComponents(){const e=this.element.querySelectorAll(`[data-next-accordion-trigger="${this.id}"]`);this.triggers=Array.from(e);const t=this.element.querySelectorAll(`[data-next-accordion-panel="${this.id}"]`);this.panels=Array.from(t);const i=this.element.querySelectorAll(`[data-next-accordion-text="${this.id}"]`);this.textElements=Array.from(i),this.triggers.length,this.panels.length}initializeState(){const e=this.config.toggleClass;this.isOpen?(this.element.classList.add(e),this.panels.forEach(t=>{t.classList.add(e),t.style.height="auto"}),this.textElements.forEach(e=>{this.config.openText&&(e.textContent=this.config.openText)})):(this.element.classList.remove(e),this.panels.forEach(t=>{t.classList.remove(e),t.style.height="0px"}),this.textElements.forEach(e=>{this.config.closeText&&(e.textContent=this.config.closeText)}))}}const $i=Object.freeze(Object.defineProperty({__proto__:null,AccordionEnhancer:Mi},Symbol.toStringTag,{value:"Module"})),qi=Math.min,Oi=Math.max,Ui=Math.round,Ni=e=>({x:e,y:e}),zi={left:"right",right:"left",bottom:"top",top:"bottom"},Ri={start:"end",end:"start"};function Hi(e,t,i){return Oi(e,qi(t,i))}function ji(e,t){return"function"==typeof e?e(t):e}function Vi(e){return e.split("-")[0]}function Bi(e){return e.split("-")[1]}function Ki(e){return"x"===e?"y":"x"}function Wi(e){return"y"===e?"height":"width"}const Qi=new Set(["top","bottom"]);function Ji(e){return Qi.has(Vi(e))?"y":"x"}function Gi(e){return Ki(Ji(e))}function Zi(e){return e.replace(/start|end/g,e=>Ri[e])}const Yi=["left","right"],Xi=["right","left"],en=["top","bottom"],tn=["bottom","top"];function nn(e,t,i,n){const a=Bi(e);let s=function(e,t,i){switch(e){case"top":case"bottom":return i?t?Xi:Yi:t?Yi:Xi;case"left":case"right":return t?en:tn;default:return[]}}(Vi(e),"start"===i,n);return a&&(s=s.map(e=>e+"-"+a),t&&(s=s.concat(s.map(Zi)))),s}function an(e){return e.replace(/left|right|bottom|top/g,e=>zi[e])}function sn(e){return"number"!=typeof e?function(e){return{top:0,right:0,bottom:0,left:0,...e}}(e):{top:e,right:e,bottom:e,left:e}}function rn(e){const{x:t,y:i,width:n,height:a}=e;return{width:n,height:a,top:i,left:t,right:t+n,bottom:i+a,x:t,y:i}}function on(e,t,i){let{reference:n,floating:a}=e;const s=Ji(t),r=Gi(t),o=Wi(r),l=Vi(t),c="y"===s,d=n.x+n.width/2-a.width/2,u=n.y+n.height/2-a.height/2,p=n[o]/2-a[o]/2;let h;switch(l){case"top":h={x:d,y:n.y-a.height};break;case"bottom":h={x:d,y:n.y+n.height};break;case"right":h={x:n.x+n.width,y:u};break;case"left":h={x:n.x-a.width,y:u};break;default:h={x:n.x,y:n.y}}switch(Bi(t)){case"start":h[r]-=p*(i&&c?-1:1);break;case"end":h[r]+=p*(i&&c?-1:1)}return h}async function ln(e,t){var i;void 0===t&&(t={});const{x:n,y:a,platform:s,rects:r,elements:o,strategy:l}=e,{boundary:c="clippingAncestors",rootBoundary:d="viewport",elementContext:u="floating",altBoundary:p=!1,padding:h=0}=ji(t,e),g=sn(h),m=o[p?"floating"===u?"reference":"floating":u],f=rn(await s.getClippingRect({element:null==(i=await(null==s.isElement?void 0:s.isElement(m)))||i?m:m.contextElement||await(null==s.getDocumentElement?void 0:s.getDocumentElement(o.floating)),boundary:c,rootBoundary:d,strategy:l})),y="floating"===u?{x:n,y:a,width:r.floating.width,height:r.floating.height}:r.reference,v=await(null==s.getOffsetParent?void 0:s.getOffsetParent(o.floating)),b=await(null==s.isElement?void 0:s.isElement(v))&&await(null==s.getScale?void 0:s.getScale(v))||{x:1,y:1},x=rn(s.convertOffsetParentRelativeRectToViewportRelativeRect?await s.convertOffsetParentRelativeRectToViewportRelativeRect({elements:o,rect:y,offsetParent:v,strategy:l}):y);return{top:(f.top-x.top+g.top)/b.y,bottom:(x.bottom-f.bottom+g.bottom)/b.y,left:(f.left-x.left+g.left)/b.x,right:(x.right-f.right+g.right)/b.x}}const cn=new Set(["left","top"]);function dn(){return"undefined"!=typeof window}function un(e){return gn(e)?(e.nodeName||"").toLowerCase():"#document"}function pn(e){var t;return(null==e||null==(t=e.ownerDocument)?void 0:t.defaultView)||window}function hn(e){var t;return null==(t=(gn(e)?e.ownerDocument:e.document)||window.document)?void 0:t.documentElement}function gn(e){return!!dn()&&(e instanceof Node||e instanceof pn(e).Node)}function mn(e){return!!dn()&&(e instanceof Element||e instanceof pn(e).Element)}function fn(e){return!!dn()&&(e instanceof HTMLElement||e instanceof pn(e).HTMLElement)}function yn(e){return!(!dn()||"undefined"==typeof ShadowRoot)&&(e instanceof ShadowRoot||e instanceof pn(e).ShadowRoot)}const vn=new Set(["inline","contents"]);function bn(e){const{overflow:t,overflowX:i,overflowY:n,display:a}=Tn(e);return/auto|scroll|overlay|hidden|clip/.test(t+n+i)&&!vn.has(a)}const xn=new Set(["table","td","th"]);function wn(e){return xn.has(un(e))}const Sn=[":popover-open",":modal"];function _n(e){return Sn.some(t=>{try{return e.matches(t)}catch(i){return!1}})}const kn=["transform","translate","scale","rotate","perspective"],Cn=["transform","translate","scale","rotate","perspective","filter"],En=["paint","layout","strict","content"];function In(e){const t=Pn(),i=mn(e)?Tn(e):e;return kn.some(e=>!!i[e]&&"none"!==i[e])||!!i.containerType&&"normal"!==i.containerType||!t&&!!i.backdropFilter&&"none"!==i.backdropFilter||!t&&!!i.filter&&"none"!==i.filter||Cn.some(e=>(i.willChange||"").includes(e))||En.some(e=>(i.contain||"").includes(e))}function Pn(){return!("undefined"==typeof CSS||!CSS.supports)&&CSS.supports("-webkit-backdrop-filter","none")}const An=new Set(["html","body","#document"]);function Ln(e){return An.has(un(e))}function Tn(e){return pn(e).getComputedStyle(e)}function Dn(e){return mn(e)?{scrollLeft:e.scrollLeft,scrollTop:e.scrollTop}:{scrollLeft:e.scrollX,scrollTop:e.scrollY}}function Mn(e){if("html"===un(e))return e;const t=e.assignedSlot||e.parentNode||yn(e)&&e.host||hn(e);return yn(t)?t.host:t}function Fn(e){const t=Mn(e);return Ln(t)?e.ownerDocument?e.ownerDocument.body:e.body:fn(t)&&bn(t)?t:Fn(t)}function $n(e,t,i){var n;void 0===t&&(t=[]);const a=Fn(e),s=a===(null==(n=e.ownerDocument)?void 0:n.body),r=pn(a);return s?(qn(r),t.concat(r,r.visualViewport||[],bn(a)?a:[],[])):t.concat(a,$n(a,[]))}function qn(e){return e.parent&&Object.getPrototypeOf(e.parent)?e.frameElement:null}function On(e){const t=Tn(e);let i=parseFloat(t.width)||0,n=parseFloat(t.height)||0;const a=fn(e),s=a?e.offsetWidth:i,r=a?e.offsetHeight:n,o=Ui(i)!==s||Ui(n)!==r;return o&&(i=s,n=r),{width:i,height:n,$:o}}function Un(e){return mn(e)?e:e.contextElement}function Nn(e){const t=Un(e);if(!fn(t))return Ni(1);const i=t.getBoundingClientRect(),{width:n,height:a,$:s}=On(t);let r=(s?Ui(i.width):i.width)/n,o=(s?Ui(i.height):i.height)/a;return r&&Number.isFinite(r)||(r=1),o&&Number.isFinite(o)||(o=1),{x:r,y:o}}const zn=Ni(0);function Rn(e){const t=pn(e);return Pn()&&t.visualViewport?{x:t.visualViewport.offsetLeft,y:t.visualViewport.offsetTop}:zn}function Hn(e,t,i,n){void 0===t&&(t=!1),void 0===i&&(i=!1);const a=e.getBoundingClientRect(),s=Un(e);let r=Ni(1);t&&(n?mn(n)&&(r=Nn(n)):r=Nn(e));const o=function(e,t,i){return void 0===t&&(t=!1),!(!i||t&&i!==pn(e))&&t}(s,i,n)?Rn(s):Ni(0);let l=(a.left+o.x)/r.x,c=(a.top+o.y)/r.y,d=a.width/r.x,u=a.height/r.y;if(s){const e=pn(s),t=n&&mn(n)?pn(n):n;let i=e,a=qn(i);for(;a&&n&&t!==i;){const e=Nn(a),t=a.getBoundingClientRect(),n=Tn(a),s=t.left+(a.clientLeft+parseFloat(n.paddingLeft))*e.x,r=t.top+(a.clientTop+parseFloat(n.paddingTop))*e.y;l*=e.x,c*=e.y,d*=e.x,u*=e.y,l+=s,c+=r,i=pn(a),a=qn(i)}}return rn({width:d,height:u,x:l,y:c})}function jn(e,t){const i=Dn(e).scrollLeft;return t?t.left+i:Hn(hn(e)).left+i}function Vn(e,t,i){void 0===i&&(i=!1);const n=e.getBoundingClientRect();return{x:n.left+t.scrollLeft-(i?0:jn(e,n)),y:n.top+t.scrollTop}}const Bn=new Set(["absolute","fixed"]);function Kn(e,t,i){let n;if("viewport"===t)n=function(e,t){const i=pn(e),n=hn(e),a=i.visualViewport;let s=n.clientWidth,r=n.clientHeight,o=0,l=0;if(a){s=a.width,r=a.height;const e=Pn();(!e||e&&"fixed"===t)&&(o=a.offsetLeft,l=a.offsetTop)}return{width:s,height:r,x:o,y:l}}(e,i);else if("document"===t)n=function(e){const t=hn(e),i=Dn(e),n=e.ownerDocument.body,a=Oi(t.scrollWidth,t.clientWidth,n.scrollWidth,n.clientWidth),s=Oi(t.scrollHeight,t.clientHeight,n.scrollHeight,n.clientHeight);let r=-i.scrollLeft+jn(e);const o=-i.scrollTop;return"rtl"===Tn(n).direction&&(r+=Oi(t.clientWidth,n.clientWidth)-a),{width:a,height:s,x:r,y:o}}(hn(e));else if(mn(t))n=function(e,t){const i=Hn(e,!0,"fixed"===t),n=i.top+e.clientTop,a=i.left+e.clientLeft,s=fn(e)?Nn(e):Ni(1);return{width:e.clientWidth*s.x,height:e.clientHeight*s.y,x:a*s.x,y:n*s.y}}(t,i);else{const i=Rn(e);n={x:t.x-i.x,y:t.y-i.y,width:t.width,height:t.height}}return rn(n)}function Wn(e,t){const i=Mn(e);return!(i===t||!mn(i)||Ln(i))&&("fixed"===Tn(i).position||Wn(i,t))}function Qn(e,t,i){const n=fn(t),a=hn(t),s="fixed"===i,r=Hn(e,!0,s,t);let o={scrollLeft:0,scrollTop:0};const l=Ni(0);function c(){l.x=jn(a)}if(n||!n&&!s)if(("body"!==un(t)||bn(a))&&(o=Dn(t)),n){const e=Hn(t,!0,s,t);l.x=e.x+t.clientLeft,l.y=e.y+t.clientTop}else a&&c();s&&!n&&a&&c();const d=!a||n||s?Ni(0):Vn(a,o);return{x:r.left+o.scrollLeft-l.x-d.x,y:r.top+o.scrollTop-l.y-d.y,width:r.width,height:r.height}}function Jn(e){return"static"===Tn(e).position}function Gn(e,t){if(!fn(e)||"fixed"===Tn(e).position)return null;if(t)return t(e);let i=e.offsetParent;return hn(e)===i&&(i=i.ownerDocument.body),i}function Zn(e,t){const i=pn(e);if(_n(e))return i;if(!fn(e)){let t=Mn(e);for(;t&&!Ln(t);){if(mn(t)&&!Jn(t))return t;t=Mn(t)}return i}let n=Gn(e,t);for(;n&&wn(n)&&Jn(n);)n=Gn(n,t);return n&&Ln(n)&&Jn(n)&&!In(n)?i:n||function(e){let t=Mn(e);for(;fn(t)&&!Ln(t);){if(In(t))return t;if(_n(t))return null;t=Mn(t)}return null}(e)||i}const Yn={convertOffsetParentRelativeRectToViewportRelativeRect:function(e){let{elements:t,rect:i,offsetParent:n,strategy:a}=e;const s="fixed"===a,r=hn(n),o=!!t&&_n(t.floating);if(n===r||o&&s)return i;let l={scrollLeft:0,scrollTop:0},c=Ni(1);const d=Ni(0),u=fn(n);if((u||!u&&!s)&&(("body"!==un(n)||bn(r))&&(l=Dn(n)),fn(n))){const e=Hn(n);c=Nn(n),d.x=e.x+n.clientLeft,d.y=e.y+n.clientTop}const p=!r||u||s?Ni(0):Vn(r,l,!0);return{width:i.width*c.x,height:i.height*c.y,x:i.x*c.x-l.scrollLeft*c.x+d.x+p.x,y:i.y*c.y-l.scrollTop*c.y+d.y+p.y}},getDocumentElement:hn,getClippingRect:function(e){let{element:t,boundary:i,rootBoundary:n,strategy:a}=e;const s=[..."clippingAncestors"===i?_n(t)?[]:function(e,t){const i=t.get(e);if(i)return i;let n=$n(e,[]).filter(e=>mn(e)&&"body"!==un(e)),a=null;const s="fixed"===Tn(e).position;let r=s?Mn(e):e;for(;mn(r)&&!Ln(r);){const t=Tn(r),i=In(r);i||"fixed"!==t.position||(a=null),(s?!i&&!a:!i&&"static"===t.position&&a&&Bn.has(a.position)||bn(r)&&!i&&Wn(e,r))?n=n.filter(e=>e!==r):a=t,r=Mn(r)}return t.set(e,n),n}(t,this._c):[].concat(i),n],r=s[0],o=s.reduce((e,i)=>{const n=Kn(t,i,a);return e.top=Oi(n.top,e.top),e.right=qi(n.right,e.right),e.bottom=qi(n.bottom,e.bottom),e.left=Oi(n.left,e.left),e},Kn(t,r,a));return{width:o.right-o.left,height:o.bottom-o.top,x:o.left,y:o.top}},getOffsetParent:Zn,getElementRects:async function(e){const t=this.getOffsetParent||Zn,i=this.getDimensions,n=await i(e.floating);return{reference:Qn(e.reference,await t(e.floating),e.strategy),floating:{x:0,y:0,width:n.width,height:n.height}}},getClientRects:function(e){return Array.from(e.getClientRects())},getDimensions:function(e){const{width:t,height:i}=On(e);return{width:t,height:i}},getScale:Nn,isElement:mn,isRTL:function(e){return"rtl"===Tn(e).direction}},Xn=function(e){return void 0===e&&(e=0),{name:"offset",options:e,async fn(t){var i,n;const{x:a,y:s,placement:r,middlewareData:o}=t,l=await async function(e,t){const{placement:i,platform:n,elements:a}=e,s=await(null==n.isRTL?void 0:n.isRTL(a.floating)),r=Vi(i),o=Bi(i),l="y"===Ji(i),c=cn.has(r)?-1:1,d=s&&l?-1:1,u=ji(t,e);let{mainAxis:p,crossAxis:h,alignmentAxis:g}="number"==typeof u?{mainAxis:u,crossAxis:0,alignmentAxis:null}:{mainAxis:u.mainAxis||0,crossAxis:u.crossAxis||0,alignmentAxis:u.alignmentAxis};return o&&"number"==typeof g&&(h="end"===o?-1*g:g),l?{x:h*d,y:p*c}:{x:p*c,y:h*d}}(t,e);return r===(null==(i=o.offset)?void 0:i.placement)&&null!=(n=o.arrow)&&n.alignmentOffset?{}:{x:a+l.x,y:s+l.y,data:{...l,placement:r}}}}},ea=function(e){return void 0===e&&(e={}),{name:"shift",options:e,async fn(t){const{x:i,y:n,placement:a}=t,{mainAxis:s=!0,crossAxis:r=!1,limiter:o={fn:e=>{let{x:t,y:i}=e;return{x:t,y:i}}},...l}=ji(e,t),c={x:i,y:n},d=await ln(t,l),u=Ji(Vi(a)),p=Ki(u);let h=c[p],g=c[u];if(s){const e="y"===p?"bottom":"right";h=Hi(h+d["y"===p?"top":"left"],h,h-d[e])}if(r){const e="y"===u?"bottom":"right";g=Hi(g+d["y"===u?"top":"left"],g,g-d[e])}const m=o.fn({...t,[p]:h,[u]:g});return{...m,data:{x:m.x-i,y:m.y-n,enabled:{[p]:s,[u]:r}}}}}},ta=function(e){return void 0===e&&(e={}),{name:"flip",options:e,async fn(t){var i,n;const{placement:a,middlewareData:s,rects:r,initialPlacement:o,platform:l,elements:c}=t,{mainAxis:d=!0,crossAxis:u=!0,fallbackPlacements:p,fallbackStrategy:h="bestFit",fallbackAxisSideDirection:g="none",flipAlignment:m=!0,...f}=ji(e,t);if(null!=(i=s.arrow)&&i.alignmentOffset)return{};const y=Vi(a),v=Ji(o),b=Vi(o)===o,x=await(null==l.isRTL?void 0:l.isRTL(c.floating)),w=p||(b||!m?[an(o)]:function(e){const t=an(e);return[Zi(e),t,Zi(t)]}(o)),S="none"!==g;!p&&S&&w.push(...nn(o,m,g,x));const _=[o,...w],k=await ln(t,f),C=[];let E=(null==(n=s.flip)?void 0:n.overflows)||[];if(d&&C.push(k[y]),u){const e=function(e,t,i){void 0===i&&(i=!1);const n=Bi(e),a=Gi(e),s=Wi(a);let r="x"===a?n===(i?"end":"start")?"right":"left":"start"===n?"bottom":"top";return t.reference[s]>t.floating[s]&&(r=an(r)),[r,an(r)]}(a,r,x);C.push(k[e[0]],k[e[1]])}if(E=[...E,{placement:a,overflows:C}],!C.every(e=>e<=0)){var I,P;const e=((null==(I=s.flip)?void 0:I.index)||0)+1,t=_[e];if(t){if(!("alignment"===u&&v!==Ji(t))||E.every(e=>Ji(e.placement)!==v||e.overflows[0]>0))return{data:{index:e,overflows:E},reset:{placement:t}}}let i=null==(P=E.filter(e=>e.overflows[0]<=0).sort((e,t)=>e.overflows[1]-t.overflows[1])[0])?void 0:P.placement;if(!i)switch(h){case"bestFit":{var A;const e=null==(A=E.filter(e=>{if(S){const t=Ji(e.placement);return t===v||"y"===t}return!0}).map(e=>[e.placement,e.overflows.filter(e=>e>0).reduce((e,t)=>e+t,0)]).sort((e,t)=>e[1]-t[1])[0])?void 0:A[0];e&&(i=e);break}case"initialPlacement":i=o}if(a!==i)return{reset:{placement:i}}}return{}}}},ia=e=>({name:"arrow",options:e,async fn(t){const{x:i,y:n,placement:a,rects:s,platform:r,elements:o,middlewareData:l}=t,{element:c,padding:d=0}=ji(e,t)||{};if(null==c)return{};const u=sn(d),p={x:i,y:n},h=Gi(a),g=Wi(h),m=await r.getDimensions(c),f="y"===h,y=f?"top":"left",v=f?"bottom":"right",b=f?"clientHeight":"clientWidth",x=s.reference[g]+s.reference[h]-p[h]-s.floating[g],w=p[h]-s.reference[h],S=await(null==r.getOffsetParent?void 0:r.getOffsetParent(c));let _=S?S[b]:0;_&&await(null==r.isElement?void 0:r.isElement(S))||(_=o.floating[b]||s.floating[g]);const k=x/2-w/2,C=_/2-m[g]/2-1,E=qi(u[y],C),I=qi(u[v],C),P=E,A=_-m[g]-I,L=_/2-m[g]/2+k,T=Hi(P,L,A),D=!l.arrow&&null!=Bi(a)&&L!==T&&s.reference[g]/2-(L<P?E:I)-m[g]/2<0,M=D?L<P?L-P:L-A:0;return{[h]:p[h]+M,data:{[h]:T,centerOffset:L-T-M,...D&&{alignmentOffset:M}},reset:D}}}),na=(e,t,i)=>{const n=new Map,a={platform:Yn,...i},s={...a.platform,_c:n};return(async(e,t,i)=>{const{placement:n="bottom",strategy:a="absolute",middleware:s=[],platform:r}=i,o=s.filter(Boolean),l=await(null==r.isRTL?void 0:r.isRTL(t));let c=await r.getElementRects({reference:e,floating:t,strategy:a}),{x:d,y:u}=on(c,n,l),p=n,h={},g=0;for(let m=0;m<o.length;m++){const{name:i,fn:s}=o[m],{x:f,y:y,data:v,reset:b}=await s({x:d,y:u,initialPlacement:n,placement:p,strategy:a,middlewareData:h,rects:c,platform:r,elements:{reference:e,floating:t}});d=null!=f?f:d,u=null!=y?y:u,h={...h,[i]:{...h[i],...v}},b&&g<=50&&(g++,"object"==typeof b&&(b.placement&&(p=b.placement),b.rects&&(c=!0===b.rects?await r.getElementRects({reference:e,floating:t,strategy:a}):b.rects),({x:d,y:u}=on(c,p,l))),m=-1)}return{x:d,y:u,placement:p,strategy:a,middlewareData:h}})(e,t,{...a,platform:s})},aa=class e extends pt{constructor(e){super(e),this.tooltip=null,this.arrow=null,this.showTimeout=null,this.hideTimeout=null,this.isVisible=!1,this.handleMouseEnter=()=>{this.scheduleShow()},this.handleMouseLeave=()=>{this.scheduleHide()},this.handleFocus=()=>{this.scheduleShow()},this.handleBlur=()=>{this.scheduleHide()},this.handleTouchStart=()=>{this.isVisible?this.hide():this.show()},this.handleKeydown=e=>{"Escape"===e.key&&this.isVisible&&this.hide()},this.config=this.parseConfig(),this.injectStyles()}async initialize(){try{this.validateElement(),this.setupEventListeners(),this.logger.debug("Tooltip enhancer initialized")}catch(e){this.handleError(e,"initialize")}}update(){this.config=this.parseConfig(),this.isVisible&&this.tooltip&&this.updateTooltipContent()}destroy(){this.hide(),this.cleanupTimeouts(),super.destroy()}parseConfig(){return{placement:this.getAttribute("data-next-tooltip-placement")||"top",offset:parseInt(this.getAttribute("data-next-tooltip-offset")||"8"),delay:parseInt(this.getAttribute("data-next-tooltip-delay")||"500"),maxWidth:this.getAttribute("data-next-tooltip-max-width")||"200px",className:this.getAttribute("data-next-tooltip-class")||""}}injectStyles(){if(e.stylesInjected)return;const t="next-tooltip-styles";if(document.getElementById(t))return;const i=document.createElement("style");i.id=t,i.textContent='\n      .next-tooltip {\n        position: fixed;\n        top: 0;\n        left: 0;\n        z-index: 99999;\n        opacity: 0;\n        visibility: hidden;\n        transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;\n        transform: scale(0.95);\n        pointer-events: none;\n      }\n\n      .next-tooltip--visible {\n        opacity: 1;\n        visibility: visible;\n        transform: scale(1);\n        pointer-events: auto;\n      }\n\n      .next-tooltip__content {\n        background: #333;\n        color: #fff;\n        padding: 8px 12px;\n        border-radius: 6px;\n        font-size: 13px;\n        line-height: 1.4;\n        font-weight: 400;\n        text-align: center;\n        word-wrap: break-word;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        white-space: nowrap;\n        max-width: 200px;\n        white-space: normal;\n        -webkit-font-smoothing: antialiased;\n        -moz-osx-font-smoothing: grayscale;\n      }\n\n      .next-tooltip__arrow {\n        position: absolute;\n        width: 8px;\n        height: 8px;\n        background: #333;\n        transform: rotate(45deg);\n      }\n\n      .next-tooltip[data-placement^="top"] .next-tooltip__arrow {\n        border-top: none;\n        border-left: none;\n      }\n\n      .next-tooltip[data-placement^="bottom"] .next-tooltip__arrow {\n        border-bottom: none;\n        border-right: none;\n      }\n\n      .next-tooltip[data-placement^="left"] .next-tooltip__arrow {\n        border-left: none;\n        border-bottom: none;\n      }\n\n      .next-tooltip[data-placement^="right"] .next-tooltip__arrow {\n        border-right: none;\n        border-top: none;\n      }\n\n      .next-tooltip--light .next-tooltip__content {\n        background: #fff;\n        color: #333;\n        border: 1px solid #ddd;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      }\n\n      .next-tooltip--light .next-tooltip__arrow {\n        background: #fff;\n        border: 1px solid #ddd;\n      }\n\n      .next-tooltip--error .next-tooltip__content {\n        background: #dc3545;\n        color: #fff;\n      }\n\n      .next-tooltip--error .next-tooltip__arrow {\n        background: #dc3545;\n      }\n\n      .next-tooltip--success .next-tooltip__content {\n        background: #28a745;\n        color: #fff;\n      }\n\n      .next-tooltip--success .next-tooltip__arrow {\n        background: #28a745;\n      }\n\n      .next-tooltip--warning .next-tooltip__content {\n        background: #ffc107;\n        color: #333;\n      }\n\n      .next-tooltip--warning .next-tooltip__arrow {\n        background: #ffc107;\n      }\n\n      .next-tooltip--large .next-tooltip__content {\n        padding: 12px 16px;\n        font-size: 14px;\n        max-width: 300px;\n      }\n\n      .next-tooltip--small .next-tooltip__content {\n        padding: 4px 8px;\n        font-size: 12px;\n        max-width: 150px;\n      }\n\n      @media (hover: none) {\n        .next-tooltip {\n          transition-duration: 0.15s;\n        }\n      }\n\n      @media (prefers-contrast: high) {\n        .next-tooltip__content {\n          border: 2px solid currentColor;\n        }\n      }\n\n      @media (prefers-reduced-motion: reduce) {\n        .next-tooltip {\n          transition: opacity 0.1s ease, visibility 0.1s ease;\n          transform: none;\n        }\n        \n        .next-tooltip--visible {\n          transform: none;\n        }\n      }\n    ',document.head.appendChild(i),e.stylesInjected=!0,this.logger.debug("Tooltip styles injected into document head")}setupEventListeners(){this.element.addEventListener("mouseenter",this.handleMouseEnter),this.element.addEventListener("mouseleave",this.handleMouseLeave),this.element.addEventListener("focus",this.handleFocus),this.element.addEventListener("blur",this.handleBlur),this.element.addEventListener("touchstart",this.handleTouchStart),document.addEventListener("keydown",this.handleKeydown)}cleanupEventListeners(){this.element.removeEventListener("mouseenter",this.handleMouseEnter),this.element.removeEventListener("mouseleave",this.handleMouseLeave),this.element.removeEventListener("focus",this.handleFocus),this.element.removeEventListener("blur",this.handleBlur),this.element.removeEventListener("touchstart",this.handleTouchStart),document.removeEventListener("keydown",this.handleKeydown)}scheduleShow(){this.cleanupTimeouts(),this.showTimeout=window.setTimeout(()=>{this.show()},this.config.delay)}scheduleHide(){this.cleanupTimeouts(),this.hideTimeout=window.setTimeout(()=>{this.hide()},150)}cleanupTimeouts(){this.showTimeout&&(clearTimeout(this.showTimeout),this.showTimeout=null),this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null)}async show(){if(this.isVisible)return;const e=this.getTooltipContent();if(e)try{if(this.createTooltip(e),!this.tooltip)return;this.isVisible=!0,document.body.appendChild(this.tooltip);const t=this.element.getBoundingClientRect();this.logger.debug("Element position",{top:t.top,left:t.left,width:t.width,height:t.height,scrollY:window.scrollY,scrollX:window.scrollX}),await new Promise(e=>requestAnimationFrame(e)),await this.positionTooltip(),requestAnimationFrame(()=>{this.tooltip&&this.tooltip.classList.add("next-tooltip--visible")}),this.element.setAttribute("aria-describedby",this.tooltip.id),this.logger.debug("Tooltip shown")}catch(t){this.handleError(t,"show tooltip")}}hide(){this.isVisible&&this.tooltip&&(this.isVisible=!1,this.tooltip.classList.remove("next-tooltip--visible"),setTimeout(()=>{this.tooltip&&this.tooltip.parentNode&&this.tooltip.parentNode.removeChild(this.tooltip),this.tooltip=null,this.arrow=null},200),this.element.removeAttribute("aria-describedby"),this.logger.debug("Tooltip hidden"))}getTooltipContent(){return this.getAttribute("data-next-tooltip")||""}updateTooltipContent(){if(!this.tooltip)return;const e=this.getTooltipContent(),t=this.tooltip.querySelector(".next-tooltip__content");t&&(t.textContent=e)}createTooltip(e){this.tooltip=document.createElement("div"),this.tooltip.className=`next-tooltip ${this.config.className||""}`.trim(),this.tooltip.id=`tooltip-${Math.random().toString(36).substr(2,9)}`,this.tooltip.role="tooltip",this.tooltip.style.maxWidth=this.config.maxWidth||"200px";const t=document.createElement("div");t.className="next-tooltip__content",t.textContent=e,this.arrow=document.createElement("div"),this.arrow.className="next-tooltip__arrow",this.tooltip.appendChild(t),this.tooltip.appendChild(this.arrow),this.tooltip.addEventListener("mouseenter",()=>{this.cleanupTimeouts()}),this.tooltip.addEventListener("mouseleave",()=>{this.scheduleHide()})}async positionTooltip(){if(this.tooltip&&this.arrow)try{const{x:e,y:t,placement:i,middlewareData:n}=await na(this.element,this.tooltip,{placement:this.config.placement||"top",middleware:[Xn(this.config.offset||8),ta(),ea({padding:5}),ia({element:this.arrow})],strategy:"fixed"});if(Object.assign(this.tooltip.style,{left:`${e}px`,top:`${t}px`}),n.arrow){const{x:e,y:t}=n.arrow,a={top:"bottom",right:"left",bottom:"top",left:"right"}[i.split("-")[0]];Object.assign(this.arrow.style,{left:null!=e?`${e}px`:"",top:null!=t?`${t}px`:"",right:"",bottom:"",[a]:"-4px"})}this.tooltip.setAttribute("data-placement",i),this.logger.debug("Tooltip positioned",{x:e,y:t,placement:i})}catch(e){this.handleError(e,"position tooltip")}}};aa.stylesInjected=!1;let sa=aa;const ra=Object.freeze(Object.defineProperty({__proto__:null,TooltipEnhancer:sa},Symbol.toStringTag,{value:"Module"}));const oa=Object.freeze(Object.defineProperty({__proto__:null,ScrollHintEnhancer:class extends pt{constructor(){super(...arguments),this.scrollThreshold=5,this.activeClass="cart-items__scroll-hint--active"}async initialize(){this.validateElement(),this.scrollThreshold=parseInt(this.getAttribute("data-next-scroll-threshold")||"5",10);const e=this.getAttribute("data-next-scroll-target");if(e)this.scrollTarget=document.querySelector(e);else{const e=this.findScrollTarget();e&&(this.scrollTarget=e)}this.scrollTarget?(this.scrollHandler=this.throttle(this.updateScrollHint.bind(this),16),this.resizeHandler=this.debounce(this.updateScrollHint.bind(this),100),this.scrollTarget.addEventListener("scroll",this.scrollHandler),window.addEventListener("resize",this.resizeHandler),this.observeContentChanges(),this.updateScrollHint(),this.logger.debug("ScrollHintEnhancer initialized",{scrollTarget:this.scrollTarget,threshold:this.scrollThreshold})):this.logger.warn("No scroll target found for scroll hint")}findScrollTarget(){const e=[".cart-items__list","[data-next-cart-items]","[data-next-order-items]",".order-items__list",".scrollable-content"],t=this.element.parentElement;if(t)for(const n of e){const e=t.querySelector(n);if(e)return e}const i=this.element.closest(".order-summary, .cart-items, .modal-content");if(i)for(const n of e){const e=i.querySelector(n);if(e)return e}return null}observeContentChanges(){this.scrollTarget&&(this.mutationObserver=new MutationObserver(()=>{this.scheduleUpdate()}),this.mutationObserver.observe(this.scrollTarget,{childList:!0,subtree:!0,characterData:!0}))}scheduleUpdate(){this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{this.updateScrollHint()})}hasScrollableContent(){return!!this.scrollTarget&&this.scrollTarget.scrollHeight>this.scrollTarget.clientHeight}updateScrollHint(){if(!this.scrollTarget)return;if(!this.hasScrollableContent())return this.removeClass(this.activeClass),void this.setAttribute("aria-hidden","true");const e=this.scrollTarget.scrollTop<=this.scrollThreshold;e?(this.addClass(this.activeClass),this.setAttribute("aria-hidden","false")):(this.removeClass(this.activeClass),this.setAttribute("aria-hidden","true")),this.eventBus.emit("scroll-hint:updated",{isVisible:e&&this.hasScrollableContent(),scrollTop:this.scrollTarget.scrollTop,scrollHeight:this.scrollTarget.scrollHeight,clientHeight:this.scrollTarget.clientHeight})}throttle(e,t){let i=!1;return(...n)=>{i||(e.apply(this,n),i=!0,setTimeout(()=>i=!1,t))}}debounce(e,t){let i;return(...n)=>{clearTimeout(i),i=window.setTimeout(()=>e.apply(this,n),t)}}update(){this.updateScrollHint()}destroy(){this.scrollTarget&&this.scrollHandler&&this.scrollTarget.removeEventListener("scroll",this.scrollHandler),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.mutationObserver&&this.mutationObserver.disconnect(),this.rafId&&cancelAnimationFrame(this.rafId),super.destroy()}}},Symbol.toStringTag,{value:"Module"})),la=R("UtmTransfer");const ca=Object.freeze(Object.defineProperty({__proto__:null,UtmTransfer:class{constructor(e={}){this.config={enabled:!0,applyToExternalLinks:!1,excludedDomains:[],paramsToCopy:[],debug:!1,...e},this.paramsToApply=new URLSearchParams}init(){if(!this.config.enabled)return void la.debug("UTM Transfer disabled by configuration");const e=new URLSearchParams(window.location.search);if(""!==e.toString()){if(this.config.debug){const t=[];e.forEach((e,i)=>{t.push(`${i}=${e}`)}),la.debug(`Available parameters: ${t.join(", ")}`)}this.prepareParameters(e),""!==this.paramsToApply.toString()?(this.enhanceLinks(),this.observeNewLinks(),la.debug(`UTM Transfer initialized with parameters: ${this.paramsToApply.toString()}`)):la.debug("No matching parameters to transfer")}else la.debug("No URL parameters to transfer")}prepareParameters(e){Array.isArray(this.config.paramsToCopy)&&this.config.paramsToCopy.length>0?(la.debug(`Filtering to specific parameters: ${this.config.paramsToCopy.join(", ")}`),this.config.paramsToCopy.forEach(t=>{e.has(t)&&(this.paramsToApply.append(t,e.get(t)),la.debug(`Found parameter to copy: ${t}=${e.get(t)}`))})):(la.debug("No specific parameters configured, will copy all parameters"),e.forEach((e,t)=>{this.paramsToApply.append(t,e)}))}enhanceLinks(){const e=document.querySelectorAll("a");la.debug(`Found ${e.length} links on the page`),e.forEach(e=>{this.addClickListener(e)})}addClickListener(e){"true"!==e.dataset.utmEnhanced&&(e.addEventListener("click",t=>{this.applyParamsToLink(e)}),e.dataset.utmEnhanced="true")}applyParamsToLink(e){if(!e||!e.getAttribute)return void la.error("Invalid link element provided");const t=e.getAttribute("href");if(!t)return;if(this.shouldSkipLink(t))return;if(this.isExternalLink(t)){if(!this.config.applyToExternalLinks)return;if(this.isExcludedDomain(t))return}let i;try{i=new URL(t,window.location.origin)}catch(s){return void la.error("Invalid URL:",t)}const n=new URLSearchParams(i.search);let a=!1;this.paramsToApply.forEach((e,t)=>{n.has(t)||(n.append(t,e),a=!0)}),a&&(i.search=n.toString(),e.setAttribute("href",i.toString()),la.debug(`Updated link ${t} to ${i.toString()}`))}shouldSkipLink(e){return e.startsWith("#")||e.startsWith("javascript:")||e.startsWith("mailto:")||e.startsWith("tel:")||e.startsWith("sms:")||e.startsWith("whatsapp:")}isExternalLink(e){return e.includes("://")&&!e.includes(window.location.hostname)}isExcludedDomain(e){return!(!this.config.excludedDomains||0===this.config.excludedDomains.length)&&this.config.excludedDomains.some(t=>e.includes(t))}observeNewLinks(){new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const t=e;"A"===t.tagName&&this.addClickListener(t);t.querySelectorAll("a").forEach(e=>{this.addClickListener(e)})}})})}).observe(document.body,{childList:!0,subtree:!0})}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e}}}},Symbol.toStringTag,{value:"Module"}));const da=new class{constructor(){this.logger=new N("ErrorHandler"),this.initialized=!1,this.isHandlingError=!1}initialize(){if(this.initialized)return;window.addEventListener("error",e=>{this.handleError(e.error,{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})}),window.addEventListener("unhandledrejection",e=>{this.handleError(e.reason,{type:"unhandledRejection",promise:e.promise})});const e=console.error;console.error=(...t)=>{if(e.apply(console,t),this.isHandlingError)return;const i=t[0];i instanceof Error?this.handleError(i,{source:"console.error"}):"string"==typeof i&&i.toLowerCase().includes("error")&&this.handleError(new Error(i),{source:"console.error",additionalArgs:t.slice(1)})},this.initialized=!0,this.logger.debug("Global error handler initialized")}handleError(e,t){if(e&&!this.isHandlingError)try{this.isHandlingError=!0;const i=e instanceof Error?e:new Error(String(e)),n={...t,sdk:{version:"0.2.0",timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent}};this.logger.error("Captured error:",i,n),B.getInstance().emit("error:occurred",{message:i.message,code:i.name,details:n})}finally{this.isHandlingError=!1}}captureMessage(e,t="info"){}addBreadcrumb(e){}},ua=Object.freeze(Object.defineProperty({__proto__:null,errorHandler:da},Symbol.toStringTag,{value:"Module"}));class pa{constructor(){this.eventLog=[],this.maxEvents=100,this.initializeEventCapture()}initializeEventCapture(){["next:cart-updated","next:checkout-step","next:item-added","next:item-removed","next:timer-expired","next:validation-error","next:payment-success","next:payment-error"].forEach(e=>{document.addEventListener(e,t=>{this.logEvent(e.replace("next:",""),t.detail,"CustomEvent")})}),this.interceptFetch()}interceptFetch(){const e=window.fetch;window.fetch=async(...t)=>{const i=t[0].toString();return(i.includes("29next.com")||i.includes("campaigns."))&&this.logEvent("api-request",{url:i,method:t[1]?.method||"GET"},"API"),e.apply(window,t)}}logEvent(e,t,i){this.eventLog.push({timestamp:new Date,type:e,data:t,source:i}),this.eventLog.length>this.maxEvents&&this.eventLog.shift()}getEvents(e){return(e?this.eventLog.slice(-e):this.eventLog).reverse()}clearEvents(){this.eventLog=[]}exportEvents(){return JSON.stringify(this.eventLog,null,2)}}class ha{static createOverlayHTML(e,t,i,n){const a=e.find(e=>e.id===t);return`\n      <div class="enhanced-debug-overlay ${i?"expanded":"collapsed"}">\n        ${this.createBottomBar(i)}\n        ${i?this.createExpandedContent(e,a,t,n):""}\n      </div>\n    `}static createBottomBar(e){return`\n      <div class="debug-bottom-bar">\n        <div class="debug-logo-section">\n          ${this.get29NextLogo()}\n          <span class="debug-title">Debug Tools</span>\n          <div class="debug-status">\n            <div class="status-indicator active"></div>\n            <span class="status-text">Active</span>\n          </div>\n        </div>\n        \n        <div class="debug-quick-stats">\n          <div class="stat-item">\n            <span class="stat-value" data-debug-stat="cart-items">0</span>\n            <span class="stat-label">Items</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-value" data-debug-stat="cart-total">$0.00</span>\n            <span class="stat-label">Total</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-value" data-debug-stat="enhanced-elements">0</span>\n            <span class="stat-label">Enhanced</span>\n          </div>\n        </div>\n\n        <div class="debug-controls">\n          <button class="debug-control-btn" data-action="toggle-mini-cart" title="Toggle Mini Cart">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">\n              <path d="M17,18C15.89,18 15,18.89 15,20A2,2 0 0,0 17,22A2,2 0 0,0 19,20C19,18.89 18.1,18 17,18M1,2V4H3L6.6,11.59L5.24,14.04C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42A0.25,0.25 0 0,1 7.17,14.75C7.17,14.7 7.18,14.66 7.2,14.63L8.1,13H15.55C16.3,13 16.96,12.58 17.3,11.97L20.88,5.5C20.95,5.34 21,5.17 21,5A1,1 0 0,0 20,4H5.21L4.27,2M7,18C5.89,18 5,18.89 5,20A2,2 0 0,0 7,22A2,2 0 0,0 9,20C9,18.89 8.1,18 7,18Z"/>\n            </svg>\n          </button>\n          <button class="debug-control-btn" data-action="clear-cart" title="Clear Cart">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">\n              <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>\n            </svg>\n          </button>\n          <button class="debug-control-btn" data-action="toggle-xray" title="Toggle X-Ray View">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">\n              <path d="M5 3C3.89 3 3 3.9 3 5V19C3 20.11 3.89 21 5 21H19C20.11 21 21 20.11 21 19V5C21 3.9 20.11 3 19 3H5M5 5H19V19H5V5M7 7V9H9V7H7M11 7V9H13V7H11M15 7V9H17V7H15M7 11V13H9V11H7M11 11V13H13V11H11M15 11V13H17V11H15M7 15V17H9V15H7M11 15V17H13V15H11M15 15V17H17V15H15Z"/>\n            </svg>\n          </button>\n          <button class="debug-control-btn" data-action="export-data" title="Export Debug Data">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">\n              <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>\n            </svg>\n          </button>\n          <button class="debug-expand-btn" data-action="toggle-expand" title="${e?"Collapse":"Expand"}">\n            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="expand-icon ${e?"rotated":""}">\n              <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>\n            </svg>\n          </button>\n          <button class="debug-control-btn close-btn" data-action="close" title="Close Debug Tools">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">\n              <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>\n            </svg>\n          </button>\n        </div>\n      </div>\n    `}static createExpandedContent(e,t,i,n){return`\n      <div class="debug-expanded-content">\n        <div class="debug-sidebar">\n          ${this.createPanelTabs(e,i)}\n        </div>\n        \n        <div class="debug-main-content">\n          ${this.createPanelContent(t,n)}\n        </div>\n      </div>\n    `}static createPanelTabs(e,t){return`\n      <div class="debug-panel-tabs">\n        ${e.map(e=>`\n          <button class="debug-panel-tab ${e.id===t?"active":""}" \n                  data-panel="${e.id}">\n            <span class="tab-icon">${e.icon}</span>\n            <span class="tab-label">${e.title}</span>\n            ${"events"===e.id?'<div class="tab-badge" data-debug-badge="events">0</div>':""}\n          </button>\n        `).join("")}\n      </div>\n    `}static createPanelContent(e,t){if(!e)return"";const i=e.getTabs?.()||[];if(i.length>0){const n=t||i[0]?.id,a=i.find(e=>e.id===n)||i[0];return`\n        <div class="debug-panel-container">\n          <div class="panel-header">\n            <div class="panel-title">\n              <span class="panel-icon">${e.icon}</span>\n              <h2>${e.title}</h2>\n            </div>\n            ${e.getActions?`\n              <div class="panel-actions">\n                ${e.getActions().map(e=>`\n                  <button class="panel-action-btn ${e.variant||"primary"}" \n                          data-panel-action="${e.label}">\n                    ${e.label}\n                  </button>\n                `).join("")}\n              </div>\n            `:""}\n          </div>\n          \n          <div class="panel-horizontal-tabs">\n            ${i.map(e=>`\n              <button class="horizontal-tab ${e.id===n?"active":""}" \n                      data-panel-tab="${e.id}">\n                ${e.icon?`<span class="tab-icon">${e.icon}</span>`:""}\n                <span class="tab-label">${e.label}</span>\n              </button>\n            `).join("")}\n          </div>\n          \n          <div class="panel-content">\n            ${a?a.getContent():""}\n          </div>\n        </div>\n      `}return`\n      <div class="debug-panel-container">\n        <div class="panel-header">\n          <div class="panel-title">\n            <span class="panel-icon">${e.icon}</span>\n            <h2>${e.title}</h2>\n          </div>\n          ${e.getActions?`\n            <div class="panel-actions">\n              ${e.getActions().map(e=>`\n                <button class="panel-action-btn ${e.variant||"primary"}" \n                        data-panel-action="${e.label}">\n                  ${e.label}\n                </button>\n              `).join("")}\n            </div>\n          `:""}\n        </div>\n        <div class="panel-content">\n          ${e.getContent()}\n        </div>\n      </div>\n    `}static get29NextLogo(){return'\n      <svg class="debug-logo" width="32" height="32" viewBox="0 0 518.2 99" fill="none">\n        <g>\n          <path d="M17.5,0c3.4,0,6.8,1,9.6,2.9l58.8,40v12.6L20.7,12.6c-1-0.6-2.1-1-3.2-1c-3.2,0-5.8,2.6-5.8,5.8v64c0,3.2,2.6,5.8,5.8,5.8h3.1V99h-3.1C7.8,99,0,91.2,0,81.5v-64C0,7.8,7.8,0,17.5,0z" fill="currentColor"/>\n          <path d="M95.4,99c-3.4,0-6.8-1-9.6-2.9L27,56.1V43.5l65.2,42.8c1,0.6,2.1,1,3.2,1c3.2,0,5.8-2.6,5.8-5.8v-64c0-3.2-2.6-5.8-5.8-5.8h-3.1V0h3.1c9.7,0,17.5,7.8,17.5,17.5v64C112.9,91.2,105.1,99,95.4,99z" fill="currentColor"/>\n        </g>\n        <g>\n          <path d="M161.1,69.5c1.9-1.9,3.8-3.5,5.9-4.9l10.1-7.5c4.4-3.2,7.9-6.6,10.4-10.2c2.5-3.7,3.8-7.8,3.8-12.5c0-4.6-1-8.7-3.2-12.2c-2.2-3.5-5.2-6.3-9.2-8.3s-8.8-3-14.3-3c-4.8,0-9.1,1-12.9,2.9c-3.8,1.9-6.9,4.4-9.2,7.5c-2.4,3.1-3.9,6.5-4.6,10.1l15,2.6c0.4-1.7,1.1-3.3,2.2-4.7c1.1-1.5,2.4-2.6,4.1-3.5c1.7-0.9,3.6-1.3,5.7-1.3c2.5,0,4.6,0.4,6.3,1.3c1.7,0.9,3,2.1,3.9,3.6c0.9,1.5,1.3,3.2,1.3,5.1c0,1.5-0.4,3.1-1.3,4.7c-0.9,1.6-2,3.1-3.4,4.5c-1.4,1.4-2.8,2.6-4.4,3.7L156,55.6c-3.1,2.1-5.7,4.5-8,7c-2.2,2.6-4,5.1-5.3,7.6s-1.9,4.8-1.9,6.9l0.1,0.1V88h51.5V75h-35.2C158.3,73,159.6,71.1,161.1,69.5z" fill="currentColor"/>\n          <path d="M248.3,20.8c-2.2-3.2-5.1-5.7-8.6-7.6c-3.5-1.9-7.8-2.8-12.8-2.8c-5.3,0-10,1-14.2,3.1c-4,2.1-7.1,5-9.3,8.6c-2.2,3.6-3.3,7.8-3.3,12.6c0,4.9,1,9.2,3.1,13c2,3.8,4.9,6.8,8.6,9.1s7.9,3.4,12.6,3.4c4.7,0,8.8-1.2,12.2-3.6c1.7-1.2,3.2-2.6,4.5-4.2c-0.4,6.9-1.8,12.2-4.2,15.9c-3.1,4.9-7.5,7.4-13,7.4c-2.1,0-4.4-0.3-6.9-1.1c-2.5-0.8-4.9-1.9-7.2-3.4L202.7,82c3,2.1,6.4,3.7,10.1,4.9c3.7,1.2,7.5,1.8,11.4,1.8c5.4,0,10-1.1,13.8-3.4s7-5.4,9.4-9.3c2.5-3.9,4.3-8.4,5.5-13.6c1.2-5.2,1.8-10.7,1.8-16.5c0-4.9-0.5-9.5-1.5-13.8C252.2,27.8,250.5,24,248.3,20.8z M237.6,41.9c-1.1,1.9-2.6,3.4-4.4,4.5c-1.9,1.1-4,1.6-6.3,1.6c-2.4,0-4.5-0.5-6.3-1.6c-1.9-1-3.3-2.6-4.4-4.5c-1.1-1.9-1.6-4.1-1.6-6.6s0.5-4.6,1.6-6.5c1.1-1.8,2.6-3.3,4.4-4.4c1.9-1.1,4-1.6,6.3-1.6c2.4,0,4.5,0.5,6.3,1.6c1.8,1,3.3,2.5,4.4,4.4c1.1,1.9,1.6,4,1.6,6.5S238.7,40,237.6,41.9z" fill="currentColor"/>\n        </g>\n      </svg>\n    '}static addStyles(){}static removeStyles(){}}const ga=class{static initialize(){"true"===localStorage.getItem(this.STORAGE_KEY)&&this.activate()}static toggle(){return this.isActive?this.deactivate():this.activate(),this.isActive}static activate(){this.isActive||(this.styleElement=document.createElement("style"),this.styleElement.id="debug-xray-styles",this.styleElement.textContent='\n    /* X-RAY WIREFRAME CSS - PURE CSS, NO JS */\n\n    /* Subtle outlines for all data attributes */\n    [data-next-display],\n    [data-next-show],\n    [data-next-checkout],\n    [data-next-selector-id],\n    [data-next-cart-selector],\n    [data-next-selection-mode],\n    [data-next-shipping-id],\n    [data-next-selector-card],\n    [data-next-package-id],\n    [data-next-quantity],\n    [data-next-selected],\n    [data-next-await],\n    [data-next-in-cart],\n    [data-next-express-checkout],\n    [data-next-payment-method],\n    [data-next-checkout-field],\n    [data-next-payment-form] {\n      position: relative !important;\n      outline: 1px dashed rgba(0, 0, 0, 0.3) !important;\n      outline-offset: -1px !important;\n    }\n\n    /* Color coding for different attribute types */\n    [data-next-display] {\n      outline-color: #4ecdc4 !important;\n    }\n\n    [data-next-show] {\n      outline-color: #ffe66d !important;\n    }\n\n    [data-next-checkout] {\n      outline-color: #ff6b6b !important;\n    }\n\n    [data-next-selector-id] {\n      outline-color: #a8e6cf !important;\n    }\n\n    [data-next-selector-card] {\n      outline-color: #95e1d3 !important;\n    }\n\n    [data-next-in-cart] {\n      outline-color: #c7ceea !important;\n    }\n\n    [data-next-selected] {\n      outline-color: #ffa502 !important;\n    }\n\n    [data-next-package-id] {\n      outline-color: #ff8b94 !important;\n    }\n\n    /* Small corner labels */\n    [data-next-selector-id]::before {\n      content: attr(data-next-selector-id) !important;\n      position: absolute !important;\n      top: 2px !important;\n      right: 2px !important;\n      background: rgba(168, 230, 207, 0.9) !important;\n      color: #333 !important;\n      padding: 2px 4px !important;\n      font-size: 9px !important;\n      font-family: monospace !important;\n      line-height: 1 !important;\n      border-radius: 2px !important;\n      pointer-events: none !important;\n      z-index: 10 !important;\n    }\n\n    [data-next-package-id]::before {\n      content: "PKG " attr(data-next-package-id) !important;\n      position: absolute !important;\n      top: 2px !important;\n      left: 2px !important;\n      background: rgba(255, 139, 148, 0.9) !important;\n      color: white !important;\n      padding: 2px 4px !important;\n      font-size: 9px !important;\n      font-family: monospace !important;\n      font-weight: bold !important;\n      line-height: 1 !important;\n      border-radius: 2px !important;\n      pointer-events: none !important;\n      z-index: 10 !important;\n    }\n\n    /* Special highlighting for active states */\n    [data-next-selected="true"] {\n      outline-width: 2px !important;\n      outline-style: solid !important;\n    }\n\n    [data-next-in-cart="true"] {\n      background-color: rgba(199, 206, 234, 0.1) !important;\n    }\n\n    /* Hover tooltips */\n    [data-next-display]:hover::after,\n    [data-next-show]:hover::after,\n    [data-next-selector-card]:hover::after {\n      position: absolute !important;\n      z-index: 99999 !important;\n      pointer-events: none !important;\n      font-family: monospace !important;\n      font-size: 10px !important;\n      padding: 4px 6px !important;\n      border-radius: 3px !important;\n      white-space: nowrap !important;\n      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;\n      bottom: 100% !important;\n      left: 0 !important;\n      margin-bottom: 4px !important;\n    }\n\n    [data-next-display]:hover::after {\n      content: "display: " attr(data-next-display) !important;\n      background: #4ecdc4 !important;\n      color: white !important;\n    }\n\n    [data-next-show]:hover::after {\n      content: "show: " attr(data-next-show) !important;\n      background: #ffe66d !important;\n      color: #333 !important;\n    }\n\n    [data-next-selector-card]:hover::after {\n      content: "pkg:" attr(data-next-package-id) " | selected:" attr(data-next-selected) " | in-cart:" attr(data-next-in-cart) !important;\n      background: #95e1d3 !important;\n      color: #333 !important;\n    }\n  ',document.head.appendChild(this.styleElement),document.body.classList.add("debug-xray-active"),this.isActive=!0,localStorage.setItem(this.STORAGE_KEY,"true"))}static deactivate(){this.isActive&&(this.styleElement&&(this.styleElement.remove(),this.styleElement=null),document.body.classList.remove("debug-xray-active"),this.isActive=!1,localStorage.setItem(this.STORAGE_KEY,"false"))}static isXrayActive(){return this.isActive}};ga.styleElement=null,ga.isActive=!1,ga.STORAGE_KEY="debug-xray-active";let ma=ga;class fa{constructor(){this.id="cart",this.title="Cart State",this.icon="ðŸ›’"}getContent(){const e=this.getTabs();return e[0]?.getContent()||""}getTabs(){return[{id:"overview",label:"Overview",icon:"ðŸ“Š",getContent:()=>this.getOverviewContent()},{id:"items",label:"Items",icon:"ðŸ“¦",getContent:()=>this.getItemsContent()},{id:"raw",label:"Raw Data",icon:"ðŸ”§",getContent:()=>this.getRawDataContent()}]}getOverviewContent(){const e=Q.getState();return`\n      <div class="enhanced-panel">\n        <div class="metrics-grid">\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ“¦</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.items.length}</div>\n              <div class="metric-label">Unique Items</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ”¢</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.totalQuantity}</div>\n              <div class="metric-label">Total Quantity</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ’°</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.totals.subtotal.formatted}</div>\n              <div class="metric-label">Subtotal</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸšš</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.totals.shipping.formatted}</div>\n              <div class="metric-label">Shipping</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ“Š</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.totals.tax.formatted}</div>\n              <div class="metric-label">Tax</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ’³</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.totals.total.formatted}</div>\n              <div class="metric-label">Total</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}getItemsContent(){const e=Q.getState();return`\n      <div class="enhanced-panel">\n        <div class="section">\n          ${0===e.items.length?'\n            <div class="empty-state">\n              <div class="empty-icon">ðŸ›’</div>\n              <div class="empty-text">Cart is empty</div>\n              <button class="empty-action" onclick="window.nextDebug.addTestItems()">Add Test Items</button>\n            </div>\n          ':`\n            <div class="cart-items-list">\n              ${e.items.map(e=>`\n                <div class="cart-item-card">\n                  <div class="item-info">\n                    <div class="item-title">${e.title}</div>\n                    <div class="item-details">\n                      Package ID: ${e.packageId} â€¢ Price: $${e.price}\n                    </div>\n                  </div>\n                  <div class="item-quantity">\n                    <button onclick="window.nextDebug.updateQuantity(${e.packageId}, ${e.quantity-1})" \n                            class="qty-btn">-</button>\n                    <span class="qty-value">${e.quantity}</span>\n                    <button onclick="window.nextDebug.updateQuantity(${e.packageId}, ${e.quantity+1})" \n                            class="qty-btn">+</button>\n                  </div>\n                  <div class="item-total">$${(e.price*e.quantity).toFixed(2)}</div>\n                  <button onclick="window.nextDebug.removeItem(${e.packageId})" \n                          class="remove-btn">Ã—</button>\n                </div>\n              `).join("")}\n            </div>\n          `}\n        </div>\n      </div>\n    `}getRawDataContent(){const e=Q.getState();return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="json-viewer">\n            <pre><code>${JSON.stringify(e,null,2)}</code></pre>\n          </div>\n        </div>\n      </div>\n    `}getActions(){return[{label:"Clear Cart",action:()=>Q.getState().clear(),variant:"danger"},{label:"Add Test Items",action:this.addTestItems,variant:"secondary"},{label:"Recalculate",action:()=>Q.getState().calculateTotals(),variant:"primary"},{label:"Export Cart",action:this.exportCart,variant:"secondary"}]}addTestItems(){const e=Q.getState();[{packageId:999,quantity:1,price:19.99,title:"Debug Test Item 1",isUpsell:!1},{packageId:998,quantity:2,price:29.99,title:"Debug Test Item 2",isUpsell:!1},{packageId:997,quantity:1,price:9.99,title:"Debug Test Item 3",isUpsell:!1}].forEach(t=>e.addItem(t))}exportCart(){const e=Q.getState(),t=JSON.stringify(e,null,2),i=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(i),a=document.createElement("a");a.href=n,a.download=`cart-state-${(new Date).toISOString()}.json`,a.click(),URL.revokeObjectURL(n)}}class ya{constructor(e){this.events=e,this.id="events",this.title="Event Timeline",this.icon="ðŸ“‹"}getContent(){const e=this.getTabs();return e[0]?.getContent()||""}getTabs(){return[{id:"overview",label:"Overview",icon:"ðŸ“Š",getContent:()=>this.getOverviewContent()},{id:"timeline",label:"Timeline",icon:"â°",getContent:()=>this.getTimelineContent()},{id:"analytics",label:"Analytics",icon:"ðŸ“ˆ",getContent:()=>this.getAnalyticsContent()}]}getOverviewContent(){const e=[...new Set(this.events.map(e=>e.type))];return`\n      <div class="enhanced-panel">\n        <div class="metrics-grid">\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ“Š</div>\n            <div class="metric-content">\n              <div class="metric-value">${this.events.length}</div>\n              <div class="metric-label">Total Events</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸŽ¯</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.length}</div>\n              <div class="metric-label">Event Types</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">â±ï¸</div>\n            <div class="metric-content">\n              <div class="metric-value">${this.getEventsPerMinute()}</div>\n              <div class="metric-label">Events/min</div>\n            </div>\n          </div>\n        </div>\n\n        <div class="section">\n          <h3 class="section-title">Event Types</h3>\n          <div class="event-types">\n            ${e.map(e=>{const t=this.events.filter(t=>t.type===e).length;return`\n                <div class="event-type-card" onclick="window.nextDebug.filterEvents('${e}')">\n                  <div class="event-type-name">${e}</div>\n                  <div class="event-type-count">${t}</div>\n                </div>\n              `}).join("")}\n          </div>\n        </div>\n      </div>\n    `}getTimelineContent(){const e=this.events.slice(0,30);return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="events-timeline">\n            ${0===e.length?'\n              <div class="empty-state">\n                <div class="empty-icon">ðŸ“‹</div>\n                <div class="empty-text">No events logged yet</div>\n              </div>\n            ':e.map(e=>`\n              <div class="timeline-event">\n                <div class="event-time">${e.timestamp.toLocaleTimeString()}</div>\n                <div class="event-content">\n                  <div class="event-header">\n                    <span class="event-type-badge">${e.type}</span>\n                    <span class="event-source">${e.source}</span>\n                  </div>\n                  <div class="event-data-preview">\n                    ${this.formatEventData(e.data)}\n                  </div>\n                </div>\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      </div>\n    `}getAnalyticsContent(){const e=[...new Set(this.events.map(e=>e.type))],t=this.getSourceStatistics();return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <h3 class="section-title">Event Distribution</h3>\n          <div class="analytics-charts">\n            ${e.map(e=>{const t=this.events.filter(t=>t.type===e).length,i=this.events.length>0?(t/this.events.length*100).toFixed(1):0;return`\n                <div class="analytics-bar">\n                  <div class="bar-label">${e}</div>\n                  <div class="bar-container">\n                    <div class="bar-fill" style="width: ${i}%"></div>\n                    <div class="bar-value">${t} (${i}%)</div>\n                  </div>\n                </div>\n              `}).join("")}\n          </div>\n        </div>\n        \n        <div class="section">\n          <h3 class="section-title">Source Statistics</h3>\n          <div class="source-stats">\n            ${Object.entries(t).map(([e,t])=>`\n              <div class="source-stat-item">\n                <span class="source-name">${e}</span>\n                <span class="source-count">${t}</span>\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      </div>\n    `}getActions(){return[{label:"Clear Events",action:()=>this.clearEvents(),variant:"danger"},{label:"Export Timeline",action:()=>this.exportEvents(),variant:"secondary"},{label:"Start Recording",action:()=>this.startRecording(),variant:"primary"}]}getEventsPerMinute(){const e=new Date((new Date).getTime()-6e4);return this.events.filter(t=>t.timestamp>e).length}getSourceStatistics(){const e={};return this.events.forEach(t=>{e[t.source]=(e[t.source]||0)+1}),e}formatEventData(e){if("object"==typeof e&&null!==e){const t=Object.keys(e);if(0===t.length)return"No data";if(1===t.length){const i=t[0];return i?`${i}: ${e[i]||"undefined"}`:"No data"}return`${t.slice(0,2).join(", ")}${t.length>2?"...":""}`}return String(e)}clearEvents(){this.events.length=0,document.dispatchEvent(new CustomEvent("debug:update-content"))}exportEvents(){const e=JSON.stringify(this.events,null,2),t=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=`debug-events-${(new Date).toISOString()}.json`,n.click(),URL.revokeObjectURL(i)}startRecording(){}}class va{constructor(){this.id="event-timeline",this.title="Events",this.icon="âš¡",this.events=[],this.maxEvents=1e3,this.isRecording=!0,this.filters={types:new Set(["dataLayer","internal","dom"]),sources:new Set,search:"",timeRange:30},this.startTime=Date.now(),this.eventBus=B.getInstance(),this.initializeEventWatching()}initializeEventWatching(){this.watchDataLayer(),this.watchInternalEvents(),this.watchDOMEvents(),this.watchPerformanceEvents()}watchDataLayer(){if("undefined"==typeof window)return;window.dataLayer=window.dataLayer||[];const e=window.dataLayer.push;window.dataLayer.push=(...t)=>(this.isRecording&&t.forEach(e=>{let t="GTM DataLayer";e.event&&e.event.startsWith("gtm_")?t="GTM Internal":(e.timestamp||e.event_context)&&(t="Analytics Manager"),this.addEvent({type:"dataLayer",name:e.event||"dataLayer.push",data:e,source:t})}),e.apply(window.dataLayer,t)),window.dataLayer.length>0&&window.dataLayer.forEach((e,t)=>{"object"==typeof e&&e.event&&this.addEvent({type:"dataLayer",name:e.event,data:e,source:"GTM DataLayer (existing)",timestamp:this.startTime+10*t})})}watchInternalEvents(){["cart:updated","cart:item-added","cart:item-removed","cart:quantity-changed","campaign:loaded","checkout:started","checkout:form-initialized","order:completed","payment:tokenized","payment:error","coupon:applied","coupon:removed","upsell:added","upsell:skipped","config:updated","error:occurred"].forEach(e=>{this.eventBus.on(e,t=>{this.isRecording&&this.addEvent({type:"internal",name:e,data:t,source:"SDK Internal"})})})}watchDOMEvents(){if("undefined"==typeof document)return;["next:initialized","next:cart-updated","next:item-added","next:item-removed","next:checkout-started","next:payment-success","next:payment-error","next:timer-expired","next:coupon-applied","next:display-ready"].forEach(e=>{document.addEventListener(e,t=>{if(this.isRecording){const i=t;this.addEvent({type:"dom",name:e,data:i.detail,source:"DOM CustomEvent"})}})})}watchPerformanceEvents(){if("undefined"==typeof window||!window.performance)return;const e=performance.mark,t=performance.measure,i=this;performance.mark=function(t){const n=e.call(performance,t);return i.isRecording&&i.addEvent({type:"performance",name:`mark: ${t}`,data:{markName:t,timestamp:performance.now()},source:"Performance API"}),n},performance.measure=function(e,n,a){const s=t.call(performance,e,n,a);return i.isRecording&&i.addEvent({type:"performance",name:`measure: ${e}`,data:{measureName:e,startMark:n,endMark:a},source:"Performance API"}),s}}addEvent(e){const t=Date.now(),i={id:`event_${t}_${Math.random().toString(36).substr(2,9)}`,timestamp:e.timestamp||t,type:e.type||"internal",name:e.name||"unknown",data:e.data||{},source:e.source||"Unknown",relativeTime:this.formatRelativeTime(e.timestamp||t)};if(this.events.unshift(i),this.events.length>this.maxEvents&&(this.events=this.events.slice(0,this.maxEvents)),i.source&&"Unknown"!==i.source&&this.filters.sources.add(i.source),"undefined"!=typeof document){const e=document.activeElement;e&&("INPUT"===e.tagName||"SELECT"===e.tagName)||setTimeout(()=>{document.dispatchEvent(new CustomEvent("debug:update-content"))},100)}}formatRelativeTime(e){const t=Date.now()-e,i=Math.floor(t/1e3),n=Math.floor(i/60),a=Math.floor(n/60);return a>0?`${a}h ${n%60}m ago`:n>0?`${n}m ${i%60}s ago`:i>0?`${i}s ago`:"just now"}getFilteredEvents(){const e=Date.now()-60*this.filters.timeRange*1e3;return this.events.filter(t=>{if(t.timestamp<e)return!1;if(!this.filters.types.has(t.type))return!1;if(this.filters.sources.size>0&&!this.filters.sources.has(t.source))return!1;if(this.filters.search){const e=this.filters.search.toLowerCase();return t.name.toLowerCase().includes(e)||t.source.toLowerCase().includes(e)||JSON.stringify(t.data).toLowerCase().includes(e)}return!0})}getEventTypeColor(e){return{dataLayer:"#4CAF50",internal:"#2196F3",dom:"#FF9800",performance:"#9C27B0"}[e]||"#666"}getTabs(){return[{id:"timeline",label:"Events",icon:"ðŸ“…",getContent:()=>this.getTimelineContent()},{id:"analytics",label:"Stats",icon:"ðŸ“Š",getContent:()=>this.getAnalyticsContent()},{id:"filters",label:"Filter",icon:"ðŸ”",getContent:()=>this.getFiltersContent()}]}getTimelineContent(){const e=this.getFilteredEvents();if(0===e.length)return'<div style="padding: 20px; text-align: center; color: #666;">No events yet</div>';let t="";return e.slice(0,20).forEach(e=>{t+=`\n        <div style="border-bottom: 1px solid #333; padding: 8px; background: #1a1a1a;">\n          <div style="font-weight: bold; color: ${this.getEventTypeColor(e.type)};">\n            ${e.name} <span style="float: right; font-weight: normal; color: #999;">${e.relativeTime}</span>\n          </div>\n          <div style="color: #999; font-size: 11px; margin: 4px 0;">${e.source}</div>\n          <div style="background: #2a2a2a; padding: 4px; border-radius: 3px; font-family: monospace; font-size: 10px; overflow: hidden; color: #ccc;">\n            ${JSON.stringify(e.data).length>100?JSON.stringify(e.data).substring(0,100)+"...":JSON.stringify(e.data)}\n          </div>\n        </div>\n      `}),`\n      <div style="padding: 10px; border-bottom: 1px solid #444; background: #2a2a2a; color: #fff;">\n        <strong>Total Events: ${this.events.length}</strong>\n        <span style="float: right;">\n          <button onclick="this.closest('.debug-panel').dispatchEvent(new CustomEvent('timeline-action', {detail: 'toggle'}))" style="margin-right: 5px; background: #444; color: #fff; border: 1px solid #666; padding: 4px 8px; cursor: pointer;">\n            ${this.isRecording?"Pause":"Record"}\n          </button>\n          <button onclick="this.closest('.debug-panel').dispatchEvent(new CustomEvent('timeline-action', {detail: 'clear'}))" style="background: #444; color: #fff; border: 1px solid #666; padding: 4px 8px; cursor: pointer;">\n            Clear\n          </button>\n        </span>\n      </div>\n      <div style="max-height: 300px; overflow-y: auto; background: #1a1a1a;">\n        ${t}\n      </div>\n    `}getAnalyticsContent(){const e=this.getEventStats(),t=this.getTypeDistribution();return`\n      <div style="padding: 15px; background: #1a1a1a; color: #fff;">\n        <h4 style="color: #fff;">Event Statistics</h4>\n        <p>Total Events: <strong>${e.total}</strong></p>\n        <p>Events Per Minute: <strong>${e.eventsPerMinute}</strong></p>\n        <p>Most Active Type: <strong>${e.mostActiveType}</strong></p>\n        \n        <h4 style="margin-top: 20px; color: #fff;">Event Types</h4>\n        ${Object.entries(t).map(([e,t])=>`\n          <p style="margin: 5px 0;">\n            <span style="color: ${this.getEventTypeColor(e)};">${e}:</span> \n            <strong>${t}</strong>\n          </p>\n        `).join("")}\n      </div>\n    `}getFiltersContent(){return`\n      <div style="padding: 15px; background: #1a1a1a; color: #fff;">\n        <h4 style="color: #fff;">Search Events</h4>\n        <input type="text" \n               placeholder="Search event names or data..." \n               value="${this.filters.search||""}"\n               style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #666; border-radius: 4px; background: #2a2a2a; color: #fff;">\n        \n        <h4 style="color: #fff;">Event Types</h4>\n        ${["dataLayer","internal","dom","performance"].map(e=>`\n          <label style="display: block; margin: 8px 0; color: #fff;">\n            <input type="checkbox" ${this.filters.types.has(e)?"checked":""} style="margin-right: 8px;">\n            ${e}\n          </label>\n        `).join("")}\n        \n        <h4 style="margin-top: 20px; color: #fff;">Time Range</h4>\n        <select style="width: 100%; padding: 8px; border: 1px solid #666; border-radius: 4px; background: #2a2a2a; color: #fff;">\n          <option value="5">Last 5 minutes</option>\n          <option value="15">Last 15 minutes</option>\n          <option value="30" selected>Last 30 minutes</option>\n          <option value="60">Last hour</option>\n        </select>\n      </div>\n    `}getEventStats(){const e=Date.now()-6e4,t=this.events.filter(t=>t?.timestamp&&t.timestamp>e),i=this.events.reduce((e,t)=>(t?.type&&(e[t.type]=(e[t.type]||0)+1),e),{}),n=Object.entries(i).sort(([,e],[,t])=>(t||0)-(e||0))[0]?.[0];return{total:this.events.length,eventsPerMinute:t.length,mostActiveType:n||"None"}}getTypeDistribution(){return this.events.reduce((e,t)=>(t?.type&&(e[t.type]=(e[t.type]||0)+1),e),{})}getSourceDistribution(){return this.events.reduce((e,t)=>(t?.source&&(e[t.source]=(e[t.source]||0)+1),e),{})}getActions(){return[{label:this.isRecording?"â¸ï¸ Pause Recording":"â–¶ï¸ Start Recording",action:()=>{this.isRecording=!this.isRecording}},{label:"ðŸ—‘ï¸ Clear Events",action:()=>{this.events=[]}},{label:"ðŸ’¾ Export Events",action:()=>this.exportEvents()},{label:"ðŸ§ª Test Events",action:()=>this.generateTestEvents()}]}exportEvents(){const e={timestamp:(new Date).toISOString(),totalEvents:this.events.length,filters:{types:Array.from(this.filters.types),sources:Array.from(this.filters.sources),search:this.filters.search,timeRange:this.filters.timeRange},events:this.events,stats:this.getEventStats(),typeDistribution:this.getTypeDistribution(),sourceDistribution:this.getSourceDistribution()},t=JSON.stringify(e,null,2),i=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(i),a=document.createElement("a");a.href=n,a.download=`event-timeline-${(new Date).toISOString().split("T")[0]}.json`,a.click(),URL.revokeObjectURL(n)}generateTestEvents(){[{type:"dataLayer",name:"add_to_cart",data:{item_id:"123",value:29.99},source:"Test"},{type:"internal",name:"cart:updated",data:{itemCount:2},source:"Test"},{type:"dom",name:"next:item-added",data:{packageId:123},source:"Test"},{type:"performance",name:"navigation",data:{loadTime:1234},source:"Test"}].forEach((e,t)=>{setTimeout(()=>{this.addEvent(e)},200*t)})}getContent(){return this.getTimelineContent()}}class ba{constructor(){this.id="config",this.title="Configuration",this.icon="âš™ï¸"}getContent(){const e=this.getTabs();return e[0]?.getContent()||""}getTabs(){return[{id:"overview",label:"Overview",icon:"ðŸ“Š",getContent:()=>this.getOverviewContent()},{id:"settings",label:"Settings",icon:"âš™ï¸",getContent:()=>this.getSettingsContent()},{id:"raw",label:"Raw Data",icon:"ðŸ”§",getContent:()=>this.getRawDataContent()}]}getOverviewContent(){const e=oe.getState();return`\n      <div class="enhanced-panel">\n        <div class="metrics-grid">\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ”§</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.debug?"ON":"OFF"}</div>\n              <div class="metric-label">Debug Mode</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸŒ</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.environment||"production"}</div>\n              <div class="metric-label">Environment</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ”‘</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.apiKey?"SET":"MISSING"}</div>\n              <div class="metric-label">API Key</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ“‹</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.campaignId||"NONE"}</div>\n              <div class="metric-label">Campaign ID</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}getSettingsContent(){const e=oe.getState();return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="config-groups">\n            <div class="config-group">\n              <h4 class="config-group-title">Core Settings</h4>\n              <div class="config-items">\n                <div class="config-item">\n                  <span class="config-key">Campaign ID:</span>\n                  <span class="config-value">${e.campaignId||"Not set"}</span>\n                </div>\n                <div class="config-item">\n                  <span class="config-key">API Key:</span>\n                  <span class="config-value">${e.apiKey?`${e.apiKey.substring(0,8)}...`:"Not set"}</span>\n                </div>\n                <div class="config-item">\n                  <span class="config-key">Environment:</span>\n                  <span class="config-value">${e.environment||"production"}</span>\n                </div>\n                <div class="config-item">\n                  <span class="config-key">Base URL:</span>\n                  <span class="config-value">https://campaigns.apps.29next.com</span>\n                </div>\n              </div>\n            </div>\n\n            <div class="config-group">\n              <h4 class="config-group-title">Feature Flags</h4>\n              <div class="config-items">\n                <div class="config-item">\n                  <span class="config-key">Debug Mode:</span>\n                  <span class="config-value ${e.debug?"enabled":"disabled"}">${e.debug?"Enabled":"Disabled"}</span>\n                </div>\n                <div class="config-item">\n                  <span class="config-key">Test Mode:</span>\n                  <span class="config-value ${e.testMode?"enabled":"disabled"}">${e.testMode?"Enabled":"Disabled"}</span>\n                </div>\n                <div class="config-item">\n                  <span class="config-key">Analytics:</span>\n                  <span class="config-value ${e.enableAnalytics??1?"enabled":"disabled"}">${e.enableAnalytics??1?"Enabled":"Disabled"}</span>\n                </div>\n                <div class="config-item">\n                  <span class="config-key">Auto Initialize:</span>\n                  <span class="config-value ${e.autoInit??1?"enabled":"disabled"}">${e.autoInit??1?"Enabled":"Disabled"}</span>\n                </div>\n              </div>\n            </div>\n\n            <div class="config-group">\n              <h4 class="config-group-title">Performance</h4>\n              <div class="config-items">\n                <div class="config-item">\n                  <span class="config-key">Rate Limit:</span>\n                  <span class="config-value">${e.rateLimit??4} req/sec</span>\n                </div>\n                <div class="config-item">\n                  <span class="config-key">Cache TTL:</span>\n                  <span class="config-value">${e.cacheTtl??300}s</span>\n                </div>\n                <div class="config-item">\n                  <span class="config-key">Retry Attempts:</span>\n                  <span class="config-value">${e.retryAttempts??3}</span>\n                </div>\n                <div class="config-item">\n                  <span class="config-key">Timeout:</span>\n                  <span class="config-value">${e.timeout??1e4}ms</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}getRawDataContent(){const e=oe.getState();return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="json-viewer">\n            <pre><code>${JSON.stringify(e,null,2)}</code></pre>\n          </div>\n        </div>\n      </div>\n    `}getActions(){return[{label:"Toggle Debug",action:()=>this.toggleDebug(),variant:"primary"},{label:"Toggle Test Mode",action:()=>this.toggleTestMode(),variant:"secondary"},{label:"Export Config",action:()=>this.exportConfig(),variant:"secondary"},{label:"Reset Config",action:()=>this.resetConfig(),variant:"danger"}]}toggleDebug(){const e=oe.getState();e.updateConfig({debug:!e.debug}),document.dispatchEvent(new CustomEvent("debug:update-content"))}toggleTestMode(){const e=oe.getState();e.updateConfig({testMode:!e.testMode}),document.dispatchEvent(new CustomEvent("debug:update-content"))}exportConfig(){const e=oe.getState(),t=JSON.stringify(e,null,2),i=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(i),a=document.createElement("a");a.href=n,a.download=`next-config-${(new Date).toISOString()}.json`,a.click(),URL.revokeObjectURL(n)}resetConfig(){if(confirm("Are you sure you want to reset the configuration to defaults?")){oe.getState().reset(),document.dispatchEvent(new CustomEvent("debug:update-content"))}}}class xa{constructor(){this.id="checkout",this.title="Checkout State",this.icon="ðŸ’³"}getContent(){const e=this.getTabs();return e[0]?.getContent()||""}getTabs(){return[{id:"overview",label:"Overview",icon:"ðŸ“Š",getContent:()=>this.getOverviewContent()},{id:"customer",label:"Customer Info",icon:"ðŸ‘¤",getContent:()=>this.getCustomerContent()},{id:"validation",label:"Validation",icon:"âœ…",getContent:()=>this.getValidationContent()},{id:"raw",label:"Raw Data",icon:"ðŸ”§",getContent:()=>this.getRawDataContent()}]}getOverviewContent(){const e=te.getState();return`\n      <div class="enhanced-panel">\n        <div class="metrics-grid">\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ“‹</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.step||"Not Started"}</div>\n              <div class="metric-label">Current Step</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">${e.isProcessing?"â³":"âœ…"}</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.isProcessing?"PROCESSING":"READY"}</div>\n              <div class="metric-label">Form Status</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ”’</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.paymentMethod||"None"}</div>\n              <div class="metric-label">Payment Method</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸšš</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.shippingMethod?.name||"None"}</div>\n              <div class="metric-label">Shipping Method</div>\n            </div>\n          </div>\n        </div>\n\n        <div class="section">\n          <h3 class="section-title">Form Fields Status</h3>\n          <div class="form-fields-grid">\n            ${this.renderFormFields(e)}\n          </div>\n        </div>\n        \n        <div class="section">\n          <h3 class="section-title">Current Form Data</h3>\n          <div class="form-data-summary">\n            ${Object.keys(e.formData).length>0?Object.entries(e.formData).map(([e,t])=>`\n                <div class="form-field-row">\n                  <span class="field-name">${this.formatFieldName(e)}</span>\n                  <span class="field-value">${t||"Empty"}</span>\n                </div>\n              `).join(""):'<div class="empty-state">No form data yet</div>'}\n          </div>\n        </div>\n      </div>\n    `}getCustomerContent(){const e=te.getState(),t=e.formData;return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="customer-info">\n            ${Object.keys(t).length>0?`\n              <div class="info-card">\n                <h4>Contact Information</h4>\n                <div class="info-row">\n                  <span class="info-label">Email:</span>\n                  <span class="info-value">${t.email||"Not provided"}</span>\n                </div>\n                <div class="info-row">\n                  <span class="info-label">Phone:</span>\n                  <span class="info-value">${t.phone||"Not provided"}</span>\n                </div>\n                <div class="info-row">\n                  <span class="info-label">Name:</span>\n                  <span class="info-value">${t.fname||""} ${t.lname||""}</span>\n                </div>\n              </div>\n              \n              <div class="info-card">\n                <h4>Shipping Address</h4>\n                <div class="address-info">\n                  ${t.address1?`\n                    <div class="info-row">\n                      <span class="info-label">Address:</span>\n                      <span class="info-value">${t.address1}</span>\n                    </div>\n                    ${t.address2?`\n                      <div class="info-row">\n                        <span class="info-label">Address 2:</span>\n                        <span class="info-value">${t.address2}</span>\n                      </div>\n                    `:""}\n                    <div class="info-row">\n                      <span class="info-label">City:</span>\n                      <span class="info-value">${t.city||"Not provided"}</span>\n                    </div>\n                    <div class="info-row">\n                      <span class="info-label">State/Province:</span>\n                      <span class="info-value">${t.province||"Not provided"}</span>\n                    </div>\n                    <div class="info-row">\n                      <span class="info-label">Postal Code:</span>\n                      <span class="info-value">${t.postal||"Not provided"}</span>\n                    </div>\n                    <div class="info-row">\n                      <span class="info-label">Country:</span>\n                      <span class="info-value">${t.country||"Not provided"}</span>\n                    </div>\n                  `:'<div class="info-empty">Not provided</div>'}\n                </div>\n              </div>\n\n              <div class="info-card">\n                <h4>Billing Address</h4>\n                <div class="address-info">\n                  ${e.sameAsShipping?'\n                    <div class="info-same">Same as shipping address</div>\n                  ':e.billingAddress?`\n                    <div class="info-row">\n                      <span class="info-label">Name:</span>\n                      <span class="info-value">${e.billingAddress.first_name} ${e.billingAddress.last_name}</span>\n                    </div>\n                    <div class="info-row">\n                      <span class="info-label">Address:</span>\n                      <span class="info-value">${e.billingAddress.address1}</span>\n                    </div>\n                    <div class="info-row">\n                      <span class="info-label">City:</span>\n                      <span class="info-value">${e.billingAddress.city}, ${e.billingAddress.province} ${e.billingAddress.postal}</span>\n                    </div>\n                  `:'<div class="info-empty">Not provided</div>'}\n                </div>\n              </div>\n            `:'\n              <div class="empty-state">\n                <div class="empty-icon">ðŸ‘¤</div>\n                <div class="empty-text">No customer information yet</div>\n                <div class="empty-subtitle">Fill out the checkout form to see data here</div>\n              </div>\n            '}\n          </div>\n        </div>\n      </div>\n    `}getValidationContent(){const e=te.getState();return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="validation-errors">\n            ${e.errors&&Object.keys(e.errors).length>0?`\n              ${Object.entries(e.errors).map(([e,t])=>`\n                <div class="error-item">\n                  <span class="error-field">${e}:</span>\n                  <span class="error-message">${t}</span>\n                </div>\n              `).join("")}\n            `:'\n              <div class="empty-state">\n                <div class="empty-icon">âœ…</div>\n                <div class="empty-text">No validation errors</div>\n              </div>\n            '}\n          </div>\n        </div>\n      </div>\n    `}getRawDataContent(){const e=te.getState();return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="json-viewer">\n            <pre><code>${JSON.stringify(e,null,2)}</code></pre>\n          </div>\n        </div>\n      </div>\n    `}getActions(){return[{label:"Fill Test Data",action:()=>this.fillTestData(),variant:"primary"},{label:"Validate Form",action:()=>this.validateForm(),variant:"secondary"},{label:"Clear Errors",action:()=>this.clearErrors(),variant:"secondary"},{label:"Reset Checkout",action:()=>this.resetCheckout(),variant:"danger"},{label:"Export State",action:()=>this.exportState(),variant:"secondary"}]}renderFormFields(e){return["email","fname","lname","address1","city","province","postal","phone","country"].map(t=>{const i=this.hasFieldValue(e,t),n=e.errors&&e.errors[t];return`\n        <div class="field-status-card ${i?"filled":"empty"} ${n?"error":""}">\n          <div class="field-name">${this.formatFieldName(t)}</div>\n          <div class="field-status">\n            ${i?"âœ…":"â³"}\n            ${n?" âŒ":""}\n          </div>\n        </div>\n      `}).join("")}hasFieldValue(e,t){return e.formData&&e.formData[t]?e.formData[t].toString().trim().length>0:!(!e.billingAddress||!e.billingAddress[t])&&e.billingAddress[t].toString().trim().length>0}formatFieldName(e){return{fname:"First Name",lname:"Last Name",email:"Email",phone:"Phone",address1:"Address",address2:"Address 2",city:"City",province:"State/Province",postal:"Postal Code",country:"Country",accepts_marketing:"Accepts Marketing"}[e]||e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase()).trim()}fillTestData(){const e=te.getState(),t={email:"test@test.com",fname:"Test",lname:"Order",phone:"+14807581224",address1:"Test Address 123",address2:"",city:"Tempe",province:"AZ",postal:"85281",country:"US",accepts_marketing:!1};e.clearAllErrors(),e.updateFormData(t),e.setPaymentMethod("credit-card"),e.setSameAsShipping(!0),e.setShippingMethod({id:1,name:"Standard Shipping",price:0,code:"standard"}),document.dispatchEvent(new CustomEvent("debug:update-content")),setTimeout(()=>{document.dispatchEvent(new CustomEvent("checkout:test-data-filled",{detail:t}))},100)}validateForm(){const e=te.getState(),t=e.formData;let i=!1;e.clearAllErrors(),["email","fname","lname","address1","city","country"].forEach(n=>{t[n]&&""!==t[n].toString().trim()||(e.setError(n,`${this.formatFieldName(n)} is required`),i=!0)}),document.dispatchEvent(new CustomEvent("debug:update-content"))}clearErrors(){te.getState().clearAllErrors(),document.dispatchEvent(new CustomEvent("debug:update-content"))}resetCheckout(){if(confirm("Are you sure you want to reset the checkout state?")){te.getState().reset(),document.dispatchEvent(new CustomEvent("debug:update-content"))}}exportState(){const e=te.getState(),t=JSON.stringify(e,null,2),i=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(i),a=document.createElement("a");a.href=n,a.download=`checkout-state-${(new Date).toISOString()}.json`,a.click(),URL.revokeObjectURL(n)}}class wa{constructor(){this.id="storage",this.title="Storage",this.icon="ðŸ’¾"}getContent(){const e=this.getTabs();return e[0]?.getContent()||""}getTabs(){return[{id:"overview",label:"Overview",icon:"ðŸ“Š",getContent:()=>this.getOverviewContent()},{id:"next-data",label:"Next Data",icon:"ðŸ·ï¸",getContent:()=>this.getNextContent()},{id:"local-storage",label:"Local Storage",icon:"ðŸ’¾",getContent:()=>this.getLocalStorageContent()},{id:"session-storage",label:"Session Storage",icon:"â°",getContent:()=>this.getSessionStorageContent()}]}getOverviewContent(){const e=this.getLocalStorageData(),t=this.getSessionStorageData();return`\n      <div class="enhanced-panel">\n        <div class="metrics-grid">\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ’¾</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.length}</div>\n              <div class="metric-label">LocalStorage Items</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">â°</div>\n            <div class="metric-content">\n              <div class="metric-value">${t.length}</div>\n              <div class="metric-label">SessionStorage Items</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ“Š</div>\n            <div class="metric-content">\n              <div class="metric-value">${this.getStorageSize()}KB</div>\n              <div class="metric-label">Total Size</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ·ï¸</div>\n            <div class="metric-content">\n              <div class="metric-value">${this.getNextItems().length}</div>\n              <div class="metric-label">Next Items</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}getNextContent(){return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="storage-items">\n            ${0===this.getNextItems().length?'\n              <div class="empty-state">\n                <div class="empty-icon">ðŸ’¾</div>\n                <div class="empty-text">No Next storage items found</div>\n              </div>\n            ':`\n              ${this.getNextItems().map(e=>`\n                <div class="storage-item-card next-item">\n                  <div class="storage-item-header">\n                    <span class="storage-key">${e.key}</span>\n                    <span class="storage-type ${e.type}">${e.type}</span>\n                    <button class="storage-delete-btn" onclick="window.nextDebug.deleteStorageItem('${e.key}', '${e.type}')">Ã—</button>\n                  </div>\n                  <div class="storage-item-size">${e.size} bytes</div>\n                  <div class="storage-item-value">\n                    <pre><code>${e.formattedValue}</code></pre>\n                  </div>\n                </div>\n              `).join("")}\n            `}\n          </div>\n        </div>\n      </div>\n    `}getLocalStorageContent(){const e=this.getLocalStorageData();return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="storage-items">\n            ${0===e.length?'\n              <div class="empty-state">\n                <div class="empty-icon">ðŸ’¾</div>\n                <div class="empty-text">No localStorage items</div>\n              </div>\n            ':`\n              ${e.map(e=>`\n                <div class="storage-item-card ${e.key.includes("next")?"next-item":""}">\n                  <div class="storage-item-header">\n                    <span class="storage-key">${e.key}</span>\n                    <span class="storage-type local">local</span>\n                    <button class="storage-delete-btn" onclick="window.nextDebug.deleteStorageItem('${e.key}', 'local')">Ã—</button>\n                  </div>\n                  <div class="storage-item-size">${e.size} bytes</div>\n                  <div class="storage-item-value">\n                    <pre><code>${e.formattedValue}</code></pre>\n                  </div>\n                </div>\n              `).join("")}\n            `}\n          </div>\n        </div>\n      </div>\n    `}getSessionStorageContent(){const e=this.getSessionStorageData();return`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="storage-items">\n            ${0===e.length?'\n              <div class="empty-state">\n                <div class="empty-icon">â°</div>\n                <div class="empty-text">No sessionStorage items</div>\n              </div>\n            ':`\n              ${e.map(e=>`\n                <div class="storage-item-card ${e.key.includes("next")?"next-item":""}">\n                  <div class="storage-item-header">\n                    <span class="storage-key">${e.key}</span>\n                    <span class="storage-type session">session</span>\n                    <button class="storage-delete-btn" onclick="window.nextDebug.deleteStorageItem('${e.key}', 'session')">Ã—</button>\n                  </div>\n                  <div class="storage-item-size">${e.size} bytes</div>\n                  <div class="storage-item-value">\n                    <pre><code>${e.formattedValue}</code></pre>\n                  </div>\n                </div>\n              `).join("")}\n            `}\n          </div>\n        </div>\n      </div>\n    `}getActions(){return[{label:"Clear Next Data",action:()=>this.clearNextStorage(),variant:"danger"},{label:"Clear All Local",action:()=>this.clearLocalStorage(),variant:"danger"},{label:"Clear All Session",action:()=>this.clearSessionStorage(),variant:"danger"},{label:"Export Storage",action:()=>this.exportStorage(),variant:"secondary"}]}getLocalStorageData(){const e=[];for(let t=0;t<localStorage.length;t++){const i=localStorage.key(t);if(i){const t=localStorage.getItem(i)||"";e.push({key:i,value:t,size:new Blob([t]).size,formattedValue:this.formatValue(t)})}}return e.sort((e,t)=>e.key.localeCompare(t.key))}getSessionStorageData(){const e=[];for(let t=0;t<sessionStorage.length;t++){const i=sessionStorage.key(t);if(i){const t=sessionStorage.getItem(i)||"";e.push({key:i,value:t,size:new Blob([t]).size,formattedValue:this.formatValue(t)})}}return e.sort((e,t)=>e.key.localeCompare(t.key))}getNextItems(){const e=[];for(let t=0;t<localStorage.length;t++){const i=localStorage.key(t);if(i&&(i.includes("next")||i.includes("29next")||i.includes("campaign"))){const t=localStorage.getItem(i)||"";e.push({key:i,value:t,size:new Blob([t]).size,formattedValue:this.formatValue(t),type:"local"})}}for(let t=0;t<sessionStorage.length;t++){const i=sessionStorage.key(t);if(i&&(i.includes("next")||i.includes("29next")||i.includes("campaign"))){const t=sessionStorage.getItem(i)||"";e.push({key:i,value:t,size:new Blob([t]).size,formattedValue:this.formatValue(t),type:"session"})}}return e.sort((e,t)=>e.key.localeCompare(t.key))}formatValue(e){try{const t=JSON.parse(e);return JSON.stringify(t,null,2)}catch{return e.length>200?e.substring(0,200)+"...":e}}getStorageSize(){let e=0;for(let t=0;t<localStorage.length;t++){const i=localStorage.key(t);if(i){const t=localStorage.getItem(i)||"";e+=new Blob([i+t]).size}}for(let t=0;t<sessionStorage.length;t++){const i=sessionStorage.key(t);if(i){const t=sessionStorage.getItem(i)||"";e+=new Blob([i+t]).size}}return Math.round(e/1024)}clearNextStorage(){if(confirm("Are you sure you want to clear all Next storage data?")){this.getNextItems().forEach(e=>{"local"===e.type?localStorage.removeItem(e.key):sessionStorage.removeItem(e.key)}),document.dispatchEvent(new CustomEvent("debug:update-content"))}}clearLocalStorage(){confirm("Are you sure you want to clear ALL localStorage data?")&&(localStorage.clear(),document.dispatchEvent(new CustomEvent("debug:update-content")))}clearSessionStorage(){confirm("Are you sure you want to clear ALL sessionStorage data?")&&(sessionStorage.clear(),document.dispatchEvent(new CustomEvent("debug:update-content")))}exportStorage(){const e={localStorage:this.getLocalStorageData(),sessionStorage:this.getSessionStorageData(),timestamp:(new Date).toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=`storage-data-${(new Date).toISOString()}.json`,n.click(),URL.revokeObjectURL(i)}}class Sa{constructor(){this.id="campaign",this.title="Campaign Data",this.icon="ðŸ“Š"}getContent(){const e=this.getTabs();return e[0]?.getContent()||""}getTabs(){return[{id:"overview",label:"Overview",icon:"ðŸ“Š",getContent:()=>this.getOverviewContent()},{id:"packages",label:"Packages",icon:"ðŸ“¦",getContent:()=>this.getPackagesContent()},{id:"shipping",label:"Shipping",icon:"ðŸšš",getContent:()=>this.getShippingContent()},{id:"raw",label:"Raw Data",icon:"ðŸ”§",getContent:()=>this.getRawDataContent()}]}getOverviewContent(){const e=Y.getState().data;return e?`\n      <div class="enhanced-panel">\n        ${this.getCampaignOverview(e)}\n      </div>\n    `:'\n        <div class="enhanced-panel">\n          <div class="empty-state">\n            <div class="empty-icon">ðŸ“Š</div>\n            <div class="empty-text">No campaign data loaded</div>\n            <button class="empty-action" onclick="window.nextDebug.loadCampaign()">Load Campaign</button>\n          </div>\n        </div>\n      '}getPackagesContent(){const e=Y.getState(),t=Q.getState(),i=e.data;return i?`\n      <div class="enhanced-panel">\n        ${this.getPackagesSection(i.packages,t)}\n      </div>\n    `:'\n        <div class="enhanced-panel">\n          <div class="empty-state">\n            <div class="empty-icon">ðŸ“¦</div>\n            <div class="empty-text">No campaign data loaded</div>\n          </div>\n        </div>\n      '}getShippingContent(){const e=Y.getState().data;return e?`\n      <div class="enhanced-panel">\n        ${this.getShippingMethodsSection(e.shipping_methods)}\n      </div>\n    `:'\n        <div class="enhanced-panel">\n          <div class="empty-state">\n            <div class="empty-icon">ðŸšš</div>\n            <div class="empty-text">No campaign data loaded</div>\n          </div>\n        </div>\n      '}getRawDataContent(){const e=Y.getState().data;return e?`\n      <div class="enhanced-panel">\n        <div class="section">\n          <div class="json-viewer">\n            <pre><code>${JSON.stringify(e,null,2)}</code></pre>\n          </div>\n        </div>\n      </div>\n    `:'\n        <div class="enhanced-panel">\n          <div class="empty-state">\n            <div class="empty-icon">ðŸ”§</div>\n            <div class="empty-text">No campaign data loaded</div>\n          </div>\n        </div>\n      '}getCampaignOverview(e){return`\n      <div class="campaign-overview">\n        <div class="campaign-header">\n          <h2 class="campaign-name">${e.name}</h2>\n          <div class="campaign-badges">\n            <span class="campaign-badge currency">${e.currency}</span>\n            <span class="campaign-badge language">${e.language.toUpperCase()}</span>\n          </div>\n        </div>\n        \n        <div class="metrics-grid">\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ“¦</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.packages.length}</div>\n              <div class="metric-label">Total Packages</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸšš</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.shipping_methods.length}</div>\n              <div class="metric-label">Shipping Methods</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ”„</div>\n            <div class="metric-content">\n              <div class="metric-value">${e.packages.filter(e=>e.is_recurring).length}</div>\n              <div class="metric-label">Recurring Items</div>\n            </div>\n          </div>\n          <div class="metric-card">\n            <div class="metric-icon">ðŸ’°</div>\n            <div class="metric-content">\n              <div class="metric-value">${this.getPriceRange(e.packages)}</div>\n              <div class="metric-label">Price Range</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}getPackagesSection(e,t){return`\n      <div class="section">\n        <div class="section-header">\n          <h3 class="section-title">Available Packages</h3>\n          <div class="section-controls">\n            <button class="sort-btn" onclick="window.nextDebug.sortPackages('price')">Sort by Price</button>\n            <button class="sort-btn" onclick="window.nextDebug.sortPackages('name')">Sort by Name</button>\n          </div>\n        </div>\n        \n        <div class="packages-grid">\n          ${e.map(e=>this.getPackageCard(e,t)).join("")}\n        </div>\n      </div>\n    `}getPackageCard(e,t){const i=t.items.some(t=>t.packageId===e.ref_id),n=t.items.find(t=>t.packageId===e.ref_id),a=parseFloat(e.price_retail_total)-parseFloat(e.price_total),s=Math.round(a/parseFloat(e.price_retail_total)*100);return`\n      <div class="package-card ${i?"in-cart":""}" data-package-id="${e.ref_id}">\n        <div class="package-image-container">\n          <img src="${e.image}" alt="${e.name}" class="package-image" loading="lazy" />\n          ${e.is_recurring?'<div class="recurring-badge">ðŸ”„ Recurring</div>':""}\n          ${i?`<div class="cart-badge">In Cart (${n?.quantity||0})</div>`:""}\n        </div>\n        \n        <div class="package-info">\n          <div class="package-header">\n            <h4 class="package-name">${e.name}</h4>\n            <div class="package-id">ID: ${e.ref_id}</div>\n          </div>\n          \n          <div class="package-details">\n            <div class="package-qty">Quantity: ${e.qty}</div>\n            <div class="package-external-id">External ID: ${e.external_id}</div>\n          </div>\n          \n          <div class="package-pricing">\n            <div class="price-row">\n              <span class="price-label">Sale Price:</span>\n              <span class="price-value sale-price">$${e.price_total}</span>\n            </div>\n            ${e.price_retail_total!==e.price_total?`\n              <div class="price-row">\n                <span class="price-label">Retail Price:</span>\n                <span class="price-value retail-price">$${e.price_retail_total}</span>\n              </div>\n              <div class="savings">\n                Save $${a.toFixed(2)} (${s}%)\n              </div>\n            `:""}\n            \n            ${e.is_recurring&&e.price_recurring?`\n              <div class="recurring-pricing">\n                <div class="price-row recurring">\n                  <span class="price-label">Recurring:</span>\n                  <span class="price-value recurring-price">\n                    $${e.price_recurring_total}/${e.interval}\n                  </span>\n                </div>\n              </div>\n            `:""}\n          </div>\n          \n          <div class="package-actions">\n            ${i?`\n              <button class="package-btn remove-btn" onclick="window.nextDebug.removeFromCart(${e.ref_id})">\n                Remove from Cart\n              </button>\n              <div class="qty-controls">\n                <button onclick="window.nextDebug.updateQuantity(${e.ref_id}, ${(n?.quantity||1)-1})">-</button>\n                <span>${n?.quantity||0}</span>\n                <button onclick="window.nextDebug.updateQuantity(${e.ref_id}, ${(n?.quantity||1)+1})">+</button>\n              </div>\n            `:`\n              <button class="package-btn add-btn" onclick="window.nextDebug.addToCart(${e.ref_id})">\n                Add to Cart - $${e.price_total}\n              </button>\n            `}\n            <button class="package-btn inspect-btn" onclick="window.nextDebug.inspectPackage(${e.ref_id})">\n              Inspect\n            </button>\n          </div>\n        </div>\n      </div>\n    `}getShippingMethodsSection(e){return`\n      <div class="section">\n        <h3 class="section-title">Shipping Methods</h3>\n        \n        <div class="shipping-methods">\n          ${e.map(e=>`\n            <div class="shipping-method-card">\n              <div class="shipping-info">\n                <div class="shipping-name">${e.code}</div>\n                <div class="shipping-id">ID: ${e.ref_id}</div>\n              </div>\n              <div class="shipping-price">\n                ${0===parseFloat(e.price)?"FREE":`$${e.price}`}\n              </div>\n              <button class="shipping-test-btn" onclick="window.nextDebug.testShippingMethod(${e.ref_id})">\n                Test\n              </button>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `}getPriceRange(e){const t=e.map(e=>parseFloat(e.price_total)).filter(e=>e>0);if(0===t.length)return"Free";const i=Math.min(...t),n=Math.max(...t);return i===n?`$${i}`:`$${i} - $${n}`}getActions(){return[{label:"Refresh Campaign",action:()=>{const e=oe.getState(),t=Y.getState();e.apiKey&&t.loadCampaign(e.apiKey)},variant:"primary"},{label:"Export Packages",action:()=>this.exportPackages(),variant:"secondary"},{label:"Test All Packages",action:()=>this.testAllPackages(),variant:"secondary"},{label:"Clear Cart",action:()=>Q.getState().clear(),variant:"danger"}]}exportPackages(){const e=Y.getState().data;if(!e)return;const t={campaign:e.name,packages:e.packages,shipping_methods:e.shipping_methods,export_date:(new Date).toISOString()},i=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=URL.createObjectURL(i),a=document.createElement("a");a.href=n,a.download=`campaign-packages-${e.name.toLowerCase().replace(/\s+/g,"-")}.json`,a.click(),URL.revokeObjectURL(n)}testAllPackages(){const e=Y.getState(),t=Q.getState(),i=e.data;i&&i.packages.slice(0,3).forEach(e=>{t.addItem({packageId:e.ref_id,quantity:1,title:e.name,isUpsell:!1})})}}const _a=class e{constructor(){this.visible=!1,this.isExpanded=!1,this.container=null,this.activePanel="cart",this.updateInterval=null,this.logger=new N("DebugOverlay"),this.panels=[],this.handleContainerClick=t=>{const i=t.target,n=i.getAttribute("data-action")||i.closest("[data-action]")?.getAttribute("data-action");if(n){switch(n){case"toggle-expand":this.isExpanded=!this.isExpanded,localStorage.setItem(e.EXPANDED_STORAGE_KEY,this.isExpanded.toString()),this.updateBodyHeight(),this.updateOverlay();break;case"close":this.hide();break;case"clear-cart":this.clearCart();break;case"export-data":this.exportAllData();break;case"toggle-mini-cart":this.toggleMiniCart();break;case"toggle-xray":this.toggleXray()}return}const a=i.closest(".debug-panel-tab");if(a){const e=a.getAttribute("data-panel");return void(e&&e!==this.activePanel&&(this.activePanel=e,this.activePanelTab=void 0,this.updateOverlay()))}const s=i.closest(".horizontal-tab");if(s){const e=s.getAttribute("data-panel-tab");return void(e&&e!==this.activePanelTab&&(this.activePanelTab=e,this.updateOverlay()))}const r=i.closest(".panel-action-btn");if(r){const e=r.getAttribute("data-panel-action"),t=this.panels.find(e=>e.id===this.activePanel),i=t?.getActions?.()?.find(t=>t.label===e);return void(i&&(i.action(),setTimeout(()=>this.updateContent(),100)))}},this.eventManager=new pa,this.initializePanels(),this.setupEventListeners();"true"===localStorage.getItem(e.EXPANDED_STORAGE_KEY)&&(this.isExpanded=!0)}static getInstance(){return e.instance||(e.instance=new e),e.instance}initializePanels(){this.panels=[new fa,new ba,new Sa,new xa,new va,new wa]}setupEventListeners(){document.addEventListener("debug:update-content",()=>{this.updateContent()})}initialize(){"true"===new URLSearchParams(window.location.search).get("debugger")&&(this.show(),this.logger.info("Debug overlay initialized"))}async show(){if(this.visible)return;if(this.visible=!0,await this.createOverlay(),this.startAutoUpdate(),ma.initialize(),ma.isXrayActive()){const e=this.container?.querySelector('[data-action="toggle-xray"]');e&&(e.classList.add("active"),e.setAttribute("title","Disable X-Ray View"))}"true"===localStorage.getItem("debug-mini-cart-visible")&&this.toggleMiniCart()}hide(){this.visible&&(this.visible=!1,this.stopAutoUpdate(),document.body.classList.remove("debug-body-expanded"),document.documentElement.classList.remove("debug-body-expanded"),this.container&&(this.container.remove(),this.container=null),ha.removeStyles())}async toggle(){this.visible?this.hide():await this.show()}isVisible(){return this.visible}async createOverlay(){const{DebugStyleLoader:e}=await Promise.resolve().then(()=>Oa);await e.loadDebugStyles(),this.container=document.createElement("div"),this.container.className="debug-overlay",this.updateOverlay(),this.addEventListeners(),document.body.appendChild(this.container)}updateOverlay(){this.container&&(this.panels=this.panels.map(e=>"events"===e.id?new ya(this.eventManager.getEvents()):e),this.container.innerHTML=ha.createOverlayHTML(this.panels,this.activePanel,this.isExpanded,this.activePanelTab),this.addEventListeners(),this.updateButtonStates())}updateContent(){if(!this.container)return;const e=this.container.querySelector(".panel-content");if(e){const t=this.panels.find(e=>e.id===this.activePanel);if(t){const i=t.getTabs?.()||[];if(i.length>0){const t=this.activePanelTab||i[0]?.id,n=i.find(e=>e.id===t)||i[0];n&&(e.innerHTML=n.getContent())}else e.innerHTML=t.getContent()}}}addEventListeners(){this.container&&(this.container.removeEventListener("click",this.handleContainerClick),this.container.addEventListener("click",this.handleContainerClick))}updateBodyHeight(){this.isExpanded?(document.body.classList.add("debug-body-expanded"),document.documentElement.classList.add("debug-body-expanded")):(document.body.classList.remove("debug-body-expanded"),document.documentElement.classList.remove("debug-body-expanded"))}startAutoUpdate(){this.updateInterval=window.setInterval(()=>{this.updateQuickStats(),"cart"!==this.activePanel&&"config"!==this.activePanel||this.updateContent()},1e3)}stopAutoUpdate(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null)}getEventManager(){return this.eventManager}getPanels(){return this.panels}setActivePanel(e){this.panels.find(t=>t.id===e)&&(this.activePanel=e,this.updateOverlay())}logEvent(e,t,i="Manual"){this.eventManager.logEvent(e,t,i)}clearCart(){Q.getState().clear(),this.updateContent()}exportAllData(){const e={timestamp:(new Date).toISOString(),cart:Q.getState(),config:oe.getState(),events:this.eventManager.getEvents(),url:window.location.href,userAgent:navigator.userAgent},t=JSON.stringify(e,null,2),i=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(i),a=document.createElement("a");a.href=n,a.download=`debug-session-${(new Date).toISOString()}.json`,a.click(),URL.revokeObjectURL(n)}toggleMiniCart(){let e=document.getElementById("debug-mini-cart-display");if(e)e.classList.toggle("show"),localStorage.setItem("debug-mini-cart-visible",e.classList.contains("show").toString()),e.classList.contains("show")&&this.updateMiniCart();else{e=document.createElement("div"),e.id="debug-mini-cart-display",e.className="debug-mini-cart-display",document.body.appendChild(e),Q.subscribe(()=>{e&&e.classList.contains("show")&&this.updateMiniCart()});"true"===localStorage.getItem("debug-mini-cart-visible")&&(e.classList.add("show"),this.updateMiniCart())}const t=this.container?.querySelector('[data-action="toggle-mini-cart"]');t&&e&&(e.classList.contains("show")?(t.classList.add("active"),t.setAttribute("title","Hide Mini Cart")):(t.classList.remove("active"),t.setAttribute("title","Toggle Mini Cart")))}updateMiniCart(){const e=document.getElementById("debug-mini-cart-display");if(!e||!e.classList.contains("show"))return;const t=Q.getState();if(!t.items||0===t.items.length)return void(e.innerHTML="\n        <div class=\"debug-mini-cart-header\">\n          <span>ðŸ›’ Debug Cart</span>\n          <button class=\"mini-cart-close\" onclick=\"document.getElementById('debug-mini-cart-display').classList.remove('show'); localStorage.setItem('debug-mini-cart-visible', 'false')\">Ã—</button>\n        </div>\n        <div class=\"debug-mini-cart-empty\">Cart empty</div>\n      ");let i="";t.items.forEach(e=>{const t=e.is_upsell?'<span class="mini-cart-upsell-badge">UPSELL</span>':"";i+=`\n        <div class="debug-mini-cart-item">\n          <div class="mini-cart-item-info">\n            <span class="mini-cart-item-id">ID: ${e.packageId}</span>\n            ${t}\n            <span class="mini-cart-item-qty">Ã—${e.quantity}</span>\n          </div>\n          <div class="mini-cart-item-title">${e.title||"Unknown"}</div>\n          <div class="mini-cart-item-price">$${(e.price*e.quantity).toFixed(2)}</div>\n        </div>\n      `}),e.innerHTML=`\n      <div class="debug-mini-cart-header">\n        <span>ðŸ›’ Debug Cart</span>\n        <button class="mini-cart-close" onclick="document.getElementById('debug-mini-cart-display').classList.remove('show'); localStorage.setItem('debug-mini-cart-visible', 'false')">Ã—</button>\n      </div>\n      <div class="debug-mini-cart-items">${i}</div>\n      <div class="debug-mini-cart-footer">\n        <div class="mini-cart-stat">\n          <span>Items:</span>\n          <span>${t.totalQuantity}</span>\n        </div>\n        <div class="mini-cart-stat">\n          <span>Total:</span>\n          <span class="mini-cart-total">${t.totals.total.formatted}</span>\n        </div>\n      </div>\n    `}toggleXray(){const e=ma.toggle(),t=this.container?.querySelector('[data-action="toggle-xray"]');t&&(e?(t.classList.add("active"),t.setAttribute("title","Disable X-Ray View")):(t.classList.remove("active"),t.setAttribute("title","Toggle X-Ray View"))),this.eventManager.logEvent("debug:xray-toggled",{active:e},"Debug")}updateButtonStates(){if(ma.isXrayActive()){const e=this.container?.querySelector('[data-action="toggle-xray"]');e&&(e.classList.add("active"),e.setAttribute("title","Disable X-Ray View"))}const e=document.getElementById("debug-mini-cart-display");if(e&&e.classList.contains("show")){const e=this.container?.querySelector('[data-action="toggle-mini-cart"]');e&&(e.classList.add("active"),e.setAttribute("title","Hide Mini Cart"))}}updateQuickStats(){if(!this.container)return;const e=Q.getState(),t=this.container.querySelector('[data-debug-stat="cart-items"]'),i=this.container.querySelector('[data-debug-stat="cart-total"]'),n=this.container.querySelector('[data-debug-stat="enhanced-elements"]');t&&(t.textContent=e.totalQuantity.toString()),i&&(i.textContent=e.totals.total.formatted),n&&(n.textContent=document.querySelectorAll("[data-next-]").length.toString())}};_a.EXPANDED_STORAGE_KEY="debug-overlay-expanded";let ka=_a;const Ca=ka.getInstance();"undefined"!=typeof window&&document.addEventListener("DOMContentLoaded",()=>{Ca.initialize()});const Ea=Object.freeze(Object.defineProperty({__proto__:null,DebugOverlay:ka,debugOverlay:Ca},Symbol.toStringTag,{value:"Module"}));R("Analytics");const Ia=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"})),Pa=".enhanced-debug-overlay{position:fixed;bottom:0;left:0;right:0;z-index:999999;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,SF Pro Display,sans-serif;font-size:13px;line-height:1.4;color:#fff;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 -4px 32px #0000004d}.enhanced-debug-overlay.collapsed{height:60px}.enhanced-debug-overlay.expanded{height:40vh;min-height:450px;max-height:calc(100vh - 120px)}body:has(.enhanced-debug-overlay.expanded){padding-bottom:40vh}.debug-body-expanded{padding-bottom:40vh!important;box-sizing:border-box}html.debug-body-expanded{overflow-x:hidden}.debug-bottom-bar{display:flex;align-items:center;justify-content:space-between;height:60px;background:linear-gradient(135deg,#1a1a1a,#2d2d2d);border-top:1px solid #3C7DFF;padding:0 20px;backdrop-filter:blur(20px)}.debug-logo-section{display:flex;align-items:center;gap:12px}.debug-logo{color:#3c7dff;filter:drop-shadow(0 0 8px rgba(60,125,255,.3))}.debug-title{font-weight:600;font-size:16px;color:#fff;letter-spacing:-.2px}.debug-status{display:flex;align-items:center;gap:6px;margin-left:12px;padding:4px 8px;background:#3c7dff1a;border-radius:12px;border:1px solid rgba(60,125,255,.2)}.status-indicator{width:6px;height:6px;border-radius:50%;background:#0f8;box-shadow:0 0 6px #0f8;animation:pulse 2s infinite}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.status-text{font-size:11px;color:#3c7dff;font-weight:500}.debug-quick-stats{display:flex;align-items:center;gap:24px}.stat-item{display:flex;flex-direction:column;align-items:center;gap:2px}.stat-value{font-size:16px;font-weight:700;color:#3c7dff;min-width:40px;text-align:center}.stat-label{font-size:10px;color:#888;text-transform:uppercase;font-weight:500;letter-spacing:.5px}.debug-controls{display:flex;align-items:center;gap:8px}.debug-control-btn,.debug-expand-btn{width:36px;height:36px;border:none;border-radius:8px;background:#ffffff1a;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;position:relative;overflow:hidden}.debug-control-btn:hover,.debug-expand-btn:hover{background:#3c7dff33;transform:translateY(-1px);box-shadow:0 4px 12px #3c7dff4d}.debug-control-btn.active{background:#3c7dff4d;color:#87b4ff;box-shadow:inset 0 0 0 1px #3c7dff80}.debug-control-btn.active:hover{background:#3c7dff66}.debug-expand-btn{background:#3c7dff;color:#fff}.debug-expand-btn:hover{background:#2563eb;transform:translateY(-1px) scale(1.05)}.expand-icon{transition:transform .3s ease}.expand-icon.rotated{transform:rotate(180deg)}.close-btn:hover{background:#ff475733!important;color:#ff4757}.debug-expanded-content{display:flex;height:calc(100% - 60px);background:#1a1a1a}.debug-highlight{outline:2px solid #3C7DFF!important;outline-offset:2px!important;background:#3c7dff1a!important;position:relative!important;z-index:999998!important}.debug-highlight:after{content:attr(data-debug-label);position:absolute;top:-30px;left:0;background:#3c7dff;color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:500;white-space:nowrap;z-index:999999}@media (max-width: 768px){.debug-quick-stats{display:none}.debug-bottom-bar{padding:0 12px}}@media (max-width: 640px){.debug-title{display:none}}",Aa='.debug-sidebar{width:240px;background:linear-gradient(180deg,#222,#1a1a1a);border-right:1px solid #333;display:flex;flex-direction:column}.debug-panel-tabs{flex:1;padding:16px 0}.debug-panel-tab{width:100%;display:flex;align-items:center;gap:12px;padding:12px 20px;border:none;background:none;color:#888;cursor:pointer;transition:all .2s ease;position:relative;font-size:14px}.debug-panel-tab:hover{background:#3c7dff1a;color:#fff}.debug-panel-tab.active{background:#3c7dff26;color:#3c7dff;border-right:3px solid #3C7DFF}.debug-panel-tab.active:before{content:"";position:absolute;left:0;top:0;bottom:0;width:3px;background:#3c7dff}.tab-icon{font-size:16px;width:20px;text-align:center}.tab-label{font-weight:500;flex:1}.tab-badge{background:#3c7dff;color:#fff;font-size:10px;font-weight:600;padding:2px 6px;border-radius:10px;min-width:16px;text-align:center}.debug-sidebar-footer{padding:16px;border-top:1px solid #333;display:flex;flex-direction:column;gap:8px}.sidebar-btn{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #333;border-radius:6px;background:#ffffff0d;color:#888;cursor:pointer;font-size:12px;transition:all .2s ease}.sidebar-btn:hover{background:#3c7dff1a;border-color:#3c7dff;color:#3c7dff}@media (max-width: 768px){.debug-sidebar{width:200px}}@media (max-width: 640px){.debug-sidebar{width:180px}}',La=".debug-main-content{flex:1;background:#1a1a1a;overflow:hidden;display:flex;flex-direction:column}.debug-panel-container{flex:1;display:flex;flex-direction:column;height:100%}.panel-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid #333;background:linear-gradient(135deg,#222,#1a1a1a)}.panel-title{display:flex;align-items:center;gap:12px}.panel-icon{font-size:20px}.panel-title h2{margin:0;font-size:18px;font-weight:600;color:#fff}.panel-actions{display:flex;gap:8px}.panel-action-btn{padding:8px 16px;border:none;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s ease}.panel-action-btn.primary{background:#3c7dff;color:#fff}.panel-action-btn.secondary{background:#ffffff1a;color:#fff;border:1px solid #333}.panel-action-btn.danger{background:#ff47571a;color:#ff4757;border:1px solid rgba(255,71,87,.3)}.panel-action-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px #0000004d}.panel-action-btn.primary:hover{background:#2563eb}.panel-action-btn.secondary:hover{background:#ffffff26}.panel-action-btn.danger:hover{background:#ff475733}.panel-horizontal-tabs{display:flex;background:#1a1a1a;border-bottom:1px solid #333;overflow-x:auto}.horizontal-tab{display:flex;align-items:center;gap:8px;padding:12px 20px;background:none;border:none;color:#888;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s ease;white-space:nowrap;border-bottom:2px solid transparent}.horizontal-tab:hover{background:#ffffff0d;color:#ccc}.horizontal-tab.active{color:#3c7dff;border-bottom-color:#3c7dff;background:#3c7dff0d}.horizontal-tab .tab-icon{font-size:14px}.horizontal-tab .tab-label{font-weight:500}.panel-content{flex:1;padding:24px;overflow-y:auto;color:#ccc}.panel-content>.enhanced-panel{margin-top:0}.panel-content>.enhanced-panel>*:first-child{margin-top:0}.panel-content .section:first-child,.panel-content .section:first-child .section-title,.panel-content h3:first-child,.panel-content .section-title:first-child,.panel-content h1,.panel-content h2,.panel-content h3,.panel-content h4,.panel-content h5,.panel-content h6{margin-top:0}.enhanced-panel{display:flex;flex-direction:column;gap:24px}.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px}.metric-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px;display:flex;align-items:center;gap:12px;transition:all .2s ease}.metric-card:hover{border-color:#3c7dff;box-shadow:0 4px 12px #3c7dff1a}.metric-icon{font-size:20px;width:32px;text-align:center}.metric-content{flex:1}.metric-value{font-size:18px;font-weight:700;color:#3c7dff;line-height:1}.metric-label{font-size:11px;color:#888;text-transform:uppercase;font-weight:500;letter-spacing:.5px;margin-top:2px}.section{display:flex;flex-direction:column;gap:16px}.section-title{font-size:16px;font-weight:600;color:#fff;margin:0;padding-bottom:8px;border-bottom:1px solid #333}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.section-controls{display:flex;gap:8px}.sort-btn{background:#ffffff1a;border:1px solid #333;color:#ccc;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer;transition:all .2s ease}.sort-btn:hover{background:#3c7dff1a;border-color:#3c7dff;color:#3c7dff}.empty-state{display:flex;flex-direction:column;align-items:center;gap:12px;padding:40px 20px;color:#888;text-align:center}.empty-icon{font-size:32px;opacity:.5}.empty-text{font-size:14px}.empty-action{background:#3c7dff;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500}.json-viewer{background:#0f0f0f;border:1px solid #333;border-radius:8px;overflow:hidden}.json-viewer pre{margin:0;padding:16px;overflow-x:auto;font-family:SF Mono,monospace;font-size:12px;line-height:1.6;color:#e6e6e6}.debug-metric{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #2a2a2a}.debug-metric:last-child{border-bottom:none}.metric-label{color:#888;font-weight:500}.metric-value{color:#3c7dff;font-family:SF Mono,monospace;font-weight:600}@media (max-width: 768px){.panel-header,.panel-content{padding:16px}.metrics-grid{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}}",Ta=".cart-items-list{display:flex;flex-direction:column;gap:8px}.cart-item-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px;display:flex;align-items:center;gap:16px}.item-info{flex:1}.item-title{font-weight:600;color:#fff;margin-bottom:4px}.item-details{font-size:12px;color:#888}.item-quantity{display:flex;align-items:center;gap:8px}.qty-btn{width:24px;height:24px;border:1px solid #333;background:#ffffff0d;color:#fff;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:600}.qty-btn:hover{background:#3c7dff1a;border-color:#3c7dff}.qty-value{font-weight:600;color:#3c7dff;min-width:20px;text-align:center}.item-total{font-weight:600;color:#3c7dff}.remove-btn{width:24px;height:24px;border:1px solid rgba(255,71,87,.3);background:#ff47571a;color:#ff4757;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:600}.remove-btn:hover{background:#ff475733}.elements-list{display:flex;flex-direction:column;gap:8px}.element-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px;cursor:pointer;transition:all .2s ease}.element-card:hover{border-color:#3c7dff;box-shadow:0 4px 12px #3c7dff1a}.element-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.element-tag{background:#3c7dff;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;text-transform:uppercase}.element-index{color:#888;font-size:12px}.element-attributes,.element-enhancers{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}.attribute-tag{background:#ffffff1a;color:#ccc;padding:2px 6px;border-radius:3px;font-size:10px;font-family:SF Mono,monospace}.enhancer-tag{background:#3c7dff33;color:#3c7dff;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:500}.requests-list{display:flex;flex-direction:column;gap:8px}.request-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px}.request-card.error{border-color:#ff47574d}.request-card.success{border-color:#00ff884d}.request-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}.request-method{padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600;text-transform:uppercase}.request-method.get{background:#0f83;color:#0f8}.request-method.post{background:#3c7dff33;color:#3c7dff}.request-method.put{background:#ffc10733;color:#ffc107}.request-method.delete{background:#ff475733;color:#ff4757}.request-url{flex:1;color:#ccc;font-family:SF Mono,monospace;font-size:12px}.request-status{padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600}.request-status.status-2xx{background:#0f83;color:#0f8}.request-status.status-4xx,.request-status.status-5xx{background:#ff475733;color:#ff4757}.request-time{color:#888;font-size:11px;font-family:SF Mono,monospace}.request-timestamp{color:#666;font-size:11px;margin-bottom:8px}.request-details summary{cursor:pointer;color:#3c7dff;font-size:12px;margin-top:8px}.request-data,.response-data{margin-top:12px}.request-data h4,.response-data h4{margin:0 0 8px;color:#fff;font-size:12px}.event-types{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}.event-type-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:6px;padding:12px;text-align:center;cursor:pointer;transition:all .2s ease}.event-type-card:hover{border-color:#3c7dff;box-shadow:0 2px 8px #3c7dff1a}.event-type-name{font-size:12px;color:#fff;font-weight:500}.event-type-count{font-size:16px;color:#3c7dff;font-weight:700;margin-top:4px}.events-timeline{display:flex;flex-direction:column;gap:12px}.timeline-event{display:flex;gap:16px;background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px}.event-time{color:#888;font-size:11px;font-family:SF Mono,monospace;white-space:nowrap;width:80px}.event-content{flex:1}.event-header{display:flex;align-items:center;gap:8px;margin-bottom:4px}.event-type-badge{background:#3c7dff;color:#fff;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600;text-transform:uppercase}.event-source{color:#888;font-size:10px;text-transform:uppercase;font-weight:500}.event-data-preview{color:#ccc;font-size:12px;font-family:SF Mono,monospace}.event-item{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px;margin-bottom:12px;transition:all .2s ease}.event-item:hover{border-color:#3c7dff;box-shadow:0 4px 12px #3c7dff1a}.event-item .event-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.event-type{background:#3c7dff;color:#fff;padding:4px 8px;border-radius:4px;font-size:10px;font-weight:600;text-transform:uppercase}.event-data{background:#0f0f0f;border-radius:4px;padding:12px;font-family:SF Mono,monospace;font-size:11px;color:#ccc;max-height:120px;overflow-y:auto}.debug-mini-cart-display{position:fixed;top:20px;right:20px;background:#000000f2;border:1px solid #333;border-radius:8px;padding:0;min-width:280px;max-width:350px;max-height:400px;box-shadow:0 8px 32px #00000080;font-family:SF Mono,monospace;font-size:12px;color:#ccc;z-index:10000;display:none;overflow:hidden}.debug-mini-cart-display.show{display:block}.debug-mini-cart-header{background:linear-gradient(135deg,#1a1a1a,#111);padding:12px 16px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;font-weight:600;color:#3c7dff}.debug-mini-cart-header span{display:flex;align-items:center;gap:8px}.mini-cart-close{background:transparent;border:none;color:#888;font-size:20px;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .2s ease}.mini-cart-close:hover{background:#ff475733;color:#ff4757}.debug-mini-cart-empty{padding:40px 20px;text-align:center;color:#666;font-style:italic}.debug-mini-cart-items{max-height:280px;overflow-y:auto;padding:8px}.debug-mini-cart-item{background:#ffffff08;border:1px solid rgba(255,255,255,.05);border-radius:6px;padding:10px;margin-bottom:6px;transition:all .2s ease}.debug-mini-cart-item:hover{background:#3c7dff0d;border-color:#3c7dff33}.debug-mini-cart-item:last-child{margin-bottom:0}.mini-cart-item-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}.mini-cart-item-id{color:#3c7dff;font-weight:600;font-size:11px}.mini-cart-item-qty{color:#ffc107;font-weight:600;font-size:11px}.mini-cart-upsell-badge{background:#ff4757;color:#fff;padding:1px 4px;border-radius:3px;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin:0 4px}.mini-cart-item-title{color:#fff;font-size:11px;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.mini-cart-item-price{color:#0f8;font-weight:600;font-size:12px;text-align:right}.debug-mini-cart-footer{background:linear-gradient(135deg,#1a1a1a,#111);border-top:1px solid #333;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}.mini-cart-stat{display:flex;align-items:center;gap:6px}.mini-cart-stat span:first-child{color:#888;font-size:11px}.mini-cart-stat span:last-child{color:#fff;font-weight:600}.mini-cart-total{color:#0f8!important;font-size:14px}.debug-mini-cart-items::-webkit-scrollbar{width:6px}.debug-mini-cart-items::-webkit-scrollbar-track{background:#ffffff05;border-radius:3px}.debug-mini-cart-items::-webkit-scrollbar-thumb{background:#3c7dff4d;border-radius:3px}.debug-mini-cart-items::-webkit-scrollbar-thumb:hover{background:#3c7dff80}",Da=".campaign-overview{background:linear-gradient(135deg,#2a2a2a,#1a1a1a);border:1px solid #333;border-radius:12px;padding:24px;margin-bottom:24px}.campaign-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.campaign-name{margin:0;font-size:24px;font-weight:700;color:#fff;background:linear-gradient(135deg,#3c7dff,#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.campaign-badges{display:flex;gap:8px}.campaign-badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}.campaign-badge.currency{background:#3c7dff33;color:#3c7dff}.campaign-badge.language{background:#0f83;color:#0f8}.packages-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;margin-bottom:32px}.package-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:12px;overflow:hidden;transition:all .3s ease;position:relative}.package-card:hover{border-color:#3c7dff;box-shadow:0 8px 32px #3c7dff1a;transform:translateY(-2px)}.package-card.in-cart{border-color:#0f8;background:linear-gradient(135deg,#00ff881a,#1a1a1a)}.package-image-container{position:relative;height:140px;background:#f8f9fa;display:flex;align-items:center;justify-content:center;overflow:hidden}.package-image{max-width:100%;max-height:100%;object-fit:contain}.recurring-badge,.cart-badge{position:absolute;top:8px;right:8px;background:#3c7dff;color:#fff;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600}.cart-badge{background:#0f8;color:#000;top:8px;left:8px}.package-info{padding:16px}.package-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}.package-name{margin:0;font-size:16px;font-weight:600;color:#fff;line-height:1.3}.package-id{font-size:11px;color:#888;font-family:SF Mono,monospace}.package-details{display:flex;gap:16px;margin-bottom:12px;font-size:12px;color:#888}.package-pricing{margin-bottom:16px}.price-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}.price-label{font-size:12px;color:#888}.price-value{font-weight:600;font-family:SF Mono,monospace}.sale-price{color:#3c7dff;font-size:16px}.retail-price{color:#888;text-decoration:line-through}.recurring-price{color:#ff6b6b}.savings{background:#00ff881a;color:#0f8;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;text-align:center;margin-top:8px}.recurring-pricing{border-top:1px solid #333;padding-top:8px;margin-top:8px}.package-actions{display:flex;gap:8px;align-items:center}.package-btn{padding:8px 12px;border:none;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s ease;flex:1}.add-btn{background:#3c7dff;color:#fff}.add-btn:hover{background:#2563eb}.remove-btn{background:#ff47571a;color:#ff4757;border:1px solid rgba(255,71,87,.3)}.remove-btn:hover{background:#ff475733}.inspect-btn{background:#ffffff1a;color:#ccc;border:1px solid #333;flex:0 0 auto}.inspect-btn:hover{background:#ffffff26;color:#fff}.qty-controls{display:flex;align-items:center;gap:8px;flex:0 0 auto}.qty-controls button{width:24px;height:24px;border:1px solid #333;background:#ffffff0d;color:#fff;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:600}.qty-controls span{font-weight:600;color:#3c7dff;min-width:20px;text-align:center}.shipping-methods{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:24px}.shipping-method-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px;display:flex;align-items:center;gap:16px;transition:all .2s ease}.shipping-method-card:hover{border-color:#3c7dff;box-shadow:0 4px 12px #3c7dff1a}.shipping-info{flex:1}.shipping-name{font-size:16px;font-weight:600;color:#fff;margin-bottom:4px}.shipping-id{font-size:11px;color:#888;font-family:SF Mono,monospace}.shipping-price{font-size:18px;font-weight:700;color:#3c7dff;font-family:SF Mono,monospace}.shipping-test-btn{background:#3c7dff1a;border:1px solid #3C7DFF;color:#3c7dff;padding:8px 16px;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s ease}.shipping-test-btn:hover{background:#3c7dff33}.raw-data-section{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;overflow:hidden}.raw-data-summary{padding:16px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none}.raw-data-summary:hover{background:#ffffff0d}.toggle-icon{color:#888;transition:transform .2s ease}.raw-data-section[open] .toggle-icon{transform:rotate(180deg)}.raw-data-section .json-viewer{border-top:1px solid #333;margin:0}@media (max-width: 768px){.packages-grid,.shipping-methods{grid-template-columns:1fr}.campaign-header{flex-direction:column;align-items:flex-start;gap:12px}.package-card{margin-bottom:16px}.package-actions{flex-direction:column;gap:8px}.package-btn{width:100%}}",Ma=".enhanced-panel{display:flex;flex-direction:column;gap:24px}.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px}.metric-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px;display:flex;align-items:center;gap:12px;transition:all .2s ease}.metric-card:hover{border-color:#3c7dff;box-shadow:0 4px 12px #3c7dff1a}.metric-icon{font-size:20px;width:32px;text-align:center}.metric-content{flex:1}.metric-value{font-size:18px;font-weight:700;color:#3c7dff;line-height:1}.metric-label{font-size:11px;color:#888;text-transform:uppercase;font-weight:500;letter-spacing:.5px;margin-top:2px}.section{display:flex;flex-direction:column;gap:16px}.section-title{font-size:16px;font-weight:600;color:#fff;margin:0;padding-bottom:8px;border-bottom:1px solid #333}.empty-state{display:flex;flex-direction:column;align-items:center;gap:12px;padding:40px 20px;color:#888;text-align:center}.empty-icon{font-size:32px;opacity:.5}.empty-text{font-size:14px}.empty-action{background:#3c7dff;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500}.config-groups{display:flex;flex-direction:column;gap:24px}.config-group{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:20px}.config-group-title{font-size:14px;font-weight:600;color:#fff;margin:0 0 16px;padding-bottom:8px;border-bottom:1px solid #333}.config-items{display:flex;flex-direction:column;gap:12px}.config-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0}.config-key{font-size:12px;color:#ccc;font-weight:500}.config-value{font-size:12px;color:#fff;font-family:SF Mono,monospace}.config-value.enabled{color:#0f8}.config-value.disabled{color:#888}.form-fields-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px}.field-status-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:6px;padding:12px;text-align:center;transition:all .2s ease}.field-status-card.filled{border-color:#00ff884d;background:linear-gradient(135deg,#00ff881a,#1a1a1a)}.field-status-card.error{border-color:#ff47574d;background:linear-gradient(135deg,#ff47571a,#1a1a1a)}.field-name{font-size:11px;color:#ccc;font-weight:500;margin-bottom:4px}.field-status{font-size:14px}.customer-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}.info-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px}.info-card h4{margin:0 0 12px;font-size:14px;color:#fff;font-weight:600}.info-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.info-label{font-size:12px;color:#888}.info-value{font-size:12px;color:#fff;font-family:SF Mono,monospace}.info-empty{color:#666;font-style:italic;font-size:12px}.address-info,.validation-errors{display:flex;flex-direction:column;gap:8px}.error-item{background:linear-gradient(135deg,#ff47571a,#1a1a1a);border:1px solid rgba(255,71,87,.3);border-radius:6px;padding:12px;display:flex;gap:8px}.error-field{font-weight:600;color:#ff4757;font-size:12px}.error-message{color:#ccc;font-size:12px}.storage-items{display:flex;flex-direction:column;gap:12px}.storage-item-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px;transition:all .2s ease}.storage-item-card.next-item{border-color:#3c7dff4d;background:linear-gradient(135deg,#3c7dff0d,#1a1a1a)}.storage-item-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}.storage-key{flex:1;font-family:SF Mono,monospace;font-size:12px;color:#fff;font-weight:500}.storage-type{padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600;text-transform:uppercase}.storage-type.local{background:#0f83;color:#0f8}.storage-type.session{background:#ffc10733;color:#ffc107}.storage-delete-btn{width:20px;height:20px;border:1px solid rgba(255,71,87,.3);background:#ff47571a;color:#ff4757;border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px}.storage-delete-btn:hover{background:#ff475733}.storage-item-size{font-size:10px;color:#666;margin-bottom:8px}.storage-item-value{background:#0f0f0f;border:1px solid #333;border-radius:4px;overflow:hidden}.storage-item-value pre{margin:0;padding:12px;overflow-x:auto;font-family:SF Mono,monospace;font-size:11px;line-height:1.4;color:#e6e6e6;max-height:200px;overflow-y:auto}.json-viewer{background:#0f0f0f;border:1px solid #333;border-radius:8px;overflow:hidden}.json-viewer pre{margin:0;padding:16px;overflow-x:auto;font-family:SF Mono,monospace;font-size:12px;line-height:1.6;color:#e6e6e6;max-height:400px;overflow-y:auto}.analytics-charts{display:flex;flex-direction:column;gap:12px}.analytics-bar{display:flex;flex-direction:column;gap:4px}.bar-label{font-size:12px;color:#ccc;font-weight:500}.bar-container{position:relative;background:#0f0f0f;border:1px solid #333;border-radius:4px;height:24px;overflow:hidden}.bar-fill{background:linear-gradient(90deg,#3c7dff,#2563eb);height:100%;transition:width .3s ease}.bar-value{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:11px;color:#fff;font-weight:500}.source-stats{display:flex;flex-direction:column;gap:8px}.source-stat-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:6px}.source-name{font-size:12px;color:#ccc}.source-count{font-size:12px;color:#3c7dff;font-weight:600}.method-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}.method-stat-card{background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:8px;padding:16px}.method-name{font-size:14px;font-weight:600;color:#fff;margin-bottom:8px}.method-metrics{display:flex;flex-direction:column;gap:4px}.method-metrics .metric{font-size:11px;color:#888}.performance-chart{display:flex;flex-direction:column;gap:8px}.performance-bar{display:flex;flex-direction:column;gap:4px}.enhancer-distribution{display:flex;flex-direction:column;gap:8px}.enhancer-dist-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:6px}.enhancer-type{font-size:12px;color:#ccc}.enhancer-count{font-size:12px;color:#3c7dff;font-weight:600}.performance-metrics{display:flex;flex-direction:column;gap:12px}.performance-metric{display:flex;justify-content:space-between;align-items:center;padding:12px;background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:6px}.enhancement-timeline{display:flex;flex-direction:column;gap:8px}.timeline-item{display:flex;gap:16px;padding:8px 12px;background:linear-gradient(135deg,#222,#1a1a1a);border:1px solid #333;border-radius:6px}.timeline-time{font-size:11px;color:#888;font-family:SF Mono,monospace;min-width:60px}.timeline-event{font-size:12px;color:#ccc}@media (max-width: 768px){.metrics-grid,.form-fields-grid{grid-template-columns:repeat(2,1fr)}.customer-info{grid-template-columns:1fr}.config-groups{gap:16px}.storage-items{gap:8px}.method-stats{grid-template-columns:1fr}}",Fa=".timeline-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#f8f9fa;border-bottom:1px solid #e9ecef;border-radius:4px 4px 0 0;margin-bottom:12px}.timeline-stats{display:flex;gap:16px}.timeline-stat{display:flex;flex-direction:column;align-items:center;font-size:11px}.timeline-stat-label{color:#6c757d;margin-bottom:2px}.timeline-stat-value{font-weight:600;color:#495057}.timeline-stat-value.recording{color:#28a745}.timeline-stat-value.paused{color:#dc3545}.timeline-controls{display:flex;gap:8px}.timeline-control-btn{padding:6px 12px;border:1px solid #dee2e6;border-radius:3px;background:#fff;font-size:11px;cursor:pointer;transition:all .2s}.timeline-control-btn:hover{background:#f8f9fa;transform:translateY(-1px)}.timeline-control-btn.record{background:#28a745;color:#fff;border-color:#28a745}.timeline-control-btn.pause{background:#ffc107;color:#212529;border-color:#ffc107}.timeline-control-btn.clear{background:#dc3545;color:#fff;border-color:#dc3545}.timeline-control-btn.export{background:#007bff;color:#fff;border-color:#007bff}.timeline-events{max-height:500px;overflow-y:auto;padding:0 4px}.timeline-event{background:#fff;border:1px solid #e9ecef;border-radius:4px;margin-bottom:8px;transition:all .2s;position:relative}.timeline-event:hover{box-shadow:0 2px 8px #0000001a;transform:translateY(-1px)}.timeline-event-header{padding:8px 12px;border-bottom:1px solid #f8f9fa;display:flex;justify-content:space-between;align-items:center}.timeline-event-meta{display:flex;align-items:center;gap:8px;font-size:11px}.timeline-event-icon{font-size:14px}.timeline-event-type{font-weight:600;text-transform:uppercase;letter-spacing:.5px}.timeline-event-time{color:#6c757d;font-style:italic}.timeline-event-name{font-weight:600;color:#495057;font-size:13px}.timeline-event-details{padding:8px 12px;font-size:11px}.timeline-event-source{color:#6c757d;margin-bottom:8px}.timeline-event-data-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}.timeline-toggle-data{background:none;border:1px solid #dee2e6;border-radius:2px;padding:2px 6px;font-size:10px;cursor:pointer;color:#007bff}.timeline-toggle-data:hover{background:#f8f9fa}.timeline-event-data-content{background:#f8f9fa;border:1px solid #e9ecef;border-radius:3px;padding:8px;margin:4px 0;font-family:Monaco,Consolas,monospace;font-size:10px;line-height:1.4;max-height:200px;overflow-y:auto}.timeline-event-data-preview{background:#f8f9fa;border:1px solid #e9ecef;border-radius:3px;padding:6px;font-family:Monaco,Consolas,monospace;font-size:10px;color:#6c757d;white-space:pre-wrap;word-break:break-all}.timeline-empty{text-align:center;padding:40px 20px;color:#6c757d}.timeline-empty-icon{font-size:48px;margin-bottom:16px}.timeline-empty-title{font-size:16px;font-weight:600;margin-bottom:8px;color:#495057}.timeline-empty-subtitle{font-size:13px}.analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}.analytics-card{background:#fff;border:1px solid #e9ecef;border-radius:4px;padding:12px}.analytics-card-full{grid-column:1 / -1}.analytics-card-title{font-weight:600;margin-bottom:12px;color:#495057;font-size:13px;border-bottom:1px solid #f8f9fa;padding-bottom:6px}.analytics-stats{display:flex;flex-direction:column;gap:8px}.analytics-stat{display:flex;justify-content:space-between;font-size:11px}.analytics-stat-label{color:#6c757d}.analytics-stat-value{font-weight:600;color:#495057}.analytics-distribution{display:flex;flex-direction:column;gap:6px}.analytics-distribution-item{display:flex;align-items:center;gap:8px;font-size:11px}.analytics-distribution-bar{flex:1;height:16px;background:#f8f9fa;border-radius:8px;overflow:hidden;position:relative}.analytics-distribution-fill{height:100%;border-radius:8px;transition:width .3s ease}.analytics-distribution-label{min-width:80px;color:#495057;font-weight:500}.analytics-sources{display:flex;flex-direction:column;gap:4px;max-height:200px;overflow-y:auto}.analytics-source-item{display:flex;justify-content:space-between;padding:4px 8px;background:#f8f9fa;border-radius:3px;font-size:11px}.analytics-source-name{color:#495057;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.analytics-source-count{color:#6c757d;font-weight:600;min-width:20px;text-align:right}.timeline-chart{display:flex;align-items:end;gap:4px;height:100px;padding:8px;background:#f8f9fa;border-radius:4px}.timeline-chart-bar{flex:1;background:linear-gradient(to top,#007bff,#66b3ff);border-radius:2px 2px 0 0;min-height:2px;position:relative;cursor:pointer;transition:all .2s}.timeline-chart-bar:hover{opacity:.8;transform:scaleY(1.1)}.timeline-chart-value{position:absolute;top:-16px;left:50%;transform:translate(-50%);font-size:9px;color:#495057;font-weight:600;opacity:0;transition:opacity .2s}.timeline-chart-bar:hover .timeline-chart-value{opacity:1}.filters-container{padding:12px;display:flex;flex-direction:column;gap:16px}.filter-group{border:1px solid #e9ecef;border-radius:4px;padding:12px;background:#fff}.filter-group-title{font-weight:600;margin-bottom:8px;color:#495057;font-size:12px}.filter-search-input{width:100%;padding:6px 8px;border:1px solid #dee2e6;border-radius:3px;font-size:11px}.filter-search-input:focus{outline:none;border-color:#007bff;box-shadow:0 0 0 2px #007bff40}.filter-checkboxes{display:flex;flex-direction:column;gap:6px}.filter-checkbox{display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;padding:4px;border-radius:3px;transition:background .2s}.filter-checkbox:hover{background:#f8f9fa}.filter-checkbox input[type=checkbox]{margin:0}.filter-checkbox-icon{font-size:14px}.filter-checkbox-label{color:#495057}.filter-sources-list{max-height:150px;overflow-y:auto;border:1px solid #e9ecef;border-radius:3px;padding:4px}.filter-empty{color:#6c757d;font-style:italic;text-align:center;padding:12px;font-size:11px}.filter-time-range{width:100%;padding:6px 8px;border:1px solid #dee2e6;border-radius:3px;font-size:11px;background:#fff}.filter-controls{display:flex;gap:8px}.filter-control-btn{flex:1;padding:8px 12px;border:1px solid #dee2e6;border-radius:3px;background:#fff;font-size:11px;cursor:pointer;transition:all .2s}.filter-control-btn:hover{background:#f8f9fa;transform:translateY(-1px)}@media (max-width: 768px){.timeline-header{flex-direction:column;gap:12px;align-items:stretch}.timeline-stats{justify-content:space-around}.analytics-grid{grid-template-columns:1fr}.filter-controls{flex-direction:column}}@keyframes eventAdded{0%{opacity:0;transform:translate(-20px)}to{opacity:1;transform:translate(0)}}.timeline-event.new{animation:eventAdded .3s ease-out}.timeline-events::-webkit-scrollbar,.analytics-sources::-webkit-scrollbar,.filter-sources-list::-webkit-scrollbar{width:6px}.timeline-events::-webkit-scrollbar-track,.analytics-sources::-webkit-scrollbar-track,.filter-sources-list::-webkit-scrollbar-track{background:#f8f9fa;border-radius:3px}.timeline-events::-webkit-scrollbar-thumb,.analytics-sources::-webkit-scrollbar-thumb,.filter-sources-list::-webkit-scrollbar-thumb{background:#dee2e6;border-radius:3px}.timeline-events::-webkit-scrollbar-thumb:hover,.analytics-sources::-webkit-scrollbar-thumb:hover,.filter-sources-list::-webkit-scrollbar-thumb:hover{background:#adb5bd}",$a=class{static async loadDebugStyles(){if(!this.isLoading&&!this.styleElement){this.isLoading=!0;try{const e=[Pa,Aa,La,Ta,Da,Ma,Fa].join("\n");this.styleElement=document.createElement("style"),this.styleElement.id="debug-overlay-styles",this.styleElement.textContent=e,document.head.appendChild(this.styleElement)}catch(e){}finally{this.isLoading=!1}}}static removeDebugStyles(){this.styleElement&&(this.styleElement.remove(),this.styleElement=null);const e=document.getElementById("debug-overlay-styles");e&&e.remove()}};$a.styleElement=null,$a.isLoading=!1;let qa=$a;const Oa=Object.freeze(Object.defineProperty({__proto__:null,DebugStyleLoader:qa},Symbol.toStringTag,{value:"Module"}));e.ApiClient=ce,e.EventBus=B,e.Logger=N,e.NextCommerce=ue,e.SDKInitializer=we,e.VERSION="__VERSION__",e.useCampaignStore=Y,e.useCartStore=Q,e.useCheckoutStore=te,e.useConfigStore=oe,e.useOrderStore=se,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
